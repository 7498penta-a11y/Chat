<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>NexusChat</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<style>
:root {
  --bg-void:     #0a0b0f;
  --bg-dark:     #0f1117;
  --bg-mid:      #161820;
  --bg-panel:    #1c1f2a;
  --bg-hover:    #252836;
  --bg-active:   #2d3147;
  --border:      rgba(255,255,255,0.07);
  --accent:      #5865f2;
  --accent-glow: rgba(88,101,242,0.3);
  --accent-2:    #eb459e;
  --green:       #3ba55d;
  --yellow:      #faa61a;
  --red:         #ed4245;
  --text-1:      #e3e5e8;
  --text-2:      #b9bbbe;
  --text-3:      #72767d;
  --text-muted:  #4f545c;
  --font-main:   'Outfit', sans-serif;
  --font-mono:   'JetBrains Mono', monospace;
  --radius:      8px;
  --radius-lg:   14px;
  --sidebar-w:   240px;
  --server-w:    72px;
  --members-w:   240px;
  --font-size:   15px;
}

/* â”€â”€ ãƒ©ã‚¤ãƒˆãƒ†ãƒ¼ãƒ â”€â”€ */
body.theme-light {
  --bg-void:   #e3e5e8;
  --bg-dark:   #ebedef;
  --bg-mid:    #f2f3f5;
  --bg-panel:  #ffffff;
  --bg-hover:  #d9dadc;
  --bg-active: #c3c4c7;
  --border:    rgba(0,0,0,0.1);
  --text-1:    #060607;
  --text-2:    #2e3338;
  --text-3:    #4f5660;
  --text-muted:#96989d;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%;
  font-family: var(--font-main);
  font-size: var(--font-size);
  background: var(--bg-void);
  color: var(--text-1);
  overflow: hidden;
  user-select: none;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AUTH â•â•â• */
#auth-screen {
  position: fixed; inset: 0;
  display: flex; align-items: center; justify-content: center;
  background: var(--bg-void); z-index: 1000;
}
.auth-bg {
  position: absolute; inset: 0;
  background:
    radial-gradient(ellipse 60% 50% at 20% 30%, rgba(88,101,242,0.15) 0%, transparent 70%),
    radial-gradient(ellipse 50% 40% at 80% 70%, rgba(235,69,158,0.1) 0%, transparent 70%);
}
.auth-card {
  position: relative; width: 420px;
  background: var(--bg-panel); border: 1px solid var(--border);
  border-radius: 20px; padding: 40px;
  box-shadow: 0 32px 80px rgba(0,0,0,0.6);
  animation: cardIn 0.4s cubic-bezier(0.16,1,0.3,1) forwards;
}
@keyframes cardIn {
  from { opacity:0; transform: translateY(24px) scale(0.97); }
  to   { opacity:1; transform: translateY(0) scale(1); }
}
.auth-logo { display:flex; align-items:center; gap:12px; margin-bottom:28px; }
.auth-logo-icon {
  width:44px; height:44px; border-radius:14px;
  background: linear-gradient(135deg,var(--accent),var(--accent-2));
  display:flex; align-items:center; justify-content:center; font-size:22px;
  box-shadow: 0 0 24px var(--accent-glow);
}
.auth-logo-text {
  font-size:24px; font-weight:700;
  background: linear-gradient(135deg,#fff 30%,var(--text-2));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}
.auth-title { font-size:22px; font-weight:600; margin-bottom:6px; }
.auth-subtitle { font-size:14px; color:var(--text-3); margin-bottom:28px; }
.tab-switcher {
  display:flex; background:var(--bg-mid); border-radius:var(--radius);
  padding:4px; margin-bottom:24px; gap:4px;
}
.tab-btn {
  flex:1; padding:8px; border:none; background:transparent;
  color:var(--text-3); font-family:var(--font-main); font-size:14px;
  font-weight:500; border-radius:6px; cursor:pointer; transition:all 0.2s;
}
.tab-btn.active { background:var(--accent); color:#fff; box-shadow:0 2px 8px var(--accent-glow); }
.field-label {
  display:block; font-size:12px; font-weight:600; color:var(--text-3);
  text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;
}
.field-input {
  width:100%; padding:12px 14px; background:var(--bg-dark);
  border:1px solid var(--border); border-radius:var(--radius);
  color:var(--text-1); font-family:var(--font-main); font-size:15px;
  outline:none; transition:border-color 0.2s,box-shadow 0.2s; margin-bottom:16px;
}
.field-input:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
.field-input::placeholder { color:var(--text-muted); }
.auth-btn {
  width:100%; padding:13px;
  background: linear-gradient(135deg,var(--accent),#4752c4);
  border:none; border-radius:var(--radius); color:#fff;
  font-family:var(--font-main); font-size:15px; font-weight:600;
  cursor:pointer; transition:all 0.2s; box-shadow:0 4px 16px var(--accent-glow);
  position:relative; overflow:hidden;
}
.auth-btn:hover { opacity:0.9; }
.auth-btn:active { transform:scale(0.98); }
.auth-btn:disabled { opacity:0.6; cursor:not-allowed; }
.auth-error {
  margin-top:12px; padding:10px 14px;
  background:rgba(237,66,69,0.15); border:1px solid rgba(237,66,69,0.3);
  border-radius:var(--radius); color:var(--red); font-size:13px; display:none;
}
.auth-error.show { display:block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• APP LAYOUT â•â•â• */
#app { display:none; height:100vh; flex-direction:row; }
#app.visible { display:flex; }

.server-list {
  width:var(--server-w); background:var(--bg-void);
  display:flex; flex-direction:column; align-items:center;
  padding:12px 0; gap:8px; overflow-y:auto; flex-shrink:0;
  border-right:1px solid var(--border);
}
.server-icon {
  width:48px; height:48px; border-radius:50%;
  background: linear-gradient(135deg,var(--accent),var(--accent-2));
  display:flex; align-items:center; justify-content:center;
  font-size:20px; cursor:pointer; transition:border-radius 0.2s,transform 0.2s;
  position:relative;
}
.server-icon:hover,.server-icon.active { border-radius:30%; transform:scale(1.05); box-shadow:0 0 0 3px var(--accent-glow); }
.server-icon::before {
  content:''; position:absolute; left:-12px; width:4px; height:0;
  background:#fff; border-radius:0 4px 4px 0; transition:height 0.2s;
}
.server-icon.active::before { height:32px; }
.server-sep { width:32px; height:2px; background:var(--bg-panel); border-radius:1px; }

.sidebar {
  width:var(--sidebar-w); background:var(--bg-dark);
  display:flex; flex-direction:column; flex-shrink:0;
  border-right:1px solid var(--border);
}
.sidebar-header {
  padding:16px; border-bottom:1px solid var(--border);
  font-weight:700; font-size:15px;
  display:flex; align-items:center; justify-content:space-between;
  cursor:pointer; transition:background 0.15s;
}
.sidebar-header:hover { background:var(--bg-hover); }
.channels-section { flex:1; overflow-y:auto; padding:8px 0; }
.ch-category {
  padding:16px 16px 4px; font-size:11px; font-weight:700;
  color:var(--text-3); text-transform:uppercase; letter-spacing:0.8px;
}
.ch-item {
  display:flex; align-items:center; gap:8px;
  padding:7px 8px 7px 16px; margin:1px 8px; border-radius:6px;
  cursor:pointer; color:var(--text-3); font-size:15px; font-weight:500;
  transition:all 0.15s; position:relative;
}
.ch-item:hover { background:var(--bg-hover); color:var(--text-2); }
.ch-item.active { background:var(--bg-active); color:var(--text-1); }
.ch-item .ch-icon { font-size:18px; flex-shrink:0; }
.ch-item .unread-badge {
  margin-left:auto; background:var(--red); color:#fff;
  font-size:11px; font-weight:700; border-radius:10px;
  padding:1px 6px; min-width:18px; text-align:center; display:none;
}
.ch-item.unread .unread-badge { display:block; }

.user-panel {
  padding:10px 8px; background:var(--bg-void);
  display:flex; align-items:center; gap:8px;
  border-top:1px solid var(--border);
}
.user-avatar { width:32px; height:32px; border-radius:50%; position:relative; flex-shrink:0; }
.user-avatar img { width:100%; height:100%; border-radius:50%; object-fit:cover; }
.user-status {
  position:absolute; bottom:-1px; right:-1px; width:10px; height:10px;
  border-radius:50%; background:var(--green); border:2px solid var(--bg-void);
}
.user-info { flex:1; min-width:0; }
.user-name { font-size:13px; font-weight:600; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
.user-tag  { font-size:11px; color:var(--text-3); font-family:var(--font-mono); }
.user-actions { display:flex; gap:4px; }
.user-action-btn {
  width:28px; height:28px; border:none; background:transparent;
  color:var(--text-3); border-radius:6px; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  font-size:16px; transition:all 0.15s;
}
.user-action-btn:hover { background:var(--bg-hover); color:var(--text-1); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CHAT â•â•â• */
.chat-area { flex:1; display:flex; flex-direction:column; min-width:0; background:var(--bg-mid); }
.chat-header {
  height:48px; padding:0 16px; border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:10px; flex-shrink:0; background:var(--bg-mid);
}
.chat-header-icon { font-size:20px; color:var(--text-3); }
.chat-header-name { font-size:16px; font-weight:700; }
.chat-header-sep  { width:1px; height:20px; background:var(--border); margin:0 4px; }
.chat-header-topic { font-size:13px; color:var(--text-3); overflow:hidden; white-space:nowrap; text-overflow:ellipsis; flex:1; }
.chat-header-actions { display:flex; gap:4px; margin-left:auto; }
.header-btn {
  width:32px; height:32px; border:none; background:transparent;
  color:var(--text-3); border-radius:6px; cursor:pointer;
  display:flex; align-items:center; justify-content:center; font-size:16px;
  transition:all 0.15s;
}
.header-btn:hover { background:var(--bg-hover); color:var(--text-1); }

/* Search bar */
.search-bar {
  padding:8px 16px; border-bottom:1px solid var(--border);
  background:var(--bg-mid); display:none;
}
.search-bar.open { display:block; }
.search-input {
  width:100%; padding:8px 12px; background:var(--bg-panel);
  border:1px solid var(--border); border-radius:var(--radius);
  color:var(--text-1); font-family:var(--font-main); font-size:14px; outline:none;
}
.search-input:focus { border-color:var(--accent); }
.search-input::placeholder { color:var(--text-muted); }

.messages {
  flex:1; overflow-y:auto; padding:16px 0;
  display:flex; flex-direction:column; gap:2px; scroll-behavior:smooth;
}
.messages::-webkit-scrollbar { width:4px; }
.messages::-webkit-scrollbar-thumb { background:var(--bg-hover); border-radius:2px; }

.msg {
  display:flex; gap:14px; padding:4px 16px; border-radius:4px;
  transition:background 0.1s; position:relative;
  animation: msgIn 0.2s ease-out;
}
@keyframes msgIn {
  from { opacity:0; transform:translateY(8px); }
  to   { opacity:1; transform:translateY(0); }
}
.msg:hover { background:rgba(0,0,0,0.1); }
.msg.mention-highlight { background:rgba(250,166,26,0.08) !important; border-left:3px solid var(--yellow); padding-left:13px; }
.msg:hover .msg-actions { opacity:1; }

.msg-avatar { width:40px; height:40px; border-radius:50%; flex-shrink:0; cursor:pointer; margin-top:2px; }
.msg-avatar img { width:100%; height:100%; border-radius:50%; object-fit:cover; }
.msg-body { flex:1; min-width:0; }
.msg-header { display:flex; align-items:baseline; gap:8px; margin-bottom:3px; }
.msg-author { font-size:15px; font-weight:600; color:var(--text-1); cursor:pointer; }
.msg-author:hover { text-decoration:underline; }
.msg-time { font-size:11px; color:var(--text-muted); font-family:var(--font-mono); }
.msg-content { font-size:var(--font-size); color:var(--text-2); line-height:1.5; word-break:break-word; user-select:text; }
.mention { color:var(--accent); background:rgba(88,101,242,0.15); border-radius:3px; padding:0 2px; font-weight:600; }

/* Message action buttons */
.msg-actions {
  position:absolute; top:-14px; right:16px;
  background:var(--bg-panel); border:1px solid var(--border);
  border-radius:8px; display:flex; gap:2px; padding:3px;
  opacity:0; transition:opacity 0.15s; z-index:10;
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
}
.msg-action-btn {
  width:28px; height:28px; border:none; background:transparent;
  color:var(--text-3); border-radius:5px; cursor:pointer;
  display:flex; align-items:center; justify-content:center; font-size:15px;
  transition:all 0.1s;
}
.msg-action-btn:hover { background:var(--bg-hover); color:var(--text-1); }

/* Reactions */
.reactions { display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; }
.reaction-pill {
  display:inline-flex; align-items:center; gap:4px;
  background:var(--bg-panel); border:1px solid var(--border);
  border-radius:12px; padding:2px 8px; font-size:13px; cursor:pointer;
  transition:all 0.15s; user-select:none;
}
.reaction-pill:hover { border-color:var(--accent); background:var(--bg-hover); }
.reaction-pill.reacted { border-color:var(--accent); background:rgba(88,101,242,0.15); color:var(--accent); }
.reaction-count { font-size:12px; font-weight:600; color:var(--text-2); }

/* System message */
.msg.system { padding-left:70px; color:var(--text-3); font-size:13px; font-style:italic; }
.msg.system::before { content:'â€”'; position:absolute; left:32px; }

/* File */
.file-attachment {
  display:inline-flex; align-items:center; gap:12px;
  background:var(--bg-panel); border:1px solid var(--border);
  border-radius:var(--radius); padding:12px 14px; margin-top:6px;
  max-width:420px; text-decoration:none; transition:border-color 0.2s;
}
.file-attachment:hover { border-color:var(--accent); }
.file-icon {
  width:40px; height:40px; border-radius:10px;
  background: linear-gradient(135deg,var(--accent),var(--accent-2));
  display:flex; align-items:center; justify-content:center;
  font-size:18px; flex-shrink:0;
}
.file-info { flex:1; min-width:0; }
.file-name { font-size:14px; font-weight:600; color:var(--text-1); overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
.file-size { font-size:12px; color:var(--text-3); margin-top:2px; }
.img-preview {
  max-width:400px; max-height:300px; border-radius:var(--radius);
  margin-top:6px; cursor:zoom-in; display:block;
  border:1px solid var(--border); object-fit:cover;
}

/* Typing */
.typing-bar { height:20px; padding:0 16px; font-size:13px; color:var(--text-3); display:flex; align-items:center; gap:6px; }
.typing-dots { display:flex; gap:3px; }
.typing-dot { width:5px; height:5px; border-radius:50%; background:var(--text-3); animation:typingBounce 1.2s infinite; }
.typing-dot:nth-child(2) { animation-delay:0.2s; }
.typing-dot:nth-child(3) { animation-delay:0.4s; }
@keyframes typingBounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-4px)} }

/* Input bar */
.input-bar { padding:0 16px 16px; flex-shrink:0; }
.input-box {
  background:var(--bg-panel); border:1px solid var(--border);
  border-radius:var(--radius-lg); display:flex; align-items:center;
  gap:6px; padding:6px 6px 6px 14px; transition:border-color 0.2s;
}
.input-box:focus-within { border-color:rgba(88,101,242,0.5); }
.attach-btn,.emoji-btn {
  width:36px; height:36px; border:none; background:transparent; color:var(--text-3);
  border-radius:8px; cursor:pointer; display:flex; align-items:center;
  justify-content:center; font-size:20px; flex-shrink:0; transition:all 0.15s;
}
.attach-btn:hover,.emoji-btn:hover { background:var(--bg-hover); color:var(--text-1); }
.msg-input {
  flex:1; border:none; background:transparent; color:var(--text-1);
  font-family:var(--font-main); font-size:var(--font-size); outline:none;
  resize:none; min-height:24px; max-height:200px; line-height:1.5; padding:4px 0;
}
.msg-input::placeholder { color:var(--text-muted); }
.send-btn {
  width:36px; height:36px; border:none; background:var(--accent); color:#fff;
  border-radius:8px; cursor:pointer; display:flex; align-items:center;
  justify-content:center; font-size:18px; flex-shrink:0;
  transition:all 0.15s; box-shadow:0 2px 8px var(--accent-glow);
}
.send-btn:hover { background:#4752c4; transform:scale(1.05); }
.send-btn:active { transform:scale(0.95); }

/* â”€â”€ Emoji Picker â”€â”€ */
.emoji-picker {
  position:absolute; bottom:80px; left:16px;
  background:var(--bg-panel); border:1px solid var(--border);
  border-radius:var(--radius-lg); padding:12px;
  box-shadow:0 16px 40px rgba(0,0,0,0.4); z-index:500;
  display:none; width:320px;
}
.emoji-picker.open { display:block; }
.emoji-categories { display:flex; gap:4px; margin-bottom:8px; overflow-x:auto; padding-bottom:4px; }
.emoji-cat-btn {
  padding:4px 8px; border:none; background:transparent; color:var(--text-3);
  border-radius:6px; cursor:pointer; font-size:18px; flex-shrink:0; transition:all 0.15s;
}
.emoji-cat-btn:hover,.emoji-cat-btn.active { background:var(--bg-hover); color:var(--text-1); }
.emoji-grid { display:grid; grid-template-columns:repeat(8,1fr); gap:4px; max-height:200px; overflow-y:auto; }
.emoji-btn-item {
  width:36px; height:36px; border:none; background:transparent; border-radius:6px;
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  font-size:20px; transition:background 0.1s;
}
.emoji-btn-item:hover { background:var(--bg-hover); }

/* Members */
.members-panel {
  width:var(--members-w); background:var(--bg-dark);
  border-left:1px solid var(--border); overflow-y:auto; flex-shrink:0;
}
.members-header { padding:16px; font-size:11px; font-weight:700; color:var(--text-3); text-transform:uppercase; letter-spacing:0.8px; }
.member-item {
  display:flex; align-items:center; gap:10px;
  padding:6px 12px; margin:1px 8px; border-radius:6px;
  cursor:pointer; transition:background 0.15s;
}
.member-item:hover { background:var(--bg-hover); }
.member-avatar { width:32px; height:32px; border-radius:50%; position:relative; flex-shrink:0; }
.member-avatar img { width:100%; height:100%; border-radius:50%; object-fit:cover; }
.member-status { position:absolute; bottom:-1px; right:-1px; width:10px; height:10px; border-radius:50%; background:var(--green); border:2px solid var(--bg-dark); }
.member-name { font-size:14px; font-weight:500; color:var(--text-2); overflow:hidden; white-space:nowrap; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SETTINGS MODAL â•â•â• */
.modal-overlay {
  display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7);
  z-index:2000; align-items:center; justify-content:center;
  backdrop-filter:blur(4px);
}
.modal-overlay.open { display:flex; }

.settings-modal {
  background:var(--bg-panel); border:1px solid var(--border);
  border-radius:20px; width:560px; max-width:calc(100vw - 32px);
  max-height:80vh; overflow:hidden; display:flex; flex-direction:column;
  box-shadow:0 32px 80px rgba(0,0,0,0.6);
  animation: cardIn 0.3s cubic-bezier(0.16,1,0.3,1);
}
.settings-header {
  padding:20px 24px 16px; border-bottom:1px solid var(--border);
  display:flex; align-items:center; justify-content:space-between;
}
.settings-title { font-size:18px; font-weight:700; }
.settings-close {
  width:32px; height:32px; border:none; background:transparent;
  color:var(--text-3); border-radius:8px; cursor:pointer;
  display:flex; align-items:center; justify-content:center; font-size:20px;
  transition:all 0.15s;
}
.settings-close:hover { background:var(--bg-hover); color:var(--text-1); }
.settings-body { padding:20px 24px; overflow-y:auto; display:flex; flex-direction:column; gap:24px; }

.settings-section-title {
  font-size:11px; font-weight:700; color:var(--text-3);
  text-transform:uppercase; letter-spacing:0.8px; margin-bottom:12px;
}
.settings-row {
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 16px; background:var(--bg-mid); border-radius:var(--radius);
  margin-bottom:8px;
}
.settings-row-label { font-size:14px; font-weight:500; color:var(--text-1); }
.settings-row-desc  { font-size:12px; color:var(--text-3); margin-top:2px; }

/* Toggle switch */
.toggle {
  width:44px; height:24px; background:var(--bg-hover);
  border-radius:12px; position:relative; cursor:pointer;
  transition:background 0.2s; flex-shrink:0;
}
.toggle.on { background:var(--accent); }
.toggle::after {
  content:''; position:absolute; top:2px; left:2px;
  width:20px; height:20px; border-radius:50%;
  background:#fff; transition:transform 0.2s;
  box-shadow:0 2px 4px rgba(0,0,0,0.3);
}
.toggle.on::after { transform:translateX(20px); }

/* Select */
.settings-select {
  padding:6px 10px; background:var(--bg-dark); border:1px solid var(--border);
  border-radius:var(--radius); color:var(--text-1);
  font-family:var(--font-main); font-size:14px; cursor:pointer; outline:none;
}
.settings-select:focus { border-color:var(--accent); }

/* Theme selector */
.theme-options { display:flex; gap:8px; }
.theme-opt {
  flex:1; padding:10px; border:2px solid var(--border);
  border-radius:var(--radius); cursor:pointer; text-align:center;
  font-size:13px; font-weight:500; transition:all 0.15s;
  background:var(--bg-mid); color:var(--text-2);
}
.theme-opt:hover { border-color:var(--accent); }
.theme-opt.active { border-color:var(--accent); background:rgba(88,101,242,0.15); color:var(--accent); }

/* Font size slider */
.font-slider { width:100%; accent-color:var(--accent); cursor:pointer; }

/* Danger zone */
.danger-btn {
  padding:10px 16px; background:rgba(237,66,69,0.15);
  border:1px solid rgba(237,66,69,0.3); border-radius:var(--radius);
  color:var(--red); font-family:var(--font-main); font-size:14px;
  font-weight:600; cursor:pointer; width:100%; transition:all 0.2s;
}
.danger-btn:hover { background:rgba(237,66,69,0.3); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MISC â•â•â• */
.upload-toast {
  position:fixed; bottom:80px; left:50%;
  transform:translateX(-50%) translateY(10px);
  background:var(--bg-panel); border:1px solid var(--border);
  border-radius:var(--radius-lg); padding:14px 18px;
  display:flex; align-items:center; gap:12px;
  box-shadow:0 16px 40px rgba(0,0,0,0.5); z-index:2000;
  min-width:280px; opacity:0; transition:all 0.3s; pointer-events:none;
}
.upload-toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
.upload-spinner { width:20px; height:20px; border:2px solid var(--bg-hover); border-top-color:var(--accent); border-radius:50%; animation:spin 0.8s linear infinite; flex-shrink:0; }
@keyframes spin { to { transform:rotate(360deg); } }
.upload-label { font-size:14px; color:var(--text-2); flex:1; }

.drop-overlay {
  display:none; position:fixed; inset:0;
  background:rgba(88,101,242,0.15); border:3px dashed var(--accent);
  border-radius:16px; margin:16px; z-index:999;
  align-items:center; justify-content:center;
  flex-direction:column; gap:16px; font-size:24px; color:var(--accent);
  backdrop-filter:blur(4px);
}
.drop-overlay.active { display:flex; }

.lightbox {
  display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85);
  z-index:3000; align-items:center; justify-content:center;
  cursor:zoom-out; backdrop-filter:blur(8px);
}
.lightbox.open { display:flex; }
.lightbox img { max-width:90vw; max-height:90vh; border-radius:var(--radius); }

.welcome-msg { padding:32px 16px 16px; border-bottom:1px solid var(--border); margin-bottom:8px; }
.welcome-icon { width:64px; height:64px; border-radius:50%; background:linear-gradient(135deg,var(--accent),var(--accent-2)); display:flex; align-items:center; justify-content:center; font-size:28px; margin-bottom:16px; }
.welcome-title { font-size:24px; font-weight:700; margin-bottom:6px; }
.welcome-sub   { font-size:15px; color:var(--text-3); }

* { scrollbar-width:thin; scrollbar-color:var(--bg-hover) transparent; }

/* â”€â”€ Toast notification â”€â”€ */
.toast-notif {
  position:fixed; top:16px; right:16px; z-index:4000;
  background:var(--bg-panel); border:1px solid var(--border);
  border-radius:var(--radius-lg); padding:12px 16px;
  display:flex; align-items:center; gap:12px;
  box-shadow:0 8px 24px rgba(0,0,0,0.4); min-width:260px; max-width:360px;
  animation: toastIn 0.3s cubic-bezier(0.16,1,0.3,1);
}
@keyframes toastIn { from{opacity:0;transform:translateX(20px)} to{opacity:1;transform:translateX(0)} }
.toast-notif-icon { font-size:20px; flex-shrink:0; }
.toast-notif-body { flex:1; }
.toast-notif-title { font-size:13px; font-weight:600; color:var(--text-1); }
.toast-notif-text  { font-size:12px; color:var(--text-3); margin-top:2px; }

/* â”€â”€ Mobile Buttons â”€â”€ */
.mobile-menu-btn,.mobile-members-btn {
  display:none; width:36px; height:36px; border:none; background:transparent;
  color:var(--text-2); border-radius:8px; cursor:pointer;
  align-items:center; justify-content:center; font-size:20px; flex-shrink:0; transition:background 0.15s;
}
.mobile-menu-btn:hover,.mobile-members-btn:hover { background:var(--bg-hover); color:var(--text-1); }

.drawer-overlay {
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.6); z-index:200; backdrop-filter:blur(2px);
  animation:fadeIn 0.2s ease;
}
.drawer-overlay.open { display:block; }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }

/* â•â•â• Tablet â‰¤900px â•â•â• */
@media (max-width:900px) {
  .members-panel {
    position:fixed; right:0; top:0; bottom:0; z-index:300;
    width:240px; transform:translateX(100%);
    transition:transform 0.28s cubic-bezier(0.16,1,0.3,1);
    box-shadow:-8px 0 32px rgba(0,0,0,0.4);
  }
  .members-panel.open { transform:translateX(0); }
  .mobile-members-btn { display:flex; }
}

/* â•â•â• Mobile â‰¤640px â•â•â• */
@media (max-width:640px) {
  .server-list { display:none; }
  .sidebar {
    position:fixed; left:0; top:0; bottom:0; z-index:300; width:280px;
    transform:translateX(-100%); transition:transform 0.28s cubic-bezier(0.16,1,0.3,1);
    box-shadow:8px 0 32px rgba(0,0,0,0.4);
  }
  .sidebar.open { transform:translateX(0); }
  .mobile-menu-btn { display:flex; }
  .auth-card { width:calc(100vw - 32px); padding:28px 20px; border-radius:16px; }
  .img-preview,.file-attachment { max-width:100%; }
  .chat-header-sep,.chat-header-topic { display:none; }
  .msg { padding:4px 10px; gap:10px; }
  .msg-avatar { width:34px; height:34px; }
  .msg.system { padding-left:54px; }
  .input-bar { padding:0 8px 12px; }
  .emoji-picker { left:8px; right:8px; width:auto; }
  .upload-toast { left:16px; right:16px; min-width:unset; transform:translateY(10px); }
  .upload-toast.show { transform:translateY(0); }
}

@media (max-width:380px) {
  .auth-logo-text { font-size:20px; }
  .auth-title { font-size:18px; }
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â• AUTH â•â•â•â•â•â•â•â•â•â• -->
<div id="auth-screen">
  <div class="auth-bg"></div>
  <div class="auth-card">
    <div class="auth-logo">
      <div class="auth-logo-icon">âš¡</div>
      <div class="auth-logo-text">NexusChat</div>
    </div>
    <h1 class="auth-title">Welcome back</h1>
    <p class="auth-subtitle">Dive back into your conversations</p>
    <div class="tab-switcher">
      <button class="tab-btn active" onclick="switchTab('login')">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button class="tab-btn" onclick="switchTab('register')">æ–°è¦ç™»éŒ²</button>
    </div>
    <div id="login-form">
      <label class="field-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
      <input class="field-input" id="login-username" type="text" placeholder="username" autocomplete="username" />
      <label class="field-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input class="field-input" id="login-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
      <button class="auth-btn" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
    <div id="register-form" style="display:none">
      <label class="field-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼å <span style="color:var(--text-muted);text-transform:none;font-size:11px">(3ã€œ20æ–‡å­—)</span></label>
      <input class="field-input" id="reg-username" type="text" placeholder="username" autocomplete="username" />
      <label class="field-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input class="field-input" id="reg-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password" />
      <button class="auth-btn" onclick="register()">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</button>
    </div>
    <div class="auth-error" id="auth-error"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• APP â•â•â•â•â•â•â•â•â•â• -->
<div id="app">
  <div class="server-list">
    <div class="server-icon active" title="NexusChat">âš¡</div>
    <div class="server-sep"></div>
    <div class="server-icon" title="Add Server" style="background:var(--bg-panel);color:var(--green);font-size:26px;font-weight:300">+</div>
  </div>

  <div class="sidebar">
    <div class="sidebar-header">
      <span>NexusChat</span>
      <span style="color:var(--text-3)">âŒ„</span>
    </div>
    <div class="channels-section" id="channel-list">
      <div class="ch-category">ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ£ãƒ³ãƒãƒ«</div>
    </div>
    <div class="user-panel">
      <div class="user-avatar">
        <img id="user-avatar-img" src="" alt="" />
        <div class="user-status"></div>
      </div>
      <div class="user-info">
        <div class="user-name" id="user-display-name">â€”</div>
        <div class="user-tag" id="user-display-tag">#0000</div>
      </div>
      <div class="user-actions">
        <button class="user-action-btn" title="è¨­å®š" onclick="openSettings()">âš™</button>
        <button class="user-action-btn" title="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ" onclick="logout()">ğŸšª</button>
      </div>
    </div>
  </div>

  <div class="chat-area">
    <div class="chat-header">
      <button class="mobile-menu-btn" onclick="toggleSidebar()" title="ãƒãƒ£ãƒ³ãƒãƒ«ä¸€è¦§">â˜°</button>
      <span class="chat-header-icon">#</span>
      <span class="chat-header-name" id="chat-header-name">general</span>
      <div class="chat-header-sep"></div>
      <span class="chat-header-topic" id="chat-header-topic">ã¿ã‚“ãªã®ãƒãƒ£ãƒ³ãƒãƒ«ã¸ã‚ˆã†ã“ãï¼</span>
      <div class="chat-header-actions">
        <button class="header-btn" onclick="toggleSearch()" title="æ¤œç´¢">ğŸ”</button>
        <button class="mobile-members-btn" onclick="toggleMembers()" title="ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§">ğŸ‘¥</button>
      </div>
    </div>

    <div class="search-bar" id="search-bar">
      <input class="search-input" id="search-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¤œç´¢..." oninput="searchMessages(this.value)" />
    </div>

    <div class="messages" id="messages">
      <div class="welcome-msg">
        <div class="welcome-icon">#</div>
        <div class="welcome-title" id="welcome-title">#general ã¸ã‚ˆã†ã“ãï¼</div>
        <div class="welcome-sub">ã“ã‚Œã¯ãƒãƒ£ãƒ³ãƒãƒ«ã®å§‹ã¾ã‚Šã§ã™ã€‚</div>
      </div>
    </div>

    <div class="typing-bar" id="typing-bar"></div>

    <div class="input-bar" style="position:relative">
      <!-- Emoji Picker -->
      <div class="emoji-picker" id="emoji-picker">
        <div class="emoji-categories" id="emoji-cats"></div>
        <div class="emoji-grid" id="emoji-grid"></div>
      </div>
      <div class="input-box">
        <button class="attach-btn" title="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ·»ä»˜" onclick="openFilePicker()">ğŸ“</button>
        <button class="emoji-btn" title="çµµæ–‡å­—" onclick="toggleEmojiPicker()">ğŸ˜Š</button>
        <textarea
          class="msg-input" id="msg-input"
          placeholder="#general ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡"
          rows="1"
          oninput="autoResize(this); emitTyping()"
          onkeydown="handleKey(event)"
        ></textarea>
        <button class="send-btn" onclick="sendMessage()" title="é€ä¿¡">â–¶</button>
      </div>
    </div>
  </div>

  <div class="members-panel">
    <div class="members-header">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ â€” <span id="online-count">0</span>å</div>
    <div id="members-list"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• SETTINGS MODAL â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="settings-modal" onclick="closeSettingsOutside(event)">
  <div class="settings-modal">
    <div class="settings-header">
      <div class="settings-title">âš™ è¨­å®š</div>
      <button class="settings-close" onclick="closeSettings()">âœ•</button>
    </div>
    <div class="settings-body">

      <!-- ãƒ†ãƒ¼ãƒ -->
      <div>
        <div class="settings-section-title">ğŸ¨ ãƒ†ãƒ¼ãƒ</div>
        <div class="theme-options">
          <div class="theme-opt active" id="theme-dark" onclick="setTheme('dark')">ğŸŒ™ ãƒ€ãƒ¼ã‚¯</div>
          <div class="theme-opt" id="theme-light" onclick="setTheme('light')">â˜€ï¸ ãƒ©ã‚¤ãƒˆ</div>
        </div>
      </div>

      <!-- ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º -->
      <div>
        <div class="settings-section-title">ğŸ”¤ ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º</div>
        <div class="settings-row">
          <div>
            <div class="settings-row-label">ã‚µã‚¤ã‚º: <span id="font-size-label">15px</span></div>
            <div class="settings-row-desc">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ†ã‚­ã‚¹ãƒˆã‚µã‚¤ã‚ºã‚’å¤‰æ›´ã—ã¾ã™</div>
          </div>
        </div>
        <input type="range" class="font-slider" id="font-slider" min="12" max="20" value="15" oninput="setFontSize(this.value)" />
      </div>

      <!-- é€šçŸ¥ -->
      <div>
        <div class="settings-section-title">ğŸ”” é€šçŸ¥</div>
        <div class="settings-row">
          <div>
            <div class="settings-row-label">é€šçŸ¥éŸ³</div>
            <div class="settings-row-desc">æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç€ä¿¡éŸ³ã‚’é³´ã‚‰ã™</div>
          </div>
          <div class="toggle on" id="toggle-sound" onclick="toggleSetting('sound')"></div>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-row-label">ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥</div>
            <div class="settings-row-desc">ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ™‚ã«ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’è¡¨ç¤º</div>
          </div>
          <div class="toggle" id="toggle-notif" onclick="requestNotifPermission()"></div>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-row-label">ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ™‚ã®ã¿é€šçŸ¥</div>
            <div class="settings-row-desc">@è‡ªåˆ† ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿é€šçŸ¥ã™ã‚‹</div>
          </div>
          <div class="toggle" id="toggle-mention-only" onclick="toggleSetting('mentionOnly')"></div>
        </div>
      </div>

      <!-- é€ä¿¡è¨­å®š -->
      <div>
        <div class="settings-section-title">âŒ¨ï¸ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡</div>
        <div class="settings-row">
          <div>
            <div class="settings-row-label">é€ä¿¡ã‚­ãƒ¼</div>
            <div class="settings-row-desc">Enterã§é€ä¿¡ / Shift+Enterã§æ”¹è¡Œ</div>
          </div>
          <select class="settings-select" id="send-key-select" onchange="setSendKey(this.value)">
            <option value="enter">Enter</option>
            <option value="ctrl">Ctrl+Enter</option>
          </select>
        </div>
      </div>

      <!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ -->
      <div>
        <div class="settings-section-title">ğŸ‘¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</div>
        <div class="settings-row">
          <div>
            <div class="settings-row-label" id="settings-username">â€”</div>
            <div class="settings-row-desc">ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</div>
          </div>
        </div>
        <button class="danger-btn" onclick="logout()">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>

    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• MISC â•â•â•â•â•â•â•â•â•â• -->
<div class="drawer-overlay" id="drawer-overlay" onclick="closeDrawers()"></div>
<div class="drop-overlay" id="drop-overlay"><div style="font-size:48px">ğŸ“</div><div>ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</div></div>
<div class="upload-toast" id="upload-toast"><div class="upload-spinner"></div><div class="upload-label" id="upload-label">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</div></div>
<div class="lightbox" id="lightbox" onclick="closeLightbox()"><img id="lightbox-img" src="" alt="" /></div>
<input type="file" id="file-input" style="display:none" onchange="handleFileSelect(this.files)" multiple />

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let token        = localStorage.getItem('token') || null;
let currentUser  = null;
let socket       = null;
let currentChannel = 'general';
let typingTimer  = null;
let typingUsers  = {};
let allMessages  = {}; // { channelId: [msg,...] }
let unreadCounts = {}; // { channelId: number }
const API = '';

// Settings
let settings = JSON.parse(localStorage.getItem('nexus_settings') || '{}');
settings = {
  theme: 'dark', fontSize: 15, sound: true,
  notif: false, mentionOnly: false, sendKey: 'enter',
  ...settings
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Emoji data
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const EMOJI_DATA = {
  'ğŸ˜Š': ['ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜†','ğŸ˜…','ğŸ˜‚','ğŸ¤£','ğŸ˜Š','ğŸ˜‡','ğŸ™‚','ğŸ™ƒ','ğŸ˜‰','ğŸ˜Œ','ğŸ˜','ğŸ¥°','ğŸ˜˜','ğŸ˜—','ğŸ˜™','ğŸ˜š','ğŸ˜‹','ğŸ˜›','ğŸ˜','ğŸ˜œ','ğŸ¤ª','ğŸ¤¨','ğŸ§','ğŸ¤“','ğŸ˜','ğŸ¥¸','ğŸ¤©','ğŸ¥³'],
  'ğŸ‘': ['ğŸ‘','ğŸ‘','ğŸ‘Œ','ğŸ¤Œ','âœŒï¸','ğŸ¤','ğŸ¤Ÿ','ğŸ¤˜','ğŸ¤™','ğŸ‘ˆ','ğŸ‘‰','ğŸ‘†','ğŸ–•','ğŸ‘‡','â˜ï¸','ğŸ‘‹','ğŸ¤š','ğŸ–ï¸','âœ‹','ğŸ––','ğŸ‘','ğŸ™Œ','ğŸ¤²','ğŸ¤','ğŸ™','âœï¸','ğŸ’ª','ğŸ¦¾','ğŸ¦¿','ğŸ¦µ','ğŸ¦¶'],
  'â¤ï¸': ['â¤ï¸','ğŸ§¡','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ–¤','ğŸ¤','ğŸ¤','ğŸ’”','â£ï¸','ğŸ’•','ğŸ’','ğŸ’“','ğŸ’—','ğŸ’–','ğŸ’˜','ğŸ’','ğŸ’Ÿ','â˜®ï¸','âœï¸','â˜ªï¸','ğŸ•‰ï¸','âœ¡ï¸','ğŸ”¯','ğŸ•','â˜¯ï¸','â˜¦ï¸','ğŸ›','â›'],
  'ğŸ±': ['ğŸ¶','ğŸ±','ğŸ­','ğŸ¹','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¨','ğŸ¯','ğŸ¦','ğŸ®','ğŸ·','ğŸ¸','ğŸµ','ğŸ”','ğŸ§','ğŸ¦','ğŸ¤','ğŸ¦†','ğŸ¦…','ğŸ¦‰','ğŸ¦‡','ğŸº','ğŸ—','ğŸ´','ğŸ¦„','ğŸ','ğŸª±','ğŸ›'],
  'ğŸ•': ['ğŸ•','ğŸ”','ğŸŒ­','ğŸ¥ª','ğŸŒ®','ğŸŒ¯','ğŸ¥™','ğŸ§†','ğŸ¥š','ğŸ³','ğŸ¥˜','ğŸ²','ğŸœ','ğŸ','ğŸ›','ğŸ£','ğŸ±','ğŸ¥Ÿ','ğŸ¦ª','ğŸ¤','ğŸ™','ğŸš','ğŸ˜','ğŸ¥','ğŸ¥®','ğŸ¡','ğŸ§','ğŸ‚','ğŸ°','ğŸ®'],
  'âš½': ['âš½','ğŸ€','ğŸˆ','âš¾','ğŸ¥','ğŸ¾','ğŸ','ğŸ‰','ğŸ¥','ğŸ±','ğŸª€','ğŸ“','ğŸ¸','ğŸ’','ğŸ¥','ğŸ','ğŸªƒ','ğŸ¥…','â›³','ğŸª','ğŸ£','ğŸ¤¿','ğŸ½','ğŸ¿','ğŸ›·','ğŸ¥Œ','ğŸ¯','ğŸ±','ğŸ®','ğŸ•¹ï¸'],
};
const EMOJI_CATS = Object.keys(EMOJI_DATA);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Settings
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveSettings() { localStorage.setItem('nexus_settings', JSON.stringify(settings)); }

function applySettings() {
  // Theme
  document.body.classList.toggle('theme-light', settings.theme === 'light');
  document.getElementById('theme-dark').classList.toggle('active', settings.theme === 'dark');
  document.getElementById('theme-light').classList.toggle('active', settings.theme === 'light');
  // Font size
  document.documentElement.style.setProperty('--font-size', settings.fontSize + 'px');
  document.getElementById('font-slider').value = settings.fontSize;
  document.getElementById('font-size-label').textContent = settings.fontSize + 'px';
  // Toggles
  document.getElementById('toggle-sound').classList.toggle('on', settings.sound);
  document.getElementById('toggle-notif').classList.toggle('on', settings.notif);
  document.getElementById('toggle-mention-only').classList.toggle('on', settings.mentionOnly);
  // Send key
  document.getElementById('send-key-select').value = settings.sendKey;
}

function setTheme(t) {
  settings.theme = t; saveSettings(); applySettings();
}
function setFontSize(v) {
  settings.fontSize = parseInt(v); saveSettings(); applySettings();
}
function toggleSetting(key) {
  settings[key] = !settings[key]; saveSettings(); applySettings();
}
function setSendKey(v) {
  settings.sendKey = v; saveSettings();
}
function requestNotifPermission() {
  if (!('Notification' in window)) return;
  Notification.requestPermission().then(p => {
    settings.notif = p === 'granted';
    saveSettings(); applySettings();
  });
}

function openSettings() {
  document.getElementById('settings-username').textContent = currentUser?.username || 'â€”';
  document.getElementById('settings-modal').classList.add('open');
}
function closeSettings() { document.getElementById('settings-modal').classList.remove('open'); }
function closeSettingsOutside(e) { if (e.target === document.getElementById('settings-modal')) closeSettings(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Emoji Picker
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let emojiPickerOpen = false;
let activeCat = EMOJI_CATS[0];

function buildEmojiPicker() {
  const catEl = document.getElementById('emoji-cats');
  catEl.innerHTML = EMOJI_CATS.map(c => `<button class="emoji-cat-btn${c===activeCat?' active':''}" onclick="showEmojiCat('${c}')">${c}</button>`).join('');
  showEmojiCat(activeCat, false);
}
function showEmojiCat(cat, updateCats=true) {
  activeCat = cat;
  if (updateCats) {
    document.querySelectorAll('.emoji-cat-btn').forEach((b,i) => b.classList.toggle('active', EMOJI_CATS[i]===cat));
  }
  const grid = document.getElementById('emoji-grid');
  grid.innerHTML = EMOJI_DATA[cat].map(e =>
    `<button class="emoji-btn-item" onclick="insertEmoji('${e}')">${e}</button>`
  ).join('');
}
function toggleEmojiPicker() {
  emojiPickerOpen = !emojiPickerOpen;
  const p = document.getElementById('emoji-picker');
  p.classList.toggle('open', emojiPickerOpen);
  if (emojiPickerOpen) buildEmojiPicker();
}
function insertEmoji(e) {
  const input = document.getElementById('msg-input');
  const pos = input.selectionStart;
  input.value = input.value.slice(0, pos) + e + input.value.slice(pos);
  input.selectionStart = input.selectionEnd = pos + e.length;
  input.focus();
  autoResize(input);
}
document.addEventListener('click', (e) => {
  if (emojiPickerOpen && !e.target.closest('#emoji-picker') && !e.target.closest('.emoji-btn')) {
    emojiPickerOpen = false;
    document.getElementById('emoji-picker').classList.remove('open');
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Search
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let searchOpen = false;
function toggleSearch() {
  searchOpen = !searchOpen;
  document.getElementById('search-bar').classList.toggle('open', searchOpen);
  if (searchOpen) document.getElementById('search-input').focus();
  else { document.getElementById('search-input').value=''; searchMessages(''); }
}
function searchMessages(q) {
  const msgs = document.querySelectorAll('#messages .msg');
  msgs.forEach(el => {
    if (!q) { el.style.display=''; return; }
    const text = el.textContent.toLowerCase();
    el.style.display = text.includes(q.toLowerCase()) ? '' : 'none';
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Notification
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function playNotifSound() {
  if (!settings.sound) return;
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.frequency.setValueAtTime(880, ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.1);
    g.gain.setValueAtTime(0.3, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
    o.start(ctx.currentTime); o.stop(ctx.currentTime + 0.3);
  } catch {}
}

function showBrowserNotif(title, body) {
  if (!settings.notif || Notification.permission !== 'granted') return;
  if (document.hasFocus()) return;
  new Notification(title, { body, icon: '/favicon.ico' });
}

function showToastNotif(author, content, channelId) {
  const el = document.createElement('div');
  el.className = 'toast-notif';
  el.innerHTML = `
    <div class="toast-notif-icon">ğŸ’¬</div>
    <div class="toast-notif-body">
      <div class="toast-notif-title">${escHtml(author)} <span style="color:var(--text-3);font-size:11px">#${escHtml(channelId)}</span></div>
      <div class="toast-notif-text">${escHtml(content.substring(0,60))}${content.length>60?'â€¦':''}</div>
    </div>`;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Auth
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.toggle('active',(i===0)===(tab==='login')));
  document.getElementById('login-form').style.display    = tab==='login'?'':'none';
  document.getElementById('register-form').style.display = tab==='register'?'':'none';
  hideError();
}
function showError(msg) { const e=document.getElementById('auth-error'); e.textContent=msg; e.classList.add('show'); }
function hideError() { document.getElementById('auth-error').classList.remove('show'); }

async function login() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  if (!username||!password) return showError('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  try {
    const res=await fetch(`${API}/api/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password})});
    const data=await res.json();
    if (!res.ok) return showError(data.error||'ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—');
    onLogin(data);
  } catch { showError('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“'); }
}
async function register() {
  const username = document.getElementById('reg-username').value.trim();
  const password = document.getElementById('reg-password').value;
  if (!username||!password) return showError('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  if (password.length<6) return showError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Š');
  try {
    const res=await fetch(`${API}/api/register`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password})});
    const data=await res.json();
    if (!res.ok) return showError(data.error||'ç™»éŒ²å¤±æ•—');
    onLogin(data);
  } catch { showError('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“'); }
}
function onLogin({token:t,user}) {
  token=t; currentUser=user;
  localStorage.setItem('token',t);
  document.getElementById('auth-screen').style.display='none';
  document.getElementById('app').classList.add('visible');
  applySettings();
  initApp();
}
function logout() {
  if (!confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  localStorage.removeItem('token');
  if (socket) socket.disconnect();
  location.reload();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// App Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initApp() {
  document.getElementById('user-display-name').textContent = currentUser.username;
  document.getElementById('user-display-tag').textContent  = '#'+currentUser.id.slice(0,4).toUpperCase();
  document.getElementById('user-avatar-img').src = currentUser.avatar;

  const res = await fetch(`${API}/api/channels`,{headers:{Authorization:`Bearer ${token}`}});
  const channels = await res.json();
  renderChannelList(channels);

  socket = io({auth:{token}});
  socket.on('connect', () => joinChannel(currentChannel));
  socket.on('message', (msg) => {
    if (!allMessages[msg.channelId]) allMessages[msg.channelId]=[];
    allMessages[msg.channelId].push(msg);

    if (msg.channelId === currentChannel) {
      appendMessage(msg);
      scrollToBottom();
    } else {
      // æœªèª­ãƒãƒƒã‚¸
      if (msg.type !== 'system') {
        unreadCounts[msg.channelId] = (unreadCounts[msg.channelId]||0)+1;
        updateUnreadBadge(msg.channelId);
      }
    }

    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³åˆ¤å®š
    const isMention = msg.content && currentUser && msg.content.includes('@'+currentUser.username);
    if (msg.type==='text' && msg.author !== currentUser?.username) {
      if (!settings.mentionOnly || isMention) playNotifSound();
      if (isMention) {
        showBrowserNotif(`${msg.author} ãŒã‚ãªãŸã‚’ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³`, msg.content);
        if (msg.channelId !== currentChannel) showToastNotif(msg.author, msg.content, msg.channelId);
      } else if (!settings.mentionOnly && msg.channelId !== currentChannel) {
        showToastNotif(msg.author, msg.content, msg.channelId);
      }
    }
  });
  socket.on('reaction_update', ({msgId, reactions}) => updateReactions(msgId, reactions));
  socket.on('online_users', renderMembers);
  socket.on('typing', ({username, isTyping}) => {
    if (isTyping) typingUsers[username]=true; else delete typingUsers[username];
    renderTyping();
  });

  document.addEventListener('dragover', e=>{e.preventDefault();document.getElementById('drop-overlay').classList.add('active');});
  document.addEventListener('dragleave', e=>{if(!e.relatedTarget)document.getElementById('drop-overlay').classList.remove('active');});
  document.addEventListener('drop', e=>{e.preventDefault();document.getElementById('drop-overlay').classList.remove('active');handleFileSelect(e.dataTransfer.files);});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Channels
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderChannelList(channels) {
  const list = document.getElementById('channel-list');
  list.innerHTML = '<div class="ch-category">ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ£ãƒ³ãƒãƒ«</div>';
  channels.forEach(ch => {
    const el = document.createElement('div');
    el.className = 'ch-item'+(ch.id===currentChannel?' active':'');
    el.id = `ch-${ch.id}`;
    el.innerHTML = `<span class="ch-icon">#</span>${ch.name}<span class="unread-badge" id="badge-${ch.id}"></span>`;
    el.onclick = () => joinChannel(ch.id);
    list.appendChild(el);
  });
}
function updateUnreadBadge(channelId) {
  const badge = document.getElementById(`badge-${channelId}`);
  const el    = document.getElementById(`ch-${channelId}`);
  const count = unreadCounts[channelId]||0;
  if (badge) badge.textContent = count>99?'99+':count;
  if (el) el.classList.toggle('unread', count>0);
}

async function joinChannel(channelId) {
  closeDrawers();
  document.querySelectorAll('.ch-item').forEach(el=>el.classList.remove('active'));
  const el = document.getElementById(`ch-${channelId}`);
  if (el) el.classList.add('active');

  currentChannel = channelId;
  unreadCounts[channelId]=0;
  updateUnreadBadge(channelId);

  document.getElementById('chat-header-name').textContent  = channelId;
  document.getElementById('msg-input').placeholder         = `#${channelId} ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡`;
  document.getElementById('messages').innerHTML = `
    <div class="welcome-msg">
      <div class="welcome-icon">#</div>
      <div class="welcome-title">#${channelId} ã¸ã‚ˆã†ã“ãï¼</div>
      <div class="welcome-sub">ã“ã‚Œã¯ãƒãƒ£ãƒ³ãƒãƒ«ã®å§‹ã¾ã‚Šã§ã™ã€‚</div>
    </div>`;

  socket.emit('join_channel', channelId);
  const res = await fetch(`${API}/api/channels/${channelId}/messages`,{headers:{Authorization:`Bearer ${token}`}});
  const messages = await res.json();
  messages.forEach(appendMessage);
  scrollToBottom();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Messages
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function appendMessage(msg) {
  const container = document.getElementById('messages');
  if (msg.type==='system') {
    const el=document.createElement('div');
    el.className='msg system'; el.textContent=msg.content;
    container.appendChild(el); return;
  }

  const avatar = `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(msg.author)}`;
  const time   = new Date(msg.timestamp).toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'});
  const isMention = msg.content && currentUser && msg.content.includes('@'+currentUser.username);

  const el = document.createElement('div');
  el.className = 'msg'+(isMention?' mention-highlight':'');
  el.dataset.id = msg.id;

  let contentHtml = '';
  if (msg.type==='file' && msg.fileInfo) {
    const {filename,url,mimetype,size} = msg.fileInfo;
    if (mimetype?.startsWith('image/')) {
      contentHtml=`<div class="msg-content" style="color:var(--text-3);font-size:13px">${escHtml(filename)}</div>
        <img class="img-preview" src="${url}" alt="${escHtml(filename)}" onclick="openLightbox('${url}')" loading="lazy" />`;
    } else {
      contentHtml=`<a class="file-attachment" href="${url}" target="_blank" download="${escHtml(filename)}">
        <div class="file-icon">${fileIcon(mimetype)}</div>
        <div class="file-info"><div class="file-name">${escHtml(filename)}</div><div class="file-size">${formatBytes(size)}</div></div>
        <span style="color:var(--text-3);font-size:18px">â¬‡</span></a>`;
    }
  } else {
    contentHtml=`<div class="msg-content">${mentionify(linkify(escHtml(msg.content)))}</div>`;
  }

  const reactionsHtml = `<div class="reactions" id="reactions-${msg.id}"></div>`;
  el.innerHTML=`
    <div class="msg-avatar"><img src="${avatar}" alt="${escHtml(msg.author)}" /></div>
    <div class="msg-body">
      <div class="msg-header">
        <span class="msg-author" onclick="insertMention('${escHtml(msg.author)}')">${escHtml(msg.author)}</span>
        <span class="msg-time">${time}</span>
      </div>
      ${contentHtml}
      ${reactionsHtml}
    </div>
    <div class="msg-actions">
      <button class="msg-action-btn" title="ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³" onclick="showReactionPicker('${msg.id}',this)">ğŸ˜Š</button>
      <button class="msg-action-btn" title="è¿”ä¿¡" onclick="replyTo('${escHtml(msg.author)}')">â†©</button>
    </div>`;
  container.appendChild(el);
  if (msg.reactions) renderReactions(msg.id, msg.reactions);
}

function insertMention(username) {
  const input = document.getElementById('msg-input');
  input.value += `@${username} `;
  input.focus();
  autoResize(input);
}
function replyTo(username) {
  const input = document.getElementById('msg-input');
  input.value = `@${username} ` + input.value;
  input.focus();
  autoResize(input);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Reactions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const QUICK_REACTIONS = ['ğŸ‘','â¤ï¸','ğŸ˜‚','ğŸ˜®','ğŸ˜¢','ğŸ‰'];

function showReactionPicker(msgId, btn) {
  // æ—¢å­˜ã®ãƒ”ãƒƒã‚«ãƒ¼ã‚’å‰Šé™¤
  document.querySelectorAll('.quick-reaction-picker').forEach(e=>e.remove());
  const picker = document.createElement('div');
  picker.className = 'quick-reaction-picker';
  picker.style.cssText='position:absolute;right:0;bottom:100%;background:var(--bg-panel);border:1px solid var(--border);border-radius:12px;padding:6px;display:flex;gap:4px;box-shadow:0 8px 24px rgba(0,0,0,0.4);z-index:100;';
  picker.innerHTML = QUICK_REACTIONS.map(e=>
    `<button onclick="addReaction('${msgId}','${e}')" style="width:32px;height:32px;border:none;background:transparent;border-radius:6px;cursor:pointer;font-size:18px;transition:background 0.1s;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">${e}</button>`
  ).join('');
  btn.closest('.msg-actions').appendChild(picker);
  setTimeout(()=>document.addEventListener('click',()=>picker.remove(),{once:true}), 100);
}

function addReaction(msgId, emoji) {
  socket.emit('add_reaction', {msgId, emoji, channelId:currentChannel});
  document.querySelectorAll('.quick-reaction-picker').forEach(e=>e.remove());
}

function updateReactions(msgId, reactions) {
  const el = document.getElementById(`reactions-${msgId}`);
  if (!el) return;
  renderReactions(msgId, reactions, el);
}
function renderReactions(msgId, reactions, el=null) {
  if (!el) el = document.getElementById(`reactions-${msgId}`);
  if (!el) return;
  if (!reactions || Object.keys(reactions).length===0) { el.innerHTML=''; return; }
  el.innerHTML = Object.entries(reactions).map(([emoji, users])=>{
    const reacted = users.includes(currentUser?.username);
    return `<span class="reaction-pill${reacted?' reacted':''}" onclick="addReaction('${msgId}','${emoji}')">
      ${emoji} <span class="reaction-count">${users.length}</span>
    </span>`;
  }).join('');
}

function scrollToBottom() { const m=document.getElementById('messages'); m.scrollTop=m.scrollHeight; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Send
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sendMessage() {
  const input = document.getElementById('msg-input');
  const content = input.value.trim();
  if (!content) return;
  socket.emit('send_message',{channelId:currentChannel,content});
  input.value=''; autoResize(input); stopTyping();
}
function handleKey(e) {
  if (settings.sendKey==='enter') {
    if (e.key==='Enter'&&!e.shiftKey) { e.preventDefault(); sendMessage(); }
  } else {
    if (e.key==='Enter'&&(e.ctrlKey||e.metaKey)) { e.preventDefault(); sendMessage(); }
  }
}
function autoResize(el) { el.style.height='24px'; el.style.height=Math.min(el.scrollHeight,200)+'px'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Typing
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function emitTyping() {
  if (!socket) return;
  socket.emit('typing',{channelId:currentChannel,isTyping:true});
  clearTimeout(typingTimer);
  typingTimer=setTimeout(stopTyping,2000);
}
function stopTyping() {
  if (!socket) return;
  socket.emit('typing',{channelId:currentChannel,isTyping:false});
  clearTimeout(typingTimer);
}
function renderTyping() {
  const bar=document.getElementById('typing-bar');
  const users=Object.keys(typingUsers).filter(u=>u!==currentUser?.username);
  if (!users.length){bar.innerHTML='';return;}
  bar.innerHTML=`<div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div><span>${escHtml(users.join(', '))} ãŒå…¥åŠ›ä¸­â€¦</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Members
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMembers(users) {
  document.getElementById('online-count').textContent=users.length;
  document.getElementById('members-list').innerHTML=users.map(u=>`
    <div class="member-item" onclick="insertMention('${escHtml(u)}')">
      <div class="member-avatar">
        <img src="https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(u)}" alt="${escHtml(u)}" />
        <div class="member-status"></div>
      </div>
      <div class="member-name">${escHtml(u)}</div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// File Upload
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openFilePicker(){document.getElementById('file-input').click();}
async function handleFileSelect(files){if(!files||!files.length)return;for(const f of files)await uploadFile(f);}
async function uploadFile(file) {
  showUploadToast(`${file.name} ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...`);
  const form=new FormData(); form.append('file',file);
  try {
    const res=await fetch(`${API}/api/upload`,{method:'POST',headers:{Authorization:`Bearer ${token}`},body:form});
    if (!res.ok){const e=await res.json();throw new Error(e.error||'Upload failed');}
    const fileInfo=await res.json();
    socket.emit('send_file',{channelId:currentChannel,fileInfo});
    hideUploadToast();
  } catch(err){hideUploadToast();alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: '+err.message);}
  document.getElementById('file-input').value='';
}
function showUploadToast(msg){document.getElementById('upload-label').textContent=msg;document.getElementById('upload-toast').classList.add('show');}
function hideUploadToast(){setTimeout(()=>document.getElementById('upload-toast').classList.remove('show'),500);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Lightbox
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openLightbox(src){document.getElementById('lightbox-img').src=src;document.getElementById('lightbox').classList.add('open');}
function closeLightbox(){document.getElementById('lightbox').classList.remove('open');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Mobile Drawer
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar(){const s=document.querySelector('.sidebar'),o=document.getElementById('drawer-overlay');const open=s.classList.toggle('open');o.classList.toggle('open',open);document.querySelector('.members-panel')?.classList.remove('open');}
function toggleMembers(){const p=document.querySelector('.members-panel'),o=document.getElementById('drawer-overlay');const open=p.classList.toggle('open');o.classList.toggle('open',open);document.querySelector('.sidebar')?.classList.remove('open');}
function closeDrawers(){document.querySelector('.sidebar')?.classList.remove('open');document.querySelector('.members-panel')?.classList.remove('open');document.getElementById('drawer-overlay')?.classList.remove('open');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escHtml(str){return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function linkify(text){return text.replace(/(https?:\/\/[^\s<]+)/g,'<a href="$1" target="_blank" rel="noopener" style="color:var(--accent)">$1</a>');}
function mentionify(text){return text.replace(/@(\w+)/g,'<span class="mention">@$1</span>');}
function formatBytes(b){if(b<1024)return b+' B';if(b<1048576)return(b/1024).toFixed(1)+' KB';return(b/1048576).toFixed(1)+' MB';}
function fileIcon(m=''){if(m.startsWith('image/'))return'ğŸ–¼ï¸';if(m.startsWith('video/'))return'ğŸ¬';if(m.startsWith('audio/'))return'ğŸµ';if(m.includes('pdf'))return'ğŸ“„';if(m.match(/zip|rar|7z/))return'ğŸ“¦';if(m.match(/word|document/))return'ğŸ“';if(m.match(/excel|spreadsheet/))return'ğŸ“Š';return'ğŸ“';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Auto-login
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
applySettings();
(async()=>{
  if (!token) return;
  try {
    const res=await fetch(`${API}/api/me`,{headers:{Authorization:`Bearer ${token}`}});
    if (!res.ok){localStorage.removeItem('token');return;}
    currentUser=await res.json();
    document.getElementById('auth-screen').style.display='none';
    document.getElementById('app').classList.add('visible');
    applySettings();
    initApp();
  } catch {localStorage.removeItem('token');}
})();
</script>
</body>
</html>
