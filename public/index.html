<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>NexusChat</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<style>
:root {
  --bg-void:#0a0b0f; --bg-dark:#0f1117; --bg-mid:#161820;
  --bg-panel:#1c1f2a; --bg-hover:#252836; --bg-active:#2d3147;
  --border:rgba(255,255,255,0.07); --accent:#5865f2; --accent-glow:rgba(88,101,242,0.3);
  --accent-2:#eb459e; --green:#3ba55d; --yellow:#faa61a; --red:#ed4245;
  --text-1:#e3e5e8; --text-2:#b9bbbe; --text-3:#72767d; --text-muted:#4f545c;
  --font-main:'Outfit',sans-serif; --font-mono:'JetBrains Mono',monospace;
  --radius:8px; --radius-lg:14px; --sidebar-w:240px; --server-w:72px;
  --members-w:220px; --font-size:15px;
}
body.theme-light {
  --bg-void:#e3e5e8; --bg-dark:#ebedef; --bg-mid:#f2f3f5; --bg-panel:#ffffff;
  --bg-hover:#d9dadc; --bg-active:#c3c4c7; --border:rgba(0,0,0,0.1);
  --text-1:#060607; --text-2:#2e3338; --text-3:#4f5660; --text-muted:#96989d;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;font-family:var(--font-main);font-size:var(--font-size);background:var(--bg-void);color:var(--text-1);overflow:hidden;user-select:none;}
#app{display:none;height:100vh;height:100dvh;flex-direction:row;}
#app.visible{display:flex;}

/* â”€â”€â”€ AUTH â”€â”€â”€ */
#auth-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg-void);z-index:1000;}
.auth-bg{position:absolute;inset:0;background:radial-gradient(ellipse 60% 50% at 20% 30%,rgba(88,101,242,0.15) 0%,transparent 70%),radial-gradient(ellipse 50% 40% at 80% 70%,rgba(235,69,158,0.1) 0%,transparent 70%);}
.auth-card{position:relative;width:420px;background:var(--bg-panel);border:1px solid var(--border);border-radius:20px;padding:40px;box-shadow:0 32px 80px rgba(0,0,0,0.6);animation:cardIn 0.4s cubic-bezier(0.16,1,0.3,1);}
@keyframes cardIn{from{opacity:0;transform:translateY(24px) scale(0.97)}to{opacity:1;transform:none}}
.auth-logo{display:flex;align-items:center;gap:12px;margin-bottom:28px;}
.auth-logo-icon{width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 0 24px var(--accent-glow);}
.auth-logo-text{font-size:24px;font-weight:700;background:linear-gradient(135deg,#fff 30%,var(--text-2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.auth-title{font-size:22px;font-weight:600;margin-bottom:6px;} .auth-subtitle{font-size:14px;color:var(--text-3);margin-bottom:28px;}
.tab-switcher{display:flex;background:var(--bg-mid);border-radius:var(--radius);padding:4px;margin-bottom:24px;gap:4px;}
.tab-btn{flex:1;padding:8px;border:none;background:transparent;color:var(--text-3);font-family:var(--font-main);font-size:14px;font-weight:500;border-radius:6px;cursor:pointer;transition:all 0.2s;}
.tab-btn.active{background:var(--accent);color:#fff;box-shadow:0 2px 8px var(--accent-glow);}
.field-label{display:block;font-size:12px;font-weight:600;color:var(--text-3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;}
.field-input{width:100%;padding:12px 14px;background:var(--bg-dark);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-1);font-family:var(--font-main);font-size:15px;outline:none;transition:all 0.2s;margin-bottom:16px;}
.field-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow);}
.field-input::placeholder{color:var(--text-muted);}
.auth-btn{width:100%;padding:13px;background:linear-gradient(135deg,var(--accent),#4752c4);border:none;border-radius:var(--radius);color:#fff;font-family:var(--font-main);font-size:15px;font-weight:600;cursor:pointer;transition:all 0.2s;box-shadow:0 4px 16px var(--accent-glow);}
.auth-btn:hover{opacity:0.9;} .auth-btn:active{transform:scale(0.98);}
.auth-error{margin-top:12px;padding:10px 14px;background:rgba(237,66,69,0.15);border:1px solid rgba(237,66,69,0.3);border-radius:var(--radius);color:var(--red);font-size:13px;display:none;}
.auth-error.show{display:block;}

/* â”€â”€â”€ LAYOUT â”€â”€â”€ */
.server-list{width:var(--server-w);background:var(--bg-void);display:flex;flex-direction:column;align-items:center;padding:12px 0;gap:8px;overflow-y:auto;flex-shrink:0;border-right:1px solid var(--border);}
.server-icon{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;transition:all 0.2s;position:relative;}
.server-icon:hover,.server-icon.active{border-radius:30%;box-shadow:0 0 0 3px var(--accent-glow);}
.server-sep{width:32px;height:2px;background:var(--bg-panel);border-radius:1px;}

/* â”€â”€â”€ SIDEBAR â”€â”€â”€ */
.sidebar{width:var(--sidebar-w);background:var(--bg-dark);display:flex;flex-direction:column;flex-shrink:0;border-right:1px solid var(--border);}
.sidebar-header{padding:16px;border-bottom:1px solid var(--border);font-weight:700;font-size:15px;display:flex;align-items:center;justify-content:space-between;}
.channels-section{flex:1;overflow-y:auto;padding:8px 0;}
.ch-category{padding:16px 8px 4px 16px;font-size:11px;font-weight:700;color:var(--text-3);text-transform:uppercase;letter-spacing:0.8px;display:flex;align-items:center;justify-content:space-between;}
.ch-category-btn{background:none;border:none;color:var(--text-3);cursor:pointer;font-size:16px;padding:2px 6px;border-radius:4px;transition:all 0.15s;}
.ch-category-btn:hover{background:var(--bg-hover);color:var(--text-1);}
.ch-item{display:flex;align-items:center;gap:8px;padding:7px 8px 7px 16px;margin:1px 8px;border-radius:6px;cursor:pointer;color:var(--text-3);font-size:15px;font-weight:500;transition:all 0.15s;position:relative;}
.ch-item:hover{background:var(--bg-hover);color:var(--text-2);}
.ch-item.active{background:var(--bg-active);color:var(--text-1);}
.ch-item .ch-icon{font-size:16px;flex-shrink:0;}
.ch-readonly-badge{font-size:10px;background:rgba(250,166,26,0.2);color:var(--yellow);border-radius:4px;padding:1px 4px;margin-left:auto;}
.ch-item .unread-badge{margin-left:auto;background:var(--red);color:#fff;font-size:11px;font-weight:700;border-radius:10px;padding:1px 6px;min-width:18px;text-align:center;display:none;}
.ch-item.unread .unread-badge{display:block;}
.user-panel{padding:10px 8px;background:var(--bg-void);display:flex;align-items:center;gap:8px;border-top:1px solid var(--border);}
.user-avatar{width:32px;height:32px;border-radius:50%;position:relative;flex-shrink:0;}
.user-avatar img{width:100%;height:100%;border-radius:50%;object-fit:cover;}
.user-status-dot{position:absolute;bottom:-1px;right:-1px;width:10px;height:10px;border-radius:50%;background:var(--green);border:2px solid var(--bg-void);}
.user-status-dot.away{background:var(--yellow);}
.user-status-dot.busy{background:var(--red);}
.user-info{flex:1;min-width:0;}
.user-name{font-size:13px;font-weight:600;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.user-tag{font-size:11px;color:var(--text-3);font-family:var(--font-mono);}
.user-actions{display:flex;gap:2px;}
.user-action-btn{width:28px;height:28px;border:none;background:transparent;color:var(--text-3);border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all 0.15s;}
.user-action-btn:hover{background:var(--bg-hover);color:var(--text-1);}

/* â”€â”€â”€ CHAT â”€â”€â”€ */
.chat-area{flex:1;display:flex;flex-direction:column;min-width:0;background:var(--bg-mid);}
.chat-header{height:48px;padding:0 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0;background:var(--bg-mid);}
.chat-header-icon{font-size:18px;color:var(--text-3);}
.chat-header-name{font-size:16px;font-weight:700;}
.chat-header-sep{width:1px;height:20px;background:var(--border);margin:0 4px;}
.chat-header-topic{font-size:13px;color:var(--text-3);overflow:hidden;white-space:nowrap;text-overflow:ellipsis;flex:1;cursor:pointer;}
.chat-header-topic:hover{color:var(--text-2);}
.chat-header-actions{display:flex;gap:2px;margin-left:auto;}
.header-btn{width:32px;height:32px;border:none;background:transparent;color:var(--text-3);border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all 0.15s;}
.header-btn:hover{background:var(--bg-hover);color:var(--text-1);}
.header-btn.active{color:var(--accent);}

/* â”€â”€â”€ SEARCH â”€â”€â”€ */
.search-bar{padding:8px 16px;border-bottom:1px solid var(--border);background:var(--bg-mid);display:none;gap:8px;align-items:center;}
.search-bar.open{display:flex;}
.search-input{flex:1;padding:8px 12px;background:var(--bg-panel);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-1);font-family:var(--font-main);font-size:14px;outline:none;}
.search-input:focus{border-color:var(--accent);}
.search-input::placeholder{color:var(--text-muted);}
.search-scope{padding:6px 10px;background:var(--bg-dark);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-2);font-family:var(--font-main);font-size:13px;cursor:pointer;outline:none;}
.search-filters{display:flex;gap:6px;padding:6px 16px;border-bottom:1px solid var(--border);background:var(--bg-dark);display:none;flex-wrap:wrap;}
.search-filters.open{display:flex;}
.search-filter-input{padding:5px 10px;background:var(--bg-mid);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-1);font-family:var(--font-main);font-size:13px;outline:none;width:130px;}
.search-results{padding:8px 16px;border-bottom:1px solid var(--border);background:var(--bg-dark);display:none;flex-direction:column;gap:4px;max-height:200px;overflow-y:auto;}
.search-results.open{display:flex;}
.search-result-item{padding:8px;border-radius:6px;cursor:pointer;transition:background 0.15s;}
.search-result-item:hover{background:var(--bg-hover);}
.search-result-author{font-size:12px;font-weight:600;color:var(--accent);}
.search-result-content{font-size:13px;color:var(--text-2);overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.search-result-meta{font-size:11px;color:var(--text-3);}

/* â”€â”€â”€ MESSAGES â”€â”€â”€ */
.messages{flex:1;overflow-y:auto;padding:16px 0;display:flex;flex-direction:column;gap:2px;scroll-behavior:smooth;}
.messages::-webkit-scrollbar{width:4px;}
.messages::-webkit-scrollbar-thumb{background:var(--bg-hover);border-radius:2px;}
.msg{display:flex;gap:14px;padding:4px 16px;border-radius:4px;transition:background 0.1s;position:relative;animation:msgIn 0.2s ease-out;}
.msg.grouped{padding-top:1px;}
.msg.grouped .msg-avatar{visibility:hidden;}
.msg.grouped .msg-header{display:none;}
@keyframes msgIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.msg:hover{background:rgba(0,0,0,0.1);}
.msg.mention-highlight{background:rgba(250,166,26,0.08) !important;border-left:3px solid var(--yellow);padding-left:13px;}
.msg.thread-reply{border-left:3px solid var(--accent);padding-left:13px;background:rgba(88,101,242,0.04);}
.msg:hover .msg-actions{opacity:1;}
.msg-avatar{width:40px;height:40px;border-radius:50%;flex-shrink:0;cursor:pointer;margin-top:2px;}
.msg-avatar img{width:100%;height:100%;border-radius:50%;object-fit:cover;}
.msg-body{flex:1;min-width:0;}
.msg-header{display:flex;align-items:baseline;gap:8px;margin-bottom:3px;flex-wrap:wrap;}
.msg-author{font-size:15px;font-weight:600;color:var(--text-1);cursor:pointer;}
.msg-author:hover{text-decoration:underline;}
.msg-time{font-size:11px;color:var(--text-muted);font-family:var(--font-mono);}
.msg-edited{font-size:11px;color:var(--text-muted);font-style:italic;}
.msg-content{font-size:var(--font-size);color:var(--text-2);line-height:1.5;word-break:break-word;user-select:text;}
.mention{color:var(--accent);background:rgba(88,101,242,0.15);border-radius:3px;padding:0 2px;font-weight:600;}
.role-badge{font-size:10px;padding:1px 5px;border-radius:4px;font-weight:700;text-transform:uppercase;}
.role-badge.admin{background:rgba(237,66,69,0.2);color:var(--red);}
.role-badge.moderator{background:rgba(250,166,26,0.2);color:var(--yellow);}
.msg-thread-btn{font-size:12px;color:var(--accent);cursor:pointer;margin-top:4px;display:inline-block;}
.msg-thread-btn:hover{text-decoration:underline;}

/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
.msg-actions{position:absolute;top:-14px;right:16px;background:var(--bg-panel);border:1px solid var(--border);border-radius:8px;display:flex;gap:2px;padding:3px;opacity:0;transition:opacity 0.15s;z-index:10;box-shadow:0 4px 12px rgba(0,0,0,0.3);}
.msg-action-btn{width:28px;height:28px;border:none;background:transparent;color:var(--text-3);border-radius:5px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all 0.1s;}
.msg-action-btn:hover{background:var(--bg-hover);color:var(--text-1);}
.msg-action-btn.danger:hover{background:rgba(237,66,69,0.2);color:var(--red);}
.msg-edit-area{margin-top:6px;display:none;}
.msg-edit-area.active{display:block;}
.msg-edit-input{width:100%;padding:8px 12px;background:var(--bg-dark);border:1px solid var(--accent);border-radius:var(--radius);color:var(--text-1);font-family:var(--font-main);font-size:14px;outline:none;resize:none;}
.msg-edit-btns{display:flex;gap:6px;margin-top:6px;}
.edit-save-btn,.edit-cancel-btn{padding:5px 12px;border:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;}
.edit-save-btn{background:var(--accent);color:#fff;}
.edit-cancel-btn{background:var(--bg-hover);color:var(--text-2);}

/* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
.reactions{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px;}
.reaction-pill{display:inline-flex;align-items:center;gap:4px;background:var(--bg-panel);border:1px solid var(--border);border-radius:12px;padding:2px 8px;font-size:13px;cursor:pointer;transition:all 0.15s;user-select:none;}
.reaction-pill:hover{border-color:var(--accent);}
.reaction-pill.reacted{border-color:var(--accent);background:rgba(88,101,242,0.15);color:var(--accent);}
.reaction-count{font-size:12px;font-weight:600;color:var(--text-2);}

/* æœªèª­ãƒ‡ã‚£ãƒã‚¤ãƒ€ãƒ¼ */
.unread-divider{display:flex;align-items:center;gap:8px;padding:8px 16px;margin:4px 0;}
.unread-divider::before,.unread-divider::after{content:'';flex:1;height:1px;background:var(--red);}
.unread-divider-label{font-size:11px;font-weight:700;color:var(--red);white-space:nowrap;}

/* ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ç”»åƒ */
.file-attachment{display:inline-flex;align-items:center;gap:12px;background:var(--bg-panel);border:1px solid var(--border);border-radius:var(--radius);padding:12px 14px;margin-top:6px;max-width:420px;text-decoration:none;transition:border-color 0.2s;}
.file-attachment:hover{border-color:var(--accent);}
.file-icon{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.file-info{flex:1;min-width:0;}
.file-name{font-size:14px;font-weight:600;color:var(--text-1);overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.file-size{font-size:12px;color:var(--text-3);margin-top:2px;}
.img-preview{max-width:400px;max-height:300px;border-radius:var(--radius);margin-top:6px;cursor:zoom-in;display:block;border:1px solid var(--border);object-fit:cover;}

/* ã‚¿ã‚¤ãƒ”ãƒ³ã‚° */
.typing-bar{height:20px;padding:0 16px;font-size:13px;color:var(--text-3);display:flex;align-items:center;gap:6px;}
.typing-dots{display:flex;gap:3px;}
.typing-dot{width:5px;height:5px;border-radius:50%;background:var(--text-3);animation:typingBounce 1.2s infinite;}
.typing-dot:nth-child(2){animation-delay:0.2s;} .typing-dot:nth-child(3){animation-delay:0.4s;}
@keyframes typingBounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-4px)}}

/* å…¥åŠ›ãƒãƒ¼ */
.input-bar{padding:0 16px 16px;flex-shrink:0;}
.reply-preview{background:var(--bg-panel);border-left:3px solid var(--accent);padding:6px 12px;margin-bottom:6px;border-radius:4px;display:none;align-items:center;justify-content:space-between;gap:8px;}
.reply-preview.show{display:flex;}
.reply-preview-text{font-size:13px;color:var(--text-2);overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.reply-close-btn{background:none;border:none;color:var(--text-3);cursor:pointer;font-size:16px;flex-shrink:0;}
.input-box{background:var(--bg-panel);border:1px solid var(--border);border-radius:var(--radius-lg);display:flex;align-items:center;gap:6px;padding:6px 6px 6px 14px;transition:border-color 0.2s;}
.input-box:focus-within{border-color:rgba(88,101,242,0.5);}
.attach-btn,.emoji-btn{width:36px;height:36px;border:none;background:transparent;color:var(--text-3);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;transition:all 0.15s;}
.attach-btn:hover,.emoji-btn:hover{background:var(--bg-hover);color:var(--text-1);}
.msg-input{flex:1;border:none;background:transparent;color:var(--text-1);font-family:var(--font-main);font-size:var(--font-size);outline:none;resize:none;min-height:24px;max-height:200px;line-height:1.5;padding:4px 0;}
.msg-input::placeholder{color:var(--text-muted);}
.send-btn{width:36px;height:36px;border:none;background:var(--accent);color:#fff;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;transition:all 0.15s;box-shadow:0 2px 8px var(--accent-glow);}
.send-btn:hover{background:#4752c4;transform:scale(1.05);}
.send-btn:active{transform:scale(0.95);}
.input-hint{font-size:11px;color:var(--text-muted);padding:4px 6px 0;display:flex;gap:12px;}
kbd{background:var(--bg-panel);border:1px solid var(--border);border-radius:4px;padding:1px 5px;font-size:10px;}

/* çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ */
.emoji-picker{position:absolute;bottom:80px;left:16px;background:var(--bg-panel);border:1px solid var(--border);border-radius:var(--radius-lg);padding:12px;box-shadow:0 16px 40px rgba(0,0,0,0.4);z-index:500;display:none;width:320px;}
.emoji-picker.open{display:block;}
.emoji-categories{display:flex;gap:4px;margin-bottom:8px;overflow-x:auto;}
.emoji-cat-btn{padding:4px 6px;border:none;background:transparent;color:var(--text-3);border-radius:6px;cursor:pointer;font-size:16px;flex-shrink:0;transition:all 0.15s;}
.emoji-cat-btn:hover,.emoji-cat-btn.active{background:var(--bg-hover);color:var(--text-1);}
.emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:2px;max-height:200px;overflow-y:auto;}
.emoji-btn-item{width:32px;height:32px;border:none;background:transparent;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;transition:background 0.1s;}
.emoji-btn-item:hover{background:var(--bg-hover);}
.custom-emoji-img{width:24px;height:24px;object-fit:contain;}

/* ãƒ¡ãƒ³ãƒãƒ¼ãƒ‘ãƒãƒ« */
.members-panel{width:var(--members-w);background:var(--bg-dark);border-left:1px solid var(--border);overflow-y:auto;flex-shrink:0;}
.members-header{padding:16px;font-size:11px;font-weight:700;color:var(--text-3);text-transform:uppercase;letter-spacing:0.8px;}
.member-item{display:flex;align-items:center;gap:10px;padding:6px 12px;margin:1px 8px;border-radius:6px;cursor:pointer;transition:background 0.15s;}
.member-item:hover{background:var(--bg-hover);}
.member-avatar{width:32px;height:32px;border-radius:50%;position:relative;flex-shrink:0;}
.member-avatar img{width:100%;height:100%;border-radius:50%;object-fit:cover;}
.member-status-dot{position:absolute;bottom:-1px;right:-1px;width:10px;height:10px;border-radius:50%;border:2px solid var(--bg-dark);}
.member-status-dot.online{background:var(--green);}
.member-status-dot.away{background:var(--yellow);}
.member-status-dot.busy{background:var(--red);}
.member-name{font-size:13px;font-weight:500;color:var(--text-2);overflow:hidden;white-space:nowrap;flex:1;}
.member-name.muted-user{text-decoration:line-through;opacity:0.5;}
.member-badge{font-size:10px;padding:1px 4px;border-radius:4px;font-weight:700;}
.member-badge.admin{background:rgba(237,66,69,0.2);color:var(--red);}
.member-badge.moderator{background:rgba(250,166,26,0.2);color:var(--yellow);}
.member-badge.banned{background:rgba(237,66,69,0.15);color:var(--red);}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:2000;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--bg-panel);border:1px solid var(--border);border-radius:20px;width:560px;max-width:calc(100vw - 32px);max-height:85vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 32px 80px rgba(0,0,0,0.6);animation:cardIn 0.3s cubic-bezier(0.16,1,0.3,1);}
.modal.wide{width:700px;}
.modal-header{padding:20px 24px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.modal-title{font-size:18px;font-weight:700;}
.modal-close{width:32px;height:32px;border:none;background:transparent;color:var(--text-3);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;transition:all 0.15s;}
.modal-close:hover{background:var(--bg-hover);color:var(--text-1);}
.modal-body{padding:20px 24px;overflow-y:auto;display:flex;flex-direction:column;gap:20px;}
.modal-tabs{display:flex;gap:4px;border-bottom:1px solid var(--border);padding:0 24px;}
.modal-tab{padding:10px 16px;border:none;background:transparent;color:var(--text-3);font-family:var(--font-main);font-size:14px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all 0.15s;}
.modal-tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.modal-tab-pane{display:none;} .modal-tab-pane.active{display:block;}

/* è¨­å®šã‚¹ã‚¿ã‚¤ãƒ« */
.settings-section-title{font-size:11px;font-weight:700;color:var(--text-3);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:12px;}
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--bg-mid);border-radius:var(--radius);margin-bottom:8px;}
.settings-row-label{font-size:14px;font-weight:500;color:var(--text-1);}
.settings-row-desc{font-size:12px;color:var(--text-3);margin-top:2px;}
.toggle{width:44px;height:24px;background:var(--bg-hover);border-radius:12px;position:relative;cursor:pointer;transition:background 0.2s;flex-shrink:0;}
.toggle.on{background:var(--accent);}
.toggle::after{content:'';position:absolute;top:2px;left:2px;width:20px;height:20px;border-radius:50%;background:#fff;transition:transform 0.2s;box-shadow:0 2px 4px rgba(0,0,0,0.3);}
.toggle.on::after{transform:translateX(20px);}
.settings-select{padding:6px 10px;background:var(--bg-dark);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-1);font-family:var(--font-main);font-size:14px;cursor:pointer;outline:none;}
.theme-options{display:flex;gap:8px;}
.theme-opt{flex:1;padding:10px;border:2px solid var(--border);border-radius:var(--radius);cursor:pointer;text-align:center;font-size:13px;font-weight:500;transition:all 0.15s;background:var(--bg-mid);color:var(--text-2);}
.theme-opt:hover{border-color:var(--accent);}
.theme-opt.active{border-color:var(--accent);background:rgba(88,101,242,0.15);color:var(--accent);}
.font-slider{width:100%;accent-color:var(--accent);cursor:pointer;}
.danger-btn{padding:10px 16px;background:rgba(237,66,69,0.15);border:1px solid rgba(237,66,69,0.3);border-radius:var(--radius);color:var(--red);font-family:var(--font-main);font-size:14px;font-weight:600;cursor:pointer;width:100%;transition:all 0.2s;}
.danger-btn:hover{background:rgba(237,66,69,0.3);}
.primary-btn{padding:10px 16px;background:var(--accent);border:none;border-radius:var(--radius);color:#fff;font-family:var(--font-main);font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s;}
.primary-btn:hover{background:#4752c4;}
.secondary-btn{padding:8px 14px;background:var(--bg-hover);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-2);font-family:var(--font-main);font-size:13px;font-weight:500;cursor:pointer;transition:all 0.15s;}
.secondary-btn:hover{background:var(--bg-active);}
.tag-input-container{display:flex;flex-wrap:wrap;gap:6px;padding:8px;background:var(--bg-dark);border:1px solid var(--border);border-radius:var(--radius);min-height:44px;}
.keyword-tag{display:flex;align-items:center;gap:4px;background:rgba(88,101,242,0.2);color:var(--accent);padding:2px 8px;border-radius:12px;font-size:13px;}
.keyword-tag button{background:none;border:none;color:var(--accent);cursor:pointer;font-size:14px;line-height:1;}
.tag-input{border:none;background:transparent;color:var(--text-1);font-family:var(--font-main);font-size:14px;outline:none;min-width:80px;}

/* ãƒ”ãƒ³ãƒ»ç®¡ç†è€… */
.pin-item{display:flex;gap:12px;padding:12px;background:var(--bg-mid);border-radius:var(--radius);border:1px solid var(--border);}
.pin-item-body{flex:1;min-width:0;}
.pin-item-author{font-size:13px;font-weight:600;margin-bottom:2px;}
.pin-item-content{font-size:13px;color:var(--text-2);}
.pin-item-meta{font-size:11px;color:var(--text-3);margin-top:4px;}
.pin-unpin-btn{padding:4px 10px;border:none;background:rgba(237,66,69,0.15);color:var(--red);border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;}
.admin-user-row{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg-mid);border-radius:var(--radius);margin-bottom:6px;}
.admin-user-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;}
.admin-user-name{flex:1;font-size:14px;font-weight:500;}
.role-select{padding:5px 8px;background:var(--bg-dark);border:1px solid var(--border);border-radius:6px;color:var(--text-1);font-size:13px;cursor:pointer;}
.admin-action-btn{padding:5px 10px;border:none;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;}
.mute-btn{background:rgba(250,166,26,0.15);color:var(--yellow);}
.mute-btn:hover{background:rgba(250,166,26,0.3);}
.ban-btn{background:rgba(237,66,69,0.15);color:var(--red);}
.ban-btn:hover{background:rgba(237,66,69,0.3);}

/* ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ */
.bookmark-item{padding:12px;background:var(--bg-mid);border-radius:var(--radius);border:1px solid var(--border);cursor:pointer;transition:border-color 0.15s;}
.bookmark-item:hover{border-color:var(--accent);}
.bookmark-author{font-size:13px;font-weight:600;color:var(--accent);margin-bottom:4px;}
.bookmark-content{font-size:13px;color:var(--text-2);overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.bookmark-meta{font-size:11px;color:var(--text-3);margin-top:4px;display:flex;align-items:center;justify-content:space-between;}
.bookmark-remove-btn{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px;}
.bookmark-remove-btn:hover{color:var(--red);}

/* æ‹›å¾… */
.invite-row{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg-mid);border-radius:var(--radius);margin-bottom:6px;}
.invite-code{font-family:var(--font-mono);font-size:14px;font-weight:600;color:var(--accent);flex:1;}
.invite-meta{font-size:12px;color:var(--text-3);}
.invite-copy-btn{padding:4px 10px;border:none;background:var(--accent);color:#fff;border-radius:6px;font-size:12px;cursor:pointer;}

/* ãƒãƒ£ãƒ³ãƒãƒ«ç®¡ç† */
.ch-manage-row{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg-mid);border-radius:var(--radius);margin-bottom:6px;}
.ch-manage-name{flex:1;font-size:14px;font-weight:500;}
.ch-edit-btn{padding:4px 10px;border:none;background:var(--bg-hover);color:var(--text-2);border-radius:6px;font-size:12px;cursor:pointer;}
.ch-del-btn{padding:4px 10px;border:none;background:rgba(237,66,69,0.15);color:var(--red);border-radius:6px;font-size:12px;cursor:pointer;}

/* ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—ç®¡ç† */
.emoji-manage-row{display:flex;align-items:center;gap:10px;padding:8px;background:var(--bg-mid);border-radius:var(--radius);margin-bottom:6px;}
.emoji-manage-preview{width:32px;height:32px;object-fit:contain;}
.emoji-manage-name{flex:1;font-size:13px;font-family:var(--font-mono);}

/* ã‚»ãƒƒã‚·ãƒ§ãƒ³ */
.session-row{padding:10px;background:var(--bg-mid);border-radius:var(--radius);margin-bottom:6px;}
.session-ip{font-size:13px;font-weight:600;color:var(--text-1);}
.session-meta{font-size:12px;color:var(--text-3);margin-top:3px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}

/* ãƒˆãƒ¼ã‚¹ãƒˆ */
.upload-toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(10px);background:var(--bg-panel);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px 18px;display:flex;align-items:center;gap:12px;box-shadow:0 16px 40px rgba(0,0,0,0.5);z-index:2000;min-width:280px;opacity:0;transition:all 0.3s;pointer-events:none;}
.upload-toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.upload-spinner{width:20px;height:20px;border:2px solid var(--bg-hover);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0;}
@keyframes spin{to{transform:rotate(360deg)}}
.toast-notif{position:fixed;top:16px;right:16px;z-index:4000;background:var(--bg-panel);border:1px solid var(--border);border-radius:var(--radius-lg);padding:12px 16px;display:flex;align-items:center;gap:12px;box-shadow:0 8px 24px rgba(0,0,0,0.4);min-width:260px;max-width:360px;animation:toastIn 0.3s cubic-bezier(0.16,1,0.3,1);cursor:pointer;}
@keyframes toastIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
.toast-notif-icon{font-size:20px;flex-shrink:0;}
.toast-notif-body{flex:1;}
.toast-notif-title{font-size:13px;font-weight:600;}
.toast-notif-text{font-size:12px;color:var(--text-3);margin-top:2px;}

/* ãƒŸãƒ¥ãƒ¼ãƒˆãƒãƒŠãƒ¼ */
.muted-banner{background:rgba(250,166,26,0.1);border:1px solid rgba(250,166,26,0.3);border-radius:var(--radius);padding:10px 14px;font-size:13px;color:var(--yellow);display:none;margin:0 16px 8px;}
.muted-banner.show{display:block;}

/* DMæ—¢èª­ */
.dm-read-receipt{font-size:11px;color:var(--text-muted);text-align:right;margin-top:2px;}
.dm-read-receipt.read{color:var(--accent);}

/* ãã®ä»– */
.drop-overlay{display:none;position:fixed;inset:0;background:rgba(88,101,242,0.15);border:3px dashed var(--accent);border-radius:16px;margin:16px;z-index:999;align-items:center;justify-content:center;flex-direction:column;gap:16px;font-size:24px;color:var(--accent);backdrop-filter:blur(4px);}
.drop-overlay.active{display:flex;}
.lightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:3000;align-items:center;justify-content:center;cursor:zoom-out;backdrop-filter:blur(8px);}
.lightbox.open{display:flex;}
.lightbox img{max-width:90vw;max-height:90vh;border-radius:var(--radius);}
.welcome-msg{padding:32px 16px 16px;border-bottom:1px solid var(--border);margin-bottom:8px;}
.welcome-icon{width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:28px;margin-bottom:16px;}
.welcome-title{font-size:24px;font-weight:700;margin-bottom:6px;}
.welcome-sub{font-size:15px;color:var(--text-3);}
*{scrollbar-width:thin;scrollbar-color:var(--bg-hover) transparent;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

/* â”€â”€â”€ MOBILE â”€â”€â”€ */
.mobile-menu-btn,.mobile-members-btn{display:none;width:36px;height:36px;border:none;background:transparent;color:var(--text-2);border-radius:8px;cursor:pointer;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.drawer-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:200;backdrop-filter:blur(2px);}
.drawer-overlay.open{display:block;}
@media(max-width:900px){
  .members-panel{position:fixed;right:0;top:0;bottom:0;z-index:300;transform:translateX(100%);transition:transform 0.28s cubic-bezier(0.16,1,0.3,1);box-shadow:-8px 0 32px rgba(0,0,0,0.4);}
  .members-panel.open{transform:translateX(0);}
  .mobile-members-btn{display:flex;}
}
@media(max-width:640px){
  .server-list{display:none;}
  .sidebar{position:fixed;left:0;top:0;bottom:0;z-index:300;transform:translateX(-100%);transition:transform 0.28s cubic-bezier(0.16,1,0.3,1);box-shadow:8px 0 32px rgba(0,0,0,0.4);width:min(280px,85vw);}
  .sidebar.open{transform:translateX(0);}
  .mobile-menu-btn{display:flex;}
  .auth-card{width:calc(100vw - 32px);padding:28px 20px;border-radius:16px;}
  .chat-header{height:52px;padding:0 8px 0 4px;}
  .chat-header-sep,.chat-header-topic{display:none;}
  .messages{padding:8px 0;}
  .msg{padding:4px 8px;gap:10px;}
  .msg-avatar{width:34px;height:34px;}
  .msg-content{font-size:14px;}
  .msg-actions{position:static;opacity:1;background:transparent;border:none;box-shadow:none;padding:2px 0;margin-top:2px;margin-left:44px;}
  .msg:hover{background:transparent;}
  .img-preview{max-width:100%;max-height:240px;}
  .file-attachment{max-width:100%;}
  .input-bar{padding:0 8px calc(8px + env(safe-area-inset-bottom)) 8px;}
  .input-hint{display:none !important;}
  .msg-input{font-size:16px;}
  .emoji-picker{position:fixed;left:0;right:0;bottom:0;width:100%;border-radius:16px 16px 0 0;padding-bottom:env(safe-area-inset-bottom);z-index:600;}
  .modal{width:100vw;max-width:100vw;max-height:92vh;border-radius:20px 20px 0 0;position:fixed;bottom:0;left:0;right:0;}
  .modal-overlay{align-items:flex-end;}
  .members-panel{width:min(280px,85vw);}
  .toast-notif{right:8px;top:8px;max-width:calc(100vw - 16px);}
}
@media(max-width:360px){.emoji-grid{grid-template-columns:repeat(7,1fr);}}
@media(max-height:500px) and (max-width:900px){.modal{max-height:96vh;}.emoji-picker{max-height:180px;}}
</style>
</head>
<body>

<!-- AUTH -->
<div id="auth-screen">
  <div class="auth-bg"></div>
  <div class="auth-card">
    <div class="auth-logo"><div class="auth-logo-icon">âš¡</div><div class="auth-logo-text">NexusChat</div></div>
    <h1 class="auth-title">Welcome back</h1>
    <p class="auth-subtitle">Dive back into your conversations</p>
    <div class="tab-switcher">
      <button class="tab-btn active" onclick="switchTab('login')">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button class="tab-btn" onclick="switchTab('register')">æ–°è¦ç™»éŒ²</button>
    </div>
    <div id="login-form">
      <label class="field-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
      <input class="field-input" id="login-username" type="text" placeholder="username" autocomplete="username" />
      <label class="field-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input class="field-input" id="login-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
      <button class="auth-btn" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
    <div id="register-form" style="display:none">
      <label class="field-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼å <span style="color:var(--text-muted);text-transform:none;font-size:11px">(3ã€œ20æ–‡å­—ãƒ»è‹±æ•°å­—ãƒ»_ãƒ»-)</span></label>
      <input class="field-input" id="reg-username" type="text" placeholder="username" autocomplete="username" />
      <label class="field-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input class="field-input" id="reg-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password" />
      <div id="invite-code-field" style="display:none">
        <label class="field-label">æ‹›å¾…ã‚³ãƒ¼ãƒ‰</label>
        <input class="field-input" id="reg-invite" type="text" placeholder="XXXXXXXX" />
      </div>
      <button class="auth-btn" onclick="register()">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</button>
    </div>
    <div class="auth-error" id="auth-error"></div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="server-list">
    <div class="server-icon active" title="NexusChat">âš¡</div>
    <div class="server-sep"></div>
  </div>

  <div class="sidebar" id="sidebar">
    <div class="sidebar-header"><span>NexusChat</span></div>
    <div class="channels-section">
      <div class="ch-category">
        ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ£ãƒ³ãƒãƒ«
        <button class="ch-category-btn" id="add-channel-btn" onclick="openChannelCreate()" style="display:none" title="ãƒãƒ£ãƒ³ãƒãƒ«ã‚’ä½œæˆ">ï¼‹</button>
      </div>
      <div id="channel-list"></div>
      <div class="ch-category" style="margin-top:8px">
        ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        <button class="ch-category-btn" onclick="openDmSearch()" title="æ–°ã—ã„DM">ï¼‹</button>
      </div>
      <div id="dm-list"></div>
    </div>
    <div class="user-panel">
      <div class="user-avatar" onclick="openStatusMenu(event)" style="cursor:pointer">
        <img id="user-avatar-img" src="" alt="" />
        <div class="user-status-dot" id="user-status-dot"></div>
      </div>
      <div class="user-info">
        <div class="user-name" id="user-display-name">â€”</div>
        <div class="user-tag" id="user-role-tag" style="color:var(--text-3);font-size:11px"></div>
      </div>
      <div class="user-actions">
        <button class="user-action-btn" title="ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯" onclick="openBookmarks()">ğŸ”–</button>
        <button class="user-action-btn" title="ç®¡ç†è€…ãƒ‘ãƒãƒ«" id="admin-btn" onclick="openAdminPanel()" style="display:none">ğŸ‘‘</button>
        <button class="user-action-btn" title="è¨­å®š" onclick="openSettings()">âš™</button>
        <button class="user-action-btn" title="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ" onclick="openLogoutConfirm()">ğŸšª</button>
      </div>
    </div>
  </div>

  <div class="chat-area">
    <div class="chat-header">
      <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
      <span class="chat-header-icon" id="chat-header-icon">#</span>
      <span class="chat-header-name" id="chat-header-name">general</span>
      <div class="chat-header-sep" id="chat-header-sep"></div>
      <span class="chat-header-topic" id="chat-header-topic" onclick="openTopicEdit()" title="ãƒˆãƒ”ãƒƒã‚¯ã‚’ç·¨é›†">ã¿ã‚“ãªã®ãƒãƒ£ãƒ³ãƒãƒ«ã¸ã‚ˆã†ã“ãï¼</span>
      <div class="chat-header-actions">
        <button class="header-btn" onclick="toggleSearch()" id="search-btn" title="æ¤œç´¢">ğŸ”</button>
        <button class="header-btn" onclick="openPins()" title="ãƒ”ãƒ³ç•™ã‚">ğŸ“Œ</button>
        <button class="mobile-members-btn" onclick="toggleMembers()" title="ãƒ¡ãƒ³ãƒãƒ¼">ğŸ‘¥</button>
      </div>
    </div>

    <div class="search-bar" id="search-bar">
      <input class="search-input" id="search-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¤œç´¢..." oninput="debounceSearch(this.value)" />
      <select class="search-scope" id="search-scope">
        <option value="">å…¨ãƒãƒ£ãƒ³ãƒãƒ«</option>
        <option value="current">ã“ã®ãƒãƒ£ãƒ³ãƒãƒ«</option>
      </select>
      <button class="secondary-btn" onclick="toggleSearchFilters()" title="è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼">âš™</button>
    </div>
    <div class="search-filters" id="search-filters">
      <input class="search-filter-input" id="search-author" placeholder="æŠ•ç¨¿è€…" />
      <input class="search-filter-input" id="search-from-date" type="date" title="é–‹å§‹æ—¥" />
      <input class="search-filter-input" id="search-to-date" type="date" title="çµ‚äº†æ—¥" />
      <button class="secondary-btn" onclick="doSearch()">æ¤œç´¢</button>
    </div>
    <div class="search-results" id="search-results"></div>

    <div class="muted-banner" id="muted-banner">ğŸ”‡ ã‚ãªãŸã¯ãƒŸãƒ¥ãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã§ãã¾ã›ã‚“ã€‚</div>

    <div class="messages" id="messages">
      <div class="welcome-msg">
        <div class="welcome-icon">#</div>
        <div class="welcome-title" id="welcome-title">#general ã¸ã‚ˆã†ã“ãï¼</div>
        <div class="welcome-sub">ã“ã‚Œã¯ãƒãƒ£ãƒ³ãƒãƒ«ã®å§‹ã¾ã‚Šã§ã™ã€‚</div>
      </div>
    </div>

    <div class="typing-bar" id="typing-bar"></div>
    <div class="input-bar" style="position:relative" id="input-bar">
      <div class="reply-preview" id="reply-preview">
        <span class="reply-preview-text" id="reply-preview-text"></span>
        <button class="reply-close-btn" onclick="cancelReply()">âœ•</button>
      </div>
      <div class="emoji-picker" id="emoji-picker">
        <div class="emoji-categories" id="emoji-cats"></div>
        <div class="emoji-grid" id="emoji-grid"></div>
      </div>
      <div class="input-box">
        <button class="attach-btn" onclick="openFilePicker()">ğŸ“</button>
        <button class="emoji-btn" onclick="toggleEmojiPicker()">ğŸ˜Š</button>
        <textarea class="msg-input" id="msg-input" placeholder="#general ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡" rows="1"
          oninput="autoResize(this);emitTyping()" onkeydown="handleKey(event)"></textarea>
        <button class="send-btn" onclick="sendMessage()">â–¶</button>
      </div>
      <div class="input-hint">
        <span><kbd>Shift+Enter</kbd> æ”¹è¡Œ</span>
        <span><kbd>**å¤ªå­—**</kbd> <kbd>*æ–œä½“*</kbd> <kbd>`ã‚³ãƒ¼ãƒ‰`</kbd></span>
      </div>
    </div>
  </div>

  <div class="members-panel" id="members-panel">
    <div class="members-header">ãƒ¡ãƒ³ãƒãƒ¼ â€” <span id="online-count">0</span>å</div>
    <div id="members-list"></div>
  </div>
</div>

<div class="drawer-overlay" id="drawer-overlay" onclick="closeDrawers()"></div>
<div class="drop-overlay" id="drop-overlay">ğŸ“<div style="font-size:18px">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦é€ä¿¡</div></div>
<div class="lightbox" id="lightbox" onclick="closeLightbox()"><img id="lightbox-img" src="" /></div>
<div class="upload-toast" id="upload-toast"><div class="upload-spinner"></div><span id="upload-toast-text">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</span></div>

<!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div id="status-menu" style="display:none;position:fixed;background:var(--bg-panel);border:1px solid var(--border);border-radius:var(--radius-lg);padding:8px;box-shadow:0 8px 24px rgba(0,0,0,0.4);z-index:3000;min-width:160px;">
  <div onclick="setStatus('online')" style="padding:8px 12px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:14px;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''"><span style="width:10px;height:10px;border-radius:50%;background:var(--green);display:inline-block"></span>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</div>
  <div onclick="setStatus('away')" style="padding:8px 12px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:14px;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''"><span style="width:10px;height:10px;border-radius:50%;background:var(--yellow);display:inline-block"></span>é›¢å¸­ä¸­</div>
  <div onclick="setStatus('busy')" style="padding:8px 12px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:14px;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''"><span style="width:10px;height:10px;border-radius:50%;background:var(--red);display:inline-block"></span>å–ã‚Šè¾¼ã¿ä¸­</div>
</div>

<!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="settings-modal" onclick="closeModalOutside(event,'settings-modal')">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">âš™ è¨­å®š</div><button class="modal-close" onclick="closeModal('settings-modal')">âœ•</button></div>
    <div class="modal-tabs">
      <button class="modal-tab active" onclick="switchSettingsTab('appearance')">ğŸ¨ è¡¨ç¤º</button>
      <button class="modal-tab" onclick="switchSettingsTab('avatar')">ğŸ–¼ ã‚¢ãƒã‚¿ãƒ¼</button>
      <button class="modal-tab" onclick="switchSettingsTab('notifications')">ğŸ”” é€šçŸ¥</button>
      <button class="modal-tab" onclick="switchSettingsTab('account')">ğŸ‘¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</button>
    </div>
    <div class="modal-body">
      <!-- è¡¨ç¤ºã‚¿ãƒ– -->
      <div class="modal-tab-pane active" id="settings-tab-appearance">
        <div class="settings-section-title">ãƒ†ãƒ¼ãƒ</div>
        <div class="theme-options">
          <div class="theme-opt active" id="theme-dark" onclick="setTheme('dark')">ğŸŒ™ ãƒ€ãƒ¼ã‚¯</div>
          <div class="theme-opt" id="theme-light" onclick="setTheme('light')">â˜€ï¸ ãƒ©ã‚¤ãƒˆ</div>
        </div>
        <div class="settings-section-title" style="margin-top:16px">ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º</div>
        <div class="settings-row"><div class="settings-row-label">ã‚µã‚¤ã‚º: <span id="font-size-label">15px</span></div></div>
        <input type="range" class="font-slider" id="font-slider" min="12" max="20" value="15" oninput="setFontSize(this.value)" />
        <div class="settings-section-title" style="margin-top:16px">é€ä¿¡ã‚­ãƒ¼</div>
        <div class="settings-row">
          <div><div class="settings-row-label">é€ä¿¡ã‚­ãƒ¼</div><div class="settings-row-desc">Enterã§é€ä¿¡ / Shift+Enterã§æ”¹è¡Œ</div></div>
          <select class="settings-select" id="send-key-select" onchange="setSendKey(this.value)"><option value="enter">Enter</option><option value="ctrl">Ctrl+Enter</option></select>
        </div>
      </div>

      <!-- ã‚¢ãƒã‚¿ãƒ¼ã‚¿ãƒ– -->
      <div class="modal-tab-pane" id="settings-tab-avatar">
        <div class="settings-section-title">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px">
          <img id="settings-avatar-preview" src="" style="width:72px;height:72px;border-radius:50%;border:2px solid var(--border);object-fit:cover" />
          <div>
            <div style="font-size:14px;font-weight:600;margin-bottom:4px" id="settings-username-display">â€”</div>
            <div style="font-size:12px;color:var(--text-3)" id="settings-role-display">member</div>
          </div>
        </div>
        <div class="settings-section-title">ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é¸ã¶</div>
        <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px" id="avatar-style-btns"></div>
        <div class="settings-section-title">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
        <input type="file" id="avatar-file-input" accept="image/*" style="display:none" onchange="handleAvatarFileSelect(this.files)" />
        <button class="secondary-btn" style="width:100%;margin-bottom:12px" onclick="document.getElementById('avatar-file-input').click()">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
        <button class="primary-btn" style="width:100%" onclick="saveAvatar()">âœ“ ä¿å­˜ã™ã‚‹</button>
        <div id="avatar-save-msg" style="font-size:12px;color:var(--green);margin-top:8px;display:none">âœ“ ä¿å­˜ã—ã¾ã—ãŸ</div>
      </div>

      <!-- é€šçŸ¥ã‚¿ãƒ– -->
      <div class="modal-tab-pane" id="settings-tab-notifications">
        <div class="settings-section-title">é€šçŸ¥</div>
        <div class="settings-row"><div><div class="settings-row-label">é€šçŸ¥éŸ³</div></div><div class="toggle on" id="toggle-sound" onclick="toggleSetting('sound')"></div></div>
        <div class="settings-row"><div><div class="settings-row-label">ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥</div></div><div class="toggle" id="toggle-notif" onclick="requestNotifPermission()"></div></div>
        <div class="settings-row"><div><div class="settings-row-label">ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ™‚ã®ã¿</div></div><div class="toggle" id="toggle-mention-only" onclick="toggleSetting('mentionOnly')"></div></div>
        <div class="settings-section-title" style="margin-top:16px">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰é€šçŸ¥</div>
        <div class="settings-row-desc" style="margin-bottom:8px">æŒ‡å®šã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€šçŸ¥ã—ã¾ã™ï¼ˆæœ€å¤§20ä»¶ï¼‰</div>
        <div class="tag-input-container" id="keyword-tags-container">
          <input class="tag-input" id="keyword-input" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦Enter" onkeydown="handleKeywordInput(event)" />
        </div>
        <button class="primary-btn" style="width:100%;margin-top:12px" onclick="saveKeywords()">ğŸ’¾ ä¿å­˜ã™ã‚‹</button>
        <div id="keyword-save-msg" style="font-size:12px;color:var(--green);margin-top:8px;display:none">âœ“ ä¿å­˜ã—ã¾ã—ãŸ</div>
      </div>

      <!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¿ãƒ– -->
      <div class="modal-tab-pane" id="settings-tab-account">
        <div class="settings-section-title">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</div>
        <div class="settings-row"><div><div class="settings-row-label" id="settings-username">â€”</div><div class="settings-row-desc" id="settings-role">member</div></div></div>
        <div class="settings-section-title">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</div>
        <input class="search-input" id="pw-current" type="password" placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width:100%;margin-bottom:8px" />
        <input class="search-input" id="pw-new" type="password" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰" style="width:100%;margin-bottom:8px" />
        <button class="primary-btn" style="width:100%;margin-bottom:8px" onclick="changePassword()">ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´</button>
        <div id="pw-msg" style="font-size:12px;margin-bottom:12px;display:none"></div>
        <div class="settings-section-title">ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´</div>
        <div id="sessions-list" style="margin-bottom:16px"></div>
        <button class="secondary-btn" style="width:100%;margin-bottom:16px" onclick="loadSessions()">ğŸ“‹ å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€</button>
        <div class="settings-section-title">å±é™ºãªæ“ä½œ</div>
        <button class="danger-btn" style="margin-bottom:8px" onclick="openLogoutConfirm()">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <button class="danger-btn" onclick="openDeleteAccount()">ğŸ—‘ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤</button>
      </div>
    </div>
  </div>
</div>

<!-- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆç¢ºèª -->
<div class="modal-overlay" id="logout-confirm-modal" onclick="closeModalOutside(event,'logout-confirm-modal')">
  <div class="modal" style="max-width:360px">
    <div class="modal-header"><div class="modal-title">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</div><button class="modal-close" onclick="closeModal('logout-confirm-modal')">âœ•</button></div>
    <div class="modal-body">
      <p style="color:var(--text-2)">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ</p>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="danger-btn" style="flex:1" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <button class="secondary-btn" style="flex:1" onclick="closeModal('logout-confirm-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>
</div>

<!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ -->
<div class="modal-overlay" id="delete-account-modal" onclick="closeModalOutside(event,'delete-account-modal')">
  <div class="modal" style="max-width:400px">
    <div class="modal-header"><div class="modal-title" style="color:var(--red)">âš  ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤</div><button class="modal-close" onclick="closeModal('delete-account-modal')">âœ•</button></div>
    <div class="modal-body">
      <p style="color:var(--text-2);line-height:1.6">ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚ç¢ºèªã®ãŸã‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
      <input id="delete-account-pw" type="password" class="search-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width:100%;margin:12px 0" />
      <div id="delete-account-err" style="color:var(--red);font-size:13px;margin-bottom:8px;display:none"></div>
      <button class="danger-btn" onclick="confirmDeleteAccount()">å‰Šé™¤ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- ãƒ”ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="pins-modal" onclick="closeModalOutside(event,'pins-modal')">
  <div class="modal"><div class="modal-header"><div class="modal-title">ğŸ“Œ ãƒ”ãƒ³ç•™ã‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div><button class="modal-close" onclick="closeModal('pins-modal')">âœ•</button></div>
  <div class="modal-body"><div id="pins-list"></div></div></div>
</div>

<!-- ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="bookmarks-modal" onclick="closeModalOutside(event,'bookmarks-modal')">
  <div class="modal"><div class="modal-header"><div class="modal-title">ğŸ”– ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯</div><button class="modal-close" onclick="closeModal('bookmarks-modal')">âœ•</button></div>
  <div class="modal-body"><div id="bookmarks-list"></div></div></div>
</div>

<!-- DMã‚µãƒ¼ãƒ -->
<div class="modal-overlay" id="dm-search-modal" onclick="closeModalOutside(event,'dm-search-modal')">
  <div class="modal" style="max-width:400px">
    <div class="modal-header"><div class="modal-title">ğŸ’¬ ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div><button class="modal-close" onclick="closeModal('dm-search-modal')">âœ•</button></div>
    <div class="modal-body">
      <input class="search-input" id="dm-search-input" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§æ¤œç´¢..." oninput="renderDmSearchResults(this.value)" style="width:100%;margin-bottom:12px" />
      <div id="dm-search-results"></div>
    </div>
  </div>
</div>

<!-- ç®¡ç†è€…ãƒ‘ãƒãƒ« -->
<div class="modal-overlay" id="admin-modal" onclick="closeModalOutside(event,'admin-modal')">
  <div class="modal wide">
    <div class="modal-header"><div class="modal-title">ğŸ‘‘ ç®¡ç†è€…ãƒ‘ãƒãƒ«</div><button class="modal-close" onclick="closeModal('admin-modal')">âœ•</button></div>
    <div class="modal-tabs">
      <button class="modal-tab active" onclick="switchAdminTab('users')">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼</button>
      <button class="modal-tab" onclick="switchAdminTab('channels')">ğŸ“¢ ãƒãƒ£ãƒ³ãƒãƒ«</button>
      <button class="modal-tab" onclick="switchAdminTab('invites')">ğŸ”— æ‹›å¾…</button>
      <button class="modal-tab" onclick="switchAdminTab('emojis')">ğŸ˜€ çµµæ–‡å­—</button>
    </div>
    <div class="modal-body">
      <div class="modal-tab-pane active" id="admin-tab-users"><div id="admin-users-list"></div></div>
      <div class="modal-tab-pane" id="admin-tab-channels">
        <div style="display:flex;gap:8px;margin-bottom:12px">
          <input class="search-input" id="new-channel-name" placeholder="ãƒãƒ£ãƒ³ãƒãƒ«å (è‹±æ•°å­—)" style="flex:1" />
          <input class="search-input" id="new-channel-topic" placeholder="ãƒˆãƒ”ãƒƒã‚¯ï¼ˆä»»æ„ï¼‰" style="flex:1" />
          <button class="primary-btn" onclick="createChannel()">ä½œæˆ</button>
        </div>
        <div id="admin-channels-list"></div>
      </div>
      <div class="modal-tab-pane" id="admin-tab-invites">
        <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center">
          <select class="settings-select" id="invite-expires">
            <option value="">æœŸé™ãªã—</option>
            <option value="24">24æ™‚é–“</option>
            <option value="72">72æ™‚é–“</option>
            <option value="168">7æ—¥é–“</option>
          </select>
          <button class="primary-btn" onclick="createInvite()">æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ</button>
          <div id="invite-only-toggle" style="display:flex;align-items:center;gap:8px;margin-left:auto;font-size:13px;color:var(--text-2)">
            æ‹›å¾…åˆ¶
          </div>
        </div>
        <div id="admin-invites-list"></div>
      </div>
      <div class="modal-tab-pane" id="admin-tab-emojis">
        <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center;flex-wrap:wrap">
          <input class="search-input" id="new-emoji-name" placeholder="çµµæ–‡å­—å (è‹±å°æ–‡å­—ãƒ»æ•°å­—ãƒ»_)" style="flex:1;min-width:120px" />
          <input type="file" id="new-emoji-file" accept="image/*" style="display:none" onchange="uploadEmoji()" />
          <button class="primary-btn" onclick="document.getElementById('new-emoji-file').click()">ğŸ–¼ ç”»åƒã‚’é¸æŠã—ã¦è¿½åŠ </button>
        </div>
        <div id="admin-emojis-list"></div>
      </div>
    </div>
  </div>
</div>

<!-- ãƒãƒ£ãƒ³ãƒãƒ«ä½œæˆ/ç·¨é›† -->
<div class="modal-overlay" id="channel-edit-modal" onclick="closeModalOutside(event,'channel-edit-modal')">
  <div class="modal" style="max-width:420px">
    <div class="modal-header"><div class="modal-title" id="channel-edit-title">ãƒãƒ£ãƒ³ãƒãƒ«ã‚’ç·¨é›†</div><button class="modal-close" onclick="closeModal('channel-edit-modal')">âœ•</button></div>
    <div class="modal-body">
      <div class="settings-section-title">ãƒˆãƒ”ãƒƒã‚¯</div>
      <input class="search-input" id="edit-channel-topic" placeholder="ãƒãƒ£ãƒ³ãƒãƒ«ã®ãƒˆãƒ”ãƒƒã‚¯" style="width:100%;margin-bottom:12px" />
      <div class="settings-row">
        <div><div class="settings-row-label">èª­ã¿å–ã‚Šå°‚ç”¨</div><div class="settings-row-desc">ç®¡ç†è€…ãƒ»ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼ä»¥å¤–ã¯æŠ•ç¨¿ã§ãã¾ã›ã‚“</div></div>
        <div class="toggle" id="edit-channel-readonly" onclick="this.classList.toggle('on')"></div>
      </div>
      <button class="primary-btn" style="width:100%;margin-top:8px" onclick="saveChannelEdit()">ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>
</div>

</body>
<script>
// â•â•â•â• STATE â•â•â•â•
const API = '';
let token = localStorage.getItem('token');
let currentUser = null;
let socket = null;
let currentChannel = null;
let currentDmRoom  = null;
let openDmRooms    = JSON.parse(localStorage.getItem('nexus_dmRooms') || '[]');
let onlineUsersList = [];
let allMessages    = {};  // channelId â†’ []
let replyTarget    = null;  // { msgId, author, content }
let editingChannelId = null;
let pendingAvatar  = null;
let keywordTags    = [];
let customEmojiList = [];
let isMutedLocally = false;
let channelLoading = {};
let pendingSocketMsgs = {};
let joinGen = {};
let typingTimers = {};
let searchDebounce = null;
const bookmarkCache = new Set();

const settings = { theme:'dark', fontSize:15, sound:true, notif:false, mentionOnly:false, sendKey:'enter',
  ...JSON.parse(localStorage.getItem('nexus_settings') || '{}') };

// â•â•â•â• AUTH â•â•â•â•
async function login() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  if (!username || !password) return showAuthError('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  try {
    const r = await fetch(`${API}/api/login`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username, password}) });
    const d = await r.json();
    if (!r.ok) return showAuthError(d.error || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
    localStorage.setItem('token', d.token);
    token = d.token;
    currentUser = d.user;
    startApp();
  } catch(e) { showAuthError('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“'); }
}
async function register() {
  const username = document.getElementById('reg-username').value.trim();
  const password = document.getElementById('reg-password').value;
  const inviteCode = document.getElementById('reg-invite').value.trim();
  if (!username || !password) return showAuthError('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  try {
    const r = await fetch(`${API}/api/register`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username, password, inviteCode}) });
    const d = await r.json();
    if (!r.ok) {
      if (d.inviteRequired) document.getElementById('invite-code-field').style.display = '';
      return showAuthError(d.error || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    localStorage.setItem('token', d.token);
    token = d.token;
    currentUser = d.user;
    startApp();
  } catch(e) { showAuthError('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“'); }
}
function showAuthError(msg) { const el = document.getElementById('auth-error'); el.textContent = msg; el.classList.add('show'); }
function switchTab(tab) {
  document.getElementById('login-form').style.display = tab === 'login' ? '' : 'none';
  document.getElementById('register-form').style.display = tab === 'register' ? '' : 'none';
  document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.toggle('active', (i===0) === (tab==='login')));
  document.getElementById('auth-error').classList.remove('show');
}

// â•â•â•â• APP INIT â•â•â•â•
async function startApp() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').classList.add('visible');
  applySettings();
  await loadCurrentUser();
  initSocket();
  await loadChannels();
  renderDmList();
  initDragDrop();
  initMobile();
  document.addEventListener('click', () => document.getElementById('status-menu').style.display = 'none', true);
  // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  loadBookmarkCache();
}

async function loadCurrentUser() {
  try {
    const r = await fetch(`${API}/api/me`, { headers: { Authorization: `Bearer ${token}` } });
    if (r.ok) {
      currentUser = await r.json();
      keywordTags = currentUser.keywordNotifs || [];
    }
  } catch(e) {}
  document.getElementById('user-display-name').textContent = currentUser?.username || 'â€”';
  document.getElementById('user-avatar-img').src = currentUser?.avatar || '';
  document.getElementById('user-role-tag').textContent = currentUser?.role || '';
  if (currentUser?.role === 'admin') {
    document.getElementById('admin-btn').style.display = '';
    document.getElementById('add-channel-btn').style.display = '';
  }
}

// â•â•â•â• SOCKET â•â•â•â•
function initSocket() {
  socket = io({ auth: { token } });
  socket.on('connect', () => console.log('Socket connected'));
  socket.on('connect_error', (e) => { if (e.message === 'Authentication error') { logout(); } });
  socket.on('force_logout', ({ reason }) => { alert(reason); logout(); });
  socket.on('muted', () => { isMutedLocally = true; document.getElementById('muted-banner').classList.add('show'); });
  socket.on('unmuted', () => { isMutedLocally = false; document.getElementById('muted-banner').classList.remove('show'); });
  socket.on('error_msg', ({ msg }) => showToastNotif('âš ï¸', msg, null));

  socket.on('online_users', (users) => {
    onlineUsersList = users;
    renderMembers(users);
    document.getElementById('online-count').textContent = users.length;
  });

  socket.on('message', (msg) => {
    if (channelLoading[msg.channelId]) { (pendingSocketMsgs[msg.channelId] = pendingSocketMsgs[msg.channelId] || []).push(msg); return; }
    if (msg.channelId === currentChannel) { renderMessageToDom(msg, true); scrollToBottom(); }
    else { markUnread(msg.channelId); }
    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰é€šçŸ¥ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®keyword_matchã§ã‚‚æ¥ã‚‹ãŒå¿µã®ãŸã‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã‚‚ï¼‰
    if (msg.author !== currentUser?.username) checkKeywordNotif(msg);
  });

  socket.on('keyword_match', ({ keyword, msg, channelId }) => {
    showToastNotif('ğŸ”‘', `ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€Œ${keyword}ã€ã«ä¸€è‡´`, msg.content, () => joinChannel(channelId));
  });

  socket.on('message_edited', ({ msgId, channelId, content, editedAt }) => {
    const el = document.getElementById(`msg-${msgId}`);
    if (el) {
      el.querySelector('.msg-content').innerHTML = renderContent(content);
      let ed = el.querySelector('.msg-edited');
      if (!ed) { ed = document.createElement('span'); ed.className = 'msg-edited'; el.querySelector('.msg-header')?.appendChild(ed); }
      ed.textContent = ` (ç·¨é›†æ¸ˆ ${formatTime(editedAt)})`;
    }
  });

  socket.on('message_deleted', ({ msgId }) => {
    document.getElementById(`msg-${msgId}`)?.remove();
  });

  socket.on('pin_update', ({ channelId, pins }) => { if (channelId === currentChannel) {} });

  socket.on('reaction_update', ({ msgId, reactions }) => {
    const el = document.getElementById(`msg-${msgId}`);
    if (el) renderReactions(el, msgId, reactions, currentChannel || currentDmRoom);
  });

  socket.on('typing', ({ username, isTyping }) => {
    if (username === currentUser?.username) return;
    clearTimeout(typingTimers[username]);
    const bar = document.getElementById('typing-bar');
    if (isTyping) {
      typingTimers[username] = setTimeout(() => { delete typingTimers[username]; updateTypingBar(); }, 3000);
    } else { delete typingTimers[username]; }
    updateTypingBar();
  });

  socket.on('dm_message', (msg) => {
    const roomId = msg.channelId;
    if (currentDmRoom === roomId) { renderMessageToDom(msg, true); scrollToBottom(); markDmRead(msg); }
    else {
      const other = roomId.split('__').find(u => u !== currentUser?.username);
      showToastNotif('ğŸ’¬', other, msg.content, () => openDm(other));
      if (!openDmRooms.find(r => r.roomId === roomId)) {
        openDmRooms.push({ roomId, otherUser: other });
        localStorage.setItem('nexus_dmRooms', JSON.stringify(openDmRooms));
        renderDmList();
      }
    }
  });

  socket.on('dm_read_update', ({ roomId, msgId, readBy }) => {
    const el = document.querySelector(`#msg-${msgId} .dm-read-receipt`);
    if (el) { const other = roomId.split('__').find(u => u !== currentUser?.username); if (readBy.includes(other)) { el.textContent = 'âœ“âœ“ æ—¢èª­'; el.classList.add('read'); } }
  });

  socket.on('role_changed', ({ role }) => { currentUser.role = role; document.getElementById('user-role-tag').textContent = role; if (role === 'admin') { document.getElementById('admin-btn').style.display = ''; document.getElementById('add-channel-btn').style.display = ''; } });
  socket.on('user_role_updated', () => renderMembers(onlineUsersList));
  socket.on('user_avatar_updated', ({ username, avatar }) => {
    if (username === currentUser?.username) { currentUser.avatar = avatar; document.getElementById('user-avatar-img').src = avatar; }
    document.querySelectorAll('.msg').forEach(el => { if (el.querySelector('.msg-author')?.textContent === username) { const img = el.querySelector('.msg-avatar img'); if (img) img.src = avatar; } });
  });
  socket.on('user_banned', ({ username }) => { if (username === currentUser?.username) { alert('BANã•ã‚Œã¾ã—ãŸ'); logout(); } renderMembers(onlineUsersList); });
  socket.on('channel_updated', ({ action, channel, channelId }) => {
    if (action === 'created') { channels_state[channel.id] = channel; renderChannelList(); }
    else if (action === 'updated') { if (channels_state[channel.id]) Object.assign(channels_state[channel.id], channel); renderChannelList(); if (channel.id === currentChannel) { document.getElementById('chat-header-topic').textContent = channel.topic || ''; } }
    else if (action === 'deleted') { delete channels_state[channelId]; renderChannelList(); if (currentChannel === channelId) joinChannel('general'); }
  });
  socket.on('custom_emojis', (list) => { customEmojiList = list; });
  socket.on('custom_emoji_updated', ({ name, url }) => { const idx = customEmojiList.findIndex(e => e.name === name); if (idx >= 0) customEmojiList[idx].url = url; else customEmojiList.push({ name, url }); });
  socket.on('custom_emoji_deleted', ({ name }) => { customEmojiList = customEmojiList.filter(e => e.name !== name); });
}

// â•â•â•â• CHANNELS â•â•â•â•
let channels_state = {};
async function loadChannels() {
  const r = await fetch(`${API}/api/channels`, { headers: { Authorization: `Bearer ${token}` } });
  if (!r.ok) return;
  const list = await r.json();
  channels_state = {};
  list.forEach(ch => channels_state[ch.id] = ch);
  renderChannelList();
  const first = list[0]?.id || 'general';
  joinChannel(first);
}

function renderChannelList() {
  const list = document.getElementById('channel-list');
  list.innerHTML = Object.values(channels_state).map(ch => `
    <div class="ch-item${ch.id === currentChannel ? ' active' : ''}${unreadSet.has(ch.id) ? ' unread' : ''}" id="ch-item-${ch.id}" onclick="joinChannel('${ch.id}')">
      <span class="ch-icon">${ch.readonly ? 'ğŸ“¢' : '#'}</span>
      <span style="flex:1">${escHtml(ch.name)}</span>
      ${ch.readonly ? '<span class="ch-readonly-badge">RO</span>' : ''}
      <span class="unread-badge">â—</span>
    </div>`).join('');
}

const unreadSet = new Set();
function markUnread(channelId) {
  if (channelId === currentChannel) return;
  unreadSet.add(channelId);
  document.getElementById(`ch-item-${channelId}`)?.classList.add('unread');
}

async function joinChannel(channelId) {
  if (!channels_state[channelId] && channelId !== 'general') return;
  currentChannel = channelId;
  currentDmRoom  = null;
  unreadSet.delete(channelId);

  const gen = (joinGen[channelId] = (joinGen[channelId] || 0) + 1);
  const ch = channels_state[channelId] || { name: channelId, topic: '' };

  document.getElementById('chat-header-icon').textContent = ch.readonly ? 'ğŸ“¢' : '#';
  document.getElementById('chat-header-name').textContent = ch.name;
  document.getElementById('chat-header-topic').textContent = ch.topic || '';
  document.getElementById('msg-input').placeholder = `#${ch.name} ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡`;
  const _welcomeTitle = document.getElementById('welcome-title');
  if (_welcomeTitle) _welcomeTitle.textContent = `#${ch.name} ã¸ã‚ˆã†ã“ãï¼`;
  document.getElementById('chat-header-sep').style.display = ch.topic ? '' : 'none';
  document.getElementById('input-bar').style.display = '';

  renderChannelList();
  socket?.emit('join_channel', channelId);
  closeDrawers();

  channelLoading[channelId] = true;
  pendingSocketMsgs[channelId] = [];

  const msgEl = document.getElementById('messages');
  msgEl.innerHTML = `<div class="welcome-msg"><div class="welcome-icon">${ch.readonly ? 'ğŸ“¢' : '#'}</div><div class="welcome-title" id="welcome-title">#${escHtml(ch.name)} ã¸ã‚ˆã†ã“ãï¼</div><div class="welcome-sub">ã“ã‚Œã¯ãƒãƒ£ãƒ³ãƒãƒ«ã®å§‹ã¾ã‚Šã§ã™ã€‚</div></div>`;

  try {
    const r = await fetch(`${API}/api/channels/${channelId}/messages`, { headers: { Authorization: `Bearer ${token}` } });
    if (gen !== joinGen[channelId]) return;
    const messages = r.ok ? await r.json() : [];
    const serverIds = new Set(messages.map(m => m.id));
    const buffered = (pendingSocketMsgs[channelId] || []).filter(m => !serverIds.has(m.id));
    const allMsgs = [...messages, ...buffered].sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
    allMessages[channelId] = allMsgs;
    msgEl.innerHTML = `<div class="welcome-msg"><div class="welcome-icon">${ch.readonly ? 'ğŸ“¢' : '#'}</div><div class="welcome-title">#${escHtml(ch.name)} ã¸ã‚ˆã†ã“ãï¼</div><div class="welcome-sub">ã“ã‚Œã¯ãƒãƒ£ãƒ³ãƒãƒ«ã®å§‹ã¾ã‚Šã§ã™ã€‚</div></div>`;
    let prevMsg = null;
    allMsgs.forEach(m => { renderMessageToDom(m, false, prevMsg); prevMsg = m; });
    scrollToBottom();
  } finally {
    channelLoading[channelId] = false;
    pendingSocketMsgs[channelId] = [];
  }
}

// â•â•â•â• MESSAGE RENDER â•â•â•â•
function renderMessageToDom(msg, append = false, prevMsg = null) {
  const msgEl = document.getElementById('messages');
  const memberData = (window._allMembers || []).find(m => m.username === msg.author);
  const avatar = memberData?.avatar || `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(msg.author)}`;

  if (msg.type === 'system') return;

  // ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°: åŒã˜è‘—è€…ã®é€£ç¶šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  let grouped = false;
  if (prevMsg === null && append) {
    const lastEl = msgEl.lastElementChild;
    if (lastEl?.dataset.author === msg.author && lastEl?.dataset.type !== 'system') {
      const lastTs = new Date(lastEl.dataset.timestamp).getTime();
      if (Date.now() - lastTs < 5 * 60000) grouped = true;
    }
  } else if (prevMsg && prevMsg.author === msg.author) {
    const diff = new Date(msg.timestamp) - new Date(prevMsg.timestamp);
    if (diff < 5 * 60000) grouped = true;
  }

  const isOwn = msg.author === currentUser?.username;
  const isMention = msg.content && currentUser && msg.content.includes('@' + currentUser.username);
  const isThread = msg.threadOf;
  const canEdit = isOwn;
  const canDel = isOwn || ['admin','moderator'].includes(currentUser?.role);
  const canPin = ['admin','moderator'].includes(currentUser?.role) && currentChannel;
  const isBm = bookmarkCache.has(msg.id);

  const el = document.createElement('div');
  el.className = `msg${grouped ? ' grouped' : ''}${isMention ? ' mention-highlight' : ''}${isThread ? ' thread-reply' : ''}`;
  el.id = `msg-${msg.id}`;
  el.dataset.author = msg.author;
  el.dataset.timestamp = msg.timestamp;
  el.dataset.type = msg.type;

  let contentHtml = '';
  if (msg.type === 'file' && msg.fileInfo) {
    const fi = msg.fileInfo;
    const isImage = fi.mimetype?.startsWith('image/') || /\.(png|jpe?g|gif|webp)$/i.test(fi.filename || '');
    if (isImage) {
      contentHtml = `<img class="img-preview" src="${escHtml(fi.url)}" alt="${escHtml(fi.filename)}" onclick="openLightbox('${escHtml(fi.url)}')" loading="lazy" />`;
    } else {
      contentHtml = `<a class="file-attachment" href="${escHtml(fi.url)}" target="_blank" download="${escHtml(fi.filename)}">
        <div class="file-icon">ğŸ“</div>
        <div class="file-info"><div class="file-name">${escHtml(fi.filename)}</div><div class="file-size">${formatBytes(fi.size)}</div></div>
      </a>`;
    }
  } else {
    contentHtml = renderContent(msg.content || '');
  }

  const threadInfo = msg.threadOf ? `<div style="font-size:12px;color:var(--text-3);margin-bottom:3px">â†© ã‚¹ãƒ¬ãƒƒãƒ‰è¿”ä¿¡</div>` : '';

  el.innerHTML = `
    <div class="msg-avatar"><img src="${escHtml(avatar)}" alt="${escHtml(msg.author)}" onclick="openDm('${escHtml(msg.author)}')" loading="lazy" /></div>
    <div class="msg-body">
      <div class="msg-header">
        <span class="msg-author" onclick="openDm('${escHtml(msg.author)}')">${escHtml(msg.author)}</span>
        <span class="msg-time">${formatTime(msg.timestamp)}</span>
        ${msg.edited ? `<span class="msg-edited">(ç·¨é›†æ¸ˆ)</span>` : ''}
      </div>
      ${threadInfo}
      <div class="msg-content">${contentHtml}</div>
      ${msg.type === 'text' ? `<div class="msg-edit-area"><textarea class="msg-edit-input" rows="1">${escHtml(msg.content||'')}</textarea><div class="msg-edit-btns"><button class="edit-save-btn" onclick="saveEdit('${msg.id}','${escHtml(currentChannel||currentDmRoom)}')">ä¿å­˜</button><button class="edit-cancel-btn" onclick="cancelEdit('${msg.id}')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div></div>` : ''}
      <div class="reactions" id="reactions-${msg.id}"></div>
      ${msg.isDM ? `<div class="dm-read-receipt" id="dr-${msg.id}"></div>` : ''}
    </div>
    <div class="msg-actions">
      ${msg.type === 'text' ? `<button class="msg-action-btn" title="è¿”ä¿¡" onclick="startReply('${msg.id}','${escHtml(msg.author)}','${escHtml((msg.content||'').replace(/'/g,"\\'"))}')">â†©</button>` : ''}
      <button class="msg-action-btn" title="ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³" onclick="toggleReactionPicker('${msg.id}')">ğŸ˜Š</button>
      <button class="msg-action-btn" title="${isBm ? 'ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯è§£é™¤' : 'ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯'}" id="bm-btn-${msg.id}" onclick="toggleBookmark('${msg.id}','${escHtml(msg.author)}','${escHtml((msg.content||'').substring(0,100).replace(/'/g,"\\'"))}','${msg.timestamp}')">${isBm ? 'ğŸ”–' : 'ğŸ·'}</button>
      ${canEdit && msg.type === 'text' ? `<button class="msg-action-btn" title="ç·¨é›†" onclick="startEdit('${msg.id}')">âœ</button>` : ''}
      ${canPin ? `<button class="msg-action-btn" title="ãƒ”ãƒ³ç•™ã‚" onclick="pinMessage('${msg.id}')">ğŸ“Œ</button>` : ''}
      ${canDel ? `<button class="msg-action-btn danger" title="å‰Šé™¤" onclick="deleteMessage('${msg.id}','${escHtml(currentChannel||currentDmRoom)}')">ğŸ—‘</button>` : ''}
    </div>`;

  if (msg.reactions && Object.keys(msg.reactions).length > 0) renderReactions(el, msg.id, msg.reactions, currentChannel || currentDmRoom);

  if (append) msgEl.appendChild(el);
  else msgEl.appendChild(el);
}

function renderReactions(el, msgId, reactions, channelId) {
  const container = el.querySelector ? el.querySelector(`#reactions-${msgId}`) : document.getElementById(`reactions-${msgId}`);
  if (!container) return;
  container.innerHTML = Object.entries(reactions).map(([emoji, users]) => {
    const reacted = users.includes(currentUser?.username);
    return `<span class="reaction-pill${reacted ? ' reacted' : ''}" onclick="socket.emit('add_reaction',{msgId:'${msgId}',emoji:'${escHtml(emoji)}',channelId:'${escHtml(channelId)}'})">
      ${emoji} <span class="reaction-count">${users.length}</span>
    </span>`;
  }).join('');
}

// â•â•â•â• SEND â•â•â•â•
function sendMessage() {
  const input = document.getElementById('msg-input');
  const content = input.value.trim();
  if (!content) return;
  if (isMutedLocally) return;

  if (currentDmRoom) {
    const other = currentDmRoom.split('__').find(u => u !== currentUser?.username);
    socket.emit('send_dm', { toUsername: other, content });
  } else if (currentChannel) {
    socket.emit('send_message', { channelId: currentChannel, content, threadOf: replyTarget?.msgId || null });
  }
  input.value = '';
  input.style.height = '24px';
  cancelReply();
}

function startReply(msgId, author, content) {
  replyTarget = { msgId, author, content };
  const prev = document.getElementById('reply-preview');
  prev.classList.add('show');
  document.getElementById('reply-preview-text').textContent = `${author}: ${content}`;
  document.getElementById('msg-input').focus();
}
function cancelReply() { replyTarget = null; document.getElementById('reply-preview').classList.remove('show'); }

function deleteMessage(msgId, channelId) {
  socket.emit('delete_message', { msgId, channelId });
}

function startEdit(msgId) {
  const el = document.getElementById(`msg-${msgId}`);
  if (!el) return;
  el.querySelector('.msg-content').style.display = 'none';
  const area = el.querySelector('.msg-edit-area');
  if (area) { area.classList.add('active'); const ta = area.querySelector('textarea'); autoResize(ta); ta.focus(); }
}
function cancelEdit(msgId) {
  const el = document.getElementById(`msg-${msgId}`);
  if (!el) return;
  el.querySelector('.msg-content').style.display = '';
  el.querySelector('.msg-edit-area')?.classList.remove('active');
}
function saveEdit(msgId, channelId) {
  const el = document.getElementById(`msg-${msgId}`);
  const content = el?.querySelector('.msg-edit-input')?.value.trim();
  if (!content) return;
  socket.emit('edit_message', { msgId, channelId, content });
  cancelEdit(msgId);
}

function pinMessage(msgId) { socket.emit('pin_message', { msgId, channelId: currentChannel }); }

// â•â•â•â• REPLY REACTION PICKER â•â•â•â•
let reactionPickerOpen = null;
function toggleReactionPicker(msgId) {
  if (reactionPickerOpen === msgId) { closeReactionPicker(); return; }
  closeReactionPicker();
  const el = document.getElementById(`msg-${msgId}`);
  if (!el) return;
  const picker = document.createElement('div');
  picker.id = 'reaction-quick-picker';
  picker.style.cssText = 'position:absolute;background:var(--bg-panel);border:1px solid var(--border);border-radius:12px;padding:8px;display:flex;flex-wrap:wrap;gap:4px;z-index:100;box-shadow:0 8px 24px rgba(0,0,0,0.4);';
  const quickEmojis = ['ğŸ‘','â¤ï¸','ğŸ˜‚','ğŸ˜®','ğŸ˜¢','ğŸ”¥','âœ…','ğŸ‰','ğŸ‘€','ğŸ™'];
  quickEmojis.forEach(e => {
    const btn = document.createElement('button');
    btn.textContent = e;
    btn.style.cssText = 'border:none;background:none;font-size:20px;cursor:pointer;padding:4px;border-radius:8px;transition:background 0.1s;';
    btn.onclick = () => { socket.emit('add_reaction', { msgId, emoji: e, channelId: currentChannel || currentDmRoom }); closeReactionPicker(); };
    picker.appendChild(btn);
  });
  el.style.position = 'relative';
  el.appendChild(picker);
  reactionPickerOpen = msgId;
  setTimeout(() => document.addEventListener('click', closeReactionPicker, { once: true }), 0);
}
function closeReactionPicker() { document.getElementById('reaction-quick-picker')?.remove(); reactionPickerOpen = null; }

// â•â•â•â• DM â•â•â•â•
let dmAllMessages = {};
function renderDmList() {
  const list = document.getElementById('dm-list');
  list.innerHTML = openDmRooms.map(({ roomId, otherUser }) => `
    <div class="ch-item${currentDmRoom === roomId ? ' active' : ''}" onclick="openDm('${escHtml(otherUser)}')">
      <span class="ch-icon">@</span><span>${escHtml(otherUser)}</span>
    </div>`).join('');
}

async function openDm(username) {
  if (username === currentUser?.username) return;
  closeModal('dm-search-modal');
  const roomId = [currentUser.username, username].sort().join('__');
  currentDmRoom = roomId;
  currentChannel = null;
  if (!openDmRooms.find(r => r.roomId === roomId)) {
    openDmRooms.push({ roomId, otherUser: username });
    localStorage.setItem('nexus_dmRooms', JSON.stringify(openDmRooms));
  }
  renderDmList();

  document.getElementById('chat-header-icon').textContent = '@';
  document.getElementById('chat-header-name').textContent = username;
  document.getElementById('chat-header-topic').textContent = 'ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸';
  document.getElementById('msg-input').placeholder = `${username} ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡`;
  document.getElementById('input-bar').style.display = '';
  closeDrawers();

  const msgEl = document.getElementById('messages');
  msgEl.innerHTML = '';
  const r = await fetch(`${API}/api/dm/${roomId}`, { headers: { Authorization: `Bearer ${token}` } });
  if (r.ok) {
    const msgs = await r.json();
    msgs.forEach(m => renderMessageToDom(m, true));
    // æœªèª­ã‚’æ—¢èª­ã«ã™ã‚‹
    if (msgs.length) markDmRead(msgs[msgs.length - 1]);
  }
  scrollToBottom();
}

function markDmRead(msg) {
  if (msg.author !== currentUser?.username) socket.emit('dm_read', { roomId: msg.channelId, msgId: msg.id });
}

function openDmSearch() {
  document.getElementById('dm-search-input').value = '';
  renderDmSearchResults('');
  openModal('dm-search-modal');
}

async function renderDmSearchResults(q) {
  const container = document.getElementById('dm-search-results');
  if (!window._allMembers) {
    const r = await fetch(`${API}/api/members`, { headers: { Authorization: `Bearer ${token}` } });
    if (r.ok) window._allMembers = await r.json();
  }
  const users = (window._allMembers || []).filter(u => u.username !== currentUser?.username && (!q || u.username.toLowerCase().includes(q.toLowerCase())));
  container.innerHTML = users.map(u => `
    <div class="member-item" onclick="openDm('${escHtml(u.username)}')">
      <div class="member-avatar"><img src="${escHtml(u.avatar)}" /></div>
      <span class="member-name">${escHtml(u.username)}</span>
      <span class="member-badge ${u.role}">${u.role !== 'member' ? u.role : ''}</span>
    </div>`).join('');
}

// â•â•â•â• MEMBERS â•â•â•â•
async function renderMembers(users) {
  // ãƒ•ãƒ«ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚‚å«ã‚€ï¼‰
  if (!window._allMembers) {
    const r = await fetch(`${API}/api/members`, { headers: { Authorization: `Bearer ${token}` } });
    if (r.ok) window._allMembers = await r.json();
  }
  const all = window._allMembers || [];
  const onlineNames = new Set(users.map(u => u.username));
  const statusMap = {};
  users.forEach(u => statusMap[u.username] = u.status || 'online');

  const online = all.filter(u => onlineNames.has(u.username));
  const offline = all.filter(u => !onlineNames.has(u.username));

  const renderUser = (u) => {
    const status = statusMap[u.username] || 'offline';
    return `<div class="member-item" onclick="openDm('${escHtml(u.username)}')">
      <div class="member-avatar">
        <img src="${escHtml(u.avatar)}" alt="${escHtml(u.username)}" />
        <div class="member-status-dot ${status}"></div>
      </div>
      <span class="member-name${u.muted ? ' muted-user' : ''}">${escHtml(u.username)}</span>
      ${u.role !== 'member' ? `<span class="member-badge ${u.role}">${u.role}</span>` : ''}
      ${u.banned ? `<span class="member-badge banned">BAN</span>` : ''}
    </div>`;
  };

  const list = document.getElementById('members-list');
  list.innerHTML =
    (online.length ? `<div style="padding:4px 16px;font-size:11px;color:var(--text-3);font-weight:700;text-transform:uppercase">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ â€” ${online.length}</div>${online.map(renderUser).join('')}` : '') +
    (offline.length ? `<div style="padding:12px 16px 4px;font-size:11px;color:var(--text-3);font-weight:700;text-transform:uppercase">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ â€” ${offline.length}</div>${offline.map(renderUser).join('')}` : '');
}

// â•â•â•â• TYPING â•â•â•â•
let typingTimeout = null;
let isTyping = false;
function emitTyping() {
  if (!currentChannel) return;
  if (!isTyping) { isTyping = true; socket.emit('typing', { channelId: currentChannel, isTyping: true }); }
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => { isTyping = false; socket.emit('typing', { channelId: currentChannel, isTyping: false }); }, 2000);
}
function updateTypingBar() {
  const names = Object.keys(typingTimers);
  const bar = document.getElementById('typing-bar');
  if (!names.length) { bar.innerHTML = ''; return; }
  bar.innerHTML = `<div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div> ${escHtml(names.join(', '))} ãŒå…¥åŠ›ä¸­...`;
}

// â•â•â•â• SEARCH â•â•â•â•
function toggleSearch() {
  const bar = document.getElementById('search-bar');
  bar.classList.toggle('open');
  if (bar.classList.contains('open')) document.getElementById('search-input').focus();
  else { document.getElementById('search-results').classList.remove('open'); document.getElementById('search-filters').classList.remove('open'); }
  document.getElementById('search-btn').classList.toggle('active', bar.classList.contains('open'));
}
function toggleSearchFilters() { document.getElementById('search-filters').classList.toggle('open'); }
function debounceSearch(q) { clearTimeout(searchDebounce); searchDebounce = setTimeout(() => doSearch(), 400); }
async function doSearch() {
  const q = document.getElementById('search-input').value.trim();
  if (q.length < 2) { document.getElementById('search-results').classList.remove('open'); return; }
  const scope = document.getElementById('search-scope').value;
  const author = document.getElementById('search-author')?.value.trim() || '';
  const from   = document.getElementById('search-from-date')?.value || '';
  const to     = document.getElementById('search-to-date')?.value || '';
  let url = `${API}/api/search?q=${encodeURIComponent(q)}`;
  if (scope === 'current' && currentChannel) url += `&channel=${currentChannel}`;
  if (author) url += `&author=${encodeURIComponent(author)}`;
  if (from)   url += `&from=${from}T00:00:00.000Z`;
  if (to)     url += `&to=${to}T23:59:59.999Z`;
  const r = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
  if (!r.ok) return;
  const results = await r.json();
  const container = document.getElementById('search-results');
  container.innerHTML = results.length ? results.map(m => `
    <div class="search-result-item" onclick="jumpToMsg('${m.id}','${m.channelId}')">
      <div class="search-result-author">${escHtml(m.author)} <span style="color:var(--text-3);font-weight:400">in #${escHtml(m.channelId)}</span></div>
      <div class="search-result-content">${escHtml((m.content||'').substring(0,100))}</div>
      <div class="search-result-meta">${formatTime(m.timestamp)}</div>
    </div>`).join('') : '<div style="padding:12px;color:var(--text-3);font-size:13px">çµæœãªã—</div>';
  container.classList.add('open');
}
async function jumpToMsg(msgId, channelId) {
  if (channelId !== currentChannel) await joinChannel(channelId);
  setTimeout(() => {
    const el = document.getElementById(`msg-${msgId}`);
    if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); el.style.background = 'rgba(88,101,242,0.2)'; setTimeout(() => el.style.background = '', 2000); }
  }, 300);
}

// â•â•â•â• PINS â•â•â•â•
async function openPins() {
  if (!currentChannel) return;
  const r = await fetch(`${API}/api/channels/${currentChannel}/pins`, { headers: { Authorization: `Bearer ${token}` } });
  const pins = r.ok ? await r.json() : [];
  const list = document.getElementById('pins-list');
  if (!pins.length) { list.innerHTML = '<p style="color:var(--text-3)">ãƒ”ãƒ³ç•™ã‚ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“</p>'; }
  else list.innerHTML = pins.map(p => `
    <div class="pin-item">
      <div class="pin-item-body">
        <div class="pin-item-author">${escHtml(p.author)}</div>
        <div class="pin-item-content">${escHtml((p.content||'').substring(0,200))}</div>
        <div class="pin-item-meta">${formatTime(p.timestamp)} â€¢ ãƒ”ãƒ³ç•™ã‚ by ${escHtml(p.pinnedBy||'')}</div>
      </div>
      ${['admin','moderator'].includes(currentUser?.role) ? `<button class="pin-unpin-btn" onclick="unpinMessage('${p.id}')">è§£é™¤</button>` : ''}
    </div>`).join('');
  openModal('pins-modal');
}
function unpinMessage(msgId) { socket.emit('unpin_message', { msgId, channelId: currentChannel }); openPins(); }

// â•â•â•â• BOOKMARKS â•â•â•â•
async function loadBookmarkCache() {
  const r = await fetch(`${API}/api/bookmarks`, { headers: { Authorization: `Bearer ${token}` } });
  if (r.ok) { const list = await r.json(); list.forEach(b => bookmarkCache.add(b.msgId)); }
}
async function toggleBookmark(msgId, author, content, timestamp) {
  const btn = document.getElementById(`bm-btn-${msgId}`);
  if (bookmarkCache.has(msgId)) {
    await fetch(`${API}/api/bookmarks/${msgId}`, { method:'DELETE', headers: { Authorization: `Bearer ${token}` } });
    bookmarkCache.delete(msgId);
    if (btn) btn.textContent = 'ğŸ·';
  } else {
    await fetch(`${API}/api/bookmarks`, { method:'POST', headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`}, body: JSON.stringify({ msgId, channelId: currentChannel, content, author, timestamp }) });
    bookmarkCache.add(msgId);
    if (btn) btn.textContent = 'ğŸ”–';
  }
}
async function openBookmarks() {
  const r = await fetch(`${API}/api/bookmarks`, { headers: { Authorization: `Bearer ${token}` } });
  const list = r.ok ? await r.json() : [];
  const container = document.getElementById('bookmarks-list');
  if (!list.length) { container.innerHTML = '<p style="color:var(--text-3)">ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</p>'; }
  else container.innerHTML = list.map(b => `
    <div class="bookmark-item" onclick="jumpToMsg('${b.msgId}','${b.channelId}');closeModal('bookmarks-modal')">
      <div class="bookmark-author">${escHtml(b.author)} <span style="color:var(--text-3);font-weight:400">in #${escHtml(b.channelId||'')}</span></div>
      <div class="bookmark-content">${escHtml((b.content||'').substring(0,120))}</div>
      <div class="bookmark-meta">
        <span>${formatTime(b.timestamp)}</span>
        <button class="bookmark-remove-btn" onclick="event.stopPropagation();removeBookmark('${b.msgId}',this.closest('.bookmark-item'))">âœ•</button>
      </div>
    </div>`).join('');
  openModal('bookmarks-modal');
}
async function removeBookmark(msgId, el) {
  await fetch(`${API}/api/bookmarks/${msgId}`, { method:'DELETE', headers: { Authorization: `Bearer ${token}` } });
  bookmarkCache.delete(msgId);
  el?.remove();
  document.getElementById(`bm-btn-${msgId}`)?.setAttribute('textContent', 'ğŸ·');
}

// â•â•â•â• STATUS â•â•â•â•
function openStatusMenu(e) {
  e.stopPropagation();
  const menu = document.getElementById('status-menu');
  const rect = e.currentTarget.getBoundingClientRect();
  menu.style.left = rect.left + 'px';
  menu.style.bottom = (window.innerHeight - rect.top + 8) + 'px';
  menu.style.display = 'block';
}
function setStatus(status) {
  socket?.emit('set_status', status);
  const dot = document.getElementById('user-status-dot');
  dot.className = `user-status-dot ${status}`;
  document.getElementById('status-menu').style.display = 'none';
}

// â•â•â•â• KEYWORDS â•â•â•â•
function handleKeywordInput(e) {
  if (e.key === 'Enter' || e.key === ',') {
    e.preventDefault();
    const val = document.getElementById('keyword-input').value.trim().toLowerCase();
    if (val && !keywordTags.includes(val) && keywordTags.length < 20) {
      keywordTags.push(val);
      renderKeywordTags();
      document.getElementById('keyword-input').value = '';
    }
  }
}
function renderKeywordTags() {
  const container = document.getElementById('keyword-tags-container');
  const input = document.getElementById('keyword-input');
  container.innerHTML = '';
  keywordTags.forEach((kw, i) => {
    const tag = document.createElement('span');
    tag.className = 'keyword-tag';
    tag.innerHTML = `${escHtml(kw)}<button onclick="removeKeyword(${i})">Ã—</button>`;
    container.appendChild(tag);
  });
  container.appendChild(input);
}
function removeKeyword(i) { keywordTags.splice(i, 1); renderKeywordTags(); }
async function saveKeywords() {
  const r = await fetch(`${API}/api/profile/keywords`, { method:'PUT', headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`}, body: JSON.stringify({ keywords: keywordTags }) });
  if (r.ok) { const msg = document.getElementById('keyword-save-msg'); msg.style.display = ''; setTimeout(() => msg.style.display = 'none', 2000); }
}
function checkKeywordNotif(msg) {
  if (!keywordTags.length) return;
  const lower = (msg.content || '').toLowerCase();
  const matched = keywordTags.find(kw => lower.includes(kw));
  if (matched) showToastNotif('ğŸ”‘', `ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€Œ${matched}ã€`, msg.content, () => {});
}

// â•â•â•â• ADMIN â•â•â•â•
async function openAdminPanel() {
  openModal('admin-modal');
  switchAdminTab('users');
}
function switchAdminTab(tab) {
  document.querySelectorAll('#admin-modal .modal-tab').forEach((t,i) => t.classList.toggle('active', ['users','channels','invites','emojis'][i] === tab));
  document.querySelectorAll('#admin-modal .modal-tab-pane').forEach(p => p.classList.remove('active'));
  document.getElementById(`admin-tab-${tab}`)?.classList.add('active');
  if (tab === 'users') loadAdminUsers();
  else if (tab === 'channels') loadAdminChannels();
  else if (tab === 'invites') loadAdminInvites();
  else if (tab === 'emojis') loadAdminEmojis();
}

async function loadAdminUsers() {
  const r = await fetch(`${API}/api/users`, { headers: { Authorization: `Bearer ${token}` } });
  const users = r.ok ? await r.json() : [];
  window._allMembers = users;
  document.getElementById('admin-users-list').innerHTML = users.map(u => `
    <div class="admin-user-row">
      <img class="admin-user-avatar" src="${escHtml(u.avatar)}" />
      <span class="admin-user-name">${escHtml(u.username)} ${u.banned ? 'ğŸš«' : ''} ${u.muted ? 'ğŸ”‡' : ''}</span>
      <select class="role-select" onchange="changeRole('${escHtml(u.username)}',this.value)">
        <option value="member"${u.role==='member'?' selected':''}>member</option>
        <option value="moderator"${u.role==='moderator'?' selected':''}>moderator</option>
        <option value="admin"${u.role==='admin'?' selected':''}>admin</option>
      </select>
      <button class="admin-action-btn mute-btn" onclick="${u.muted ? `unmuteUser('${escHtml(u.username)}')` : `muteUser('${escHtml(u.username)}')`}">${u.muted ? 'ğŸ”Š ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤' : 'ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆ'}</button>
      <button class="admin-action-btn ban-btn" onclick="${u.banned ? `unbanUser('${escHtml(u.username)}')` : `banUser('${escHtml(u.username)}')`}">${u.banned ? 'ğŸ”“ BANè§£é™¤' : 'ğŸš« BAN'}</button>
    </div>`).join('');
}

async function changeRole(username, role) {
  await fetch(`${API}/api/users/${username}/role`, { method:'PUT', headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`}, body: JSON.stringify({ role }) });
}
async function muteUser(username) { await fetch(`${API}/api/users/${username}/mute`, { method:'POST', headers:{ Authorization:`Bearer ${token}` } }); loadAdminUsers(); }
async function unmuteUser(username) { await fetch(`${API}/api/users/${username}/unmute`, { method:'POST', headers:{ Authorization:`Bearer ${token}` } }); loadAdminUsers(); }
async function banUser(username) { if (!confirm(`${username} ã‚’BANã—ã¾ã™ã‹ï¼Ÿ`)) return; await fetch(`${API}/api/users/${username}/ban`, { method:'POST', headers:{ Authorization:`Bearer ${token}` } }); loadAdminUsers(); }
async function unbanUser(username) { await fetch(`${API}/api/users/${username}/unban`, { method:'POST', headers:{ Authorization:`Bearer ${token}` } }); loadAdminUsers(); }

async function loadAdminChannels() {
  const chs = Object.values(channels_state);
  document.getElementById('admin-channels-list').innerHTML = chs.map(ch => `
    <div class="ch-manage-row">
      <span class="ch-manage-name">${ch.readonly ? 'ğŸ“¢' : '#'}${escHtml(ch.name)} <span style="color:var(--text-3);font-size:12px">${escHtml(ch.topic||'')}</span></span>
      <button class="ch-edit-btn" onclick="openChannelEdit('${ch.id}')">ç·¨é›†</button>
      ${!['general','random','media','dev'].includes(ch.id) ? `<button class="ch-del-btn" onclick="deleteChannel('${ch.id}')">å‰Šé™¤</button>` : ''}
    </div>`).join('');
}

async function createChannel() {
  const name = document.getElementById('new-channel-name').value.trim();
  const topic = document.getElementById('new-channel-topic').value.trim();
  if (!name) return;
  const r = await fetch(`${API}/api/channels`, { method:'POST', headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`}, body: JSON.stringify({ name, topic }) });
  const d = await r.json();
  if (!r.ok) { alert(d.error); return; }
  document.getElementById('new-channel-name').value = '';
  document.getElementById('new-channel-topic').value = '';
  loadAdminChannels();
}

function openChannelEdit(channelId) {
  editingChannelId = channelId;
  const ch = channels_state[channelId];
  document.getElementById('edit-channel-topic').value = ch?.topic || '';
  const readonlyToggle = document.getElementById('edit-channel-readonly');
  readonlyToggle.classList.toggle('on', ch?.readonly || false);
  document.getElementById('channel-edit-title').textContent = `#${ch?.name} ã‚’ç·¨é›†`;
  closeModal('admin-modal');
  openModal('channel-edit-modal');
}
async function saveChannelEdit() {
  if (!editingChannelId) return;
  const topic = document.getElementById('edit-channel-topic').value.trim();
  const readonly = document.getElementById('edit-channel-readonly').classList.contains('on');
  await fetch(`${API}/api/channels/${editingChannelId}`, { method:'PUT', headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`}, body: JSON.stringify({ topic, readonly }) });
  closeModal('channel-edit-modal');
}

async function deleteChannel(channelId) {
  if (!confirm(`#${channelId} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) return;
  await fetch(`${API}/api/channels/${channelId}`, { method:'DELETE', headers:{ Authorization:`Bearer ${token}` } });
  loadAdminChannels();
}

function openChannelCreate() {
  openAdminPanel();
  setTimeout(() => switchAdminTab('channels'), 100);
}

async function openTopicEdit() {
  if (!['admin','moderator'].includes(currentUser?.role)) return;
  openChannelEdit(currentChannel);
}

async function loadAdminInvites() {
  const r = await fetch(`${API}/api/invites`, { headers: { Authorization: `Bearer ${token}` } });
  const list = r.ok ? await r.json() : [];
  document.getElementById('admin-invites-list').innerHTML = list.length ? list.map(inv => `
    <div class="invite-row">
      <span class="invite-code">${escHtml(inv.code)}</span>
      <span class="invite-meta">${inv.used ? 'ä½¿ç”¨æ¸ˆ' : inv.expiresAt ? `æœŸé™: ${new Date(inv.expiresAt).toLocaleDateString()}` : 'æœŸé™ãªã—'}</span>
      <button class="invite-copy-btn" onclick="navigator.clipboard.writeText('${escHtml(inv.code)}');this.textContent='âœ“ ã‚³ãƒ”ãƒ¼'">ã‚³ãƒ”ãƒ¼</button>
      <button class="secondary-btn" onclick="deleteInvite('${escHtml(inv.code)}')">å‰Šé™¤</button>
    </div>`).join('') : '<p style="color:var(--text-3)">æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
}
async function createInvite() {
  const expiresIn = document.getElementById('invite-expires').value || null;
  const r = await fetch(`${API}/api/invites`, { method:'POST', headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`}, body: JSON.stringify({ expiresIn: expiresIn ? parseInt(expiresIn) : null }) });
  if (r.ok) loadAdminInvites();
}
async function deleteInvite(code) { await fetch(`${API}/api/invites/${code}`, { method:'DELETE', headers:{ Authorization:`Bearer ${token}` } }); loadAdminInvites(); }

async function loadAdminEmojis() {
  const r = await fetch(`${API}/api/emojis`, { headers: { Authorization: `Bearer ${token}` } });
  const list = r.ok ? await r.json() : [];
  document.getElementById('admin-emojis-list').innerHTML = list.length ? list.map(e => `
    <div class="emoji-manage-row">
      <img class="emoji-manage-preview" src="${escHtml(e.url)}" />
      <span class="emoji-manage-name">:${escHtml(e.name)}:</span>
      <button class="secondary-btn" onclick="deleteEmoji('${escHtml(e.name)}')">å‰Šé™¤</button>
    </div>`).join('') : '<p style="color:var(--text-3)">ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
}
async function uploadEmoji() {
  const name = document.getElementById('new-emoji-name').value.trim();
  const file = document.getElementById('new-emoji-file').files[0];
  if (!name || !file) { alert('åå‰ã¨ç”»åƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const form = new FormData();
  form.append('name', name);
  form.append('image', file);
  const r = await fetch(`${API}/api/emojis`, { method:'POST', headers:{ Authorization:`Bearer ${token}` }, body: form });
  if (!r.ok) { const d = await r.json(); alert(d.error); return; }
  loadAdminEmojis();
}
async function deleteEmoji(name) { await fetch(`${API}/api/emojis/${name}`, { method:'DELETE', headers:{ Authorization:`Bearer ${token}` } }); loadAdminEmojis(); }

// â•â•â•â• SETTINGS â•â•â•â•
const AVATAR_STYLES = [
  { key:'bottts', label:'ğŸ¤– ãƒœãƒƒãƒˆ' }, { key:'avataaars', label:'ğŸ‘¤ äººç‰©' },
  { key:'pixel-art', label:'ğŸ® ãƒ”ã‚¯ã‚»ãƒ«' }, { key:'fun-emoji', label:'ğŸ˜€ çµµæ–‡å­—' },
  { key:'thumbs', label:'ğŸ‘ ã‚µãƒ ã‚º' }, { key:'shapes', label:'ğŸ”· ã‚·ã‚§ã‚¤ãƒ—' },
];

function openSettings() {
  document.getElementById('settings-username').textContent = currentUser?.username || 'â€”';
  document.getElementById('settings-role').textContent = currentUser?.role || 'member';
  document.getElementById('settings-username-display').textContent = currentUser?.username || 'â€”';
  document.getElementById('settings-role-display').textContent = currentUser?.role || 'member';
  pendingAvatar = currentUser?.avatar;
  document.getElementById('settings-avatar-preview').src = pendingAvatar || '';
  const container = document.getElementById('avatar-style-btns');
  container.innerHTML = AVATAR_STYLES.map(s =>
    `<button onclick="previewAvatarStyle('${s.key}')" class="secondary-btn" style="font-size:12px;padding:4px 10px">${s.label}</button>`).join('');
  renderKeywordTags();
  applySettings();
  switchSettingsTab('appearance');
  openModal('settings-modal');
}
function switchSettingsTab(tab) {
  document.querySelectorAll('#settings-modal .modal-tab').forEach((t,i) => t.classList.toggle('active', ['appearance','avatar','notifications','account'][i] === tab));
  document.querySelectorAll('#settings-modal .modal-tab-pane').forEach(p => p.classList.remove('active'));
  document.getElementById(`settings-tab-${tab}`)?.classList.add('active');
}

function previewAvatarStyle(style) {
  const url = `https://api.dicebear.com/7.x/${style}/svg?seed=${encodeURIComponent(currentUser?.username||'user')}`;
  pendingAvatar = url;
  document.getElementById('settings-avatar-preview').src = url;
}
async function handleAvatarFileSelect(files) {
  if (!files?.length) return;
  const form = new FormData(); form.append('file', files[0]);
  const r = await fetch(`${API}/api/upload`, { method:'POST', headers:{ Authorization:`Bearer ${token}` }, body: form });
  if (!r.ok) { alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
  const d = await r.json();
  pendingAvatar = d.url.startsWith('http') ? d.url : `${API}${d.url}`;
  document.getElementById('settings-avatar-preview').src = pendingAvatar;
}
async function saveAvatar() {
  if (!pendingAvatar || pendingAvatar === currentUser?.avatar) return;
  const r = await fetch(`${API}/api/profile/avatar`, { method:'PUT', headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`}, body: JSON.stringify({ avatar: pendingAvatar }) });
  if (!r.ok) { alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
  currentUser.avatar = pendingAvatar;
  document.getElementById('user-avatar-img').src = pendingAvatar;
  const msg = document.getElementById('avatar-save-msg'); msg.style.display = ''; setTimeout(() => msg.style.display = 'none', 2000);
}

async function changePassword() {
  const cur = document.getElementById('pw-current').value;
  const nw  = document.getElementById('pw-new').value;
  const msgEl = document.getElementById('pw-msg');
  if (!cur || !nw) { showPwMsg('ç¾åœ¨ã¨æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'red'); return; }
  const r = await fetch(`${API}/api/profile/password`, { method:'PUT', headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`}, body: JSON.stringify({ currentPassword: cur, newPassword: nw }) });
  const d = await r.json();
  if (!r.ok) { showPwMsg(d.error || 'å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ', 'red'); return; }
  showPwMsg('âœ“ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ', 'var(--green)');
  document.getElementById('pw-current').value = '';
  document.getElementById('pw-new').value = '';
}
function showPwMsg(msg, color) {
  const el = document.getElementById('pw-msg');
  el.textContent = msg; el.style.color = color; el.style.display = '';
  setTimeout(() => el.style.display = 'none', 3000);
}

async function loadSessions() {
  const r = await fetch(`${API}/api/profile/sessions`, { headers: { Authorization: `Bearer ${token}` } });
  const list = r.ok ? await r.json() : [];
  document.getElementById('sessions-list').innerHTML = list.length ? list.map(s => `
    <div class="session-row">
      <div class="session-ip">ğŸ“ ${escHtml(s.ip || 'ä¸æ˜')}</div>
      <div class="session-meta">${escHtml((s.ua||'').substring(0,80))} â€¢ ${new Date(s.loginAt).toLocaleString()}</div>
    </div>`).join('') : '<p style="color:var(--text-3);font-size:13px">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
}

function setTheme(t) { settings.theme = t; applySettings(); saveSettings(); }
function setFontSize(v) { settings.fontSize = parseInt(v); document.getElementById('font-size-label').textContent = v + 'px'; applySettings(); saveSettings(); }
function setSendKey(v) { settings.sendKey = v; saveSettings(); }
function toggleSetting(k) { settings[k] = !settings[k]; document.getElementById('toggle-' + (k === 'mentionOnly' ? 'mention-only' : k)).classList.toggle('on', settings[k]); saveSettings(); }
async function requestNotifPermission() { const p = await Notification.requestPermission(); settings.notif = p === 'granted'; document.getElementById('toggle-notif').classList.toggle('on', settings.notif); saveSettings(); }
function applySettings() {
  document.body.classList.toggle('theme-light', settings.theme === 'light');
  document.getElementById('theme-dark')?.classList.toggle('active', settings.theme === 'dark');
  document.getElementById('theme-light')?.classList.toggle('active', settings.theme === 'light');
  document.documentElement.style.setProperty('--font-size', settings.fontSize + 'px');
  const sl = document.getElementById('font-slider'); if (sl) sl.value = settings.fontSize;
  const fl = document.getElementById('font-size-label'); if (fl) fl.textContent = settings.fontSize + 'px';
  document.getElementById('toggle-sound')?.classList.toggle('on', settings.sound);
  document.getElementById('toggle-notif')?.classList.toggle('on', settings.notif);
  document.getElementById('toggle-mention-only')?.classList.toggle('on', settings.mentionOnly);
  const sk = document.getElementById('send-key-select'); if (sk) sk.value = settings.sendKey;
}
function saveSettings() { localStorage.setItem('nexus_settings', JSON.stringify(settings)); }

function openLogoutConfirm() { closeModal('settings-modal'); openModal('logout-confirm-modal'); }
function logout() { localStorage.removeItem('token'); localStorage.removeItem('nexus_dmRooms'); socket?.disconnect(); location.reload(); }
function openDeleteAccount() { document.getElementById('delete-account-pw').value = ''; document.getElementById('delete-account-err').style.display = 'none'; openModal('delete-account-modal'); }
async function confirmDeleteAccount() {
  const pw = document.getElementById('delete-account-pw').value;
  if (!pw) { showDeleteErr('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const r = await fetch(`${API}/api/account`, { method:'DELETE', headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`}, body: JSON.stringify({ password: pw }) });
  const d = await r.json();
  if (!r.ok) { showDeleteErr(d.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
  alert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  logout();
}
function showDeleteErr(msg) { const el = document.getElementById('delete-account-err'); el.textContent = msg; el.style.display = ''; }

// â•â•â•â• FILE UPLOAD â•â•â•â•
let fileInputEl;
function openFilePicker() {
  if (!fileInputEl) { fileInputEl = document.createElement('input'); fileInputEl.type = 'file'; fileInputEl.style.display = 'none'; fileInputEl.onchange = e => handleFileSelect(e.target.files); document.body.appendChild(fileInputEl); }
  fileInputEl.click();
}
async function handleFileSelect(files) {
  if (!files?.length) return;
  showUploadToast('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');
  const form = new FormData(); form.append('file', files[0]);
  const r = await fetch(`${API}/api/upload`, { method:'POST', headers:{ Authorization:`Bearer ${token}` }, body: form });
  hideUploadToast();
  if (!r.ok) { alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
  const fi = await r.json();
  if (currentDmRoom) {
    const other = currentDmRoom.split('__').find(u => u !== currentUser?.username);
    socket.emit('send_dm', { toUsername: other, content: `ğŸ“ ${fi.filename}`, fileInfo: fi });
  } else {
    socket.emit('send_file', { channelId: currentChannel, fileInfo: fi });
  }
}
function showUploadToast(msg) { const t = document.getElementById('upload-toast'); t.querySelector('#upload-toast-text').textContent = msg; t.classList.add('show'); }
function hideUploadToast() { document.getElementById('upload-toast').classList.remove('show'); }
function initDragDrop() {
  document.addEventListener('dragover', e => { e.preventDefault(); document.getElementById('drop-overlay').classList.add('active'); });
  document.addEventListener('dragleave', e => { if (!e.relatedTarget) document.getElementById('drop-overlay').classList.remove('active'); });
  document.addEventListener('drop', e => { e.preventDefault(); document.getElementById('drop-overlay').classList.remove('active'); handleFileSelect(e.dataTransfer.files); });
}

// â•â•â•â• EMOJI PICKER â•â•â•â•
const EMOJI_DATA = { 'ğŸ˜€ é¡”': ['ğŸ˜€','ğŸ˜‚','ğŸ˜…','ğŸ¤£','ğŸ˜Š','ğŸ˜‡','ğŸ™‚','ğŸ˜','ğŸ¥°','ğŸ˜˜','ğŸ˜‹','ğŸ˜','ğŸ¥³','ğŸ¤©','ğŸ˜','ğŸ˜’','ğŸ˜','ğŸ˜”','ğŸ˜Ÿ','ğŸ˜•','ğŸ™','â˜¹ï¸','ğŸ˜£','ğŸ˜–','ğŸ˜«','ğŸ˜©','ğŸ¥º','ğŸ˜¢','ğŸ˜­','ğŸ˜¤','ğŸ˜ ','ğŸ˜¡','ğŸ¤¬','ğŸ˜ˆ','ğŸ’€'], 'â¤ï¸ ãƒãƒ¼ãƒˆ': ['â¤ï¸','ğŸ§¡','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ–¤','ğŸ¤','ğŸ’•','ğŸ’','ğŸ’“','ğŸ’—','ğŸ’–','ğŸ’˜','ğŸ’','ğŸ’Ÿ','â£ï¸'], 'ğŸ‘ ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼': ['ğŸ‘','ğŸ‘','ğŸ‘Œ','âœŒï¸','ğŸ¤','ğŸ¤Ÿ','ğŸ¤˜','ğŸ¤™','ğŸ‘ˆ','ğŸ‘‰','ğŸ‘†','ğŸ‘‡','â˜ï¸','âœ‹','ğŸ¤š','ğŸ–ï¸','ğŸ––','ğŸ‘‹','ğŸ¤œ','ğŸ¤›','ğŸ‘Š','âœŠ','ğŸ™Œ','ğŸ‘','ğŸ¤²','ğŸ™'], 'ğŸ‰ ãŠç¥ã„': ['ğŸ‰','ğŸŠ','ğŸˆ','ğŸ','ğŸ€','ğŸ†','ğŸ‡','âœ¨','ğŸŒŸ','â­','ğŸ†','ğŸ¥‡','ğŸ–ï¸'], 'ğŸ”¥ ã‚·ãƒ³ãƒœãƒ«': ['ğŸ”¥','ğŸ’¯','âœ…','âŒ','â­•','â“','â—','ğŸ’¤','ğŸ†’','ğŸ†“','ğŸ†•','ğŸ†™','ğŸ†—'] };

function toggleEmojiPicker() {
  const picker = document.getElementById('emoji-picker');
  if (picker.classList.toggle('open')) {
    const cats = document.getElementById('emoji-cats');
    cats.innerHTML = Object.keys(EMOJI_DATA).concat(customEmojiList.length ? ['ğŸ¨ ã‚«ã‚¹ã‚¿ãƒ '] : []).map((c,i) => `<button class="emoji-cat-btn${i===0?' active':''}" onclick="showEmojiCat(${i},'${escHtml(c)}')">${c.split(' ')[0]}</button>`).join('');
    showEmojiCat(0, Object.keys(EMOJI_DATA)[0]);
  }
}
function showEmojiCat(idx, cat) {
  document.querySelectorAll('.emoji-cat-btn').forEach((b,i) => b.classList.toggle('active', i === idx));
  const grid = document.getElementById('emoji-grid');
  if (cat === 'ğŸ¨ ã‚«ã‚¹ã‚¿ãƒ ') {
    grid.innerHTML = customEmojiList.map(e => `<button class="emoji-btn-item" onclick="insertEmoji(':${e.name}:')" title=":${escHtml(e.name)}:"><img class="custom-emoji-img" src="${escHtml(e.url)}" /></button>`).join('');
  } else {
    grid.innerHTML = (EMOJI_DATA[cat] || []).map(e => `<button class="emoji-btn-item" onclick="insertEmoji('${e}')">${e}</button>`).join('');
  }
}
function insertEmoji(e) { const inp = document.getElementById('msg-input'); inp.value += e; inp.focus(); document.getElementById('emoji-picker').classList.remove('open'); }

// â•â•â•â• NOTIFICATION â•â•â•â•
function showToastNotif(icon, title, text, onClick) {
  document.querySelectorAll('.toast-notif').forEach(el => el.remove());
  const el = document.createElement('div'); el.className = 'toast-notif';
  el.innerHTML = `<div class="toast-notif-icon">${icon}</div><div class="toast-notif-body"><div class="toast-notif-title">${escHtml(title)}</div>${text ? `<div class="toast-notif-text">${escHtml(text.substring(0,80))}</div>` : ''}</div>`;
  if (onClick) el.onclick = () => { onClick(); el.remove(); };
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 4000);
  if (settings.sound) { try { const ctx = new AudioContext(); const g = ctx.createGain(); g.gain.value = 0.15; const o = ctx.createOscillator(); o.frequency.value = 880; o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime + 0.1); } catch(e) {} }
  if (settings.notif && document.hidden) { try { new Notification(String(title), { body: String(text || ''), icon: '/favicon.ico' }); } catch(e) {} }
}

// â•â•â•â• HELPERS â•â•â•â•
function renderContent(text) {
  if (!text) return '';
  let t = escHtml(text);
  t = t.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  t = t.replace(/\*(.+?)\*/g, '<em>$1</em>');
  t = t.replace(/`(.+?)`/g, '<code style="background:var(--bg-panel);padding:1px 5px;border-radius:4px;font-family:var(--font-mono);font-size:13px">$1</code>');
  t = t.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
  t = t.replace(/\n/g, '<br>');
  // ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—
  t = t.replace(/:([a-z0-9_]+):/g, (m, name) => {
    const ce = customEmojiList.find(e => e.name === name);
    return ce ? `<img src="${escHtml(ce.url)}" class="custom-emoji-img" title=":${escHtml(name)}:" />` : m;
  });
  return t;
}
function escHtml(s) { return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function formatTime(ts) { const d = new Date(ts); return d.toLocaleString('ja-JP', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' }); }
function formatBytes(b) { if (!b) return ''; if (b < 1024) return b + 'B'; if (b < 1048576) return (b/1024).toFixed(1) + 'KB'; return (b/1048576).toFixed(1) + 'MB'; }
function scrollToBottom() { const m = document.getElementById('messages'); requestAnimationFrame(() => { m.scrollTop = m.scrollHeight; }); }
function handleKey(e) {
  if (settings.sendKey === 'enter') { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
  else { if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); sendMessage(); } }
}
function autoResize(el) { el.style.height = '24px'; el.style.height = Math.min(el.scrollHeight, 200) + 'px'; }
function openLightbox(src) { document.getElementById('lightbox-img').src = src; document.getElementById('lightbox').classList.add('open'); }
function closeLightbox() { document.getElementById('lightbox').classList.remove('open'); }
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
function closeModalOutside(e, id) { if (e.target === document.getElementById(id)) closeModal(id); }
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('drawer-overlay').classList.toggle('open'); }
function toggleMembers() { document.getElementById('members-panel').classList.toggle('open'); document.getElementById('drawer-overlay').classList.toggle('open'); }
function closeDrawers() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('members-panel').classList.remove('open'); document.getElementById('drawer-overlay').classList.remove('open'); }

function initMobile() {
  const isMobile = window.matchMedia('(max-width:640px)').matches;
  if (!isMobile) return;
  document.getElementById('msg-input').addEventListener('focus', () => setTimeout(scrollToBottom, 350));
  let tx = 0, ty = 0;
  document.addEventListener('touchstart', e => { tx = e.touches[0].clientX; ty = e.touches[0].clientY; }, { passive: true });
  document.addEventListener('touchend', e => {
    const dx = e.changedTouches[0].clientX - tx;
    const dy = Math.abs(e.changedTouches[0].clientY - ty);
    if (dx > 60 && dy < 60 && tx < 30) toggleSidebar();
    else if (dx < -60 && dy < 60) closeDrawers();
  }, { passive: true });
}

// â•â•â•â• INIT â•â•â•â•
if (token) {
  fetch(`${API}/api/me`, { headers: { Authorization: `Bearer ${token}` } })
    .then(r => r.ok ? r.json() : null).then(u => { if (u) { currentUser = u; startApp(); } });
}
</script>
