<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>NexusChat</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSS Variables & Reset
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg-void:     #0a0b0f;
  --bg-dark:     #0f1117;
  --bg-mid:      #161820;
  --bg-panel:    #1c1f2a;
  --bg-hover:    #252836;
  --bg-active:   #2d3147;
  --border:      rgba(255,255,255,0.07);
  --accent:      #5865f2;
  --accent-glow: rgba(88,101,242,0.3);
  --accent-2:    #eb459e;
  --green:       #3ba55d;
  --yellow:      #faa61a;
  --red:         #ed4245;
  --text-1:      #e3e5e8;
  --text-2:      #b9bbbe;
  --text-3:      #72767d;
  --text-muted:  #4f545c;
  --font-main:   'Outfit', sans-serif;
  --font-mono:   'JetBrains Mono', monospace;
  --radius:      8px;
  --radius-lg:   14px;
  --sidebar-w:   240px;
  --server-w:    72px;
  --members-w:   240px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%;
  font-family: var(--font-main);
  background: var(--bg-void);
  color: var(--text-1);
  overflow: hidden;
  user-select: none;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Auth Screen
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#auth-screen {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-void);
  z-index: 1000;
}

.auth-bg {
  position: absolute;
  inset: 0;
  background: 
    radial-gradient(ellipse 60% 50% at 20% 30%, rgba(88,101,242,0.15) 0%, transparent 70%),
    radial-gradient(ellipse 50% 40% at 80% 70%, rgba(235,69,158,0.1) 0%, transparent 70%);
}

.auth-card {
  position: relative;
  width: 420px;
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 40px;
  box-shadow: 0 32px 80px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.03);
  animation: cardIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

@keyframes cardIn {
  from { opacity: 0; transform: translateY(24px) scale(0.97); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}

.auth-logo {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 28px;
}

.auth-logo-icon {
  width: 44px;
  height: 44px;
  border-radius: 14px;
  background: linear-gradient(135deg, var(--accent), var(--accent-2));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  box-shadow: 0 0 24px var(--accent-glow);
}

.auth-logo-text {
  font-size: 24px;
  font-weight: 700;
  background: linear-gradient(135deg, #fff 30%, var(--text-2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: -0.5px;
}

.auth-title {
  font-size: 22px;
  font-weight: 600;
  margin-bottom: 6px;
  color: var(--text-1);
}

.auth-subtitle {
  font-size: 14px;
  color: var(--text-3);
  margin-bottom: 28px;
}

.tab-switcher {
  display: flex;
  background: var(--bg-mid);
  border-radius: var(--radius);
  padding: 4px;
  margin-bottom: 24px;
  gap: 4px;
}

.tab-btn {
  flex: 1;
  padding: 8px;
  border: none;
  background: transparent;
  color: var(--text-3);
  font-family: var(--font-main);
  font-size: 14px;
  font-weight: 500;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
}
.tab-btn.active {
  background: var(--accent);
  color: #fff;
  box-shadow: 0 2px 8px var(--accent-glow);
}

.field-label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-3);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

.field-input {
  width: 100%;
  padding: 12px 14px;
  background: var(--bg-dark);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-1);
  font-family: var(--font-main);
  font-size: 15px;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
  margin-bottom: 16px;
}
.field-input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}
.field-input::placeholder { color: var(--text-muted); }

.auth-btn {
  width: 100%;
  padding: 13px;
  background: linear-gradient(135deg, var(--accent), #4752c4);
  border: none;
  border-radius: var(--radius);
  color: #fff;
  font-family: var(--font-main);
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 4px 16px var(--accent-glow);
  position: relative;
  overflow: hidden;
}
.auth-btn::after {
  content: '';
  position: absolute;
  inset: 0;
  background: rgba(255,255,255,0);
  transition: background 0.2s;
}
.auth-btn:hover::after { background: rgba(255,255,255,0.08); }
.auth-btn:active { transform: scale(0.98); }
.auth-btn:disabled { opacity: 0.6; cursor: not-allowed; }

.auth-error {
  margin-top: 12px;
  padding: 10px 14px;
  background: rgba(237,66,69,0.15);
  border: 1px solid rgba(237,66,69,0.3);
  border-radius: var(--radius);
  color: var(--red);
  font-size: 13px;
  display: none;
}
.auth-error.show { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   App Layout
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app {
  display: none;
  height: 100vh;
  flex-direction: row;
}
#app.visible { display: flex; }

/* Server list */
.server-list {
  width: var(--server-w);
  background: var(--bg-void);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 12px 0;
  gap: 8px;
  overflow-y: auto;
  flex-shrink: 0;
  border-right: 1px solid var(--border);
}

.server-icon {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--accent-2));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  cursor: pointer;
  transition: border-radius 0.2s, transform 0.2s;
  box-shadow: 0 0 0 0 var(--accent-glow);
  position: relative;
}
.server-icon:hover,
.server-icon.active {
  border-radius: 30%;
  transform: scale(1.05);
  box-shadow: 0 0 0 3px var(--accent-glow);
}

.server-icon::before {
  content: '';
  position: absolute;
  left: -12px;
  width: 4px;
  height: 0;
  background: #fff;
  border-radius: 0 4px 4px 0;
  transition: height 0.2s;
}
.server-icon.active::before { height: 32px; }

.server-sep {
  width: 32px;
  height: 2px;
  background: var(--bg-panel);
  border-radius: 1px;
}

/* Sidebar / Channel list */
.sidebar {
  width: var(--sidebar-w);
  background: var(--bg-dark);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  border-right: 1px solid var(--border);
}

.sidebar-header {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  font-weight: 700;
  font-size: 15px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  transition: background 0.15s;
}
.sidebar-header:hover { background: var(--bg-hover); }

.channels-section {
  flex: 1;
  overflow-y: auto;
  padding: 8px 0;
}

.ch-category {
  padding: 16px 16px 4px;
  font-size: 11px;
  font-weight: 700;
  color: var(--text-3);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  display: flex;
  align-items: center;
  gap: 4px;
  cursor: default;
}

.ch-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 7px 8px 7px 16px;
  margin: 1px 8px;
  border-radius: 6px;
  cursor: pointer;
  color: var(--text-3);
  font-size: 15px;
  font-weight: 500;
  transition: all 0.15s;
}
.ch-item:hover { background: var(--bg-hover); color: var(--text-2); }
.ch-item.active { background: var(--bg-active); color: var(--text-1); }
.ch-item .ch-icon { font-size: 18px; flex-shrink: 0; }
.ch-item .unread-dot {
  width: 8px; height: 8px;
  background: var(--text-1);
  border-radius: 50%;
  margin-left: auto;
  display: none;
}
.ch-item.unread .unread-dot { display: block; }

/* User panel at bottom of sidebar */
.user-panel {
  padding: 10px 8px;
  background: var(--bg-void);
  display: flex;
  align-items: center;
  gap: 8px;
  border-top: 1px solid var(--border);
}

.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  position: relative;
  flex-shrink: 0;
}
.user-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
.user-status {
  position: absolute;
  bottom: -1px;
  right: -1px;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--green);
  border: 2px solid var(--bg-void);
}

.user-info { flex: 1; min-width: 0; }
.user-name  { font-size: 13px; font-weight: 600; truncate: ellipsis; overflow: hidden; white-space: nowrap; }
.user-tag   { font-size: 11px; color: var(--text-3); font-family: var(--font-mono); }

.user-actions { display: flex; gap: 4px; }
.user-action-btn {
  width: 28px; height: 28px;
  border: none;
  background: transparent;
  color: var(--text-3);
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  transition: all 0.15s;
}
.user-action-btn:hover { background: var(--bg-hover); color: var(--text-1); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Main Chat
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chat-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
  background: var(--bg-mid);
}

.chat-header {
  height: 48px;
  padding: 0 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
  background: var(--bg-mid);
}

.chat-header-icon { font-size: 20px; color: var(--text-3); }
.chat-header-name { font-size: 16px; font-weight: 700; }
.chat-header-sep  { width: 1px; height: 20px; background: var(--border); margin: 0 4px; }
.chat-header-topic { font-size: 13px; color: var(--text-3); overflow: hidden; white-space: nowrap; text-overflow: ellipsis; flex: 1; }

/* Messages */
.messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px 0;
  display: flex;
  flex-direction: column;
  gap: 2px;
  scroll-behavior: smooth;
}

.messages::-webkit-scrollbar { width: 4px; }
.messages::-webkit-scrollbar-thumb { background: var(--bg-hover); border-radius: 2px; }

.msg {
  display: flex;
  gap: 14px;
  padding: 4px 16px;
  border-radius: 4px;
  transition: background 0.1s;
  position: relative;
  animation: msgIn 0.2s ease-out;
}
@keyframes msgIn {
  from { opacity: 0; transform: translateY(8px); }
  to   { opacity: 1; transform: translateY(0); }
}
.msg:hover { background: rgba(0,0,0,0.1); }

.msg-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  flex-shrink: 0;
  cursor: pointer;
  margin-top: 2px;
}
.msg-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }

.msg-body { flex: 1; min-width: 0; }
.msg-header { display: flex; align-items: baseline; gap: 8px; margin-bottom: 3px; }
.msg-author { font-size: 15px; font-weight: 600; color: var(--text-1); cursor: pointer; }
.msg-author:hover { text-decoration: underline; }
.msg-time { font-size: 11px; color: var(--text-muted); font-family: var(--font-mono); }
.msg-content { font-size: 15px; color: var(--text-2); line-height: 1.5; word-break: break-word; user-select: text; }

/* System message */
.msg.system {
  padding-left: 70px;
  color: var(--text-3);
  font-size: 13px;
  font-style: italic;
}
.msg.system::before {
  content: 'â€”';
  position: absolute;
  left: 32px;
}

/* File message */
.file-attachment {
  display: inline-flex;
  align-items: center;
  gap: 12px;
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px 14px;
  margin-top: 6px;
  max-width: 420px;
  text-decoration: none;
  transition: border-color 0.2s;
}
.file-attachment:hover { border-color: var(--accent); }

.file-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  background: var(--accent);
  background: linear-gradient(135deg, var(--accent), var(--accent-2));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
}

.file-info { flex: 1; min-width: 0; }
.file-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-1);
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}
.file-size { font-size: 12px; color: var(--text-3); margin-top: 2px; }

/* Image preview in chat */
.img-preview {
  max-width: 400px;
  max-height: 300px;
  border-radius: var(--radius);
  margin-top: 6px;
  cursor: zoom-in;
  display: block;
  border: 1px solid var(--border);
  object-fit: cover;
}

/* â”€â”€ Typing indicator â”€â”€ */
.typing-bar {
  height: 20px;
  padding: 0 16px;
  font-size: 13px;
  color: var(--text-3);
  display: flex;
  align-items: center;
  gap: 6px;
}
.typing-dots { display: flex; gap: 3px; }
.typing-dot {
  width: 5px; height: 5px;
  border-radius: 50%;
  background: var(--text-3);
  animation: typingBounce 1.2s infinite;
}
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes typingBounce {
  0%, 60%, 100% { transform: translateY(0); }
  30% { transform: translateY(-4px); }
}

/* â”€â”€ Input bar â”€â”€ */
.input-bar {
  padding: 0 16px 16px;
  flex-shrink: 0;
}

.input-box {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 6px 6px 14px;
  transition: border-color 0.2s;
}
.input-box:focus-within { border-color: rgba(88,101,242,0.5); }

.attach-btn {
  width: 36px; height: 36px;
  border: none;
  background: transparent;
  color: var(--text-3);
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  transition: all 0.15s;
  flex-shrink: 0;
}
.attach-btn:hover { background: var(--bg-hover); color: var(--text-1); }

.msg-input {
  flex: 1;
  border: none;
  background: transparent;
  color: var(--text-1);
  font-family: var(--font-main);
  font-size: 15px;
  outline: none;
  resize: none;
  min-height: 24px;
  max-height: 200px;
  line-height: 1.5;
  padding: 4px 0;
}
.msg-input::placeholder { color: var(--text-muted); }

.send-btn {
  width: 36px; height: 36px;
  border: none;
  background: var(--accent);
  color: #fff;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
  transition: all 0.15s;
  box-shadow: 0 2px 8px var(--accent-glow);
}
.send-btn:hover { background: #4752c4; transform: scale(1.05); }
.send-btn:active { transform: scale(0.95); }

/* File drop overlay */
.drop-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(88,101,242,0.15);
  border: 3px dashed var(--accent);
  border-radius: 16px;
  margin: 16px;
  z-index: 999;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 16px;
  font-size: 24px;
  color: var(--accent);
  backdrop-filter: blur(4px);
}
.drop-overlay.active { display: flex; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Members sidebar
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.members-panel {
  width: var(--members-w);
  background: var(--bg-dark);
  border-left: 1px solid var(--border);
  overflow-y: auto;
  flex-shrink: 0;
}

.members-header {
  padding: 16px;
  font-size: 11px;
  font-weight: 700;
  color: var(--text-3);
  text-transform: uppercase;
  letter-spacing: 0.8px;
}

.member-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 6px 12px;
  margin: 1px 8px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.15s;
}
.member-item:hover { background: var(--bg-hover); }

.member-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  position: relative;
  flex-shrink: 0;
}
.member-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
.member-status {
  position: absolute;
  bottom: -1px; right: -1px;
  width: 10px; height: 10px;
  border-radius: 50%;
  background: var(--green);
  border: 2px solid var(--bg-dark);
}

.member-name { font-size: 14px; font-weight: 500; color: var(--text-2); overflow: hidden; white-space: nowrap; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   File upload progress
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.upload-toast {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 14px 18px;
  display: flex;
  align-items: center;
  gap: 12px;
  box-shadow: 0 16px 40px rgba(0,0,0,0.5);
  z-index: 2000;
  min-width: 280px;
  opacity: 0;
  transform: translateX(-50%) translateY(10px);
  transition: all 0.3s;
  pointer-events: none;
}
.upload-toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

.upload-spinner {
  width: 20px; height: 20px;
  border: 2px solid var(--bg-hover);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  flex-shrink: 0;
}
@keyframes spin { to { transform: rotate(360deg); } }

.upload-label { font-size: 14px; color: var(--text-2); flex: 1; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Image lightbox
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.lightbox {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  z-index: 3000;
  align-items: center;
  justify-content: center;
  cursor: zoom-out;
  backdrop-filter: blur(8px);
}
.lightbox.open { display: flex; }
.lightbox img { max-width: 90vw; max-height: 90vh; border-radius: var(--radius); }

/* Scrollbar global */
* { scrollbar-width: thin; scrollbar-color: var(--bg-hover) transparent; }

/* Welcome message */
.welcome-msg {
  padding: 32px 16px 16px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 8px;
}
.welcome-icon {
  width: 64px; height: 64px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--accent-2));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  margin-bottom: 16px;
}
.welcome-title { font-size: 24px; font-weight: 700; margin-bottom: 6px; }
.welcome-sub   { font-size: 15px; color: var(--text-3); }

@media (max-width: 900px) {
  .members-panel { display: none; }
}
@media (max-width: 640px) {
  .server-list { display: none; }
  :root { --sidebar-w: 0px; }
  .sidebar { display: none; }
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• AUTH SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="auth-screen">
  <div class="auth-bg"></div>
  <div class="auth-card">
    <div class="auth-logo">
      <div class="auth-logo-icon">âš¡</div>
      <div class="auth-logo-text">NexusChat</div>
    </div>
    <h1 class="auth-title">Welcome back</h1>
    <p class="auth-subtitle">Dive back into your conversations</p>

    <div class="tab-switcher">
      <button class="tab-btn active" onclick="switchTab('login')">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button class="tab-btn" onclick="switchTab('register')">æ–°è¦ç™»éŒ²</button>
    </div>

    <div id="login-form">
      <label class="field-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
      <input class="field-input" id="login-username" type="text" placeholder="username" autocomplete="username" />
      <label class="field-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input class="field-input" id="login-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
      <button class="auth-btn" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <div id="register-form" style="display:none">
      <label class="field-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼å <span style="color:var(--text-muted);text-transform:none;font-size:11px">(3ã€œ20æ–‡å­—)</span></label>
      <input class="field-input" id="reg-username" type="text" placeholder="username" autocomplete="username" />
      <label class="field-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input class="field-input" id="reg-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password" />
      <button class="auth-btn" onclick="register()">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</button>
    </div>

    <div class="auth-error" id="auth-error"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• APP â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app">

  <!-- Server list -->
  <div class="server-list">
    <div class="server-icon active" title="NexusChat">âš¡</div>
    <div class="server-sep"></div>
    <div class="server-icon" title="Add Server" style="background:var(--bg-panel);color:var(--green);font-size:26px;font-weight:300">+</div>
  </div>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <span>NexusChat</span>
      <span style="color:var(--text-3)">âŒ„</span>
    </div>

    <div class="channels-section" id="channel-list">
      <div class="ch-category">ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ£ãƒ³ãƒãƒ«</div>
      <!-- dynamically filled -->
    </div>

    <div class="user-panel">
      <div class="user-avatar">
        <img id="user-avatar-img" src="" alt="" />
        <div class="user-status"></div>
      </div>
      <div class="user-info">
        <div class="user-name" id="user-display-name">â€”</div>
        <div class="user-tag" id="user-display-tag">#0000</div>
      </div>
      <div class="user-actions">
        <button class="user-action-btn" title="è¨­å®š" onclick="alert('è¨­å®šã¯ã¾ã å®Ÿè£…ä¸­ã§ã™')">âš™</button>
        <button class="user-action-btn" title="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ" onclick="logout()">ğŸšª</button>
      </div>
    </div>
  </div>

  <!-- Chat -->
  <div class="chat-area">
    <div class="chat-header">
      <span class="chat-header-icon">#</span>
      <span class="chat-header-name" id="chat-header-name">general</span>
      <div class="chat-header-sep"></div>
      <span class="chat-header-topic" id="chat-header-topic">ã¿ã‚“ãªã®ãƒãƒ£ãƒ³ãƒãƒ«ã¸ã‚ˆã†ã“ãï¼</span>
    </div>

    <div class="messages" id="messages">
      <div class="welcome-msg">
        <div class="welcome-icon">#</div>
        <div class="welcome-title" id="welcome-title">#general ã¸ã‚ˆã†ã“ãï¼</div>
        <div class="welcome-sub">ã“ã‚Œã¯ãƒãƒ£ãƒ³ãƒãƒ«ã®å§‹ã¾ã‚Šã§ã™ã€‚</div>
      </div>
    </div>

    <div class="typing-bar" id="typing-bar"></div>

    <div class="input-bar">
      <div class="input-box">
        <button class="attach-btn" title="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ·»ä»˜" onclick="openFilePicker()">ğŸ“</button>
        <textarea
          class="msg-input"
          id="msg-input"
          placeholder="#general ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡"
          rows="1"
          oninput="autoResize(this); emitTyping()"
          onkeydown="handleKey(event)"
        ></textarea>
        <button class="send-btn" onclick="sendMessage()" title="é€ä¿¡">â–¶</button>
      </div>
    </div>
  </div>

  <!-- Members -->
  <div class="members-panel">
    <div class="members-header">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ â€” <span id="online-count">0</span>å</div>
    <div id="members-list"></div>
  </div>

</div><!-- #app -->

<!-- Drop overlay -->
<div class="drop-overlay" id="drop-overlay">
  <div style="font-size:48px">ğŸ“</div>
  <div>ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</div>
</div>

<!-- Upload toast -->
<div class="upload-toast" id="upload-toast">
  <div class="upload-spinner"></div>
  <div class="upload-label" id="upload-label">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <img id="lightbox-img" src="" alt="" />
</div>

<!-- Hidden file input -->
<input type="file" id="file-input" style="display:none" onchange="handleFileSelect(this.files)" multiple />

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let token     = localStorage.getItem('token') || null;
let currentUser = null;
let socket    = null;
let currentChannel = 'general';
let typingTimer = null;
let typingUsers = {};

const API = '';  // same origin

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Auth Tab
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.toggle('active', (i===0) === (tab==='login')));
  document.getElementById('login-form').style.display    = tab === 'login' ? '' : 'none';
  document.getElementById('register-form').style.display = tab === 'register' ? '' : 'none';
  hideError();
}

function showError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg;
  el.classList.add('show');
}
function hideError() {
  document.getElementById('auth-error').classList.remove('show');
}

async function login() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  if (!username || !password) return showError('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

  try {
    const res  = await fetch(`${API}/api/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });
    const data = await res.json();
    if (!res.ok) return showError(data.error || 'ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—');
    onLogin(data);
  } catch { showError('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“'); }
}

async function register() {
  const username = document.getElementById('reg-username').value.trim();
  const password = document.getElementById('reg-password').value;
  if (!username || !password) return showError('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  if (password.length < 6) return showError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Š');

  try {
    const res  = await fetch(`${API}/api/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });
    const data = await res.json();
    if (!res.ok) return showError(data.error || 'ç™»éŒ²å¤±æ•—');
    onLogin(data);
  } catch { showError('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“'); }
}

function onLogin({ token: t, user }) {
  token = t;
  currentUser = user;
  localStorage.setItem('token', t);
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').classList.add('visible');
  initApp();
}

function logout() {
  if (!confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  localStorage.removeItem('token');
  if (socket) socket.disconnect();
  location.reload();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// App Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initApp() {
  // Show user info
  document.getElementById('user-display-name').textContent = currentUser.username;
  document.getElementById('user-display-tag').textContent  = '#' + currentUser.id.slice(0,4).toUpperCase();
  document.getElementById('user-avatar-img').src = currentUser.avatar;

  // Load channels
  const res = await fetch(`${API}/api/channels`, { headers: { Authorization: `Bearer ${token}` } });
  const channels = await res.json();
  renderChannelList(channels);

  // Connect socket
  socket = io({ auth: { token } });

  socket.on('connect', () => {
    joinChannel(currentChannel);
  });

  socket.on('message', (msg) => {
    appendMessage(msg);
    scrollToBottom();
  });

  socket.on('online_users', (users) => {
    renderMembers(users);
  });

  socket.on('typing', ({ username, isTyping }) => {
    if (isTyping) typingUsers[username] = true;
    else delete typingUsers[username];
    renderTyping();
  });

  socket.on('connect_error', (err) => {
    console.error('Socket error:', err.message);
  });

  // Drag & drop
  document.addEventListener('dragover', (e) => {
    e.preventDefault();
    document.getElementById('drop-overlay').classList.add('active');
  });
  document.addEventListener('dragleave', (e) => {
    if (!e.relatedTarget) document.getElementById('drop-overlay').classList.remove('active');
  });
  document.addEventListener('drop', (e) => {
    e.preventDefault();
    document.getElementById('drop-overlay').classList.remove('active');
    handleFileSelect(e.dataTransfer.files);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Channels
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderChannelList(channels) {
  const list = document.getElementById('channel-list');
  list.innerHTML = '<div class="ch-category">ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ£ãƒ³ãƒãƒ«</div>';
  channels.forEach(ch => {
    const el = document.createElement('div');
    el.className = 'ch-item' + (ch.id === currentChannel ? ' active' : '');
    el.id = `ch-${ch.id}`;
    el.innerHTML = `<span class="ch-icon">#</span>${ch.name}<span class="unread-dot"></span>`;
    el.onclick = () => joinChannel(ch.id);
    list.appendChild(el);
  });
}

async function joinChannel(channelId) {
  // Update UI
  document.querySelectorAll('.ch-item').forEach(el => el.classList.remove('active'));
  const el = document.getElementById(`ch-${channelId}`);
  if (el) { el.classList.add('active'); el.classList.remove('unread'); }

  currentChannel = channelId;
  document.getElementById('chat-header-name').textContent = channelId;
  document.getElementById('msg-input').placeholder = `#${channelId} ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡`;
  document.getElementById('welcome-title').textContent = `#${channelId} ã¸ã‚ˆã†ã“ãï¼`;
  document.getElementById('messages').innerHTML = `
    <div class="welcome-msg">
      <div class="welcome-icon">#</div>
      <div class="welcome-title" id="welcome-title">#${channelId} ã¸ã‚ˆã†ã“ãï¼</div>
      <div class="welcome-sub">ã“ã‚Œã¯ãƒãƒ£ãƒ³ãƒãƒ«ã®å§‹ã¾ã‚Šã§ã™ã€‚</div>
    </div>`;

  socket.emit('join_channel', channelId);

  // Load history
  const res = await fetch(`${API}/api/channels/${channelId}/messages`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const messages = await res.json();
  messages.forEach(appendMessage);
  scrollToBottom();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Messages
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function appendMessage(msg) {
  const container = document.getElementById('messages');

  if (msg.type === 'system') {
    const el = document.createElement('div');
    el.className = 'msg system';
    el.textContent = msg.content;
    container.appendChild(el);
    return;
  }

  const avatar = `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(msg.author)}`;
  const time   = new Date(msg.timestamp).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

  const el = document.createElement('div');
  el.className = 'msg';
  el.dataset.id = msg.id;

  let contentHtml = '';
  if (msg.type === 'file' && msg.fileInfo) {
    const { filename, url, mimetype, size } = msg.fileInfo;
    const isImage = mimetype && mimetype.startsWith('image/');
    if (isImage) {
      contentHtml = `
        <div class="msg-content" style="color:var(--text-3);font-size:13px">${escHtml(filename)}</div>
        <img class="img-preview" src="${url}" alt="${escHtml(filename)}" onclick="openLightbox('${url}')" loading="lazy" />
      `;
    } else {
      const icon = fileIcon(mimetype);
      contentHtml = `
        <a class="file-attachment" href="${url}" target="_blank" download="${escHtml(filename)}">
          <div class="file-icon">${icon}</div>
          <div class="file-info">
            <div class="file-name">${escHtml(filename)}</div>
            <div class="file-size">${formatBytes(size)}</div>
          </div>
          <span style="color:var(--text-3);font-size:18px">â¬‡</span>
        </a>
      `;
    }
  } else {
    contentHtml = `<div class="msg-content">${linkify(escHtml(msg.content))}</div>`;
  }

  el.innerHTML = `
    <div class="msg-avatar"><img src="${avatar}" alt="${escHtml(msg.author)}" /></div>
    <div class="msg-body">
      <div class="msg-header">
        <span class="msg-author">${escHtml(msg.author)}</span>
        <span class="msg-time">${time}</span>
      </div>
      ${contentHtml}
    </div>
  `;

  container.appendChild(el);
}

function scrollToBottom() {
  const m = document.getElementById('messages');
  m.scrollTop = m.scrollHeight;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Send
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sendMessage() {
  const input = document.getElementById('msg-input');
  const content = input.value.trim();
  if (!content) return;
  socket.emit('send_message', { channelId: currentChannel, content });
  input.value = '';
  autoResize(input);
  stopTyping();
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function autoResize(el) {
  el.style.height = '24px';
  el.style.height = Math.min(el.scrollHeight, 200) + 'px';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Typing
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function emitTyping() {
  if (!socket) return;
  socket.emit('typing', { channelId: currentChannel, isTyping: true });
  clearTimeout(typingTimer);
  typingTimer = setTimeout(stopTyping, 2000);
}

function stopTyping() {
  if (!socket) return;
  socket.emit('typing', { channelId: currentChannel, isTyping: false });
  clearTimeout(typingTimer);
}

function renderTyping() {
  const bar = document.getElementById('typing-bar');
  const users = Object.keys(typingUsers).filter(u => u !== currentUser?.username);
  if (users.length === 0) { bar.innerHTML = ''; return; }
  const names = users.join(', ');
  bar.innerHTML = `
    <div class="typing-dots">
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    </div>
    <span>${escHtml(names)} ãŒå…¥åŠ›ä¸­â€¦</span>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Members
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMembers(users) {
  document.getElementById('online-count').textContent = users.length;
  const list = document.getElementById('members-list');
  list.innerHTML = users.map(u => `
    <div class="member-item">
      <div class="member-avatar">
        <img src="https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(u)}" alt="${escHtml(u)}" />
        <div class="member-status"></div>
      </div>
      <div class="member-name">${escHtml(u)}</div>
    </div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// File Upload
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openFilePicker() {
  document.getElementById('file-input').click();
}

async function handleFileSelect(files) {
  if (!files || files.length === 0) return;
  for (const file of files) {
    await uploadFile(file);
  }
}

async function uploadFile(file) {
  showUploadToast(`${file.name} ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...`);

  const formData = new FormData();
  formData.append('file', file);

  try {
    const res = await fetch(`${API}/api/upload`, {
      method: 'POST',
      headers: { Authorization: `Bearer ${token}` },
      body: formData
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || 'Upload failed');
    }

    const fileInfo = await res.json();
    socket.emit('send_file', { channelId: currentChannel, fileInfo });
    hideUploadToast();
  } catch (err) {
    hideUploadToast();
    alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ' + err.message);
  }

  // Reset file input
  document.getElementById('file-input').value = '';
}

function showUploadToast(msg) {
  document.getElementById('upload-label').textContent = msg;
  document.getElementById('upload-toast').classList.add('show');
}
function hideUploadToast() {
  setTimeout(() => document.getElementById('upload-toast').classList.remove('show'), 500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Lightbox
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openLightbox(src) {
  document.getElementById('lightbox-img').src = src;
  document.getElementById('lightbox').classList.add('open');
}
function closeLightbox() {
  document.getElementById('lightbox').classList.remove('open');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function linkify(text) {
  return text.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener" style="color:var(--accent)">$1</a>');
}

function formatBytes(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function fileIcon(mimetype = '') {
  if (mimetype.startsWith('image/')) return 'ğŸ–¼ï¸';
  if (mimetype.startsWith('video/')) return 'ğŸ¬';
  if (mimetype.startsWith('audio/')) return 'ğŸµ';
  if (mimetype.includes('pdf'))      return 'ğŸ“„';
  if (mimetype.includes('zip') || mimetype.includes('rar') || mimetype.includes('7z')) return 'ğŸ“¦';
  if (mimetype.includes('word') || mimetype.includes('document')) return 'ğŸ“';
  if (mimetype.includes('excel') || mimetype.includes('spreadsheet')) return 'ğŸ“Š';
  return 'ğŸ“';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Auto-login if token exists
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async () => {
  if (!token) return;
  try {
    const res  = await fetch(`${API}/api/me`, { headers: { Authorization: `Bearer ${token}` } });
    if (!res.ok) { localStorage.removeItem('token'); return; }
    const user = await res.json();
    currentUser = user;
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('app').classList.add('visible');
    initApp();
  } catch {
    localStorage.removeItem('token');
  }
})();
</script>
</body>
</html>
