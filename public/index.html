<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>NexusChat</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<style>
:root {
  --bg-void:#0a0b0f; --bg-dark:#0f1117; --bg-mid:#161820;
  --bg-panel:#1c1f2a; --bg-hover:#252836; --bg-active:#2d3147;
  --border:rgba(255,255,255,0.07); --accent:#5865f2; --accent-glow:rgba(88,101,242,0.3);
  --accent-2:#eb459e; --green:#3ba55d; --yellow:#faa61a; --red:#ed4245;
  --text-1:#e3e5e8; --text-2:#b9bbbe; --text-3:#72767d; --text-muted:#4f545c;
  --font-main:'Outfit',sans-serif; --font-mono:'JetBrains Mono',monospace;
  --radius:8px; --radius-lg:14px; --sidebar-w:240px; --server-w:72px;
  --members-w:220px; --font-size:15px;
}
body.theme-light {
  --bg-void:#e3e5e8; --bg-dark:#ebedef; --bg-mid:#f2f3f5; --bg-panel:#ffffff;
  --bg-hover:#d9dadc; --bg-active:#c3c4c7; --border:rgba(0,0,0,0.1);
  --text-1:#060607; --text-2:#2e3338; --text-3:#4f5660; --text-muted:#96989d;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;font-family:var(--font-main);font-size:var(--font-size);background:var(--bg-void);color:var(--text-1);overflow:hidden;user-select:none;}
#app{display:none;height:100vh;height:100dvh;flex-direction:row;}
#app.visible{display:flex;}

/* ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ */
#auth-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg-void);z-index:1000;}
.auth-bg{position:absolute;inset:0;background:radial-gradient(ellipse 60% 50% at 20% 30%,rgba(88,101,242,0.15) 0%,transparent 70%),radial-gradient(ellipse 50% 40% at 80% 70%,rgba(235,69,158,0.1) 0%,transparent 70%);}
.auth-card{position:relative;width:420px;background:var(--bg-panel);border:1px solid var(--border);border-radius:20px;padding:40px;box-shadow:0 32px 80px rgba(0,0,0,0.6);animation:cardIn 0.4s cubic-bezier(0.16,1,0.3,1);}
@keyframes cardIn{from{opacity:0;transform:translateY(24px) scale(0.97)}to{opacity:1;transform:none}}
.auth-logo{display:flex;align-items:center;gap:12px;margin-bottom:28px;}
.auth-logo-icon{width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 0 24px var(--accent-glow);}
.auth-logo-text{font-size:24px;font-weight:700;background:linear-gradient(135deg,#fff 30%,var(--text-2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.auth-title{font-size:22px;font-weight:600;margin-bottom:6px;} .auth-subtitle{font-size:14px;color:var(--text-3);margin-bottom:28px;}
.tab-switcher{display:flex;background:var(--bg-mid);border-radius:var(--radius);padding:4px;margin-bottom:24px;gap:4px;}
.tab-btn{flex:1;padding:8px;border:none;background:transparent;color:var(--text-3);font-family:var(--font-main);font-size:14px;font-weight:500;border-radius:6px;cursor:pointer;transition:all 0.2s;}
.tab-btn.active{background:var(--accent);color:#fff;box-shadow:0 2px 8px var(--accent-glow);}
.field-label{display:block;font-size:12px;font-weight:600;color:var(--text-3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;}
.field-input{width:100%;padding:12px 14px;background:var(--bg-dark);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-1);font-family:var(--font-main);font-size:15px;outline:none;transition:all 0.2s;margin-bottom:16px;}
.field-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow);}
.field-input::placeholder{color:var(--text-muted);}
.auth-btn{width:100%;padding:13px;background:linear-gradient(135deg,var(--accent),#4752c4);border:none;border-radius:var(--radius);color:#fff;font-family:var(--font-main);font-size:15px;font-weight:600;cursor:pointer;transition:all 0.2s;box-shadow:0 4px 16px var(--accent-glow);}
.auth-btn:hover{opacity:0.9;} .auth-btn:active{transform:scale(0.98);}
.auth-error{margin-top:12px;padding:10px 14px;background:rgba(237,66,69,0.15);border:1px solid rgba(237,66,69,0.3);border-radius:var(--radius);color:var(--red);font-size:13px;display:none;}
.auth-error.show{display:block;}

/* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
.server-list{width:var(--server-w);background:var(--bg-void);display:flex;flex-direction:column;align-items:center;padding:12px 0;gap:8px;overflow-y:auto;flex-shrink:0;border-right:1px solid var(--border);}
.server-icon{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;transition:all 0.2s;position:relative;}
.server-icon:hover,.server-icon.active{border-radius:30%;box-shadow:0 0 0 3px var(--accent-glow);}
.server-sep{width:32px;height:2px;background:var(--bg-panel);border-radius:1px;}

/* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
.sidebar{width:var(--sidebar-w);background:var(--bg-dark);display:flex;flex-direction:column;flex-shrink:0;border-right:1px solid var(--border);}
.sidebar-header{padding:16px;border-bottom:1px solid var(--border);font-weight:700;font-size:15px;display:flex;align-items:center;justify-content:space-between;}
.channels-section{flex:1;overflow-y:auto;padding:8px 0;}
.ch-category{padding:16px 8px 4px 16px;font-size:11px;font-weight:700;color:var(--text-3);text-transform:uppercase;letter-spacing:0.8px;display:flex;align-items:center;justify-content:space-between;}
.ch-category-btn{background:none;border:none;color:var(--text-3);cursor:pointer;font-size:16px;padding:2px 6px;border-radius:4px;transition:all 0.15s;}
.ch-category-btn:hover{background:var(--bg-hover);color:var(--text-1);}
.ch-item{display:flex;align-items:center;gap:8px;padding:7px 8px 7px 16px;margin:1px 8px;border-radius:6px;cursor:pointer;color:var(--text-3);font-size:15px;font-weight:500;transition:all 0.15s;position:relative;}
.ch-item:hover{background:var(--bg-hover);color:var(--text-2);}
.ch-item.active{background:var(--bg-active);color:var(--text-1);}
.ch-item .ch-icon{font-size:16px;flex-shrink:0;}
.ch-readonly-badge{font-size:10px;background:rgba(250,166,26,0.2);color:var(--yellow);border-radius:4px;padding:1px 4px;margin-left:auto;}
.ch-item .unread-badge{margin-left:auto;background:var(--red);color:#fff;font-size:11px;font-weight:700;border-radius:10px;padding:1px 6px;min-width:18px;text-align:center;display:none;}
.ch-item.unread .unread-badge{display:block;}
.user-panel{padding:10px 8px;background:var(--bg-void);display:flex;align-items:center;gap:8px;border-top:1px solid var(--border);}
.user-avatar{width:32px;height:32px;border-radius:50%;position:relative;flex-shrink:0;}
.user-avatar img{width:100%;height:100%;border-radius:50%;object-fit:cover;}
.user-status-dot{position:absolute;bottom:-1px;right:-1px;width:10px;height:10px;border-radius:50%;background:var(--green);border:2px solid var(--bg-void);}
.user-status-dot.away{background:var(--yellow);}
.user-status-dot.busy{background:var(--red);}
.user-info{flex:1;min-width:0;}
.user-name{font-size:13px;font-weight:600;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.user-tag{font-size:11px;color:var(--text-3);font-family:var(--font-mono);}
.user-actions{display:flex;gap:2px;}
.user-action-btn{width:28px;height:28px;border:none;background:transparent;color:var(--text-3);border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all 0.15s;}
.user-action-btn:hover{background:var(--bg-hover);color:var(--text-1);}

/* ‚îÄ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ‚îÄ */
.chat-area{flex:1;display:flex;flex-direction:column;min-width:0;background:var(--bg-mid);}
.chat-header{height:48px;padding:0 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0;background:var(--bg-mid);}
.chat-header-icon{font-size:18px;color:var(--text-3);}
.chat-header-name{font-size:16px;font-weight:700;}
.chat-header-sep{width:1px;height:20px;background:var(--border);margin:0 4px;}
.chat-header-topic{font-size:13px;color:var(--text-3);overflow:hidden;white-space:nowrap;text-overflow:ellipsis;flex:1;cursor:pointer;}
.chat-header-topic:hover{color:var(--text-2);}
.chat-header-actions{display:flex;gap:2px;margin-left:auto;}
.header-btn{width:32px;height:32px;border:none;background:transparent;color:var(--text-3);border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all 0.15s;}
.header-btn:hover{background:var(--bg-hover);color:var(--text-1);}
.header-btn.active{color:var(--accent);}

/* ‚îÄ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ‚îÄ */
.search-bar{padding:8px 16px;border-bottom:1px solid var(--border);background:var(--bg-mid);display:none;gap:8px;align-items:center;}
.search-bar.open{display:flex;}
.search-input{flex:1;padding:8px 12px;background:var(--bg-panel);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-1);font-family:var(--font-main);font-size:14px;outline:none;}
.search-input:focus{border-color:var(--accent);}
.search-input::placeholder{color:var(--text-muted);}
.search-scope{padding:6px 10px;background:var(--bg-dark);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-2);font-family:var(--font-main);font-size:13px;cursor:pointer;outline:none;}
.search-filters{display:flex;gap:6px;padding:6px 16px;border-bottom:1px solid var(--border);background:var(--bg-dark);display:none;flex-wrap:wrap;}
.search-filters.open{display:flex;}
.search-filter-input{padding:5px 10px;background:var(--bg-mid);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-1);font-family:var(--font-main);font-size:13px;outline:none;width:130px;}
.search-results{padding:8px 16px;border-bottom:1px solid var(--border);background:var(--bg-dark);display:none;flex-direction:column;gap:4px;max-height:200px;overflow-y:auto;}
.search-results.open{display:flex;}
.search-result-item{padding:8px;border-radius:6px;cursor:pointer;transition:background 0.15s;}
.search-result-item:hover{background:var(--bg-hover);}
.search-result-author{font-size:12px;font-weight:600;color:var(--accent);}
.search-result-content{font-size:13px;color:var(--text-2);overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.search-result-meta{font-size:11px;color:var(--text-3);}

/* ‚îÄ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ‚îÄ */
.messages{flex:1;overflow-y:auto;padding:16px 0;display:flex;flex-direction:column;gap:2px;scroll-behavior:smooth;}
.messages::-webkit-scrollbar{width:4px;}
.messages::-webkit-scrollbar-thumb{background:var(--bg-hover);border-radius:2px;}
.msg{display:flex;gap:14px;padding:4px 16px;border-radius:4px;transition:background 0.1s;position:relative;animation:msgIn 0.2s ease-out;}
.msg.grouped{padding-top:1px;}
.msg.grouped .msg-avatar{visibility:hidden;}
.msg.grouped .msg-header{display:none;}
@keyframes msgIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.msg:hover{background:rgba(0,0,0,0.1);}
.msg.mention-highlight{background:rgba(250,166,26,0.08) !important;border-left:3px solid var(--yellow);padding-left:13px;}
.msg.thread-reply{border-left:3px solid var(--accent);padding-left:13px;background:rgba(88,101,242,0.04);}
.msg:hover .msg-actions{opacity:1;}
.msg-avatar{width:40px;height:40px;border-radius:50%;flex-shrink:0;cursor:pointer;margin-top:2px;}
.msg-avatar img{width:100%;height:100%;border-radius:50%;object-fit:cover;}
.msg-body{flex:1;min-width:0;}
.msg-header{display:flex;align-items:baseline;gap:8px;margin-bottom:3px;flex-wrap:wrap;}
.msg-author{font-size:15px;font-weight:600;color:var(--text-1);cursor:pointer;}
.msg-author:hover{text-decoration:underline;}
.msg-time{font-size:11px;color:var(--text-muted);font-family:var(--font-mono);}
.msg-edited{font-size:11px;color:var(--text-muted);font-style:italic;}
.msg-content{font-size:var(--font-size);color:var(--text-2);line-height:1.5;word-break:break-word;user-select:text;}
.mention{color:var(--accent);background:rgba(88,101,242,0.15);border-radius:3px;padding:0 2px;font-weight:600;}
.role-badge{font-size:10px;padding:1px 5px;border-radius:4px;font-weight:700;text-transform:uppercase;}
.role-badge.admin{background:rgba(237,66,69,0.2);color:var(--red);}
.role-badge.moderator{background:rgba(250,166,26,0.2);color:var(--yellow);}
.msg-thread-btn{font-size:12px;color:var(--accent);cursor:pointer;margin-top:4px;display:inline-block;}
.msg-thread-btn:hover{text-decoration:underline;}

/* „É°„ÉÉ„Çª„Éº„Ç∏„Ç¢„ÇØ„Ç∑„Éß„É≥ */
.msg-actions{position:absolute;top:-14px;right:16px;background:var(--bg-panel);border:1px solid var(--border);border-radius:8px;display:flex;gap:2px;padding:3px;opacity:0;transition:opacity 0.15s;z-index:10;box-shadow:0 4px 12px rgba(0,0,0,0.3);}
.msg-action-btn{width:28px;height:28px;border:none;background:transparent;color:var(--text-3);border-radius:5px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all 0.1s;}
.msg-action-btn:hover{background:var(--bg-hover);color:var(--text-1);}
.msg-action-btn.danger:hover{background:rgba(237,66,69,0.2);color:var(--red);}
.msg-edit-area{margin-top:6px;display:none;}
.msg-edit-area.active{display:block;}
.msg-edit-input{width:100%;padding:8px 12px;background:var(--bg-dark);border:1px solid var(--accent);border-radius:var(--radius);color:var(--text-1);font-family:var(--font-main);font-size:14px;outline:none;resize:none;}
.msg-edit-btns{display:flex;gap:6px;margin-top:6px;}
.edit-save-btn,.edit-cancel-btn{padding:5px 12px;border:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;}
.edit-save-btn{background:var(--accent);color:#fff;}
.edit-cancel-btn{background:var(--bg-hover);color:var(--text-2);}

/* „É™„Ç¢„ÇØ„Ç∑„Éß„É≥ */
.reactions{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px;}
.reaction-pill{display:inline-flex;align-items:center;gap:4px;background:var(--bg-panel);border:1px solid var(--border);border-radius:12px;padding:2px 8px;font-size:13px;cursor:pointer;transition:all 0.15s;user-select:none;}
.reaction-pill:hover{border-color:var(--accent);}
.reaction-pill.reacted{border-color:var(--accent);background:rgba(88,101,242,0.15);color:var(--accent);}
.reaction-count{font-size:12px;font-weight:600;color:var(--text-2);}

/* Êú™Ë™≠„Éá„Ç£„Éê„Ç§„ÉÄ„Éº */
.unread-divider{display:flex;align-items:center;gap:8px;padding:8px 16px;margin:4px 0;}
.unread-divider::before,.unread-divider::after{content:'';flex:1;height:1px;background:var(--red);}
.unread-divider-label{font-size:11px;font-weight:700;color:var(--red);white-space:nowrap;}

/* „Éï„Ç°„Ç§„É´„ÉªÁîªÂÉè */
.file-attachment{display:inline-flex;align-items:center;gap:12px;background:var(--bg-panel);border:1px solid var(--border);border-radius:var(--radius);padding:12px 14px;margin-top:6px;max-width:420px;text-decoration:none;transition:border-color 0.2s;}
.file-attachment:hover{border-color:var(--accent);}
.file-icon{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.file-info{flex:1;min-width:0;}
.file-name{font-size:14px;font-weight:600;color:var(--text-1);overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.file-size{font-size:12px;color:var(--text-3);margin-top:2px;}
.img-preview{max-width:400px;max-height:300px;border-radius:var(--radius);margin-top:6px;cursor:zoom-in;display:block;border:1px solid var(--border);object-fit:cover;}

/* „Çø„Ç§„Éî„É≥„Ç∞ */
.typing-bar{height:20px;padding:0 16px;font-size:13px;color:var(--text-3);display:flex;align-items:center;gap:6px;}
.typing-dots{display:flex;gap:3px;}
.typing-dot{width:5px;height:5px;border-radius:50%;background:var(--text-3);animation:typingBounce 1.2s infinite;}
.typing-dot:nth-child(2){animation-delay:0.2s;} .typing-dot:nth-child(3){animation-delay:0.4s;}
@keyframes typingBounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-4px)}}

/* ÂÖ•Âäõ„Éê„Éº */
.input-bar{padding:0 16px 16px;flex-shrink:0;}
.reply-preview{background:var(--bg-panel);border-left:3px solid var(--accent);padding:6px 12px;margin-bottom:6px;border-radius:4px;display:none;align-items:center;justify-content:space-between;gap:8px;}
.reply-preview.show{display:flex;}
.reply-preview-text{font-size:13px;color:var(--text-2);overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.reply-close-btn{background:none;border:none;color:var(--text-3);cursor:pointer;font-size:16px;flex-shrink:0;}
.input-box{background:var(--bg-panel);border:1px solid var(--border);border-radius:var(--radius-lg);display:flex;align-items:center;gap:6px;padding:6px 6px 6px 14px;transition:border-color 0.2s;}
.input-box:focus-within{border-color:rgba(88,101,242,0.5);}
.attach-btn,.emoji-btn{width:36px;height:36px;border:none;background:transparent;color:var(--text-3);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;transition:all 0.15s;}
.attach-btn:hover,.emoji-btn:hover{background:var(--bg-hover);color:var(--text-1);}
.msg-input{flex:1;border:none;background:transparent;color:var(--text-1);font-family:var(--font-main);font-size:var(--font-size);outline:none;resize:none;min-height:24px;max-height:200px;line-height:1.5;padding:4px 0;}
.msg-input::placeholder{color:var(--text-muted);}
.send-btn{width:36px;height:36px;border:none;background:var(--accent);color:#fff;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;transition:all 0.15s;box-shadow:0 2px 8px var(--accent-glow);}
.send-btn:hover{background:#4752c4;transform:scale(1.05);}
.send-btn:active{transform:scale(0.95);}
.input-hint{font-size:11px;color:var(--text-muted);padding:4px 6px 0;display:flex;gap:12px;}
kbd{background:var(--bg-panel);border:1px solid var(--border);border-radius:4px;padding:1px 5px;font-size:10px;}

/* ÁµµÊñáÂ≠ó„Éî„ÉÉ„Ç´„Éº */
.emoji-picker{position:absolute;bottom:80px;left:16px;background:var(--bg-panel);border:1px solid var(--border);border-radius:var(--radius-lg);padding:12px;box-shadow:0 16px 40px rgba(0,0,0,0.4);z-index:500;display:none;width:320px;}
.emoji-picker.open{display:block;}
.emoji-categories{display:flex;gap:4px;margin-bottom:8px;overflow-x:auto;}
.emoji-cat-btn{padding:4px 6px;border:none;background:transparent;color:var(--text-3);border-radius:6px;cursor:pointer;font-size:16px;flex-shrink:0;transition:all 0.15s;}
.emoji-cat-btn:hover,.emoji-cat-btn.active{background:var(--bg-hover);color:var(--text-1);}
.emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:2px;max-height:200px;overflow-y:auto;}
.emoji-btn-item{width:32px;height:32px;border:none;background:transparent;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;transition:background 0.1s;}
.emoji-btn-item:hover{background:var(--bg-hover);}
.custom-emoji-img{width:24px;height:24px;object-fit:contain;}

/* „É°„É≥„Éê„Éº„Éë„Éç„É´ */
.members-panel{width:var(--members-w);background:var(--bg-dark);border-left:1px solid var(--border);overflow-y:auto;flex-shrink:0;}
.members-header{padding:16px;font-size:11px;font-weight:700;color:var(--text-3);text-transform:uppercase;letter-spacing:0.8px;}
.member-item{display:flex;align-items:center;gap:10px;padding:6px 12px;margin:1px 8px;border-radius:6px;cursor:pointer;transition:background 0.15s;}
.member-item:hover{background:var(--bg-hover);}
.member-avatar{width:32px;height:32px;border-radius:50%;position:relative;flex-shrink:0;}
.member-avatar img{width:100%;height:100%;border-radius:50%;object-fit:cover;}
.member-status-dot{position:absolute;bottom:-1px;right:-1px;width:10px;height:10px;border-radius:50%;border:2px solid var(--bg-dark);}
.member-status-dot.online{background:var(--green);}
.member-status-dot.away{background:var(--yellow);}
.member-status-dot.busy{background:var(--red);}
.member-name{font-size:13px;font-weight:500;color:var(--text-2);overflow:hidden;white-space:nowrap;flex:1;}
.member-name.muted-user{text-decoration:line-through;opacity:0.5;}
.member-badge{font-size:10px;padding:1px 4px;border-radius:4px;font-weight:700;}
.member-badge.admin{background:rgba(237,66,69,0.2);color:var(--red);}
.member-badge.moderator{background:rgba(250,166,26,0.2);color:var(--yellow);}
.member-badge.banned{background:rgba(237,66,69,0.15);color:var(--red);}

/* „É¢„Éº„ÉÄ„É´ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:2000;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--bg-panel);border:1px solid var(--border);border-radius:20px;width:560px;max-width:calc(100vw - 32px);max-height:85vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 32px 80px rgba(0,0,0,0.6);animation:cardIn 0.3s cubic-bezier(0.16,1,0.3,1);}
.modal.wide{width:700px;}
.modal-header{padding:20px 24px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.modal-title{font-size:18px;font-weight:700;}
.modal-close{width:32px;height:32px;border:none;background:transparent;color:var(--text-3);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;transition:all 0.15s;}
.modal-close:hover{background:var(--bg-hover);color:var(--text-1);}
.modal-body{padding:20px 24px;overflow-y:auto;display:flex;flex-direction:column;gap:20px;}
.modal-tabs{display:flex;gap:4px;border-bottom:1px solid var(--border);padding:0 24px;}
.modal-tab{padding:10px 16px;border:none;background:transparent;color:var(--text-3);font-family:var(--font-main);font-size:14px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all 0.15s;}
.modal-tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.modal-tab-pane{display:none;} .modal-tab-pane.active{display:block;}

/* Ë®≠ÂÆö„Çπ„Çø„Ç§„É´ */
.settings-section-title{font-size:11px;font-weight:700;color:var(--text-3);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:12px;}
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--bg-mid);border-radius:var(--radius);margin-bottom:8px;}
.settings-row-label{font-size:14px;font-weight:500;color:var(--text-1);}
.settings-row-desc{font-size:12px;color:var(--text-3);margin-top:2px;}
.toggle{width:44px;height:24px;background:var(--bg-hover);border-radius:12px;position:relative;cursor:pointer;transition:background 0.2s;flex-shrink:0;}
.toggle.on{background:var(--accent);}
.toggle::after{content:'';position:absolute;top:2px;left:2px;width:20px;height:20px;border-radius:50%;background:#fff;transition:transform 0.2s;box-shadow:0 2px 4px rgba(0,0,0,0.3);}
.toggle.on::after{transform:translateX(20px);}
.settings-select{padding:6px 10px;background:var(--bg-dark);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-1);font-family:var(--font-main);font-size:14px;cursor:pointer;outline:none;}
.theme-options{display:flex;gap:8px;}
.theme-opt{flex:1;padding:10px;border:2px solid var(--border);border-radius:var(--radius);cursor:pointer;text-align:center;font-size:13px;font-weight:500;transition:all 0.15s;background:var(--bg-mid);color:var(--text-2);}
.theme-opt:hover{border-color:var(--accent);}
.theme-opt.active{border-color:var(--accent);background:rgba(88,101,242,0.15);color:var(--accent);}
.font-slider{width:100%;accent-color:var(--accent);cursor:pointer;}
.danger-btn{padding:10px 16px;background:rgba(237,66,69,0.15);border:1px solid rgba(237,66,69,0.3);border-radius:var(--radius);color:var(--red);font-family:var(--font-main);font-size:14px;font-weight:600;cursor:pointer;width:100%;transition:all 0.2s;}
.danger-btn:hover{background:rgba(237,66,69,0.3);}
.primary-btn{padding:10px 16px;background:var(--accent);border:none;border-radius:var(--radius);color:#fff;font-family:var(--font-main);font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s;}
.primary-btn:hover{background:#4752c4;}
.secondary-btn{padding:8px 14px;background:var(--bg-hover);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-2);font-family:var(--font-main);font-size:13px;font-weight:500;cursor:pointer;transition:all 0.15s;}
.secondary-btn:hover{background:var(--bg-active);}
.tag-input-container{display:flex;flex-wrap:wrap;gap:6px;padding:8px;background:var(--bg-dark);border:1px solid var(--border);border-radius:var(--radius);min-height:44px;}
.keyword-tag{display:flex;align-items:center;gap:4px;background:rgba(88,101,242,0.2);color:var(--accent);padding:2px 8px;border-radius:12px;font-size:13px;}
.keyword-tag button{background:none;border:none;color:var(--accent);cursor:pointer;font-size:14px;line-height:1;}
.tag-input{border:none;background:transparent;color:var(--text-1);font-family:var(--font-main);font-size:14px;outline:none;min-width:80px;}

/* „Éî„É≥„ÉªÁÆ°ÁêÜËÄÖ */
.pin-item{display:flex;gap:12px;padding:12px;background:var(--bg-mid);border-radius:var(--radius);border:1px solid var(--border);}
.pin-item-body{flex:1;min-width:0;}
.pin-item-author{font-size:13px;font-weight:600;margin-bottom:2px;}
.pin-item-content{font-size:13px;color:var(--text-2);}
.pin-item-meta{font-size:11px;color:var(--text-3);margin-top:4px;}
.pin-unpin-btn{padding:4px 10px;border:none;background:rgba(237,66,69,0.15);color:var(--red);border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;}
.admin-user-row{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg-mid);border-radius:var(--radius);margin-bottom:6px;}
.admin-user-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;}
.admin-user-name{flex:1;font-size:14px;font-weight:500;}
.role-select{padding:5px 8px;background:var(--bg-dark);border:1px solid var(--border);border-radius:6px;color:var(--text-1);font-size:13px;cursor:pointer;}
.admin-action-btn{padding:5px 10px;border:none;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;}
.mute-btn{background:rgba(250,166,26,0.15);color:var(--yellow);}
.mute-btn:hover{background:rgba(250,166,26,0.3);}
.ban-btn{background:rgba(237,66,69,0.15);color:var(--red);}
.ban-btn:hover{background:rgba(237,66,69,0.3);}

/* „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ */
.bookmark-item{padding:12px;background:var(--bg-mid);border-radius:var(--radius);border:1px solid var(--border);cursor:pointer;transition:border-color 0.15s;}
.bookmark-item:hover{border-color:var(--accent);}
.bookmark-author{font-size:13px;font-weight:600;color:var(--accent);margin-bottom:4px;}
.bookmark-content{font-size:13px;color:var(--text-2);overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.bookmark-meta{font-size:11px;color:var(--text-3);margin-top:4px;display:flex;align-items:center;justify-content:space-between;}
.bookmark-remove-btn{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px;}
.bookmark-remove-btn:hover{color:var(--red);}

/* ÊãõÂæÖ */
.invite-row{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg-mid);border-radius:var(--radius);margin-bottom:6px;}
.invite-code{font-family:var(--font-mono);font-size:14px;font-weight:600;color:var(--accent);flex:1;}
.invite-meta{font-size:12px;color:var(--text-3);}
.invite-copy-btn{padding:4px 10px;border:none;background:var(--accent);color:#fff;border-radius:6px;font-size:12px;cursor:pointer;}

/* „ÉÅ„É£„É≥„Éç„É´ÁÆ°ÁêÜ */
.ch-manage-row{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg-mid);border-radius:var(--radius);margin-bottom:6px;}
.ch-manage-name{flex:1;font-size:14px;font-weight:500;}
.ch-edit-btn{padding:4px 10px;border:none;background:var(--bg-hover);color:var(--text-2);border-radius:6px;font-size:12px;cursor:pointer;}
.ch-del-btn{padding:4px 10px;border:none;background:rgba(237,66,69,0.15);color:var(--red);border-radius:6px;font-size:12px;cursor:pointer;}

/* „Ç´„Çπ„Çø„É†ÁµµÊñáÂ≠óÁÆ°ÁêÜ */
.emoji-manage-row{display:flex;align-items:center;gap:10px;padding:8px;background:var(--bg-mid);border-radius:var(--radius);margin-bottom:6px;}
.emoji-manage-preview{width:32px;height:32px;object-fit:contain;}
.emoji-manage-name{flex:1;font-size:13px;font-family:var(--font-mono);}

/* „Çª„ÉÉ„Ç∑„Éß„É≥ */
.session-row{padding:10px;background:var(--bg-mid);border-radius:var(--radius);margin-bottom:6px;}
.session-ip{font-size:13px;font-weight:600;color:var(--text-1);}
.session-meta{font-size:12px;color:var(--text-3);margin-top:3px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}

/* „Éà„Éº„Çπ„Éà */
.upload-toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(10px);background:var(--bg-panel);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px 18px;display:flex;align-items:center;gap:12px;box-shadow:0 16px 40px rgba(0,0,0,0.5);z-index:2000;min-width:280px;opacity:0;transition:all 0.3s;pointer-events:none;}
.upload-toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.upload-spinner{width:20px;height:20px;border:2px solid var(--bg-hover);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0;}
@keyframes spin{to{transform:rotate(360deg)}}
.toast-notif{position:fixed;top:16px;right:16px;z-index:4000;background:var(--bg-panel);border:1px solid var(--border);border-radius:var(--radius-lg);padding:12px 16px;display:flex;align-items:center;gap:12px;box-shadow:0 8px 24px rgba(0,0,0,0.4);min-width:260px;max-width:360px;animation:toastIn 0.3s cubic-bezier(0.16,1,0.3,1);cursor:pointer;}
@keyframes toastIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
.toast-notif-icon{font-size:20px;flex-shrink:0;}
.toast-notif-body{flex:1;}
.toast-notif-title{font-size:13px;font-weight:600;}
.toast-notif-text{font-size:12px;color:var(--text-3);margin-top:2px;}

/* „Éü„É•„Éº„Éà„Éê„Éä„Éº */
.muted-banner{background:rgba(250,166,26,0.1);border:1px solid rgba(250,166,26,0.3);border-radius:var(--radius);padding:10px 14px;font-size:13px;color:var(--yellow);display:none;margin:0 16px 8px;}
.muted-banner.show{display:block;}

/* DMÊó¢Ë™≠ */
.dm-read-receipt{font-size:11px;color:var(--text-muted);text-align:right;margin-top:2px;}
.dm-read-receipt.read{color:var(--accent);}

/* „Åù„ÅÆ‰ªñ */
.drop-overlay{display:none;position:fixed;inset:0;background:rgba(88,101,242,0.15);border:3px dashed var(--accent);border-radius:16px;margin:16px;z-index:999;align-items:center;justify-content:center;flex-direction:column;gap:16px;font-size:24px;color:var(--accent);backdrop-filter:blur(4px);}
.drop-overlay.active{display:flex;}
.lightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:3000;align-items:center;justify-content:center;cursor:zoom-out;backdrop-filter:blur(8px);}
.lightbox.open{display:flex;}
.lightbox img{max-width:90vw;max-height:90vh;border-radius:var(--radius);}
.welcome-msg{padding:32px 16px 16px;border-bottom:1px solid var(--border);margin-bottom:8px;}
.welcome-icon{width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:28px;margin-bottom:16px;}
.welcome-title{font-size:24px;font-weight:700;margin-bottom:6px;}
.welcome-sub{font-size:15px;color:var(--text-3);}

/* OGP Preview Cards */
.ogp-card{display:flex;gap:0;background:var(--bg-panel);border:1px solid var(--border);border-radius:var(--radius);margin-top:8px;max-width:440px;overflow:hidden;text-decoration:none;transition:border-color 0.2s;}
.ogp-card:hover{border-color:var(--accent);}
.ogp-card-accent{width:4px;background:var(--accent);flex-shrink:0;}
.ogp-card-body{padding:12px;flex:1;min-width:0;}
.ogp-card-site{font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;}
.ogp-card-title{font-size:14px;font-weight:600;color:var(--text-1);margin-bottom:4px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.ogp-card-desc{font-size:12px;color:var(--text-3);line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.ogp-card-img{width:80px;min-width:80px;height:80px;object-fit:cover;flex-shrink:0;}

/* Voice Channel */
.voice-panel{position:fixed;bottom:60px;left:72px;width:220px;background:var(--bg-dark);border:1px solid var(--border);border-radius:var(--radius-lg);padding:12px;z-index:1500;box-shadow:0 8px 32px rgba(0,0,0,0.5);display:none;}
.voice-panel.open{display:block;}
.voice-panel-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.voice-panel-title{font-size:12px;font-weight:700;color:var(--green);display:flex;align-items:center;gap:6px;}
.voice-pulse{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 1.5s infinite;}
.voice-participants-list{display:flex;flex-direction:column;gap:4px;margin-bottom:10px;}
.voice-participant{display:flex;align-items:center;gap:8px;padding:4px 6px;border-radius:6px;font-size:13px;color:var(--text-2);}
.voice-participant-dot{width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0;}
.voice-controls{display:flex;gap:6px;}
.voice-ctrl-btn{flex:1;padding:7px;border:none;border-radius:var(--radius);font-size:12px;font-weight:600;cursor:pointer;font-family:var(--font-main);transition:all 0.15s;}
.voice-mute-btn{background:rgba(250,166,26,0.15);color:var(--yellow);}
.voice-mute-btn:hover{background:rgba(250,166,26,0.3);}
.voice-mute-btn.muted{background:rgba(237,66,69,0.2);color:var(--red);}
.voice-leave-btn{background:rgba(237,66,69,0.15);color:var(--red);}
.voice-leave-btn:hover{background:rgba(237,66,69,0.3);}
.ch-voice-item{display:flex;align-items:center;gap:8px;padding:5px 8px 5px 16px;margin:1px 8px;border-radius:6px;cursor:pointer;color:var(--text-3);font-size:14px;font-weight:500;transition:all 0.15s;}
.ch-voice-item:hover{background:var(--bg-hover);color:var(--text-2);}
.ch-voice-item.active-voice{background:var(--bg-active);color:var(--green);}
.ch-voice-users{padding-left:40px;}
.ch-voice-user{font-size:12px;color:var(--text-3);padding:2px 0;display:flex;align-items:center;gap:6px;}
.voice-dot-sm{width:6px;height:6px;border-radius:50%;background:var(--green);flex-shrink:0;}

*{scrollbar-width:thin;scrollbar-color:var(--bg-hover) transparent;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

/* ‚îÄ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ‚îÄ */
.mobile-menu-btn,.mobile-members-btn{display:none;width:36px;height:36px;border:none;background:transparent;color:var(--text-2);border-radius:8px;cursor:pointer;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.drawer-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:200;backdrop-filter:blur(2px);}
.drawer-overlay.open{display:block;}
@media(max-width:900px){
.members-panel{position:fixed;right:0;top:0;bottom:0;z-index:300;transform:translateX(100%);transition:transform 0.28s cubic-bezier(0.16,1,0.3,1);box-shadow:-8px 0 32px rgba(0,0,0,0.4);}
.members-panel.open{transform:translateX(0);}
.mobile-members-btn{display:flex;}
}
@media(max-width:640px){
.server-list{display:none;}
.sidebar{position:fixed;left:0;top:0;bottom:0;z-index:300;transform:translateX(-100%);transition:transform 0.28s cubic-bezier(0.16,1,0.3,1);box-shadow:8px 0 32px rgba(0,0,0,0.4);width:min(280px,85vw);}
.sidebar.open{transform:translateX(0);}
.mobile-menu-btn{display:flex;}
.auth-card{width:calc(100vw - 32px);padding:28px 20px;border-radius:16px;}
.chat-header{height:52px;padding:0 8px 0 4px;}
.chat-header-sep,.chat-header-topic{display:none;}
.messages{padding:8px 0;}
.msg{padding:4px 8px;gap:10px;}
.msg-avatar{width:34px;height:34px;}
.msg-content{font-size:14px;}
.msg-actions{position:static;opacity:1;background:transparent;border:none;box-shadow:none;padding:2px 0;margin-top:2px;margin-left:44px;}
.msg:hover{background:transparent;}
.img-preview{max-width:100%;max-height:240px;}
.file-attachment{max-width:100%;}
.input-bar{padding:0 8px calc(8px + env(safe-area-inset-bottom)) 8px;}
.input-hint{display:none !important;}
.msg-input{font-size:16px;}
.emoji-picker{position:fixed;left:0;right:0;bottom:0;width:100%;border-radius:16px 16px 0 0;padding-bottom:env(safe-area-inset-bottom);z-index:600;}
.modal{width:100vw;max-width:100vw;max-height:92vh;border-radius:20px 20px 0 0;position:fixed;bottom:0;left:0;right:0;}
.modal-overlay{align-items:flex-end;}
.members-panel{width:min(280px,85vw);}
.toast-notif{right:8px;top:8px;max-width:calc(100vw - 16px);}
}
@media(max-width:360px){.emoji-grid{grid-template-columns:repeat(7,1fr);}}
@media(max-height:500px) and (max-width:900px){.modal{max-height:96vh;}.emoji-picker{max-height:180px;}}
</style>

</head>
<body>

<!-- AUTH -->

<div id="auth-screen">
  <div class="auth-bg"></div>
  <div class="auth-card">
    <div class="auth-logo"><div class="auth-logo-icon">‚ö°</div><div class="auth-logo-text">NexusChat</div></div>
    <h1 class="auth-title">Welcome back</h1>
    <p class="auth-subtitle">Dive back into your conversations</p>
    <div class="tab-switcher">
      <button class="tab-btn active" onclick="switchTab('login')">„É≠„Ç∞„Ç§„É≥</button>
      <button class="tab-btn" onclick="switchTab('register')">Êñ∞Ë¶èÁôªÈå≤</button>
    </div>
    <div id="login-form">
      <label class="field-label">„É¶„Éº„Ç∂„ÉºÂêç</label>
      <input class="field-input" id="login-username" type="text" placeholder="username" autocomplete="username" />
      <label class="field-label">„Éë„Çπ„ÉØ„Éº„Éâ</label>
      <input class="field-input" id="login-password" type="password" placeholder="********" autocomplete="current-password" />
      <button class="auth-btn" onclick="login()">„É≠„Ç∞„Ç§„É≥</button>
    </div>
    <div id="register-form" style="display:none">
      <label class="field-label">„É¶„Éº„Ç∂„ÉºÂêç <span style="color:var(--text-muted);text-transform:none;font-size:11px">(3„Äú20ÊñáÂ≠ó„ÉªËã±Êï∞Â≠ó„Éª_„Éª-)</span></label>
      <input class="field-input" id="reg-username" type="text" placeholder="username" autocomplete="username" />
      <label class="field-label">„Éë„Çπ„ÉØ„Éº„Éâ</label>
      <input class="field-input" id="reg-password" type="password" placeholder="********" autocomplete="new-password" />
      <div id="invite-code-field" style="display:none">
        <label class="field-label">ÊãõÂæÖ„Ç≥„Éº„Éâ</label>
        <input class="field-input" id="reg-invite" type="text" placeholder="XXXXXXXX" />
      </div>
      <button class="auth-btn" onclick="register()">„Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàê</button>
    </div>
    <div class="auth-error" id="auth-error"></div>
  </div>
</div>

<!-- APP -->

<div id="app">
  <div class="server-list">
    <div class="server-icon active" title="NexusChat">‚ö°</div>
    <div class="server-sep"></div>
  </div>

  <div class="sidebar" id="sidebar">
    <div class="sidebar-header"><span>NexusChat</span></div>
    <div class="channels-section">
      <div class="ch-category">
        „ÉÜ„Ç≠„Çπ„Éà„ÉÅ„É£„É≥„Éç„É´
        <button class="ch-category-btn" id="add-channel-btn" onclick="openChannelCreate()" style="display:none" title="„ÉÅ„É£„É≥„Éç„É´„Çí‰ΩúÊàê">Ôºã</button>
      </div>
      <div id="channel-list"></div>

      <div class="ch-category" style="margin-top:4px">
        „Éú„Ç§„Çπ„ÉÅ„É£„É≥„Éç„É´
      </div>
      <div id="voice-channel-list"></div>
      <div class="ch-category" style="margin-top:8px">
        „ÉÄ„Ç§„É¨„ÇØ„Éà„É°„ÉÉ„Çª„Éº„Ç∏
        <button class="ch-category-btn" onclick="openDmSearch()" title="Êñ∞„Åó„ÅÑDM">Ôºã</button>
      </div>
      <div id="dm-list"></div>
    </div>
    <div class="user-panel">
      <div class="user-avatar" onclick="openStatusMenu(event)" style="cursor:pointer">
        <img id="user-avatar-img" src="" alt="" />
        <div class="user-status-dot" id="user-status-dot"></div>
      </div>
      <div class="user-info">
        <div class="user-name" id="user-display-name">--</div>
        <div class="user-tag" id="user-role-tag" style="color:var(--text-3);font-size:11px"></div>
      </div>
      <div class="user-actions">
        <button class="user-action-btn" title="„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ" onclick="openBookmarks()">üîñ</button>
        <button class="user-action-btn" title="ÁÆ°ÁêÜËÄÖ„Éë„Éç„É´" id="admin-btn" onclick="openAdminPanel()" style="display:none">üëë</button>
        <button class="user-action-btn" title="Ë®≠ÂÆö" onclick="openSettings()">‚öô</button>
        <button class="user-action-btn" title="„É≠„Ç∞„Ç¢„Ç¶„Éà" onclick="openLogoutConfirm()">üö™</button>
      </div>
    </div>
  </div>

  <div class="chat-area">
    <div class="chat-header">
      <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
      <span class="chat-header-icon" id="chat-header-icon">#</span>
      <span class="chat-header-name" id="chat-header-name">general</span>
      <div class="chat-header-sep" id="chat-header-sep"></div>
      <span class="chat-header-topic" id="chat-header-topic" onclick="openTopicEdit()" title="„Éà„Éî„ÉÉ„ÇØ„ÇíÁ∑®ÈõÜ">„Åø„Çì„Å™„ÅÆ„ÉÅ„É£„É≥„Éç„É´„Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ</span>
      <div class="chat-header-actions">
        <button class="header-btn" onclick="toggleSearch()" id="search-btn" title="Ê§úÁ¥¢">üîç</button>
        <button class="header-btn" onclick="openPins()" title="„Éî„É≥Áïô„ÇÅ">üìå</button>
        <button class="mobile-members-btn" onclick="toggleMembers()" title="„É°„É≥„Éê„Éº">üë•</button>
      </div>
    </div>

```
<div class="search-bar" id="search-bar">
  <input class="search-input" id="search-input" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÊ§úÁ¥¢..." oninput="debounceSearch(this.value)" />
  <select class="search-scope" id="search-scope">
    <option value="">ÂÖ®„ÉÅ„É£„É≥„Éç„É´</option>
    <option value="current">„Åì„ÅÆ„ÉÅ„É£„É≥„Éç„É´</option>
  </select>
  <button class="secondary-btn" onclick="toggleSearchFilters()" title="Ë©≥Á¥∞„Éï„Ç£„É´„Çø„Éº">‚öô</button>
</div>
<div class="search-filters" id="search-filters">
  <input class="search-filter-input" id="search-author" placeholder="ÊäïÁ®øËÄÖ" />
  <input class="search-filter-input" id="search-from-date" type="date" title="ÈñãÂßãÊó•" />
  <input class="search-filter-input" id="search-to-date" type="date" title="ÁµÇ‰∫ÜÊó•" />
  <button class="secondary-btn" onclick="doSearch()">Ê§úÁ¥¢</button>
</div>
<div class="search-results" id="search-results"></div>

<div class="muted-banner" id="muted-banner">üîá „ÅÇ„Å™„Åü„ÅØ„Éü„É•„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°„Åß„Åç„Åæ„Åõ„Çì„ÄÇ</div>

<div class="messages" id="messages">
  <div class="welcome-msg">
    <div class="welcome-icon">#</div>
    <div class="welcome-title" id="welcome-title">#general „Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ</div>
    <div class="welcome-sub">„Åì„Çå„ÅØ„ÉÅ„É£„É≥„Éç„É´„ÅÆÂßã„Åæ„Çä„Åß„Åô„ÄÇ</div>
  </div>
</div>

<div class="typing-bar" id="typing-bar"></div>
<div class="input-bar" style="position:relative" id="input-bar">
  <div class="reply-preview" id="reply-preview">
    <span class="reply-preview-text" id="reply-preview-text"></span>
    <button class="reply-close-btn" onclick="cancelReply()">‚úï</button>
  </div>
  <div class="emoji-picker" id="emoji-picker">
    <div class="emoji-categories" id="emoji-cats"></div>
    <div class="emoji-grid" id="emoji-grid"></div>
  </div>
  <div class="input-box">
    <button class="attach-btn" onclick="openFilePicker()">üìé</button>
    <button class="emoji-btn" onclick="toggleEmojiPicker()">üòä</button>
    <textarea class="msg-input" id="msg-input" placeholder="#general „Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°" rows="1"
      oninput="autoResize(this);emitTyping()" onkeydown="handleKey(event)"></textarea>
    <button class="send-btn" onclick="sendMessage()">‚ñ∂</button>
  </div>
  <div class="input-hint">
    <span><kbd>Shift+Enter</kbd> ÊîπË°å</span>
    <span><kbd>**Â§™Â≠ó**</kbd> <kbd>*Êñú‰Ωì*</kbd> <kbd>`„Ç≥„Éº„Éâ`</kbd></span>
  </div>
</div>
```

  </div>

  <div class="members-panel" id="members-panel">
    <div class="members-header">„É°„É≥„Éê„Éº -- <span id="online-count">0</span>Âêç</div>
    <div id="members-list"></div>
  </div>
</div>


<!-- Voice Channel Panel -->
<div class="voice-panel" id="voice-panel">
  <div class="voice-panel-header">
    <div class="voice-panel-title"><div class="voice-pulse"></div>Êé•Á∂ö‰∏≠</div>
    <span id="voice-panel-channel" style="font-size:11px;color:var(--text-3)"></span>
  </div>
  <div class="voice-participants-list" id="voice-participants-list"></div>
  <div class="voice-controls">
    <button class="voice-ctrl-btn voice-mute-btn" id="voice-mute-btn" onclick="toggleVoiceMute()">&#127908; „Éü„É•„Éº„Éà</button>
    <button class="voice-ctrl-btn voice-leave-btn" onclick="leaveVoiceChannel()">ÈÄÄÂá∫</button>
  </div>
</div>

<div class="drawer-overlay" id="drawer-overlay" onclick="closeDrawers()"></div>
<div class="drop-overlay" id="drop-overlay">üìÅ<div style="font-size:18px">„Éï„Ç°„Ç§„É´„Çí„Éâ„É≠„ÉÉ„Éó„Åó„Å¶ÈÄÅ‰ø°</div></div>
<div class="lightbox" id="lightbox" onclick="closeLightbox()"><img id="lightbox-img" src="" /></div>
<div class="upload-toast" id="upload-toast"><div class="upload-spinner"></div><span id="upload-toast-text">„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠...</span></div>

<!-- „Çπ„ÉÜ„Éº„Çø„Çπ„É°„Éã„É•„Éº -->

<div id="status-menu" style="display:none;position:fixed;background:var(--bg-panel);border:1px solid var(--border);border-radius:var(--radius-lg);padding:8px;box-shadow:0 8px 24px rgba(0,0,0,0.4);z-index:3000;min-width:160px;">
  <div onclick="setStatus('online')" style="padding:8px 12px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:14px;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''"><span style="width:10px;height:10px;border-radius:50%;background:var(--green);display:inline-block"></span>„Ç™„É≥„É©„Ç§„É≥</div>
  <div onclick="setStatus('away')" style="padding:8px 12px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:14px;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''"><span style="width:10px;height:10px;border-radius:50%;background:var(--yellow);display:inline-block"></span>Èõ¢Â∏≠‰∏≠</div>
  <div onclick="setStatus('busy')" style="padding:8px 12px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:14px;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''"><span style="width:10px;height:10px;border-radius:50%;background:var(--red);display:inline-block"></span>Âèñ„ÇäËæº„Åø‰∏≠</div>
</div>

<!-- Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->

<div class="modal-overlay" id="settings-modal" onclick="closeModalOutside(event,'settings-modal')">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">‚öô Ë®≠ÂÆö</div><button class="modal-close" onclick="closeModal('settings-modal')">‚úï</button></div>
    <div class="modal-tabs">
      <button class="modal-tab active" onclick="switchSettingsTab('appearance')">üé® Ë°®Á§∫</button>
      <button class="modal-tab" onclick="switchSettingsTab('avatar')">üñº „Ç¢„Éê„Çø„Éº</button>
      <button class="modal-tab" onclick="switchSettingsTab('notifications')">üîî ÈÄöÁü•</button>
      <button class="modal-tab" onclick="switchSettingsTab('account')">üë§ „Ç¢„Ç´„Ç¶„É≥„Éà</button>
    </div>
    <div class="modal-body">
      <!-- Ë°®Á§∫„Çø„Éñ -->
      <div class="modal-tab-pane active" id="settings-tab-appearance">
        <div class="settings-section-title">„ÉÜ„Éº„Éû</div>
        <div class="theme-options">
          <div class="theme-opt active" id="theme-dark" onclick="setTheme('dark')">üåô „ÉÄ„Éº„ÇØ</div>
          <div class="theme-opt" id="theme-light" onclick="setTheme('light')">‚òÄÔ∏è „É©„Ç§„Éà</div>
        </div>
        <div class="settings-section-title" style="margin-top:16px">„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫</div>
        <div class="settings-row"><div class="settings-row-label">„Çµ„Ç§„Ç∫: <span id="font-size-label">15px</span></div></div>
        <input type="range" class="font-slider" id="font-slider" min="12" max="20" value="15" oninput="setFontSize(this.value)" />
        <div class="settings-section-title" style="margin-top:16px">ÈÄÅ‰ø°„Ç≠„Éº</div>
        <div class="settings-row">
          <div><div class="settings-row-label">ÈÄÅ‰ø°„Ç≠„Éº</div><div class="settings-row-desc">Enter„ÅßÈÄÅ‰ø° / Shift+Enter„ÅßÊîπË°å</div></div>
          <select class="settings-select" id="send-key-select" onchange="setSendKey(this.value)"><option value="enter">Enter</option><option value="ctrl">Ctrl+Enter</option></select>
        </div>
      </div>

```
  <!-- „Ç¢„Éê„Çø„Éº„Çø„Éñ -->
  <div class="modal-tab-pane" id="settings-tab-avatar">
    <div class="settings-section-title">„Éó„É¨„Éì„É•„Éº</div>
    <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px">
      <img id="settings-avatar-preview" src="" style="width:72px;height:72px;border-radius:50%;border:2px solid var(--border);object-fit:cover" />
      <div>
        <div style="font-size:14px;font-weight:600;margin-bottom:4px" id="settings-username-display">--</div>
        <div style="font-size:12px;color:var(--text-3)" id="settings-role-display">member</div>
      </div>
    </div>
    <div class="settings-section-title">„Çπ„Çø„Ç§„É´„ÇíÈÅ∏„Å∂</div>
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px" id="avatar-style-btns"></div>
    <div class="settings-section-title">ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</div>
    <input type="file" id="avatar-file-input" accept="image/*" style="display:none" onchange="handleAvatarFileSelect(this.files)" />
    <button class="secondary-btn" style="width:100%;margin-bottom:12px" onclick="document.getElementById('avatar-file-input').click()">üìÅ „Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</button>
    <button class="primary-btn" style="width:100%" onclick="saveAvatar()">‚úì ‰øùÂ≠ò„Åô„Çã</button>
    <div id="avatar-save-msg" style="font-size:12px;color:var(--green);margin-top:8px;display:none">‚úì ‰øùÂ≠ò„Åó„Åæ„Åó„Åü</div>
  </div>

  <!-- ÈÄöÁü•„Çø„Éñ -->
  <div class="modal-tab-pane" id="settings-tab-notifications">
    <div class="settings-section-title">ÈÄöÁü•</div>
    <div class="settings-row"><div><div class="settings-row-label">ÈÄöÁü•Èü≥</div></div><div class="toggle on" id="toggle-sound" onclick="toggleSetting('sound')"></div></div>
    <div class="settings-row"><div><div class="settings-row-label">„Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÈÄöÁü•</div></div><div class="toggle" id="toggle-notif" onclick="requestNotifPermission()"></div></div>
    <div class="settings-row"><div><div class="settings-row-label">„É°„É≥„Ç∑„Éß„É≥ÊôÇ„ÅÆ„Åø</div></div><div class="toggle" id="toggle-mention-only" onclick="toggleSetting('mentionOnly')"></div></div>
    <div class="settings-section-title" style="margin-top:16px">„Ç≠„Éº„ÉØ„Éº„ÉâÈÄöÁü•</div>
    <div class="settings-row-desc" style="margin-bottom:8px">ÊåáÂÆö„Åó„Åü„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂê´„ÇÄ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄöÁü•„Åó„Åæ„ÅôÔºàÊúÄÂ§ß20‰ª∂Ôºâ</div>
    <div class="tag-input-container" id="keyword-tags-container">
      <input class="tag-input" id="keyword-input" placeholder="„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶Enter" onkeydown="handleKeywordInput(event)" />
    </div>
    <button class="primary-btn" style="width:100%;margin-top:12px" onclick="saveKeywords()">üíæ ‰øùÂ≠ò„Åô„Çã</button>
    <div id="keyword-save-msg" style="font-size:12px;color:var(--green);margin-top:8px;display:none">‚úì ‰øùÂ≠ò„Åó„Åæ„Åó„Åü</div>
  </div>

  <!-- „Ç¢„Ç´„Ç¶„É≥„Éà„Çø„Éñ -->
  <div class="modal-tab-pane" id="settings-tab-account">
    <div class="settings-section-title">„Éó„É≠„Éï„Ç£„Éº„É´</div>
    <div class="settings-row"><div><div class="settings-row-label" id="settings-username">--</div><div class="settings-row-desc" id="settings-role">member</div></div></div>
    <div class="settings-section-title">„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥</div>
    <input class="search-input" id="pw-current" type="password" placeholder="ÁèæÂú®„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ" style="width:100%;margin-bottom:8px" />
    <input class="search-input" id="pw-new" type="password" placeholder="Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„ÉâÔºà6ÊñáÂ≠ó‰ª•‰∏äÔºâ" style="width:100%;margin-bottom:8px" />
    <button class="primary-btn" style="width:100%;margin-bottom:8px" onclick="changePassword()">üîë „Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂ§âÊõ¥</button>
    <div id="pw-msg" style="font-size:12px;margin-bottom:12px;display:none"></div>
    <div class="settings-section-title">„É≠„Ç∞„Ç§„É≥Â±•Ê≠¥</div>
    <div id="sessions-list" style="margin-bottom:16px"></div>
    <button class="secondary-btn" style="width:100%;margin-bottom:16px" onclick="loadSessions()">üìã Â±•Ê≠¥„ÇíË™≠„ÅøËæº„ÇÄ</button>
    <div class="settings-section-title">Âç±Èô∫„Å™Êìç‰Ωú</div>
    <button class="danger-btn" style="margin-bottom:8px" onclick="openLogoutConfirm()">üö™ „É≠„Ç∞„Ç¢„Ç¶„Éà</button>
    <button class="danger-btn" onclick="openDeleteAccount()">üóë „Ç¢„Ç´„Ç¶„É≥„Éà„ÇíÂâäÈô§</button>
  </div>
</div>
```

  </div>
</div>

<!-- „É≠„Ç∞„Ç¢„Ç¶„ÉàÁ¢∫Ë™ç -->

<div class="modal-overlay" id="logout-confirm-modal" onclick="closeModalOutside(event,'logout-confirm-modal')">
  <div class="modal" style="max-width:360px">
    <div class="modal-header"><div class="modal-title">üö™ „É≠„Ç∞„Ç¢„Ç¶„Éà</div><button class="modal-close" onclick="closeModal('logout-confirm-modal')">‚úï</button></div>
    <div class="modal-body">
      <p style="color:var(--text-2)">„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü</p>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="danger-btn" style="flex:1" onclick="logout()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
        <button class="secondary-btn" style="flex:1" onclick="closeModal('logout-confirm-modal')">„Ç≠„É£„É≥„Çª„É´</button>
      </div>
    </div>
  </div>
</div>

<!-- „Ç¢„Ç´„Ç¶„É≥„ÉàÂâäÈô§ -->

<div class="modal-overlay" id="delete-account-modal" onclick="closeModalOutside(event,'delete-account-modal')">
  <div class="modal" style="max-width:400px">
    <div class="modal-header"><div class="modal-title" style="color:var(--red)">‚ö† „Ç¢„Ç´„Ç¶„É≥„ÉàÂâäÈô§</div><button class="modal-close" onclick="closeModal('delete-account-modal')">‚úï</button></div>
    <div class="modal-body">
      <p style="color:var(--text-2);line-height:1.6">„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇÁ¢∫Ë™ç„ÅÆ„Åü„ÇÅ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
      <input id="delete-account-pw" type="password" class="search-input" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" style="width:100%;margin:12px 0" />
      <div id="delete-account-err" style="color:var(--red);font-size:13px;margin-bottom:8px;display:none"></div>
      <button class="danger-btn" onclick="confirmDeleteAccount()">ÂâäÈô§„Åô„Çã</button>
    </div>
  </div>
</div>

<!-- „Éî„É≥„É¢„Éº„ÉÄ„É´ -->

<div class="modal-overlay" id="pins-modal" onclick="closeModalOutside(event,'pins-modal')">
  <div class="modal"><div class="modal-header"><div class="modal-title">üìå „Éî„É≥Áïô„ÇÅ„É°„ÉÉ„Çª„Éº„Ç∏</div><button class="modal-close" onclick="closeModal('pins-modal')">‚úï</button></div>
  <div class="modal-body"><div id="pins-list"></div></div></div>
</div>

<!-- „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„É¢„Éº„ÉÄ„É´ -->

<div class="modal-overlay" id="bookmarks-modal" onclick="closeModalOutside(event,'bookmarks-modal')">
  <div class="modal"><div class="modal-header"><div class="modal-title">üîñ „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ</div><button class="modal-close" onclick="closeModal('bookmarks-modal')">‚úï</button></div>
  <div class="modal-body"><div id="bookmarks-list"></div></div></div>
</div>

<!-- DM„Çµ„Éº„ÉÅ -->

<div class="modal-overlay" id="dm-search-modal" onclick="closeModalOutside(event,'dm-search-modal')">
  <div class="modal" style="max-width:400px">
    <div class="modal-header"><div class="modal-title">üí¨ „ÉÄ„Ç§„É¨„ÇØ„Éà„É°„ÉÉ„Çª„Éº„Ç∏</div><button class="modal-close" onclick="closeModal('dm-search-modal')">‚úï</button></div>
    <div class="modal-body">
      <input class="search-input" id="dm-search-input" placeholder="„É¶„Éº„Ç∂„ÉºÂêç„ÅßÊ§úÁ¥¢..." oninput="renderDmSearchResults(this.value)" style="width:100%;margin-bottom:12px" />
      <div id="dm-search-results"></div>
    </div>
  </div>
</div>

<!-- ÁÆ°ÁêÜËÄÖ„Éë„Éç„É´ -->

<div class="modal-overlay" id="admin-modal" onclick="closeModalOutside(event,'admin-modal')">
  <div class="modal wide">
    <div class="modal-header"><div class="modal-title">üëë ÁÆ°ÁêÜËÄÖ„Éë„Éç„É´</div><button class="modal-close" onclick="closeModal('admin-modal')">‚úï</button></div>
    <div class="modal-tabs">
      <button class="modal-tab active" onclick="switchAdminTab('users')">üë§ „É¶„Éº„Ç∂„Éº</button>
      <button class="modal-tab" onclick="switchAdminTab('channels')">üì¢ „ÉÅ„É£„É≥„Éç„É´</button>
      <button class="modal-tab" onclick="switchAdminTab('invites')">üîó ÊãõÂæÖ</button>
      <button class="modal-tab" onclick="switchAdminTab('emojis')">üòÄ ÁµµÊñáÂ≠ó</button>
    </div>
    <div class="modal-body">
      <div class="modal-tab-pane active" id="admin-tab-users"><div id="admin-users-list"></div></div>
      <div class="modal-tab-pane" id="admin-tab-channels">
        <div style="display:flex;gap:8px;margin-bottom:12px">
          <input class="search-input" id="new-channel-name" placeholder="„ÉÅ„É£„É≥„Éç„É´Âêç (Ëã±Êï∞Â≠ó)" style="flex:1" />
          <input class="search-input" id="new-channel-topic" placeholder="„Éà„Éî„ÉÉ„ÇØÔºà‰ªªÊÑèÔºâ" style="flex:1" />
          <button class="primary-btn" onclick="createChannel()">‰ΩúÊàê</button>
        </div>
        <div id="admin-channels-list"></div>
      </div>
      <div class="modal-tab-pane" id="admin-tab-invites">
        <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center">
          <select class="settings-select" id="invite-expires">
            <option value="">ÊúüÈôê„Å™„Åó</option>
            <option value="24">24ÊôÇÈñì</option>
            <option value="72">72ÊôÇÈñì</option>
            <option value="168">7Êó•Èñì</option>
          </select>
          <button class="primary-btn" onclick="createInvite()">ÊãõÂæÖ„Ç≥„Éº„Éâ„ÇíÁîüÊàê</button>
          <div id="invite-only-toggle" style="display:flex;align-items:center;gap:8px;margin-left:auto;font-size:13px;color:var(--text-2)">
            ÊãõÂæÖÂà∂
          </div>
        </div>
        <div id="admin-invites-list"></div>
      </div>
      <div class="modal-tab-pane" id="admin-tab-emojis">
        <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center;flex-wrap:wrap">
          <input class="search-input" id="new-emoji-name" placeholder="ÁµµÊñáÂ≠óÂêç (Ëã±Â∞èÊñáÂ≠ó„ÉªÊï∞Â≠ó„Éª_)" style="flex:1;min-width:120px" />
          <input type="file" id="new-emoji-file" accept="image/*" style="display:none" onchange="uploadEmoji()" />
          <button class="primary-btn" onclick="document.getElementById('new-emoji-file').click()">üñº ÁîªÂÉè„ÇíÈÅ∏Êäû„Åó„Å¶ËøΩÂä†</button>
        </div>
        <div id="admin-emojis-list"></div>
      </div>
    </div>
  </div>
</div>

<!-- „ÉÅ„É£„É≥„Éç„É´‰ΩúÊàê/Á∑®ÈõÜ -->

<div class="modal-overlay" id="channel-edit-modal" onclick="closeModalOutside(event,'channel-edit-modal')">
  <div class="modal" style="max-width:420px">
    <div class="modal-header"><div class="modal-title" id="channel-edit-title">„ÉÅ„É£„É≥„Éç„É´„ÇíÁ∑®ÈõÜ</div><button class="modal-close" onclick="closeModal('channel-edit-modal')">‚úï</button></div>
    <div class="modal-body">
      <div class="settings-section-title">„Éà„Éî„ÉÉ„ÇØ</div>
      <input class="search-input" id="edit-channel-topic" placeholder="„ÉÅ„É£„É≥„Éç„É´„ÅÆ„Éà„Éî„ÉÉ„ÇØ" style="width:100%;margin-bottom:12px" />
      <div class="settings-row">
        <div><div class="settings-row-label">Ë™≠„ÅøÂèñ„ÇäÂ∞ÇÁî®</div><div class="settings-row-desc">ÁÆ°ÁêÜËÄÖ„Éª„É¢„Éá„É¨„Éº„Çø„Éº‰ª•Â§ñ„ÅØÊäïÁ®ø„Åß„Åç„Åæ„Åõ„Çì</div></div>
        <div class="toggle" id="edit-channel-readonly" onclick="this.classList.toggle('on')"></div>
      </div>
      <button class="primary-btn" style="width:100%;margin-top:8px" onclick="saveChannelEdit()">‰øùÂ≠ò„Åô„Çã</button>
    </div>
  </div>
</div>

</body>
<script>
// ‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê
const API = '';
let token = localStorage.getItem('token');
let currentUser = null;
let socket = null;
let currentChannel = null;
let currentDmRoom  = null;
let openDmRooms    = JSON.parse(localStorage.getItem('nexus_dmRooms') || '[]');
let onlineUsersList = [];
let allMessages    = {};  // channelId ‚Üí []
let replyTarget    = null;  // { msgId, author, content }
let editingChannelId = null;
let pendingAvatar  = null;
let keywordTags    = [];
let customEmojiList = [];
let isMutedLocally = false;
let channelLoading = {};
let pendingSocketMsgs = {};
let joinGen = {};
let typingTimers = {};
let searchDebounce = null;
const bookmarkCache = new Set();

const settings = { theme:'dark', fontSize:15, sound:true, notif:false, mentionOnly:false, sendKey:'enter',
...JSON.parse(localStorage.getItem('nexus_settings') || '{}') };

// ‚ïê‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê‚ïê
async function login() {
const username = document.getElementById('login-username').value.trim();
const password = document.getElementById('login-password').value;
if (!username || !password) return showAuthError('„É¶„Éº„Ç∂„ÉºÂêç„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
try {
const r = await fetch(`${API}/api/login`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username, password}) });
const d = await r.json();
if (!r.ok) return showAuthError(d.error || '„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
localStorage.setItem('token', d.token);
token = d.token;
currentUser = d.user;
startApp();
} catch(e) { showAuthError('„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì'); }
}
async function register() {
const username = document.getElementById('reg-username').value.trim();
const password = document.getElementById('reg-password').value;
const inviteCode = document.getElementById('reg-invite').value.trim();
if (!username || !password) return showAuthError('„É¶„Éº„Ç∂„ÉºÂêç„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
try {
const r = await fetch(`${API}/api/register`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username, password, inviteCode}) });
const d = await r.json();
if (!r.ok) {
if (d.inviteRequired) document.getElementById('invite-code-field').style.display = '';
return showAuthError(d.error || 'ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
}
localStorage.setItem('token', d.token);
token = d.token;
currentUser = d.user;
startApp();
} catch(e) { showAuthError('„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì'); }
}
function showAuthError(msg) { const el = document.getElementById('auth-error'); el.textContent = msg; el.classList.add('show'); }
function switchTab(tab) {
document.getElementById('login-form').style.display = tab === 'login' ? '' : 'none';
document.getElementById('register-form').style.display = tab === 'register' ? '' : 'none';
document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.toggle('active', (i===0) === (tab==='login')));
document.getElementById('auth-error').classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê APP INIT ‚ïê‚ïê‚ïê‚ïê
async function startApp() {
document.getElementById('auth-screen').style.display = 'none';
document.getElementById('app').classList.add('visible');
applySettings();
await loadCurrentUser();
initSocket();
await loadChannels();
renderDmList();
renderVoiceChannelList();
initDragDrop();
initMobile();
document.addEventListener('click', () => document.getElementById('status-menu').style.display = 'none', true);
// „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Çí„Ç≠„É£„ÉÉ„Ç∑„É•
loadBookmarkCache();
}

async function loadCurrentUser() {
try {
const r = await fetch(`${API}/api/me`, { headers: { Authorization: `Bearer ${token}` } });
if (r.ok) {
currentUser = await r.json();
keywordTags = currentUser.keywordNotifs || [];
}
} catch(e) {}
document.getElementById('user-display-name').textContent = currentUser?.username || '--';
document.getElementById('user-avatar-img').src = currentUser?.avatar || '';
document.getElementById('user-role-tag').textContent = currentUser?.role || '';
if (currentUser?.role === 'admin') {
document.getElementById('admin-btn').style.display = '';
document.getElementById('add-channel-btn').style.display = '';
}
}

// ‚ïê‚ïê‚ïê‚ïê SOCKET ‚ïê‚ïê‚ïê‚ïê
function initSocket() {
socket = io({ auth: { token } });
socket.on('connect', () => console.log('Socket connected'));
initVoiceSocketEvents();
socket.on('connect_error', (e) => { if (e.message === 'Authentication error') { logout(); } });
socket.on('force_logout', ({ reason }) => { alert(reason); logout(); });
socket.on('muted', () => { isMutedLocally = true; document.getElementById('muted-banner').classList.add('show'); });
socket.on('unmuted', () => { isMutedLocally = false; document.getElementById('muted-banner').classList.remove('show'); });
socket.on('error_msg', ({ msg }) => showToastNotif('‚ö†Ô∏è', msg, null));

socket.on('online_users', (users) => {
onlineUsersList = users;
renderMembers(users);
document.getElementById('online-count').textContent = users.length;
});

socket.on('message', (msg) => {
if (channelLoading[msg.channelId]) { (pendingSocketMsgs[msg.channelId] = pendingSocketMsgs[msg.channelId] || []).push(msg); return; }
if (msg.channelId === currentChannel) { renderMessageToDom(msg, true); scrollToBottom(); }
else { markUnread(msg.channelId); }
// „Ç≠„Éº„ÉØ„Éº„ÉâÈÄöÁü•Ôºà„Çµ„Éº„Éê„Éº„Åã„Çâ„ÅÆkeyword_match„Åß„ÇÇÊù•„Çã„ÅåÂøµ„ÅÆ„Åü„ÇÅ„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Åß„ÇÇÔºâ
if (msg.author !== currentUser?.username) checkKeywordNotif(msg);
});

socket.on('keyword_match', ({ keyword, msg, channelId }) => {
showToastNotif('üîë', `„Ç≠„Éº„ÉØ„Éº„Éâ„Äå${keyword}„Äç„Å´‰∏ÄËá¥`, msg.content, () => joinChannel(channelId));
});

socket.on('message_edited', ({ msgId, channelId, content, editedAt }) => {
const el = document.getElementById(`msg-${msgId}`);
if (el) {
el.querySelector('.msg-content').innerHTML = renderContent(content);
let ed = el.querySelector('.msg-edited');
if (!ed) { ed = document.createElement('span'); ed.className = 'msg-edited'; el.querySelector('.msg-header')?.appendChild(ed); }
ed.textContent = ` (Á∑®ÈõÜÊ∏à ${formatTime(editedAt)})`;
}
});

socket.on('message_deleted', ({ msgId }) => {
document.getElementById(`msg-${msgId}`)?.remove();
});

socket.on('pin_update', ({ channelId, pins }) => { if (channelId === currentChannel) {} });

socket.on('reaction_update', ({ msgId, reactions }) => {
const el = document.getElementById(`msg-${msgId}`);
if (el) renderReactions(el, msgId, reactions, currentChannel || currentDmRoom);
});

socket.on('typing', ({ username, isTyping }) => {
if (username === currentUser?.username) return;
clearTimeout(typingTimers[username]);
const bar = document.getElementById('typing-bar');
if (isTyping) {
typingTimers[username] = setTimeout(() => { delete typingTimers[username]; updateTypingBar(); }, 3000);
} else { delete typingTimers[username]; }
updateTypingBar();
});

socket.on('dm_message', (msg) => {
const roomId = msg.channelId;
if (currentDmRoom === roomId) { renderMessageToDom(msg, true); scrollToBottom(); markDmRead(msg); }
else {
const other = roomId.split('__').find(u => u !== currentUser?.username);
showToastNotif('üí¨', other, msg.content, () => openDm(other));
if (!openDmRooms.find(r => r.roomId === roomId)) {
openDmRooms.push({ roomId, otherUser: other });
localStorage.setItem('nexus_dmRooms', JSON.stringify(openDmRooms));
renderDmList();
}
}
});

socket.on('dm_read_update', ({ roomId, msgId, readBy }) => {
const el = document.querySelector(`#msg-${msgId} .dm-read-receipt`);
if (el) { const other = roomId.split('__').find(u => u !== currentUser?.username); if (readBy.includes(other)) { el.textContent = '‚úì‚úì Êó¢Ë™≠'; el.classList.add('read'); } }
});

socket.on('role_changed', ({ role }) => { currentUser.role = role; document.getElementById('user-role-tag').textContent = role; if (role === 'admin') { document.getElementById('admin-btn').style.display = ''; document.getElementById('add-channel-btn').style.display = ''; } });
socket.on('user_role_updated', () => renderMembers(onlineUsersList));
socket.on('user_avatar_updated', ({ username, avatar }) => {
if (username === currentUser?.username) { currentUser.avatar = avatar; document.getElementById('user-avatar-img').src = avatar; }
document.querySelectorAll('.msg').forEach(el => { if (el.querySelector('.msg-author')?.textContent === username) { const img = el.querySelector('.msg-avatar img'); if (img) img.src = avatar; } });
});
socket.on('user_banned', ({ username }) => { if (username === currentUser?.username) { alert('BAN„Åï„Çå„Åæ„Åó„Åü'); logout(); } renderMembers(onlineUsersList); });
socket.on('channel_updated', ({ action, channel, channelId }) => {
if (action === 'created') { channels_state[channel.id] = channel; renderChannelList(); }
else if (action === 'updated') { if (channels_state[channel.id]) Object.assign(channels_state[channel.id], channel); renderChannelList(); if (channel.id === currentChannel) { document.getElementById('chat-header-topic').textContent = channel.topic || ''; } }
else if (action === 'deleted') { delete channels_state[channelId]; renderChannelList(); if (currentChannel === channelId) joinChannel('general'); }
});
socket.on('custom_emojis', (list) => { customEmojiList = list; });
socket.on('custom_emoji_updated', ({ name, url }) => { const idx = customEmojiList.findIndex(e => e.name === name); if (idx >= 0) customEmojiList[idx].url = url; else customEmojiList.push({ name, url }); });
socket.on('custom_emoji_deleted', ({ name }) => { customEmojiList = customEmojiList.filter(e => e.name !== name); });
}

// ‚ïê‚ïê‚ïê‚ïê CHANNELS ‚ïê‚ïê‚ïê‚ïê
let channels_state = {};
async function loadChannels() {
const r = await fetch(`${API}/api/channels`, { headers: { Authorization: `Bearer ${token}` } });
if (!r.ok) return;
const list = await r.json();
channels_state = {};
list.forEach(ch => channels_state[ch.id] = ch);
renderChannelList();
const first = list[0]?.id || 'general';
joinChannel(first);
}

function renderChannelList() {
const list = document.getElementById('channel-list');
list.innerHTML = Object.values(channels_state).map(ch => ` <div class="ch-item${ch.id === currentChannel ? ' active' : ''}${unreadSet.has(ch.id) ? ' unread' : ''}" id="ch-item-${ch.id}" onclick="joinChannel('${ch.id}')"> <span class="ch-icon">${ch.readonly ? 'üì¢' : '#'}</span> <span style="flex:1">${escHtml(ch.name)}</span> ${ch.readonly ? '<span class="ch-readonly-badge">RO</span>' : ''} <span class="unread-badge">‚óè</span> </div>`).join('');
}

const unreadSet = new Set();
function markUnread(channelId) {
if (channelId === currentChannel) return;
unreadSet.add(channelId);
document.getElementById(`ch-item-${channelId}`)?.classList.add('unread');
}

async function joinChannel(channelId) {
if (!channels_state[channelId] && channelId !== 'general') return;
currentChannel = channelId;
currentDmRoom  = null;
unreadSet.delete(channelId);

const gen = (joinGen[channelId] = (joinGen[channelId] || 0) + 1);
const ch = channels_state[channelId] || { name: channelId, topic: '' };

document.getElementById('chat-header-icon').textContent = ch.readonly ? 'üì¢' : '#';
document.getElementById('chat-header-name').textContent = ch.name;
document.getElementById('chat-header-topic').textContent = ch.topic || '';
document.getElementById('msg-input').placeholder = `#${ch.name} „Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°`;
document.getElementById('welcome-title').textContent = `#${ch.name} „Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ`;
document.getElementById('chat-header-sep').style.display = ch.topic ? '' : 'none';
document.getElementById('input-bar').style.display = '';

renderChannelList();
socket?.emit('join_channel', channelId);
closeDrawers();

channelLoading[channelId] = true;
pendingSocketMsgs[channelId] = [];

const msgEl = document.getElementById('messages');
msgEl.innerHTML = `<div class="welcome-msg"><div class="welcome-icon">${ch.readonly ? 'üì¢' : '#'}</div><div class="welcome-title" id="welcome-title">#${escHtml(ch.name)} „Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ</div><div class="welcome-sub">„Åì„Çå„ÅØ„ÉÅ„É£„É≥„Éç„É´„ÅÆÂßã„Åæ„Çä„Åß„Åô„ÄÇ</div></div>`;

try {
const r = await fetch(`${API}/api/channels/${channelId}/messages`, { headers: { Authorization: `Bearer ${token}` } });
if (gen !== joinGen[channelId]) return;
const messages = r.ok ? await r.json() : [];
const serverIds = new Set(messages.map(m => m.id));
const buffered = (pendingSocketMsgs[channelId] || []).filter(m => !serverIds.has(m.id));
const allMsgs = [...messages, ...buffered].sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
allMessages[channelId] = allMsgs;
msgEl.innerHTML = `<div class="welcome-msg"><div class="welcome-icon">${ch.readonly ? 'üì¢' : '#'}</div><div class="welcome-title">#${escHtml(ch.name)} „Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ</div><div class="welcome-sub">„Åì„Çå„ÅØ„ÉÅ„É£„É≥„Éç„É´„ÅÆÂßã„Åæ„Çä„Åß„Åô„ÄÇ</div></div>`;
let prevMsg = null;
allMsgs.forEach(m => { renderMessageToDom(m, false, prevMsg); prevMsg = m; });
scrollToBottom();
} finally {
channelLoading[channelId] = false;
pendingSocketMsgs[channelId] = [];
}
}

// ‚ïê‚ïê‚ïê‚ïê MESSAGE RENDER ‚ïê‚ïê‚ïê‚ïê
function renderMessageToDom(msg, append = false, prevMsg = null) {
const msgEl = document.getElementById('messages');
const memberData = (window._allMembers || []).find(m => m.username === msg.author);
const avatar = memberData?.avatar || `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(msg.author)}`;

if (msg.type === 'system') return;

// „Ç∞„É´„Éº„Éî„É≥„Ç∞: Âêå„ÅòËëóËÄÖ„ÅÆÈÄ£Á∂ö„É°„ÉÉ„Çª„Éº„Ç∏
let grouped = false;
if (prevMsg === null && append) {
const lastEl = msgEl.lastElementChild;
if (lastEl?.dataset.author === msg.author && lastEl?.dataset.type !== 'system') {
const lastTs = new Date(lastEl.dataset.timestamp).getTime();
if (Date.now() - lastTs < 5 * 60000) grouped = true;
}
} else if (prevMsg && prevMsg.author === msg.author) {
const diff = new Date(msg.timestamp) - new Date(prevMsg.timestamp);
if (diff < 5 * 60000) grouped = true;
}

const isOwn = msg.author === currentUser?.username;
const isMention = msg.content && currentUser && msg.content.includes('@' + currentUser.username);
const isThread = msg.threadOf;
const canEdit = isOwn;
const canDel = isOwn || ['admin','moderator'].includes(currentUser?.role);
const canPin = ['admin','moderator'].includes(currentUser?.role) && currentChannel;
const isBm = bookmarkCache.has(msg.id);

const el = document.createElement('div');
el.className = `msg${grouped ? ' grouped' : ''}${isMention ? ' mention-highlight' : ''}${isThread ? ' thread-reply' : ''}`;
el.id = `msg-${msg.id}`;
el.dataset.author = msg.author;
el.dataset.timestamp = msg.timestamp;
el.dataset.type = msg.type;

let contentHtml = '';
let msgUrls = [];
if (msg.type === 'file' && msg.fileInfo) {
const fi = msg.fileInfo;
const isImage = fi.mimetype?.startsWith('image/') || /.(png|jpe?g|gif|webp)$/i.test(fi.filename || '');
if (isImage) {
contentHtml = `<img class="img-preview" src="${escHtml(fi.url)}" alt="${escHtml(fi.filename)}" onclick="openLightbox('${escHtml(fi.url)}')" loading="lazy" />`;
} else {
contentHtml = `<a class="file-attachment" href="${escHtml(fi.url)}" target="_blank" download="${escHtml(fi.filename)}"> <div class="file-icon">üìé</div> <div class="file-info"><div class="file-name">${escHtml(fi.filename)}</div><div class="file-size">${formatBytes(fi.size)}</div></div> </a>`;
}
} else {
const _rc = renderContent(msg.content || '');
contentHtml = _rc.html;
msgUrls = _rc.urls || [];
}

const threadInfo = msg.threadOf ? `<div style="font-size:12px;color:var(--text-3);margin-bottom:3px">‚Ü© „Çπ„É¨„ÉÉ„ÉâËøî‰ø°</div>` : '';

el.innerHTML = `<div class="msg-avatar"><img src="${escHtml(avatar)}" alt="${escHtml(msg.author)}" onclick="openDm('${escHtml(msg.author)}')" loading="lazy" /></div> <div class="msg-body"> <div class="msg-header"> <span class="msg-author" onclick="openDm('${escHtml(msg.author)}')">${escHtml(msg.author)}</span> <span class="msg-time">${formatTime(msg.timestamp)}</span> ${msg.edited ?`<span class="msg-edited">(Á∑®ÈõÜÊ∏à)</span>`: ''} </div> ${threadInfo} <div class="msg-content">${contentHtml}</div> ${msg.type === 'text' ?`<div class="msg-edit-area"><textarea class="msg-edit-input" rows="1">${escHtml(msg.content||'')}</textarea><div class="msg-edit-btns"><button class="edit-save-btn" onclick="saveEdit('${msg.id}','${escHtml(currentChannel||currentDmRoom)}')">‰øùÂ≠ò</button><button class="edit-cancel-btn" onclick="cancelEdit('${msg.id}')">„Ç≠„É£„É≥„Çª„É´</button></div></div>`: ''} <div class="reactions" id="reactions-${msg.id}"></div> ${msg.isDM ?`<div class="dm-read-receipt" id="dr-${msg.id}"></div>`: ''} </div> <div class="msg-actions"> ${msg.type === 'text' ?`<button class="msg-action-btn" title="Ëøî‰ø°" onclick="startReply('${msg.id}','${escHtml(msg.author)}','${escHtml((msg.content||'').replace(/'/g,"\'"))}')">‚Ü©</button>`: ''} <button class="msg-action-btn" title="„É™„Ç¢„ÇØ„Ç∑„Éß„É≥" onclick="toggleReactionPicker('${msg.id}')">üòä</button> <button class="msg-action-btn" title="${isBm ? '„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØËß£Èô§' : '„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ'}" id="bm-btn-${msg.id}" onclick="toggleBookmark('${msg.id}','${escHtml(msg.author)}','${escHtml((msg.content||'').substring(0,100).replace(/'/g,"\\'"))}','${msg.timestamp}')">${isBm ? 'üîñ' : 'üè∑'}</button> ${canEdit && msg.type === 'text' ?`<button class="msg-action-btn" title="Á∑®ÈõÜ" onclick="startEdit('${msg.id}')">‚úè</button>`: ''} ${canPin ?`<button class="msg-action-btn" title="„Éî„É≥Áïô„ÇÅ" onclick="pinMessage('${msg.id}')">üìå</button>`: ''} ${canDel ?`<button class="msg-action-btn danger" title="ÂâäÈô§" onclick="deleteMessage('${msg.id}','${escHtml(currentChannel||currentDmRoom)}')">üóë</button>` : ''} </div>`;

if (msg.reactions && Object.keys(msg.reactions).length > 0) renderReactions(el, msg.id, msg.reactions, currentChannel || currentDmRoom);

if (append) msgEl.appendChild(el);
else msgEl.appendChild(el);

// OGP preview
if (msgUrls && msgUrls.length > 0) {
  msgUrls.forEach(function(url) { fetchAndRenderOgp(el, url); });
}
}

function renderReactions(el, msgId, reactions, channelId) {
const container = el.querySelector ? el.querySelector(`#reactions-${msgId}`) : document.getElementById(`reactions-${msgId}`);
if (!container) return;
container.innerHTML = Object.entries(reactions).map(([emoji, users]) => {
const reacted = users.includes(currentUser?.username);
return `<span class="reaction-pill${reacted ? ' reacted' : ''}" onclick="socket.emit('add_reaction',{msgId:'${msgId}',emoji:'${escHtml(emoji)}',channelId:'${escHtml(channelId)}'})"> ${emoji} <span class="reaction-count">${users.length}</span> </span>`;
}).join('');
}

// ‚ïê‚ïê‚ïê‚ïê SEND ‚ïê‚ïê‚ïê‚ïê
function sendMessage() {
const input = document.getElementById('msg-input');
const content = input.value.trim();
if (!content) return;
if (isMutedLocally) return;

if (currentDmRoom) {
const other = currentDmRoom.split('__').find(u => u !== currentUser?.username);
socket.emit('send_dm', { toUsername: other, content });
} else if (currentChannel) {
socket.emit('send_message', { channelId: currentChannel, content, threadOf: replyTarget?.msgId || null });
}
input.value = '';
input.style.height = '24px';
cancelReply();
}

function startReply(msgId, author, content) {
replyTarget = { msgId, author, content };
const prev = document.getElementById('reply-preview');
prev.classList.add('show');
document.getElementById('reply-preview-text').textContent = `${author}: ${content}`;
document.getElementById('msg-input').focus();
}
function cancelReply() { replyTarget = null; document.getElementById('reply-preview').classList.remove('show'); }

function deleteMessage(msgId, channelId) {
socket.emit('delete_message', { msgId, channelId });
}

function startEdit(msgId) {
const el = document.getElementById(`msg-${msgId}`);
if (!el) return;
el.querySelector('.msg-content').style.display = 'none';
const area = el.querySelector('.msg-edit-area');
if (area) { area.classList.add('active'); const ta = area.querySelector('textarea'); autoResize(ta); ta.focus(); }
}
function cancelEdit(msgId) {
const el = document.getElementById(`msg-${msgId}`);
if (!el) return;
el.querySelector('.msg-content').style.display = '';
el.querySelector('.msg-edit-area')?.classList.remove('active');
}
function saveEdit(msgId, channelId) {
const el = document.getElementById(`msg-${msgId}`);
const content = el?.querySelector('.msg-edit-input')?.value.trim();
if (!content) return;
socket.emit('edit_message', { msgId, channelId, content });
cancelEdit(msgId);
}

function pinMessage(msgId) { socket.emit('pin_message', { msgId, channelId: currentChannel }); }

// ‚ïê‚ïê‚ïê‚ïê REPLY REACTION PICKER ‚ïê‚ïê‚ïê‚ïê
let reactionPickerOpen = null;
function toggleReactionPicker(msgId) {
if (reactionPickerOpen === msgId) { closeReactionPicker(); return; }
closeReactionPicker();
const el = document.getElementById(`msg-${msgId}`);
if (!el) return;
const picker = document.createElement('div');
picker.id = 'reaction-quick-picker';
picker.style.cssText = 'position:absolute;background:var(--bg-panel);border:1px solid var(--border);border-radius:12px;padding:8px;display:flex;flex-wrap:wrap;gap:4px;z-index:100;box-shadow:0 8px 24px rgba(0,0,0,0.4);';
const quickEmojis = ['üëç','‚ù§Ô∏è','üòÇ','üòÆ','üò¢','üî•','‚úÖ','üéâ','üëÄ','üôè'];
quickEmojis.forEach(e => {
const btn = document.createElement('button');
btn.textContent = e;
btn.style.cssText = 'border:none;background:none;font-size:20px;cursor:pointer;padding:4px;border-radius:8px;transition:background 0.1s;';
btn.onclick = () => { socket.emit('add_reaction', { msgId, emoji: e, channelId: currentChannel || currentDmRoom }); closeReactionPicker(); };
picker.appendChild(btn);
});
el.style.position = 'relative';
el.appendChild(picker);
reactionPickerOpen = msgId;
setTimeout(() => document.addEventListener('click', closeReactionPicker, { once: true }), 0);
}
function closeReactionPicker() { document.getElementById('reaction-quick-picker')?.remove(); reactionPickerOpen = null; }

// ‚ïê‚ïê‚ïê‚ïê DM ‚ïê‚ïê‚ïê‚ïê
let dmAllMessages = {};
function renderDmList() {
const list = document.getElementById('dm-list');
list.innerHTML = openDmRooms.map(({ roomId, otherUser }) => ` <div class="ch-item${currentDmRoom === roomId ? ' active' : ''}" onclick="openDm('${escHtml(otherUser)}')"> <span class="ch-icon">@</span><span>${escHtml(otherUser)}</span> </div>`).join('');
}

async function openDm(username) {
if (username === currentUser?.username) return;
closeModal('dm-search-modal');
const roomId = [currentUser.username, username].sort().join('__');
currentDmRoom = roomId;
currentChannel = null;
if (!openDmRooms.find(r => r.roomId === roomId)) {
openDmRooms.push({ roomId, otherUser: username });
localStorage.setItem('nexus_dmRooms', JSON.stringify(openDmRooms));
}
renderDmList();

document.getElementById('chat-header-icon').textContent = '@';
document.getElementById('chat-header-name').textContent = username;
document.getElementById('chat-header-topic').textContent = '„ÉÄ„Ç§„É¨„ÇØ„Éà„É°„ÉÉ„Çª„Éº„Ç∏';
document.getElementById('msg-input').placeholder = `${username} „Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°`;
document.getElementById('input-bar').style.display = '';
closeDrawers();

const msgEl = document.getElementById('messages');
msgEl.innerHTML = '';
const r = await fetch(`${API}/api/dm/${roomId}`, { headers: { Authorization: `Bearer ${token}` } });
if (r.ok) {
const msgs = await r.json();
msgs.forEach(m => renderMessageToDom(m, true));
// Êú™Ë™≠„ÇíÊó¢Ë™≠„Å´„Åô„Çã
if (msgs.length) markDmRead(msgs[msgs.length - 1]);
}
scrollToBottom();
}

function markDmRead(msg) {
if (msg.author !== currentUser?.username) socket.emit('dm_read', { roomId: msg.channelId, msgId: msg.id });
}

function openDmSearch() {
document.getElementById('dm-search-input').value = '';
renderDmSearchResults('');
openModal('dm-search-modal');
}

async function renderDmSearchResults(q) {
const container = document.getElementById('dm-search-results');
if (!window._allMembers) {
const r = await fetch(`${API}/api/members`, { headers: { Authorization: `Bearer ${token}` } });
if (r.ok) window._allMembers = await r.json();
}
const users = (window._allMembers || []).filter(u => u.username !== currentUser?.username && (!q || u.username.toLowerCase().includes(q.toLowerCase())));
container.innerHTML = users.map(u => ` <div class="member-item" onclick="openDm('${escHtml(u.username)}')"> <div class="member-avatar"><img src="${escHtml(u.avatar)}" /></div> <span class="member-name">${escHtml(u.username)}</span> <span class="member-badge ${u.role}">${u.role !== 'member' ? u.role : ''}</span> </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê MEMBERS ‚ïê‚ïê‚ïê‚ïê
async function renderMembers(users) {
// „Éï„É´„É°„É≥„Éê„Éº„É™„Çπ„Éà„ÇíÂèñÂæóÔºà„Ç™„Éï„É©„Ç§„É≥„ÇÇÂê´„ÇÄÔºâ
if (!window._allMembers) {
const r = await fetch(`${API}/api/members`, { headers: { Authorization: `Bearer ${token}` } });
if (r.ok) window._allMembers = await r.json();
}
const all = window._allMembers || [];
const onlineNames = new Set(users.map(u => u.username));
const statusMap = {};
users.forEach(u => statusMap[u.username] = u.status || 'online');

const online = all.filter(u => onlineNames.has(u.username));
const offline = all.filter(u => !onlineNames.has(u.username));

const renderUser = (u) => {
const status = statusMap[u.username] || 'offline';
return `<div class="member-item" onclick="openDm('${escHtml(u.username)}')"> <div class="member-avatar"> <img src="${escHtml(u.avatar)}" alt="${escHtml(u.username)}" /> <div class="member-status-dot ${status}"></div> </div> <span class="member-name${u.muted ? ' muted-user' : ''}">${escHtml(u.username)}</span> ${u.role !== 'member' ? `<span class="member-badge ${u.role}">${u.role}</span>`: ''} ${u.banned ?`<span class="member-badge banned">BAN</span>` : ''} </div>`;
};

const list = document.getElementById('members-list');
list.innerHTML =
(online.length ? `<div style="padding:4px 16px;font-size:11px;color:var(--text-3);font-weight:700;text-transform:uppercase">„Ç™„É≥„É©„Ç§„É≥ -- ${online.length}</div>${online.map(renderUser).join('')}` : '') +
(offline.length ? `<div style="padding:12px 16px 4px;font-size:11px;color:var(--text-3);font-weight:700;text-transform:uppercase">„Ç™„Éï„É©„Ç§„É≥ -- ${offline.length}</div>${offline.map(renderUser).join('')}` : '');
}

// ‚ïê‚ïê‚ïê‚ïê TYPING ‚ïê‚ïê‚ïê‚ïê
let typingTimeout = null;
let isTyping = false;
function emitTyping() {
if (!currentChannel) return;
if (!isTyping) { isTyping = true; socket.emit('typing', { channelId: currentChannel, isTyping: true }); }
clearTimeout(typingTimeout);
typingTimeout = setTimeout(() => { isTyping = false; socket.emit('typing', { channelId: currentChannel, isTyping: false }); }, 2000);
}
function updateTypingBar() {
const names = Object.keys(typingTimers);
const bar = document.getElementById('typing-bar');
if (!names.length) { bar.innerHTML = ''; return; }
bar.innerHTML = `<div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div> ${escHtml(names.join(', '))} „ÅåÂÖ•Âäõ‰∏≠...`;
}

// ‚ïê‚ïê‚ïê‚ïê SEARCH ‚ïê‚ïê‚ïê‚ïê
function toggleSearch() {
const bar = document.getElementById('search-bar');
bar.classList.toggle('open');
if (bar.classList.contains('open')) document.getElementById('search-input').focus();
else { document.getElementById('search-results').classList.remove('open'); document.getElementById('search-filters').classList.remove('open'); }
document.getElementById('search-btn').classList.toggle('active', bar.classList.contains('open'));
}
function toggleSearchFilters() { document.getElementById('search-filters').classList.toggle('open'); }
function debounceSearch(q) { clearTimeout(searchDebounce); searchDebounce = setTimeout(() => doSearch(), 400); }
async function doSearch() {
const q = document.getElementById('search-input').value.trim();
if (q.length < 2) { document.getElementById('search-results').classList.remove('open'); return; }
const scope = document.getElementById('search-scope').value;
const author = document.getElementById('search-author')?.value.trim() || '';
const from   = document.getElementById('search-from-date')?.value || '';
const to     = document.getElementById('search-to-date')?.value || '';
let url = `${API}/api/search?q=${encodeURIComponent(q)}`;
if (scope === 'current' && currentChannel) url += `&channel=${currentChannel}`;
if (author) url += `&author=${encodeURIComponent(author)}`;
if (from)   url += `&from=${from}T00:00:00.000Z`;
if (to)     url += `&to=${to}T23:59:59.999Z`;
const r = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
if (!r.ok) return;
const results = await r.json();
const container = document.getElementById('search-results');
container.innerHTML = results.length ? results.map(m => ` <div class="search-result-item" onclick="jumpToMsg('${m.id}','${m.channelId}')"> <div class="search-result-author">${escHtml(m.author)} <span style="color:var(--text-3);font-weight:400">in #${escHtml(m.channelId)}</span></div> <div class="search-result-content">${escHtml((m.content||'').substring(0,100))}</div> <div class="search-result-meta">${formatTime(m.timestamp)}</div> </div>`).join('') : '<div style="padding:12px;color:var(--text-3);font-size:13px">ÁµêÊûú„Å™„Åó</div>';
container.classList.add('open');
}
async function jumpToMsg(msgId, channelId) {
if (channelId !== currentChannel) await joinChannel(channelId);
setTimeout(() => {
const el = document.getElementById(`msg-${msgId}`);
if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); el.style.background = 'rgba(88,101,242,0.2)'; setTimeout(() => el.style.background = '', 2000); }
}, 300);
}

// ‚ïê‚ïê‚ïê‚ïê PINS ‚ïê‚ïê‚ïê‚ïê
async function openPins() {
if (!currentChannel) return;
const r = await fetch(`${API}/api/channels/${currentChannel}/pins`, { headers: { Authorization: `Bearer ${token}` } });
const pins = r.ok ? await r.json() : [];
const list = document.getElementById('pins-list');
if (!pins.length) { list.innerHTML = '<p style="color:var(--text-3)">„Éî„É≥Áïô„ÇÅ„Åï„Çå„Åü„É°„ÉÉ„Çª„Éº„Ç∏„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>'; }
else list.innerHTML = pins.map(p => `<div class="pin-item"> <div class="pin-item-body"> <div class="pin-item-author">${escHtml(p.author)}</div> <div class="pin-item-content">${escHtml((p.content||'').substring(0,200))}</div> <div class="pin-item-meta">${formatTime(p.timestamp)} * „Éî„É≥Áïô„ÇÅ by ${escHtml(p.pinnedBy||'')}</div> </div> ${['admin','moderator'].includes(currentUser?.role) ?`<button class="pin-unpin-btn" onclick="unpinMessage('${p.id}')">Ëß£Èô§</button>` : ''} </div>`).join('');
openModal('pins-modal');
}
function unpinMessage(msgId) { socket.emit('unpin_message', { msgId, channelId: currentChannel }); openPins(); }

// ‚ïê‚ïê‚ïê‚ïê BOOKMARKS ‚ïê‚ïê‚ïê‚ïê
async function loadBookmarkCache() {
const r = await fetch(`${API}/api/bookmarks`, { headers: { Authorization: `Bearer ${token}` } });
if (r.ok) { const list = await r.json(); list.forEach(b => bookmarkCache.add(b.msgId)); }
}
async function toggleBookmark(msgId, author, content, timestamp) {
const btn = document.getElementById(`bm-btn-${msgId}`);
if (bookmarkCache.has(msgId)) {
await fetch(`${API}/api/bookmarks/${msgId}`, { method:'DELETE', headers: { Authorization: `Bearer ${token}` } });
bookmarkCache.delete(msgId);
if (btn) btn.textContent = 'üè∑';
} else {
await fetch(`${API}/api/bookmarks`, { method:'POST', headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`}, body: JSON.stringify({ msgId, channelId: currentChannel, content, author, timestamp }) });
bookmarkCache.add(msgId);
if (btn) btn.textContent = 'üîñ';
}
}
async function openBookmarks() {
const r = await fetch(`${API}/api/bookmarks`, { headers: { Authorization: `Bearer ${token}` } });
const list = r.ok ? await r.json() : [];
const container = document.getElementById('bookmarks-list');
if (!list.length) { container.innerHTML = '<p style="color:var(--text-3)">„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>'; }
else container.innerHTML = list.map(b => ` <div class="bookmark-item" onclick="jumpToMsg('${b.msgId}','${b.channelId}');closeModal('bookmarks-modal')"> <div class="bookmark-author">${escHtml(b.author)} <span style="color:var(--text-3);font-weight:400">in #${escHtml(b.channelId||'')}</span></div> <div class="bookmark-content">${escHtml((b.content||'').substring(0,120))}</div> <div class="bookmark-meta"> <span>${formatTime(b.timestamp)}</span> <button class="bookmark-remove-btn" onclick="event.stopPropagation();removeBookmark('${b.msgId}',this.closest('.bookmark-item'))">‚úï</button> </div> </div>`).join('');
openModal('bookmarks-modal');
}
async function removeBookmark(msgId, el) {
await fetch(`${API}/api/bookmarks/${msgId}`, { method:'DELETE', headers: { Authorization: `Bearer ${token}` } });
bookmarkCache.delete(msgId);
el?.remove();
document.getElementById(`bm-btn-${msgId}`)?.setAttribute('textContent', 'üè∑');
}

// ‚ïê‚ïê‚ïê‚ïê STATUS ‚ïê‚ïê‚ïê‚ïê
function openStatusMenu(e) {
e.stopPropagation();
const menu = document.getElementById('status-menu');
const rect = e.currentTarget.getBoundingClientRect();
menu.style.left = rect.left + 'px';
menu.style.bottom = (window.innerHeight - rect.top + 8) + 'px';
menu.style.display = 'block';
}
function setStatus(status) {
socket?.emit('set_status', status);
const dot = document.getElementById('user-status-dot');
dot.className = `user-status-dot ${status}`;
document.getElementById('status-menu').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê KEYWORDS ‚ïê‚ïê‚ïê‚ïê
function handleKeywordInput(e) {
if (e.key === 'Enter' || e.key === ',') {
e.preventDefault();
const val = document.getElementById('keyword-input').value.trim().toLowerCase();
if (val && !keywordTags.includes(val) && keywordTags.length < 20) {
keywordTags.push(val);
renderKeywordTags();
document.getElementById('keyword-input').value = '';
}
}
}
function renderKeywordTags() {
const container = document.getElementById('keyword-tags-container');
const input = document.getElementById('keyword-input');
container.innerHTML = '';
keywordTags.forEach((kw, i) => {
const tag = document.createElement('span');
tag.className = 'keyword-tag';
tag.innerHTML = `${escHtml(kw)}<button onclick="removeKeyword(${i})">√ó</button>`;
container.appendChild(tag);
});
container.appendChild(input);
}
function removeKeyword(i) { keywordTags.splice(i, 1); renderKeywordTags(); }
async function saveKeywords() {
const r = await fetch(`${API}/api/profile/keywords`, { method:'PUT', headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`}, body: JSON.stringify({ keywords: keywordTags }) });
if (r.ok) { const msg = document.getElementById('keyword-save-msg'); msg.style.display = ''; setTimeout(() => msg.style.display = 'none', 2000); }
}
function checkKeywordNotif(msg) {
if (!keywordTags.length) return;
const lower = (msg.content || '').toLowerCase();
const matched = keywordTags.find(kw => lower.includes(kw));
if (matched) showToastNotif('üîë', `„Ç≠„Éº„ÉØ„Éº„Éâ„Äå${matched}„Äç`, msg.content, () => {});
}

// ‚ïê‚ïê‚ïê‚ïê ADMIN ‚ïê‚ïê‚ïê‚ïê
async function openAdminPanel() {
openModal('admin-modal');
switchAdminTab('users');
}
function switchAdminTab(tab) {
document.querySelectorAll('#admin-modal .modal-tab').forEach((t,i) => t.classList.toggle('active', ['users','channels','invites','emojis'][i] === tab));
document.querySelectorAll('#admin-modal .modal-tab-pane').forEach(p => p.classList.remove('active'));
document.getElementById(`admin-tab-${tab}`)?.classList.add('active');
if (tab === 'users') loadAdminUsers();
else if (tab === 'channels') loadAdminChannels();
else if (tab === 'invites') loadAdminInvites();
else if (tab === 'emojis') loadAdminEmojis();
}

async function loadAdminUsers() {
const r = await fetch(`${API}/api/users`, { headers: { Authorization: `Bearer ${token}` } });
const users = r.ok ? await r.json() : [];
window._allMembers = users;
document.getElementById('admin-users-list').innerHTML = users.map(u => `<div class="admin-user-row"> <img class="admin-user-avatar" src="${escHtml(u.avatar)}" /> <span class="admin-user-name">${escHtml(u.username)} ${u.banned ? 'üö´' : ''} ${u.muted ? 'üîá' : ''}</span> <select class="role-select" onchange="changeRole('${escHtml(u.username)}',this.value)"> <option value="member"${u.role==='member'?' selected':''}>member</option> <option value="moderator"${u.role==='moderator'?' selected':''}>moderator</option> <option value="admin"${u.role==='admin'?' selected':''}>admin</option> </select> <button class="admin-action-btn mute-btn" onclick="${u.muted ?`unmuteUser('${escHtml(u.username)}')`:`muteUser('${escHtml(u.username)}')`}">${u.muted ? 'üîä „Éü„É•„Éº„ÉàËß£Èô§' : 'üîá „Éü„É•„Éº„Éà'}</button> <button class="admin-action-btn ban-btn" onclick="${u.banned ? `unbanUser('${escHtml(u.username)}')`:`banUser('${escHtml(u.username)}')`}">${u.banned ? 'üîì BANËß£Èô§' : 'üö´ BAN'}</button> </div>`).join('');
}

async function changeRole(username, role) {
await fetch(`${API}/api/users/${username}/role`, { method:'PUT', headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`}, body: JSON.stringify({ role }) });
}
async function muteUser(username) { await fetch(`${API}/api/users/${username}/mute`, { method:'POST', headers:{ Authorization:`Bearer ${token}` } }); loadAdminUsers(); }
async function unmuteUser(username) { await fetch(`${API}/api/users/${username}/unmute`, { method:'POST', headers:{ Authorization:`Bearer ${token}` } }); loadAdminUsers(); }
async function banUser(username) { if (!confirm(`${username} „ÇíBAN„Åó„Åæ„Åô„ÅãÔºü`)) return; await fetch(`${API}/api/users/${username}/ban`, { method:'POST', headers:{ Authorization:`Bearer ${token}` } }); loadAdminUsers(); }
async function unbanUser(username) { await fetch(`${API}/api/users/${username}/unban`, { method:'POST', headers:{ Authorization:`Bearer ${token}` } }); loadAdminUsers(); }

async function loadAdminChannels() {
const chs = Object.values(channels_state);
document.getElementById('admin-channels-list').innerHTML = chs.map(ch => `<div class="ch-manage-row"> <span class="ch-manage-name">${ch.readonly ? 'üì¢' : '#'}${escHtml(ch.name)} <span style="color:var(--text-3);font-size:12px">${escHtml(ch.topic||'')}</span></span> <button class="ch-edit-btn" onclick="openChannelEdit('${ch.id}')">Á∑®ÈõÜ</button> ${!['general','random','media','dev'].includes(ch.id) ?`<button class="ch-del-btn" onclick="deleteChannel('${ch.id}')">ÂâäÈô§</button>` : ''} </div>`).join('');
}

async function createChannel() {
const name = document.getElementById('new-channel-name').value.trim();
const topic = document.getElementById('new-channel-topic').value.trim();
if (!name) return;
const r = await fetch(`${API}/api/channels`, { method:'POST', headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`}, body: JSON.stringify({ name, topic }) });
const d = await r.json();
if (!r.ok) { alert(d.error); return; }
document.getElementById('new-channel-name').value = '';
document.getElementById('new-channel-topic').value = '';
loadAdminChannels();
}

function openChannelEdit(channelId) {
editingChannelId = channelId;
const ch = channels_state[channelId];
document.getElementById('edit-channel-topic').value = ch?.topic || '';
const readonlyToggle = document.getElementById('edit-channel-readonly');
readonlyToggle.classList.toggle('on', ch?.readonly || false);
document.getElementById('channel-edit-title').textContent = `#${ch?.name} „ÇíÁ∑®ÈõÜ`;
closeModal('admin-modal');
openModal('channel-edit-modal');
}
async function saveChannelEdit() {
if (!editingChannelId) return;
const topic = document.getElementById('edit-channel-topic').value.trim();
const readonly = document.getElementById('edit-channel-readonly').classList.contains('on');
await fetch(`${API}/api/channels/${editingChannelId}`, { method:'PUT', headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`}, body: JSON.stringify({ topic, readonly }) });
closeModal('channel-edit-modal');
}

async function deleteChannel(channelId) {
if (!confirm(`#${channelId} „ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ`)) return;
await fetch(`${API}/api/channels/${channelId}`, { method:'DELETE', headers:{ Authorization:`Bearer ${token}` } });
loadAdminChannels();
}

function openChannelCreate() {
openAdminPanel();
setTimeout(() => switchAdminTab('channels'), 100);
}

async function openTopicEdit() {
if (!['admin','moderator'].includes(currentUser?.role)) return;
openChannelEdit(currentChannel);
}

async function loadAdminInvites() {
const r = await fetch(`${API}/api/invites`, { headers: { Authorization: `Bearer ${token}` } });
const list = r.ok ? await r.json() : [];
document.getElementById('admin-invites-list').innerHTML = list.length ? list.map(inv => `<div class="invite-row"> <span class="invite-code">${escHtml(inv.code)}</span> <span class="invite-meta">${inv.used ? '‰ΩøÁî®Ê∏à' : inv.expiresAt ?`ÊúüÈôê: ${new Date(inv.expiresAt).toLocaleDateString()}` : 'ÊúüÈôê„Å™„Åó'}</span> <button class="invite-copy-btn" onclick="navigator.clipboard.writeText('${escHtml(inv.code)}');this.textContent='‚úì „Ç≥„Éî„Éº'">„Ç≥„Éî„Éº</button> <button class="secondary-btn" onclick="deleteInvite('${escHtml(inv.code)}')">ÂâäÈô§</button> </div>`).join('') : '<p style="color:var(--text-3)">ÊãõÂæÖ„Ç≥„Éº„Éâ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
}
async function createInvite() {
const expiresIn = document.getElementById('invite-expires').value || null;
const r = await fetch(`${API}/api/invites`, { method:'POST', headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`}, body: JSON.stringify({ expiresIn: expiresIn ? parseInt(expiresIn) : null }) });
if (r.ok) loadAdminInvites();
}
async function deleteInvite(code) { await fetch(`${API}/api/invites/${code}`, { method:'DELETE', headers:{ Authorization:`Bearer ${token}` } }); loadAdminInvites(); }

async function loadAdminEmojis() {
const r = await fetch(`${API}/api/emojis`, { headers: { Authorization: `Bearer ${token}` } });
const list = r.ok ? await r.json() : [];
document.getElementById('admin-emojis-list').innerHTML = list.length ? list.map(e => ` <div class="emoji-manage-row"> <img class="emoji-manage-preview" src="${escHtml(e.url)}" /> <span class="emoji-manage-name">:${escHtml(e.name)}:</span> <button class="secondary-btn" onclick="deleteEmoji('${escHtml(e.name)}')">ÂâäÈô§</button> </div>`).join('') : '<p style="color:var(--text-3)">„Ç´„Çπ„Çø„É†ÁµµÊñáÂ≠ó„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
}
async function uploadEmoji() {
const name = document.getElementById('new-emoji-name').value.trim();
const file = document.getElementById('new-emoji-file').files[0];
if (!name || !file) { alert('ÂêçÂâç„Å®ÁîªÂÉè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
const form = new FormData();
form.append('name', name);
form.append('image', file);
const r = await fetch(`${API}/api/emojis`, { method:'POST', headers:{ Authorization:`Bearer ${token}` }, body: form });
if (!r.ok) { const d = await r.json(); alert(d.error); return; }
loadAdminEmojis();
}
async function deleteEmoji(name) { await fetch(`${API}/api/emojis/${name}`, { method:'DELETE', headers:{ Authorization:`Bearer ${token}` } }); loadAdminEmojis(); }

// ‚ïê‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê‚ïê
const AVATAR_STYLES = [
{ key:'bottts', label:'ü§ñ „Éú„ÉÉ„Éà' }, { key:'avataaars', label:'üë§ ‰∫∫Áâ©' },
{ key:'pixel-art', label:'üéÆ „Éî„ÇØ„Çª„É´' }, { key:'fun-emoji', label:'üòÄ ÁµµÊñáÂ≠ó' },
{ key:'thumbs', label:'üëç „Çµ„É†„Ç∫' }, { key:'shapes', label:'üî∑ „Ç∑„Çß„Ç§„Éó' },
];

function openSettings() {
document.getElementById('settings-username').textContent = currentUser?.username || '--';
document.getElementById('settings-role').textContent = currentUser?.role || 'member';
document.getElementById('settings-username-display').textContent = currentUser?.username || '--';
document.getElementById('settings-role-display').textContent = currentUser?.role || 'member';
pendingAvatar = currentUser?.avatar;
document.getElementById('settings-avatar-preview').src = pendingAvatar || '';
const container = document.getElementById('avatar-style-btns');
container.innerHTML = AVATAR_STYLES.map(s =>
`<button onclick="previewAvatarStyle('${s.key}')" class="secondary-btn" style="font-size:12px;padding:4px 10px">${s.label}</button>`).join('');
renderKeywordTags();
applySettings();
switchSettingsTab('appearance');
openModal('settings-modal');
}
function switchSettingsTab(tab) {
document.querySelectorAll('#settings-modal .modal-tab').forEach((t,i) => t.classList.toggle('active', ['appearance','avatar','notifications','account'][i] === tab));
document.querySelectorAll('#settings-modal .modal-tab-pane').forEach(p => p.classList.remove('active'));
document.getElementById(`settings-tab-${tab}`)?.classList.add('active');
}

function previewAvatarStyle(style) {
const url = `https://api.dicebear.com/7.x/${style}/svg?seed=${encodeURIComponent(currentUser?.username||'user')}`;
pendingAvatar = url;
document.getElementById('settings-avatar-preview').src = url;
}
async function handleAvatarFileSelect(files) {
if (!files?.length) return;
const form = new FormData(); form.append('file', files[0]);
const r = await fetch(`${API}/api/upload`, { method:'POST', headers:{ Authorization:`Bearer ${token}` }, body: form });
if (!r.ok) { alert('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'); return; }
const d = await r.json();
pendingAvatar = d.url.startsWith('http') ? d.url : `${API}${d.url}`;
document.getElementById('settings-avatar-preview').src = pendingAvatar;
}
async function saveAvatar() {
if (!pendingAvatar || pendingAvatar === currentUser?.avatar) return;
const r = await fetch(`${API}/api/profile/avatar`, { method:'PUT', headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`}, body: JSON.stringify({ avatar: pendingAvatar }) });
if (!r.ok) { alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'); return; }
currentUser.avatar = pendingAvatar;
document.getElementById('user-avatar-img').src = pendingAvatar;
const msg = document.getElementById('avatar-save-msg'); msg.style.display = ''; setTimeout(() => msg.style.display = 'none', 2000);
}

async function changePassword() {
const cur = document.getElementById('pw-current').value;
const nw  = document.getElementById('pw-new').value;
const msgEl = document.getElementById('pw-msg');
if (!cur || !nw) { showPwMsg('ÁèæÂú®„Å®Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'red'); return; }
const r = await fetch(`${API}/api/profile/password`, { method:'PUT', headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`}, body: JSON.stringify({ currentPassword: cur, newPassword: nw }) });
const d = await r.json();
if (!r.ok) { showPwMsg(d.error || 'Â§âÊõ¥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'red'); return; }
showPwMsg('‚úì „Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü', 'var(--green)');
document.getElementById('pw-current').value = '';
document.getElementById('pw-new').value = '';
}
function showPwMsg(msg, color) {
const el = document.getElementById('pw-msg');
el.textContent = msg; el.style.color = color; el.style.display = '';
setTimeout(() => el.style.display = 'none', 3000);
}

async function loadSessions() {
const r = await fetch(`${API}/api/profile/sessions`, { headers: { Authorization: `Bearer ${token}` } });
const list = r.ok ? await r.json() : [];
document.getElementById('sessions-list').innerHTML = list.length ? list.map(s => ` <div class="session-row"> <div class="session-ip">üìç ${escHtml(s.ip || '‰∏çÊòé')}</div> <div class="session-meta">${escHtml((s.ua||'').substring(0,80))} * ${new Date(s.loginAt).toLocaleString()}</div> </div>`).join('') : '<p style="color:var(--text-3);font-size:13px">Â±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
}

function setTheme(t) { settings.theme = t; applySettings(); saveSettings(); }
function setFontSize(v) { settings.fontSize = parseInt(v); document.getElementById('font-size-label').textContent = v + 'px'; applySettings(); saveSettings(); }
function setSendKey(v) { settings.sendKey = v; saveSettings(); }
function toggleSetting(k) { settings[k] = !settings[k]; document.getElementById('toggle-' + (k === 'mentionOnly' ? 'mention-only' : k)).classList.toggle('on', settings[k]); saveSettings(); }
async function requestNotifPermission() { const p = await Notification.requestPermission(); settings.notif = p === 'granted'; document.getElementById('toggle-notif').classList.toggle('on', settings.notif); saveSettings(); }
function applySettings() {
document.body.classList.toggle('theme-light', settings.theme === 'light');
document.getElementById('theme-dark')?.classList.toggle('active', settings.theme === 'dark');
document.getElementById('theme-light')?.classList.toggle('active', settings.theme === 'light');
document.documentElement.style.setProperty('--font-size', settings.fontSize + 'px');
const sl = document.getElementById('font-slider'); if (sl) sl.value = settings.fontSize;
const fl = document.getElementById('font-size-label'); if (fl) fl.textContent = settings.fontSize + 'px';
document.getElementById('toggle-sound')?.classList.toggle('on', settings.sound);
document.getElementById('toggle-notif')?.classList.toggle('on', settings.notif);
document.getElementById('toggle-mention-only')?.classList.toggle('on', settings.mentionOnly);
const sk = document.getElementById('send-key-select'); if (sk) sk.value = settings.sendKey;
}
function saveSettings() { localStorage.setItem('nexus_settings', JSON.stringify(settings)); }

function openLogoutConfirm() { closeModal('settings-modal'); openModal('logout-confirm-modal'); }
function logout() { localStorage.removeItem('token'); localStorage.removeItem('nexus_dmRooms'); socket?.disconnect(); location.reload(); }
function openDeleteAccount() { document.getElementById('delete-account-pw').value = ''; document.getElementById('delete-account-err').style.display = 'none'; openModal('delete-account-modal'); }
async function confirmDeleteAccount() {
const pw = document.getElementById('delete-account-pw').value;
if (!pw) { showDeleteErr('„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
const r = await fetch(`${API}/api/account`, { method:'DELETE', headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`}, body: JSON.stringify({ password: pw }) });
const d = await r.json();
if (!r.ok) { showDeleteErr(d.error || 'ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'); return; }
alert('„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
logout();
}
function showDeleteErr(msg) { const el = document.getElementById('delete-account-err'); el.textContent = msg; el.style.display = ''; }

// ‚ïê‚ïê‚ïê‚ïê FILE UPLOAD ‚ïê‚ïê‚ïê‚ïê
let fileInputEl;
function openFilePicker() {
if (!fileInputEl) { fileInputEl = document.createElement('input'); fileInputEl.type = 'file'; fileInputEl.style.display = 'none'; fileInputEl.onchange = e => handleFileSelect(e.target.files); document.body.appendChild(fileInputEl); }
fileInputEl.click();
}
async function handleFileSelect(files) {
if (!files?.length) return;
showUploadToast('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠...');
const form = new FormData(); form.append('file', files[0]);
const r = await fetch(`${API}/api/upload`, { method:'POST', headers:{ Authorization:`Bearer ${token}` }, body: form });
hideUploadToast();
if (!r.ok) { alert('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'); return; }
const fi = await r.json();
if (currentDmRoom) {
const other = currentDmRoom.split('__').find(u => u !== currentUser?.username);
socket.emit('send_dm', { toUsername: other, content: `üìé ${fi.filename}`, fileInfo: fi });
} else {
socket.emit('send_file', { channelId: currentChannel, fileInfo: fi });
}
}
function showUploadToast(msg) { const t = document.getElementById('upload-toast'); t.querySelector('#upload-toast-text').textContent = msg; t.classList.add('show'); }
function hideUploadToast() { document.getElementById('upload-toast').classList.remove('show'); }
function initDragDrop() {
document.addEventListener('dragover', e => { e.preventDefault(); document.getElementById('drop-overlay').classList.add('active'); });
document.addEventListener('dragleave', e => { if (!e.relatedTarget) document.getElementById('drop-overlay').classList.remove('active'); });
document.addEventListener('drop', e => { e.preventDefault(); document.getElementById('drop-overlay').classList.remove('active'); handleFileSelect(e.dataTransfer.files); });
}

// ‚ïê‚ïê‚ïê‚ïê EMOJI PICKER ‚ïê‚ïê‚ïê‚ïê
const EMOJI_DATA = { 'üòÄ È°î': ['üòÄ','üòÇ','üòÖ','ü§£','üòä','üòá','üôÇ','üòç','ü•∞','üòò','üòã','üòé','ü•≥','ü§©','üòè','üòí','üòû','üòî','üòü','üòï','üôÅ','‚òπÔ∏è','üò£','üòñ','üò´','üò©','ü•∫','üò¢','üò≠','üò§','üò†','üò°','ü§¨','üòà','üíÄ'], '‚ù§Ô∏è „Éè„Éº„Éà': ['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','üíï','üíû','üíì','üíó','üíñ','üíò','üíù','üíü','‚ù£Ô∏è'], 'üëç „Ç∏„Çß„Çπ„ÉÅ„É£„Éº': ['üëç','üëé','üëå','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëà','üëâ','üëÜ','üëá','‚òùÔ∏è','‚úã','ü§ö','üñêÔ∏è','üññ','üëã','ü§ú','ü§õ','üëä','‚úä','üôå','üëê','ü§≤','üôè'], 'üéâ „ÅäÁ•ù„ÅÑ': ['üéâ','üéä','üéà','üéÅ','üéÄ','üéÜ','üéá','‚ú®','üåü','‚≠ê','üèÜ','ü•á','üéñÔ∏è'], 'üî• „Ç∑„É≥„Éú„É´': ['üî•','üíØ','‚úÖ','‚ùå','‚≠ï','‚ùì','‚ùó','üí§','üÜí','üÜì','üÜï','üÜô','üÜó'] };

function toggleEmojiPicker() {
const picker = document.getElementById('emoji-picker');
if (picker.classList.toggle('open')) {
const cats = document.getElementById('emoji-cats');
cats.innerHTML = Object.keys(EMOJI_DATA).concat(customEmojiList.length ? ['üé® „Ç´„Çπ„Çø„É†'] : []).map((c,i) => `<button class="emoji-cat-btn${i===0?' active':''}" onclick="showEmojiCat(${i},'${escHtml(c)}')">${c.split(' ')[0]}</button>`).join('');
showEmojiCat(0, Object.keys(EMOJI_DATA)[0]);
}
}
function showEmojiCat(idx, cat) {
document.querySelectorAll('.emoji-cat-btn').forEach((b,i) => b.classList.toggle('active', i === idx));
const grid = document.getElementById('emoji-grid');
if (cat === 'üé® „Ç´„Çπ„Çø„É†') {
grid.innerHTML = customEmojiList.map(e => `<button class="emoji-btn-item" onclick="insertEmoji(':${e.name}:')" title=":${escHtml(e.name)}:"><img class="custom-emoji-img" src="${escHtml(e.url)}" /></button>`).join('');
} else {
grid.innerHTML = (EMOJI_DATA[cat] || []).map(e => `<button class="emoji-btn-item" onclick="insertEmoji('${e}')">${e}</button>`).join('');
}
}
function insertEmoji(e) { const inp = document.getElementById('msg-input'); inp.value += e; inp.focus(); document.getElementById('emoji-picker').classList.remove('open'); }

// ‚ïê‚ïê‚ïê‚ïê NOTIFICATION ‚ïê‚ïê‚ïê‚ïê
function showToastNotif(icon, title, text, onClick) {
document.querySelectorAll('.toast-notif').forEach(el => el.remove());
const el = document.createElement('div'); el.className = 'toast-notif';
el.innerHTML = `<div class="toast-notif-icon">${icon}</div><div class="toast-notif-body"><div class="toast-notif-title">${escHtml(title)}</div>${text ? `<div class="toast-notif-text">${escHtml(text.substring(0,80))}</div>` : ''}</div>`;
if (onClick) el.onclick = () => { onClick(); el.remove(); };
document.body.appendChild(el);
setTimeout(() => el.remove(), 4000);
if (settings.sound) { try { const ctx = new AudioContext(); const g = ctx.createGain(); g.gain.value = 0.15; const o = ctx.createOscillator(); o.frequency.value = 880; o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime + 0.1); } catch(e) {} }
if (settings.notif && document.hidden) { try { new Notification(String(title), { body: String(text || ''), icon: '/favicon.ico' }); } catch(e) {} }
}

// ‚ïê‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê‚ïê
function renderContent(text) {
if (!text) return { html: '', urls: [] };
const urlRx = /https?:\/\/[^\s<>"')\]]+/g;
const urls = (text.match(urlRx) || []).slice(0, 2);
let t = escHtml(text);
t = t.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
t = t.replace(/\*(.+?)\*/g, '<em>$1</em>');
t = t.replace(/`(.+?)`/g, '<code style="background:var(--bg-panel);padding:1px 5px;border-radius:4px;font-family:var(--font-mono);font-size:13px">$1</code>');
t = t.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
t = t.replace(/https?:\/\/[^\s<>"'&)\]]+/g, function(url) {
  const clean = url.replace(/&amp;/g, '&');
  return '<a href="' + clean + '" target="_blank" rel="noopener noreferrer" style="color:var(--accent);text-decoration:none;" onmouseover="this.style.textDecoration=\'underline\'" onmouseout="this.style.textDecoration=\'none\'">' + url + '</a>';
});
t = t.replace(/\n/g, '<br>');
t = t.replace(/:([a-z0-9_]+):/g, function(m, name) {
  const ce = customEmojiList.find(function(e) { return e.name === name; });
  return ce ? '<img src="' + escHtml(ce.url) + '" class="custom-emoji-img" title=":' + escHtml(name) + ':" />' : m;
});
return { html: t, urls: urls };
}
function escHtml(s) { return String(s || '').replace(/&/g,'&').replace(/</g,'<').replace(/>/g,'>').replace(/"/g,'"').replace(/'/g,'''); }
function formatTime(ts) { const d = new Date(ts); return d.toLocaleString('ja-JP', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' }); }
function formatBytes(b) { if (!b) return ''; if (b < 1024) return b + 'B'; if (b < 1048576) return (b/1024).toFixed(1) + 'KB'; return (b/1048576).toFixed(1) + 'MB'; }
function scrollToBottom() { const m = document.getElementById('messages'); requestAnimationFrame(() => { m.scrollTop = m.scrollHeight; }); }
function handleKey(e) {
if (settings.sendKey === 'enter') { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
else { if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); sendMessage(); } }
}
function autoResize(el) { el.style.height = '24px'; el.style.height = Math.min(el.scrollHeight, 200) + 'px'; }
function openLightbox(src) { document.getElementById('lightbox-img').src = src; document.getElementById('lightbox').classList.add('open'); }
function closeLightbox() { document.getElementById('lightbox').classList.remove('open'); }
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
function closeModalOutside(e, id) { if (e.target === document.getElementById(id)) closeModal(id); }
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('drawer-overlay').classList.toggle('open'); }
function toggleMembers() { document.getElementById('members-panel').classList.toggle('open'); document.getElementById('drawer-overlay').classList.toggle('open'); }
function closeDrawers() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('members-panel').classList.remove('open'); document.getElementById('drawer-overlay').classList.remove('open'); }

function initMobile() {
const isMobile = window.matchMedia('(max-width:640px)').matches;
if (!isMobile) return;
document.getElementById('msg-input').addEventListener('focus', () => setTimeout(scrollToBottom, 350));
let tx = 0, ty = 0;
document.addEventListener('touchstart', e => { tx = e.touches[0].clientX; ty = e.touches[0].clientY; }, { passive: true });
document.addEventListener('touchend', e => {
const dx = e.changedTouches[0].clientX - tx;
const dy = Math.abs(e.changedTouches[0].clientY - ty);
if (dx > 60 && dy < 60 && tx < 30) toggleSidebar();
else if (dx < -60 && dy < 60) closeDrawers();
}, { passive: true });
}


// ‚ïê‚ïê‚ïê‚ïê OGP Preview ‚ïê‚ïê‚ïê‚ïê
const _ogpFetched = new Set();
function fetchAndRenderOgp(msgEl, url) {
  if (_ogpFetched.has(url)) return;
  _ogpFetched.add(url);
  fetch('/api/ogp?url=' + encodeURIComponent(url), { headers: { 'Authorization': 'Bearer ' + token } })
    .then(function(r) { return r.ok ? r.json() : null; })
    .then(function(ogp) {
      if (!ogp || !ogp.title) return;
      const card = document.createElement('a');
      card.href = ogp.url || url;
      card.target = '_blank';
      card.rel = 'noopener noreferrer';
      card.className = 'ogp-card';
      let imgHtml = ogp.image ? '<img class="ogp-card-img" src="' + escHtml(ogp.image) + '" alt="" onerror="this.style.display=\'none\'" loading="lazy" />' : '';
      let descHtml = ogp.description ? '<div class="ogp-card-desc">' + escHtml(ogp.description) + '</div>' : '';
      card.innerHTML = '<div class="ogp-card-accent"></div><div class="ogp-card-body"><div class="ogp-card-site">' + escHtml(ogp.siteName || '') + '</div><div class="ogp-card-title">' + escHtml(ogp.title || '') + '</div>' + descHtml + '</div>' + imgHtml;
      const body = msgEl.querySelector('.msg-body');
      if (body) body.appendChild(card);
    })
    .catch(function() {});
}

// ‚ïê‚ïê‚ïê‚ïê Voice Channel (WebRTC) ‚ïê‚ïê‚ïê‚ïê
const VOICE_CHANNELS = [
  { id: 'voice-general', name: 'General' },
  { id: 'voice-music', name: 'Music' },
  { id: 'voice-gaming', name: 'Gaming' }
];
const STUN_CONFIG = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }] };
let _voiceChannel = null;
let _localStream = null;
let _peers = {};
let _voiceMuted = false;
let _voiceStateMap = {};

function renderVoiceChannelList() {
  const list = document.getElementById('voice-channel-list');
  if (!list) return;
  list.innerHTML = VOICE_CHANNELS.map(function(vc) {
    const users = _voiceStateMap[vc.id] || [];
    const isActive = _voiceChannel === vc.id;
    const usersHtml = users.length > 0 ? '<div class="ch-voice-users">' + users.map(function(u) {
      return '<div class="ch-voice-user"><div class="voice-dot-sm"></div>' + escHtml(u.username) + '</div>';
    }).join('') + '</div>' : '';
    return '<div class="ch-voice-item' + (isActive ? ' active-voice' : '') + '" onclick="joinVoiceChannel(\'' + vc.id + '\')">'
      + '<span>&#128266;</span>'
      + '<span style="flex:1">' + escHtml(vc.name) + '</span>'
      + (users.length ? '<span style="font-size:11px;color:var(--green);font-weight:600">' + users.length + '</span>' : '')
      + '</div>' + usersHtml;
  }).join('');
}

async function joinVoiceChannel(roomId) {
  if (_voiceChannel === roomId) return;
  if (_voiceChannel) await leaveVoiceChannel();
  try {
    _localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
  } catch(e) {
    alert('„Éû„Ç§„ÇØ„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü„ÄÇ\n„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„Åã„Çâ„Éû„Ç§„ÇØ„ÅÆË®±ÂèØ„Çí„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    return;
  }
  _voiceChannel = roomId;
  _voiceMuted = false;
  const vc = VOICE_CHANNELS.find(function(v) { return v.id === roomId; });
  document.getElementById('voice-panel-channel').textContent = vc ? '#' + vc.name : roomId;
  document.getElementById('voice-panel').classList.add('open');
  const muteBtn = document.getElementById('voice-mute-btn');
  muteBtn.textContent = String.fromCharCode(127908) + ' „Éü„É•„Éº„Éà';
  muteBtn.classList.remove('muted');
  renderVoiceChannelList();
  updateVoiceParticipants();
  socket.emit('voice_join', { roomId: roomId });
}

async function leaveVoiceChannel() {
  if (!_voiceChannel) return;
  const roomId = _voiceChannel;
  _voiceChannel = null;
  Object.values(_peers).forEach(function(pc) { pc.close(); });
  _peers = {};
  if (_localStream) { _localStream.getTracks().forEach(function(t) { t.stop(); }); _localStream = null; }
  document.querySelectorAll('.remote-audio').forEach(function(el) { el.remove(); });
  socket.emit('voice_leave', { roomId: roomId });
  document.getElementById('voice-panel').classList.remove('open');
  renderVoiceChannelList();
  updateVoiceParticipants();
}

function toggleVoiceMute() {
  _voiceMuted = !_voiceMuted;
  if (_localStream) {
    _localStream.getAudioTracks().forEach(function(t) { t.enabled = !_voiceMuted; });
  }
  const btn = document.getElementById('voice-mute-btn');
  btn.textContent = _voiceMuted ? String.fromCharCode(128263) + ' „Éü„É•„Éº„Éà‰∏≠' : String.fromCharCode(127908) + ' „Éü„É•„Éº„Éà';
  btn.classList.toggle('muted', _voiceMuted);
  updateVoiceParticipants();
}

function updateVoiceParticipants() {
  const list = document.getElementById('voice-participants-list');
  if (!list) return;
  if (!_voiceChannel) { list.innerHTML = ''; return; }
  const others = _voiceStateMap[_voiceChannel] || [];
  const allUsers = [{ username: (currentUser && currentUser.username) || '...', isSelf: true }]
    .concat(others.filter(function(u) { return u.username !== (currentUser && currentUser.username); }));
  list.innerHTML = allUsers.map(function(u) {
    return '<div class="voice-participant">'
      + '<div class="voice-participant-dot"></div>'
      + '<span>' + escHtml(u.username) + (u.isSelf ? ' („ÅÇ„Å™„Åü)' : '') + '</span>'
      + (_voiceMuted && u.isSelf ? ' <span style="color:var(--red);font-size:11px">&#128263;</span>' : '')
      + '</div>';
  }).join('');
}

async function _createPeerConnection(toSocketId, isInitiator) {
  const pc = new RTCPeerConnection(STUN_CONFIG);
  _peers[toSocketId] = pc;
  if (_localStream) {
    _localStream.getTracks().forEach(function(track) { pc.addTrack(track, _localStream); });
  }
  pc.ontrack = function(e) {
    let audio = document.getElementById('remote-audio-' + toSocketId);
    if (!audio) {
      audio = document.createElement('audio');
      audio.id = 'remote-audio-' + toSocketId;
      audio.className = 'remote-audio';
      audio.autoplay = true;
      document.body.appendChild(audio);
    }
    audio.srcObject = e.streams[0];
  };
  pc.onicecandidate = function(e) {
    if (e.candidate) {
      socket.emit('voice_ice', { toSocketId: toSocketId, candidate: e.candidate });
    }
  };
  pc.onconnectionstatechange = function() {
    if (['disconnected', 'failed', 'closed'].indexOf(pc.connectionState) >= 0) {
      pc.close();
      delete _peers[toSocketId];
      const el = document.getElementById('remote-audio-' + toSocketId);
      if (el) el.remove();
    }
  };
  if (isInitiator) {
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.emit('voice_offer', { toSocketId: toSocketId, offer: offer, roomId: _voiceChannel });
  }
  return pc;
}

function initVoiceSocketEvents() {
  socket.on('voice_peers', async function(data) {
    for (let i = 0; i < data.peers.length; i++) {
      await _createPeerConnection(data.peers[i].socketId, true);
    }
    updateVoiceParticipants();
  });
  socket.on('voice_user_joined', async function(data) {
    if (data.roomId === _voiceChannel && data.socketId !== socket.id) {
      await _createPeerConnection(data.socketId, false);
    }
    updateVoiceParticipants();
  });
  socket.on('voice_user_left', function(data) {
    if (_peers[data.socketId]) {
      _peers[data.socketId].close();
      delete _peers[data.socketId];
      const el = document.getElementById('remote-audio-' + data.socketId);
      if (el) el.remove();
    }
    updateVoiceParticipants();
  });
  socket.on('voice_offer', async function(data) {
    if (!_voiceChannel) return;
    const pc = await _createPeerConnection(data.fromSocketId, false);
    await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    socket.emit('voice_answer', { toSocketId: data.fromSocketId, answer: answer });
  });
  socket.on('voice_answer', async function(data) {
    const pc = _peers[data.fromSocketId];
    if (pc) await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
  });
  socket.on('voice_ice', async function(data) {
    const pc = _peers[data.fromSocketId];
    if (pc) { try { await pc.addIceCandidate(new RTCIceCandidate(data.candidate)); } catch(e) {} }
  });
  socket.on('voice_state', function(data) {
    _voiceStateMap[data.roomId] = data.users;
    renderVoiceChannelList();
    updateVoiceParticipants();
  });
}

// ‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê
if (token) {
fetch(`${API}/api/me`, { headers: { Authorization: `Bearer ${token}` } })
.then(r => r.ok ? r.json() : null).then(u => { if (u) { currentUser = u; startApp(); } });
}
</script>
