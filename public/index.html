<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>NexusChat</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<style>
:root {
  --bg-void:#0a0b0f; --bg-dark:#0f1117; --bg-mid:#161820;
  --bg-panel:#1c1f2a; --bg-hover:#252836; --bg-active:#2d3147;
  --border:rgba(255,255,255,0.07); --accent:#5865f2; --accent-glow:rgba(88,101,242,0.3);
  --accent-2:#eb459e; --green:#3ba55d; --yellow:#faa61a; --red:#ed4245;
  --text-1:#e3e5e8; --text-2:#b9bbbe; --text-3:#72767d; --text-muted:#4f545c;
  --font-main:'Outfit',sans-serif; --font-mono:'JetBrains Mono',monospace;
  --radius:8px; --radius-lg:14px; --sidebar-w:240px; --server-w:72px;
  --members-w:220px; --font-size:15px;
}
body.theme-light {
  --bg-void:#e3e5e8; --bg-dark:#ebedef; --bg-mid:#f2f3f5; --bg-panel:#ffffff;
  --bg-hover:#d9dadc; --bg-active:#c3c4c7; --border:rgba(0,0,0,0.1);
  --text-1:#060607; --text-2:#2e3338; --text-3:#4f5660; --text-muted:#96989d;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;font-family:var(--font-main);font-size:var(--font-size);background:var(--bg-void);color:var(--text-1);overflow:hidden;user-select:none;}

/* â”€â”€â”€ AUTH â”€â”€â”€ */
#auth-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(â€“bg-void);z-index:1000;}
.auth-bg{position:absolute;inset:0;background:radial-gradient(ellipse 60% 50% at 20% 30%,rgba(88,101,242,0.15) 0%,transparent 70%),radial-gradient(ellipse 50% 40% at 80% 70%,rgba(235,69,158,0.1) 0%,transparent 70%);}
.auth-card{position:relative;width:420px;background:var(â€“bg-panel);border:1px solid var(â€“border);border-radius:20px;padding:40px;box-shadow:0 32px 80px rgba(0,0,0,0.6);animation:cardIn 0.4s cubic-bezier(0.16,1,0.3,1);}
@keyframes cardIn{from{opacity:0;transform:translateY(24px) scale(0.97)}to{opacity:1;transform:none}}
.auth-logo{display:flex;align-items:center;gap:12px;margin-bottom:28px;}
.auth-logo-icon{width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,var(â€“accent),var(â€“accent-2));display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 0 24px var(â€“accent-glow);}
.auth-logo-text{font-size:24px;font-weight:700;background:linear-gradient(135deg,#fff 30%,var(â€“text-2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.auth-title{font-size:22px;font-weight:600;margin-bottom:6px;} .auth-subtitle{font-size:14px;color:var(â€“text-3);margin-bottom:28px;}
.tab-switcher{display:flex;background:var(â€“bg-mid);border-radius:var(â€“radius);padding:4px;margin-bottom:24px;gap:4px;}
.tab-btn{flex:1;padding:8px;border:none;background:transparent;color:var(â€“text-3);font-family:var(â€“font-main);font-size:14px;font-weight:500;border-radius:6px;cursor:pointer;transition:all 0.2s;}
.tab-btn.active{background:var(â€“accent);color:#fff;box-shadow:0 2px 8px var(â€“accent-glow);}
.field-label{display:block;font-size:12px;font-weight:600;color:var(â€“text-3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;}
.field-input{width:100%;padding:12px 14px;background:var(â€“bg-dark);border:1px solid var(â€“border);border-radius:var(â€“radius);color:var(â€“text-1);font-family:var(â€“font-main);font-size:15px;outline:none;transition:all 0.2s;margin-bottom:16px;}
.field-input:focus{border-color:var(â€“accent);box-shadow:0 0 0 3px var(â€“accent-glow);}
.field-input::placeholder{color:var(â€“text-muted);}
.auth-btn{width:100%;padding:13px;background:linear-gradient(135deg,var(â€“accent),#4752c4);border:none;border-radius:var(â€“radius);color:#fff;font-family:var(â€“font-main);font-size:15px;font-weight:600;cursor:pointer;transition:all 0.2s;box-shadow:0 4px 16px var(â€“accent-glow);}
.auth-btn:hover{opacity:0.9;} .auth-btn:active{transform:scale(0.98);}
.auth-error{margin-top:12px;padding:10px 14px;background:rgba(237,66,69,0.15);border:1px solid rgba(237,66,69,0.3);border-radius:var(â€“radius);color:var(â€“red);font-size:13px;display:none;}
.auth-error.show{display:block;}

/* â”€â”€â”€ APP LAYOUT â”€â”€â”€ */
#app{display:none;height:100vh;height:100dvh;flex-direction:row;}
#app.visible{display:flex;}
.server-list{width:var(â€“server-w);background:var(â€“bg-void);display:flex;flex-direction:column;align-items:center;padding:12px 0;gap:8px;overflow-y:auto;flex-shrink:0;border-right:1px solid var(â€“border);}
.server-icon{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(â€“accent),var(â€“accent-2));display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;transition:all 0.2s;position:relative;}
.server-icon:hover,.server-icon.active{border-radius:30%;transform:scale(1.05);box-shadow:0 0 0 3px var(â€“accent-glow);}
.server-sep{width:32px;height:2px;background:var(â€“bg-panel);border-radius:1px;}

/* â”€â”€â”€ SIDEBAR â”€â”€â”€ */
.sidebar{width:var(â€“sidebar-w);background:var(â€“bg-dark);display:flex;flex-direction:column;flex-shrink:0;border-right:1px solid var(â€“border);}
.sidebar-header{padding:16px;border-bottom:1px solid var(â€“border);font-weight:700;font-size:15px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:background 0.15s;}
.sidebar-header:hover{background:var(â€“bg-hover);}
.channels-section{flex:1;overflow-y:auto;padding:8px 0;}
.ch-category{padding:16px 16px 4px;font-size:11px;font-weight:700;color:var(â€“text-3);text-transform:uppercase;letter-spacing:0.8px;display:flex;align-items:center;justify-content:space-between;}
.ch-item{display:flex;align-items:center;gap:8px;padding:7px 8px 7px 16px;margin:1px 8px;border-radius:6px;cursor:pointer;color:var(â€“text-3);font-size:15px;font-weight:500;transition:all 0.15s;position:relative;}
.ch-item:hover{background:var(â€“bg-hover);color:var(â€“text-2);}
.ch-item.active{background:var(â€“bg-active);color:var(â€“text-1);}
.ch-item .ch-icon{font-size:16px;flex-shrink:0;}
.ch-item .unread-badge{margin-left:auto;background:var(â€“red);color:#fff;font-size:11px;font-weight:700;border-radius:10px;padding:1px 6px;min-width:18px;text-align:center;display:none;}
.ch-item.unread .unread-badge{display:block;}
.dm-section{border-top:1px solid var(â€“border);padding:8px 0;}

/* â”€â”€â”€ USER PANEL â”€â”€â”€ */
.user-panel{padding:10px 8px;background:var(â€“bg-void);display:flex;align-items:center;gap:8px;border-top:1px solid var(â€“border);}
.user-avatar{width:32px;height:32px;border-radius:50%;position:relative;flex-shrink:0;}
.user-avatar img{width:100%;height:100%;border-radius:50%;object-fit:cover;}
.user-status{position:absolute;bottom:-1px;right:-1px;width:10px;height:10px;border-radius:50%;background:var(â€“green);border:2px solid var(â€“bg-void);}
.user-info{flex:1;min-width:0;}
.user-name{font-size:13px;font-weight:600;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.user-tag{font-size:11px;color:var(â€“text-3);font-family:var(â€“font-mono);}
.user-actions{display:flex;gap:2px;}
.user-action-btn{width:28px;height:28px;border:none;background:transparent;color:var(â€“text-3);border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all 0.15s;}
.user-action-btn:hover{background:var(â€“bg-hover);color:var(â€“text-1);}

/* â”€â”€â”€ CHAT AREA â”€â”€â”€ */
.chat-area{flex:1;display:flex;flex-direction:column;min-width:0;background:var(â€“bg-mid);}
.chat-header{height:48px;padding:0 16px;border-bottom:1px solid var(â€“border);display:flex;align-items:center;gap:10px;flex-shrink:0;background:var(â€“bg-mid);}
.chat-header-icon{font-size:18px;color:var(â€“text-3);}
.chat-header-name{font-size:16px;font-weight:700;}
.chat-header-sep{width:1px;height:20px;background:var(â€“border);margin:0 4px;}
.chat-header-topic{font-size:13px;color:var(â€“text-3);overflow:hidden;white-space:nowrap;text-overflow:ellipsis;flex:1;}
.chat-header-actions{display:flex;gap:2px;margin-left:auto;}
.header-btn{width:32px;height:32px;border:none;background:transparent;color:var(â€“text-3);border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all 0.15s;}
.header-btn:hover{background:var(â€“bg-hover);color:var(â€“text-1);}
.header-btn.active{color:var(â€“accent);}

/* â”€â”€â”€ SEARCH BAR â”€â”€â”€ */
.search-bar{padding:8px 16px;border-bottom:1px solid var(â€“border);background:var(â€“bg-mid);display:none;}
.search-bar.open{display:flex;gap:8px;align-items:center;}
.search-input{flex:1;padding:8px 12px;background:var(â€“bg-panel);border:1px solid var(â€“border);border-radius:var(â€“radius);color:var(â€“text-1);font-family:var(â€“font-main);font-size:14px;outline:none;}
.search-input:focus{border-color:var(â€“accent);}
.search-input::placeholder{color:var(â€“text-muted);}
.search-scope{padding:6px 10px;background:var(â€“bg-dark);border:1px solid var(â€“border);border-radius:var(â€“radius);color:var(â€“text-2);font-family:var(â€“font-main);font-size:13px;cursor:pointer;outline:none;}
.search-results{padding:8px 16px;border-bottom:1px solid var(â€“border);background:var(â€“bg-dark);display:none;flex-direction:column;gap:4px;max-height:200px;overflow-y:auto;}
.search-results.open{display:flex;}
.search-result-item{padding:8px;border-radius:6px;cursor:pointer;transition:background 0.15s;}
.search-result-item:hover{background:var(â€“bg-hover);}
.search-result-author{font-size:12px;font-weight:600;color:var(â€“accent);}
.search-result-content{font-size:13px;color:var(â€“text-2);overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.search-result-meta{font-size:11px;color:var(â€“text-3);}

/* â”€â”€â”€ MESSAGES â”€â”€â”€ */
.messages{flex:1;overflow-y:auto;padding:16px 0;display:flex;flex-direction:column;gap:2px;scroll-behavior:smooth;}
.messages::-webkit-scrollbar{width:4px;}
.messages::-webkit-scrollbar-thumb{background:var(â€“bg-hover);border-radius:2px;}
.msg{display:flex;gap:14px;padding:4px 16px;border-radius:4px;transition:background 0.1s;position:relative;animation:msgIn 0.2s ease-out;}
@keyframes msgIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.msg:hover{background:rgba(0,0,0,0.1);}
.msg.mention-highlight{background:rgba(250,166,26,0.08) !important;border-left:3px solid var(â€“yellow);padding-left:13px;}
.msg:hover .msg-actions{opacity:1;}
.msg-avatar{width:40px;height:40px;border-radius:50%;flex-shrink:0;cursor:pointer;margin-top:2px;}
.msg-avatar img{width:100%;height:100%;border-radius:50%;object-fit:cover;}
.msg-body{flex:1;min-width:0;}
.msg-header{display:flex;align-items:baseline;gap:8px;margin-bottom:3px;flex-wrap:wrap;}
.msg-author{font-size:15px;font-weight:600;color:var(â€“text-1);cursor:pointer;}
.msg-author:hover{text-decoration:underline;}
.msg-time{font-size:11px;color:var(â€“text-muted);font-family:var(â€“font-mono);}
.msg-edited{font-size:11px;color:var(â€“text-muted);font-style:italic;}
.msg-content{font-size:var(â€“font-size);color:var(â€“text-2);line-height:1.5;word-break:break-word;user-select:text;}
.mention{color:var(â€“accent);background:rgba(88,101,242,0.15);border-radius:3px;padding:0 2px;font-weight:600;}
.role-badge{font-size:10px;padding:1px 5px;border-radius:4px;font-weight:700;text-transform:uppercase;}
.role-badge.admin{background:rgba(237,66,69,0.2);color:var(â€“red);}
.role-badge.moderator{background:rgba(250,166,26,0.2);color:var(â€“yellow);}

/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
.msg-actions{position:absolute;top:-14px;right:16px;background:var(â€“bg-panel);border:1px solid var(â€“border);border-radius:8px;display:flex;gap:2px;padding:3px;opacity:0;transition:opacity 0.15s;z-index:10;box-shadow:0 4px 12px rgba(0,0,0,0.3);}
.msg-action-btn{width:28px;height:28px;border:none;background:transparent;color:var(â€“text-3);border-radius:5px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all 0.1s;touch-action:manipulation;}
.msg-action-btn:hover{background:var(â€“bg-hover);color:var(â€“text-1);}
.msg-action-btn.danger:hover{background:rgba(237,66,69,0.2);color:var(â€“red);}

/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç·¨é›†ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ */
.msg-edit-area{margin-top:6px;display:none;}
.msg-edit-area.active{display:block;}
.msg-edit-input{width:100%;padding:8px 12px;background:var(â€“bg-dark);border:1px solid var(â€“accent);border-radius:var(â€“radius);color:var(â€“text-1);font-family:var(â€“font-main);font-size:14px;outline:none;resize:none;}
.msg-edit-btns{display:flex;gap:6px;margin-top:6px;}
.edit-save-btn,.edit-cancel-btn{padding:5px 12px;border:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;}
.edit-save-btn{background:var(â€“accent);color:#fff;}
.edit-cancel-btn{background:var(â€“bg-hover);color:var(â€“text-2);}

/* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
.reactions{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px;}
.reaction-pill{display:inline-flex;align-items:center;gap:4px;background:var(â€“bg-panel);border:1px solid var(â€“border);border-radius:12px;padding:2px 8px;font-size:13px;cursor:pointer;transition:all 0.15s;user-select:none;}
.reaction-pill:hover{border-color:var(â€“accent);background:var(â€“bg-hover);}
.reaction-pill.reacted{border-color:var(â€“accent);background:rgba(88,101,242,0.15);color:var(â€“accent);}
.reaction-count{font-size:12px;font-weight:600;color:var(â€“text-2);}

/* æœªèª­ãƒ‡ã‚£ãƒã‚¤ãƒ€ãƒ¼ */
.unread-divider{display:flex;align-items:center;gap:8px;padding:8px 16px;margin:4px 0;}
.unread-divider::before,.unread-divider::after{content:â€™â€™;flex:1;height:1px;background:var(â€“red);}
.unread-divider-label{font-size:11px;font-weight:700;color:var(â€“red);white-space:nowrap;}

/* ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
.msg.system{padding-left:70px;color:var(â€“text-3);font-size:13px;font-style:italic;}
.msg.system::before{content:â€™â€”â€™;position:absolute;left:32px;}

/* ãƒ•ã‚¡ã‚¤ãƒ« */
.file-attachment{display:inline-flex;align-items:center;gap:12px;background:var(â€“bg-panel);border:1px solid var(â€“border);border-radius:var(â€“radius);padding:12px 14px;margin-top:6px;max-width:420px;text-decoration:none;transition:border-color 0.2s;}
.file-attachment:hover{border-color:var(â€“accent);}
.file-icon{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(â€“accent),var(â€“accent-2));display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.file-info{flex:1;min-width:0;}
.file-name{font-size:14px;font-weight:600;color:var(â€“text-1);overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.file-size{font-size:12px;color:var(â€“text-3);margin-top:2px;}
.img-preview{max-width:400px;max-height:300px;border-radius:var(â€“radius);margin-top:6px;cursor:zoom-in;display:block;border:1px solid var(â€“border);object-fit:cover;}

/* â”€â”€â”€ TYPING â”€â”€â”€ */
.typing-bar{height:20px;padding:0 16px;font-size:13px;color:var(â€“text-3);display:flex;align-items:center;gap:6px;}
.typing-dots{display:flex;gap:3px;}
.typing-dot{width:5px;height:5px;border-radius:50%;background:var(â€“text-3);animation:typingBounce 1.2s infinite;}
.typing-dot:nth-child(2){animation-delay:0.2s;} .typing-dot:nth-child(3){animation-delay:0.4s;}
@keyframes typingBounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-4px)}}

/* â”€â”€â”€ INPUT BAR â”€â”€â”€ */
.input-bar{padding:0 16px 16px;flex-shrink:0;}
.input-box{background:var(â€“bg-panel);border:1px solid var(â€“border);border-radius:var(â€“radius-lg);display:flex;align-items:center;gap:6px;padding:6px 6px 6px 14px;transition:border-color 0.2s;}
.input-box:focus-within{border-color:rgba(88,101,242,0.5);}
.attach-btn,.emoji-btn{width:36px;height:36px;border:none;background:transparent;color:var(â€“text-3);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;transition:all 0.15s;touch-action:manipulation;}
.attach-btn:hover,.emoji-btn:hover{background:var(â€“bg-hover);color:var(â€“text-1);}
.msg-input{flex:1;border:none;background:transparent;color:var(â€“text-1);font-family:var(â€“font-main);font-size:var(â€“font-size);outline:none;resize:none;min-height:24px;max-height:200px;line-height:1.5;padding:4px 0;}
.msg-input::placeholder{color:var(â€“text-muted);}
.send-btn{width:36px;height:36px;border:none;background:var(â€“accent);color:#fff;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;transition:all 0.15s;box-shadow:0 2px 8px var(â€“accent-glow);touch-action:manipulation;}
.send-btn:hover{background:#4752c4;transform:scale(1.05);}
.send-btn:active{transform:scale(0.95);}

/* â”€â”€â”€ EMOJI PICKER â”€â”€â”€ */
.emoji-picker{position:absolute;bottom:80px;left:16px;background:var(â€“bg-panel);border:1px solid var(â€“border);border-radius:var(â€“radius-lg);padding:12px;box-shadow:0 16px 40px rgba(0,0,0,0.4);z-index:500;display:none;width:300px;}
.emoji-picker.open{display:block;}
.emoji-categories{display:flex;gap:4px;margin-bottom:8px;overflow-x:auto;}
.emoji-cat-btn{padding:4px 6px;border:none;background:transparent;color:var(â€“text-3);border-radius:6px;cursor:pointer;font-size:16px;flex-shrink:0;transition:all 0.15s;}
.emoji-cat-btn:hover,.emoji-cat-btn.active{background:var(â€“bg-hover);color:var(â€“text-1);}
.emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:2px;max-height:180px;overflow-y:auto;}
.emoji-btn-item{width:32px;height:32px;border:none;background:transparent;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;transition:background 0.1s;}
.emoji-btn-item:hover{background:var(â€“bg-hover);}

/* â”€â”€â”€ MEMBERS PANEL â”€â”€â”€ */
.members-panel{width:var(â€“members-w);background:var(â€“bg-dark);border-left:1px solid var(â€“border);overflow-y:auto;flex-shrink:0;}
.members-header{padding:16px;font-size:11px;font-weight:700;color:var(â€“text-3);text-transform:uppercase;letter-spacing:0.8px;}
.member-item{display:flex;align-items:center;gap:10px;padding:6px 12px;margin:1px 8px;border-radius:6px;cursor:pointer;transition:background 0.15s;}
.member-item:hover{background:var(â€“bg-hover);}
.member-avatar{width:32px;height:32px;border-radius:50%;position:relative;flex-shrink:0;}
.member-avatar img{width:100%;height:100%;border-radius:50%;object-fit:cover;}
.member-status{position:absolute;bottom:-1px;right:-1px;width:10px;height:10px;border-radius:50%;background:var(â€“green);border:2px solid var(â€“bg-dark);}
.member-name{font-size:13px;font-weight:500;color:var(â€“text-2);overflow:hidden;white-space:nowrap;flex:1;}

@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

/* â”€â”€â”€ MODALS â”€â”€â”€ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:2000;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.modal-overlay.open{display:flex;}
.modal{background:var(â€“bg-panel);border:1px solid var(â€“border);border-radius:20px;width:560px;max-width:calc(100vw - 32px);max-height:85vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 32px 80px rgba(0,0,0,0.6);animation:cardIn 0.3s cubic-bezier(0.16,1,0.3,1);}
.modal.wide{width:700px;}
.modal-header{padding:20px 24px 16px;border-bottom:1px solid var(â€“border);display:flex;align-items:center;justify-content:space-between;}
.modal-title{font-size:18px;font-weight:700;}
.modal-close{width:32px;height:32px;border:none;background:transparent;color:var(â€“text-3);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;transition:all 0.15s;}
.modal-close:hover{background:var(â€“bg-hover);color:var(â€“text-1);}
.modal-body{padding:20px 24px;overflow-y:auto;display:flex;flex-direction:column;gap:20px;}

/* Settings */
.settings-section-title{font-size:11px;font-weight:700;color:var(â€“text-3);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:12px;}
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(â€“bg-mid);border-radius:var(â€“radius);margin-bottom:8px;}
.settings-row-label{font-size:14px;font-weight:500;color:var(â€“text-1);}
.settings-row-desc{font-size:12px;color:var(â€“text-3);margin-top:2px;}
.toggle{width:44px;height:24px;background:var(â€“bg-hover);border-radius:12px;position:relative;cursor:pointer;transition:background 0.2s;flex-shrink:0;}
.toggle.on{background:var(â€“accent);}
.toggle::after{content:â€™â€™;position:absolute;top:2px;left:2px;width:20px;height:20px;border-radius:50%;background:#fff;transition:transform 0.2s;box-shadow:0 2px 4px rgba(0,0,0,0.3);}
.toggle.on::after{transform:translateX(20px);}
.settings-select{padding:6px 10px;background:var(â€“bg-dark);border:1px solid var(â€“border);border-radius:var(â€“radius);color:var(â€“text-1);font-family:var(â€“font-main);font-size:14px;cursor:pointer;outline:none;}
.theme-options{display:flex;gap:8px;}
.theme-opt{flex:1;padding:10px;border:2px solid var(â€“border);border-radius:var(â€“radius);cursor:pointer;text-align:center;font-size:13px;font-weight:500;transition:all 0.15s;background:var(â€“bg-mid);color:var(â€“text-2);}
.theme-opt:hover{border-color:var(â€“accent);}
.theme-opt.active{border-color:var(â€“accent);background:rgba(88,101,242,0.15);color:var(â€“accent);}
.font-slider{width:100%;accent-color:var(â€“accent);cursor:pointer;}
.danger-btn{padding:10px 16px;background:rgba(237,66,69,0.15);border:1px solid rgba(237,66,69,0.3);border-radius:var(â€“radius);color:var(â€“red);font-family:var(â€“font-main);font-size:14px;font-weight:600;cursor:pointer;width:100%;transition:all 0.2s;}
.danger-btn:hover{background:rgba(237,66,69,0.3);}

/* Pins modal */
.pin-item{display:flex;gap:12px;padding:12px;background:var(â€“bg-mid);border-radius:var(â€“radius);border:1px solid var(â€“border);}
.pin-item-body{flex:1;min-width:0;}
.pin-item-author{font-size:13px;font-weight:600;margin-bottom:2px;}
.pin-item-content{font-size:13px;color:var(â€“text-2);overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.pin-item-meta{font-size:11px;color:var(â€“text-3);margin-top:4px;}
.pin-unpin-btn{padding:4px 10px;border:none;background:rgba(237,66,69,0.15);color:var(â€“red);border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;}
.pin-unpin-btn:hover{background:rgba(237,66,69,0.3);}

/* Admin modal - role management */
.admin-user-row{display:flex;align-items:center;gap:12px;padding:10px;background:var(â€“bg-mid);border-radius:var(â€“radius);margin-bottom:6px;}
.admin-user-avatar{width:32px;height:32px;border-radius:50%;}
.admin-user-name{flex:1;font-size:14px;font-weight:500;}
.role-select{padding:5px 8px;background:var(â€“bg-dark);border:1px solid var(â€“border);border-radius:6px;color:var(â€“text-1);font-size:13px;cursor:pointer;}

/* â”€â”€â”€ TOASTS â”€â”€â”€ */
.upload-toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(10px);background:var(â€“bg-panel);border:1px solid var(â€“border);border-radius:var(â€“radius-lg);padding:14px 18px;display:flex;align-items:center;gap:12px;box-shadow:0 16px 40px rgba(0,0,0,0.5);z-index:2000;min-width:280px;opacity:0;transition:all 0.3s;pointer-events:none;}
.upload-toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.upload-spinner{width:20px;height:20px;border:2px solid var(â€“bg-hover);border-top-color:var(â€“accent);border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0;}
@keyframes spin{to{transform:rotate(360deg)}}
.toast-notif{position:fixed;top:16px;right:16px;z-index:4000;background:var(â€“bg-panel);border:1px solid var(â€“border);border-radius:var(â€“radius-lg);padding:12px 16px;display:flex;align-items:center;gap:12px;box-shadow:0 8px 24px rgba(0,0,0,0.4);min-width:260px;max-width:360px;animation:toastIn 0.3s cubic-bezier(0.16,1,0.3,1);cursor:pointer;}
@keyframes toastIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
.toast-notif-icon{font-size:20px;flex-shrink:0;}
.toast-notif-body{flex:1;}
.toast-notif-title{font-size:13px;font-weight:600;color:var(â€“text-1);}
.toast-notif-text{font-size:12px;color:var(â€“text-3);margin-top:2px;}

/* â”€â”€â”€ MISC â”€â”€â”€ */
.drop-overlay{display:none;position:fixed;inset:0;background:rgba(88,101,242,0.15);border:3px dashed var(â€“accent);border-radius:16px;margin:16px;z-index:999;align-items:center;justify-content:center;flex-direction:column;gap:16px;font-size:24px;color:var(â€“accent);backdrop-filter:blur(4px);}
.drop-overlay.active{display:flex;}
.lightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:3000;align-items:center;justify-content:center;cursor:zoom-out;backdrop-filter:blur(8px);}
.lightbox.open{display:flex;}
.lightbox img{max-width:90vw;max-height:90vh;border-radius:var(â€“radius);}
.welcome-msg{padding:32px 16px 16px;border-bottom:1px solid var(â€“border);margin-bottom:8px;}
.welcome-icon{width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,var(â€“accent),var(â€“accent-2));display:flex;align-items:center;justify-content:center;font-size:28px;margin-bottom:16px;}
.welcome-title{font-size:24px;font-weight:700;margin-bottom:6px;}
.welcome-sub{font-size:15px;color:var(â€“text-3);}
*{scrollbar-width:thin;scrollbar-color:var(â€“bg-hover) transparent;}

/* â”€â”€â”€ MOBILE â”€â”€â”€ */
.mobile-menu-btn,.mobile-members-btn{display:none;width:36px;height:36px;border:none;background:transparent;color:var(â€“text-2);border-radius:8px;cursor:pointer;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.drawer-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:200;backdrop-filter:blur(2px);}
.drawer-overlay.open{display:block;}

/* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ: ãƒ¡ãƒ³ãƒãƒ¼ãƒ‘ãƒãƒ«ã‚’å¼•ãå‡ºã—ã« */
@media(max-width:900px){
.members-panel{position:fixed;right:0;top:0;bottom:0;z-index:300;transform:translateX(100%);transition:transform 0.28s cubic-bezier(0.16,1,0.3,1);box-shadow:-8px 0 32px rgba(0,0,0,0.4);}
.members-panel.open{transform:translateX(0);}
.mobile-members-btn{display:flex;}
}

/* ã‚¹ãƒãƒ›å…¨èˆ¬ */
@media(max-width:640px){
/* ã‚µãƒ¼ãƒãƒ¼ãƒªã‚¹ãƒˆéè¡¨ç¤ºãƒ»ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’å¼•ãå‡ºã—ã« */
.server-list{display:none;}
.sidebar{position:fixed;left:0;top:0;bottom:0;z-index:300;transform:translateX(-100%);transition:transform 0.28s cubic-bezier(0.16,1,0.3,1);box-shadow:8px 0 32px rgba(0,0,0,0.4);}
.sidebar.open{transform:translateX(0);}
.mobile-menu-btn{display:flex;}

/* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
.auth-card{width:calc(100vw - 32px);padding:28px 20px;border-radius:16px;}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
.chat-header{height:52px;padding:0 8px 0 4px;}
.chat-header-sep,.chat-header-topic{display:none;}
.chat-header-name{font-size:15px;}

/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ */
.messages{padding:8px 0;}
.msg{padding:4px 8px;gap:10px;}
.msg-avatar{width:34px;height:34px;}
.msg-author{font-size:14px;}
.msg-content{font-size:14px;}

/* ã‚¿ãƒƒãƒã§æ“ä½œã§ãã‚‹ã‚ˆã†ã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’å¸¸æ™‚è¡¨ç¤º */
.msg-actions{
position:static;
opacity:1;
display:flex;
background:transparent;
border:none;
box-shadow:none;
padding:2px 0;
margin-top:2px;
margin-left:44px; /* ã‚¢ãƒã‚¿ãƒ¼å¹…+gapåˆ†ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ */
flex-wrap:wrap;
gap:2px;
}
/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’å°ã•ãï¼ˆå¸¸æ™‚è¡¨ç¤ºã®ãŸã‚å…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å‡ºã‚‹ã®ã§æ§ãˆã‚ã«ï¼‰ */
.msg-action-btn{width:26px;height:26px;font-size:13px;color:var(â€“text-muted);}
.msg-action-btn:active{background:var(â€“bg-hover);color:var(â€“text-1);}

/* ãƒ›ãƒãƒ¼ã‚’ç„¡åŠ¹åŒ–ï¼ˆtouchç«¯æœ«ã«hoverã¯ãªã„ï¼‰ */
.msg:hover{background:transparent;}
.msg:active{background:rgba(0,0,0,0.08);}

/* ç”»åƒãƒ»ãƒ•ã‚¡ã‚¤ãƒ« */
.img-preview{max-width:100%;max-height:240px;}
.file-attachment{max-width:100%;}

/* å…¥åŠ›ãƒãƒ¼ - iPhone ã®ãƒ›ãƒ¼ãƒ ãƒãƒ¼å¯¾å¿œ */
.input-bar{
padding:0 8px calc(8px + env(safe-area-inset-bottom)) 8px;
}
/* ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒ’ãƒ³ãƒˆã¯éè¡¨ç¤º */
.input-hint{display:none !important;}
.attach-btn,.emoji-btn{width:32px;height:32px;font-size:18px;}
.send-btn{width:38px;height:38px;font-size:18px;}
.msg-input{font-size:16px;} /* iOSè‡ªå‹•ã‚ºãƒ¼ãƒ é˜²æ­¢: 16pxæœªæº€ã ã¨ã‚ºãƒ¼ãƒ ã•ã‚Œã‚‹ */

/* çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ã‚’ãƒ•ãƒ«å¹…ãƒ»ç”»é¢ä¸‹éƒ¨ã«å›ºå®š */
.emoji-picker{
position:fixed;
left:0;right:0;bottom:0;
width:100%;
border-radius:16px 16px 0 0;
padding-bottom:env(safe-area-inset-bottom);
z-index:600;
}
.emoji-grid{grid-template-columns:repeat(8,1fr);max-height:200px;}

/* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ã»ã¼ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã« */
.modal{
width:100vw;
max-width:100vw;
max-height:92vh;
border-radius:20px 20px 0 0;
position:fixed;
bottom:0;
left:0;
right:0;
}
.modal-overlay{align-items:flex-end;}

/* ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å°ã•ã */
.welcome-msg{padding:20px 12px 12px;}
.welcome-icon{width:48px;height:48px;font-size:22px;}
.welcome-title{font-size:18px;}
.welcome-sub{font-size:13px;}

/* ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒãƒ¼ */
.typing-bar{padding:0 8px;font-size:12px;height:18px;}

/* ãƒ¡ãƒ³ãƒãƒ¼ãƒ‘ãƒãƒ«å¹…ã‚’ã‚„ã‚„åºƒãï¼ˆã‚¹ãƒãƒ›ã§èª­ã¿ã‚„ã™ãï¼‰ */
.members-panel{width:min(280px, 85vw);}

/* ã‚µã‚¤ãƒ‰ãƒãƒ¼å¹… */
.sidebar{width:min(280px, 85vw);}

/* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
.toast-notif{right:8px;top:8px;min-width:0;max-width:calc(100vw - 16px);}

/* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒˆãƒ¼ã‚¹ãƒˆ */
.upload-toast{min-width:0;width:calc(100vw - 32px);}

/* ãƒ”ãƒ³ãƒ»ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒªã‚¹ãƒˆ */
.pin-item{flex-direction:column;gap:8px;}
.pin-item-content{white-space:normal;}

/* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¢ãƒã‚¿ãƒ¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
#settings-avatar-preview{width:52px;height:52px;}
}

/* æ¥µå°ç”»é¢ï¼ˆiPhone SEç­‰ï¼‰ */
@media(max-width:360px){
.msg{gap:8px;padding:3px 6px;}
.msg-avatar{width:30px;height:30px;}
.emoji-grid{grid-template-columns:repeat(7,1fr);}
}

/* é«˜ã•ãŒä½ã„ç«¯æœ«ï¼ˆæ¨ªå‘ãç­‰ï¼‰å¯¾å¿œ */
@media(max-height:500px) and (max-width:900px){
.modal{max-height:96vh;}
.emoji-picker{max-height:180px;}
}
</style>

</head>
<body>

<!-- AUTH -->

<div id="auth-screen">
  <div class="auth-bg"></div>
  <div class="auth-card">
    <div class="auth-logo"><div class="auth-logo-icon">âš¡</div><div class="auth-logo-text">NexusChat</div></div>
    <h1 class="auth-title">Welcome back</h1>
    <p class="auth-subtitle">Dive back into your conversations</p>
    <div class="tab-switcher">
      <button class="tab-btn active" onclick="switchTab('login')">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button class="tab-btn" onclick="switchTab('register')">æ–°è¦ç™»éŒ²</button>
    </div>
    <div id="login-form">
      <label class="field-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
      <input class="field-input" id="login-username" type="text" placeholder="username" autocomplete="username" />
      <label class="field-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input class="field-input" id="login-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
      <button class="auth-btn" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
    <div id="register-form" style="display:none">
      <label class="field-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼å <span style="color:var(--text-muted);text-transform:none;font-size:11px">(3ã€œ20æ–‡å­—)</span></label>
      <input class="field-input" id="reg-username" type="text" placeholder="username" autocomplete="username" />
      <label class="field-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input class="field-input" id="reg-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password" />
      <button class="auth-btn" onclick="register()">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</button>
    </div>
    <div class="auth-error" id="auth-error"></div>
  </div>
</div>

<!-- APP -->

<div id="app">
  <div class="server-list">
    <div class="server-icon active" title="NexusChat">âš¡</div>
    <div class="server-sep"></div>
  </div>

  <div class="sidebar">
    <div class="sidebar-header"><span>NexusChat</span><span style="color:var(--text-3)">âŒ„</span></div>
    <div class="channels-section">
      <div class="ch-category">ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ£ãƒ³ãƒãƒ«</div>
      <div id="channel-list"></div>
      <div class="ch-category" style="margin-top:8px">ãƒœã‚¤ã‚¹ãƒãƒ£ãƒ³ãƒãƒ«</div>
      <div class="ch-category" style="margin-top:8px">
        ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        <span style="font-size:16px;cursor:pointer;color:var(--text-2)" onclick="openDmSearch()" title="æ–°ã—ã„DM">ï¼‹</span>
      </div>
      <div id="dm-list"></div>
    </div>
    <div class="user-panel">
      <div class="user-avatar"><img id="user-avatar-img" src="" alt="" /><div class="user-status"></div></div>
      <div class="user-info">
        <div class="user-name" id="user-display-name">â€”</div>
        <div class="user-tag" id="user-role-tag" style="color:var(--text-3);font-size:11px"></div>
      </div>
      <div class="user-actions">
        <button class="user-action-btn" title="ç®¡ç†è€…ãƒ‘ãƒãƒ«" id="admin-btn" onclick="openAdminPanel()" style="display:none">ğŸ‘‘</button>
        <button class="user-action-btn" title="è¨­å®š" onclick="openSettings()">âš™</button>
        <button class="user-action-btn" title="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ" onclick="openLogoutConfirm()">ğŸšª</button>
      </div>
    </div>
  </div>

  <div class="chat-area">
    <div class="chat-header">
      <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
      <span class="chat-header-icon" id="chat-header-icon">#</span>
      <span class="chat-header-name" id="chat-header-name">general</span>
      <div class="chat-header-sep" id="chat-header-sep"></div>
      <span class="chat-header-topic" id="chat-header-topic">ã¿ã‚“ãªã®ãƒãƒ£ãƒ³ãƒãƒ«ã¸ã‚ˆã†ã“ãï¼</span>
      <div class="chat-header-actions">
        <button class="header-btn" onclick="toggleSearch()" id="search-btn" title="æ¤œç´¢">ğŸ”</button>
        <button class="header-btn" onclick="openPins()" id="pins-btn" title="ãƒ”ãƒ³ç•™ã‚">ğŸ“Œ</button>
        <button class="mobile-members-btn" onclick="toggleMembers()" title="ãƒ¡ãƒ³ãƒãƒ¼">ğŸ‘¥</button>
      </div>
    </div>

```
<div class="search-bar" id="search-bar">
  <input class="search-input" id="search-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¤œç´¢..." oninput="debounceSearch(this.value)" />
  <select class="search-scope" id="search-scope">
    <option value="">å…¨ãƒãƒ£ãƒ³ãƒãƒ«</option>
    <option value="current">ã“ã®ãƒãƒ£ãƒ³ãƒãƒ«</option>
  </select>
</div>
<div class="search-results" id="search-results"></div>

<div class="messages" id="messages">
  <div class="welcome-msg">
    <div class="welcome-icon">#</div>
    <div class="welcome-title" id="welcome-title">#general ã¸ã‚ˆã†ã“ãï¼</div>
    <div class="welcome-sub">ã“ã‚Œã¯ãƒãƒ£ãƒ³ãƒãƒ«ã®å§‹ã¾ã‚Šã§ã™ã€‚</div>
  </div>
</div>

<div class="typing-bar" id="typing-bar"></div>
<div class="input-bar" style="position:relative" id="input-bar">
  <div class="emoji-picker" id="emoji-picker">
    <div class="emoji-categories" id="emoji-cats"></div>
    <div class="emoji-grid" id="emoji-grid"></div>
  </div>
  <div class="input-box">
    <button class="attach-btn" onclick="openFilePicker()">ğŸ“</button>
    <button class="emoji-btn" onclick="toggleEmojiPicker()">ğŸ˜Š</button>
    <textarea class="msg-input" id="msg-input" placeholder="#general ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡" rows="1"
      oninput="autoResize(this);emitTyping()" onkeydown="handleKey(event)"></textarea>
    <button class="send-btn" onclick="sendMessage()">â–¶</button>
  </div>
  <div class="input-hint" style="font-size:11px;color:var(--text-muted);padding:4px 6px 0;display:flex;gap:12px">
    <span><kbd style="background:var(--bg-panel);border:1px solid var(--border);border-radius:4px;padding:1px 5px;font-size:10px">Shift+Enter</kbd> ã§æ”¹è¡Œ</span>
    <span><kbd style="background:var(--bg-panel);border:1px solid var(--border);border-radius:4px;padding:1px 5px;font-size:10px">**å¤ªå­—**</kbd> <kbd style="background:var(--bg-panel);border:1px solid var(--border);border-radius:4px;padding:1px 5px;font-size:10px">*æ–œä½“*</kbd> <kbd style="background:var(--bg-panel);border:1px solid var(--border);border-radius:4px;padding:1px 5px;font-size:10px">`ã‚³ãƒ¼ãƒ‰`</kbd></span>
  </div>
</div>
```

  </div>

  <div class="members-panel">
    <div class="members-header">ãƒ¡ãƒ³ãƒãƒ¼ â€” <span id="online-count">0</span>åã‚ªãƒ³ãƒ©ã‚¤ãƒ³</div>
    <div id="members-list"></div>
  </div>
</div>

<!-- SETTINGS MODAL -->

<div class="modal-overlay" id="settings-modal" onclick="closeModalOutside(event,'settings-modal')">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">âš™ è¨­å®š</div><button class="modal-close" onclick="closeModal('settings-modal')">âœ•</button></div>
    <div class="modal-body">
      <div>
        <div class="settings-section-title">ğŸ¨ ãƒ†ãƒ¼ãƒ</div>
        <div class="theme-options">
          <div class="theme-opt active" id="theme-dark" onclick="setTheme('dark')">ğŸŒ™ ãƒ€ãƒ¼ã‚¯</div>
          <div class="theme-opt" id="theme-light" onclick="setTheme('light')">â˜€ï¸ ãƒ©ã‚¤ãƒˆ</div>
        </div>
      </div>
      <div>
        <div class="settings-section-title">ğŸ”¤ ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º</div>
        <div class="settings-row"><div><div class="settings-row-label">ã‚µã‚¤ã‚º: <span id="font-size-label">15px</span></div></div></div>
        <input type="range" class="font-slider" id="font-slider" min="12" max="20" value="15" oninput="setFontSize(this.value)" />
      </div>
      <div>
        <div class="settings-section-title">ğŸ”” é€šçŸ¥</div>
        <div class="settings-row"><div><div class="settings-row-label">é€šçŸ¥éŸ³</div><div class="settings-row-desc">æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç€ä¿¡éŸ³</div></div><div class="toggle on" id="toggle-sound" onclick="toggleSetting('sound')"></div></div>
        <div class="settings-row"><div><div class="settings-row-label">ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥</div></div><div class="toggle" id="toggle-notif" onclick="requestNotifPermission()"></div></div>
        <div class="settings-row"><div><div class="settings-row-label">ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ™‚ã®ã¿é€šçŸ¥</div></div><div class="toggle" id="toggle-mention-only" onclick="toggleSetting('mentionOnly')"></div></div>
      </div>
      <div>
        <div class="settings-section-title">âŒ¨ï¸ é€ä¿¡ã‚­ãƒ¼</div>
        <div class="settings-row"><div><div class="settings-row-label">é€ä¿¡ã‚­ãƒ¼</div><div class="settings-row-desc">Enterã§é€ä¿¡ / Shift+Enterã§æ”¹è¡Œ</div></div>
        <select class="settings-select" id="send-key-select" onchange="setSendKey(this.value)"><option value="enter">Enter</option><option value="ctrl">Ctrl+Enter</option></select></div>
      </div>
      <div>
        <div class="settings-section-title">ğŸ–¼ ã‚¢ãƒã‚¿ãƒ¼</div>
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:12px">
          <img id="settings-avatar-preview" src="" style="width:64px;height:64px;border-radius:50%;border:2px solid var(--border);object-fit:cover" />
          <div style="flex:1">
            <div class="settings-row-label" style="margin-bottom:6px">ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é¸ã¶</div>
            <div style="display:flex;flex-wrap:wrap;gap:6px" id="avatar-style-btns"></div>
          </div>
        </div>
        <div class="settings-row-label" style="margin-bottom:6px">ã¾ãŸã¯ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
        <input type="file" id="avatar-file-input" accept="image/*" style="display:none" onchange="handleAvatarFileSelect(this.files)" />
        <button class="settings-row" style="cursor:pointer;width:100%;justify-content:center;border:1px dashed var(--border);background:transparent;color:var(--text-2);font-size:13px" onclick="document.getElementById('avatar-file-input').click()">ğŸ“ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
        <button class="danger-btn" style="margin-top:8px;background:var(--accent);border-color:var(--accent);color:#fff" onclick="saveAvatar()">âœ“ ã‚¢ãƒã‚¿ãƒ¼ã‚’ä¿å­˜</button>
        <div id="avatar-save-msg" style="font-size:12px;color:var(--green);margin-top:6px;display:none">âœ“ ä¿å­˜ã—ã¾ã—ãŸ</div>
      </div>
      <div>
        <div class="settings-section-title">ğŸ‘¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</div>
        <div class="settings-row"><div><div class="settings-row-label" id="settings-username">â€”</div><div class="settings-row-desc" id="settings-role">member</div></div></div>
        <button class="danger-btn" style="margin-bottom:8px" onclick="openLogoutConfirm()">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <button class="danger-btn" onclick="openDeleteAccount()">ğŸ—‘ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="logout-confirm-modal" onclick="closeModalOutside(event,'logout-confirm-modal')">
  <div class="modal" style="max-width:360px">
    <div class="modal-header"><div class="modal-title">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</div><button class="modal-close" onclick="closeModal('logout-confirm-modal')">âœ•</button></div>
    <div class="modal-body">
      <p style="color:var(--text-2);margin-bottom:16px">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ</p>
      <div style="display:flex;gap:8px">
        <button class="danger-btn" style="flex:1" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <button style="flex:1;padding:10px;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg-hover);color:var(--text-2);font-size:14px;cursor:pointer" onclick="closeModal('logout-confirm-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="delete-account-modal" onclick="closeModalOutside(event,'delete-account-modal')">
    <div class="modal-header"><div class="modal-title" style="color:var(--red)">âš  ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤</div><button class="modal-close" onclick="closeModal('delete-account-modal')">âœ•</button></div>
    <div class="modal-body">
      <p style="color:var(--text-2);margin-bottom:16px;line-height:1.6">ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚<br>ç¢ºèªã®ãŸã‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
      <input id="delete-account-pw" type="password" class="search-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width:100%;margin-bottom:12px;box-sizing:border-box" />
      <div id="delete-account-err" style="color:var(--red);font-size:13px;margin-bottom:8px;display:none"></div>
      <button class="danger-btn" onclick="confirmDeleteAccount()">å‰Šé™¤ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- PINS MODAL -->

<div class="modal-overlay" id="pins-modal" onclick="closeModalOutside(event,'pins-modal')">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">ğŸ“Œ ãƒ”ãƒ³ç•™ã‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div><button class="modal-close" onclick="closeModal('pins-modal')">âœ•</button></div>
    <div class="modal-body" id="pins-list"><div style="color:var(--text-3);text-align:center">ãƒ”ãƒ³ç•™ã‚ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“</div></div>
  </div>
</div>

<!-- ADMIN PANEL MODAL -->

<div class="modal-overlay" id="admin-modal" onclick="closeModalOutside(event,'admin-modal')">
  <div class="modal wide">
    <div class="modal-header"><div class="modal-title">ğŸ‘‘ ç®¡ç†è€…ãƒ‘ãƒãƒ« â€” ãƒ­ãƒ¼ãƒ«ç®¡ç†</div><button class="modal-close" onclick="closeModal('admin-modal')">âœ•</button></div>
    <div class="modal-body" id="admin-user-list"><div style="color:var(--text-3)">èª­ã¿è¾¼ã¿ä¸­...</div></div>
  </div>
</div>

<!-- DM SEARCH MODAL -->

<div class="modal-overlay" id="dm-search-modal" onclick="closeModalOutside(event,'dm-search-modal')">
  <div class="modal" style="width:400px">
    <div class="modal-header"><div class="modal-title">ğŸ’¬ æ–°ã—ã„DM</div><button class="modal-close" onclick="closeModal('dm-search-modal')">âœ•</button></div>
    <div class="modal-body">
      <input class="field-input" id="dm-search-input" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›..." oninput="filterDmSearch(this.value)" style="margin-bottom:0" />
      <div id="dm-search-results" style="margin-top:12px;display:flex;flex-direction:column;gap:4px;"></div>
    </div>
  </div>
</div>

<!-- MISC -->

<div class="drawer-overlay" id="drawer-overlay" onclick="closeDrawers()"></div>
<div class="drop-overlay" id="drop-overlay"><div style="font-size:48px">ğŸ“</div><div>ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</div></div>
<div class="upload-toast" id="upload-toast"><div class="upload-spinner"></div><div id="upload-label" style="font-size:14px;color:var(--text-2)">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</div></div>
<div class="lightbox" id="lightbox" onclick="closeLightbox()"><img id="lightbox-img" src="" alt="" /></div>
<input type="file" id="file-input" style="display:none" onchange="handleFileSelect(this.files)" multiple />

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let token         = localStorage.getItem('token') || null;
let currentUser   = null;
let socket        = null;
let currentChannel = 'general';
let currentChannelType = 'text'; // 'text' | 'voice' | 'dm'
let currentDmRoom = null;
let typingTimer   = null;
let typingUsers   = {};
let allMessages   = {};   // { channelId: [msg,...] }
let unreadCounts  = {};   // { channelId: number }
let lastSeenTs    = JSON.parse(localStorage.getItem('lastSeenTs') || '{}'); // { channelId: isoString }
let onlineUsersList = []; // [{ username, userId, voiceChannelId }]
let isMuted       = false;
let openDmRooms   = JSON.parse(localStorage.getItem('nexus_dmRooms') || '[]');   // [{ roomId, otherUser }]
let searchTimer   = null;
const API         = '';

let settings = { theme:'dark', fontSize:15, sound:true, notif:false, mentionOnly:false, sendKey:'enter',
  ...JSON.parse(localStorage.getItem('nexus_settings') || '{}') };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• EMOJI â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const EMOJI_DATA = {
  'ğŸ˜Š':['ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜†','ğŸ˜…','ğŸ˜‚','ğŸ¤£','ğŸ˜Š','ğŸ˜‡','ğŸ™‚','ğŸ™ƒ','ğŸ˜‰','ğŸ˜Œ','ğŸ˜','ğŸ¥°','ğŸ˜˜','ğŸ˜—','ğŸ˜™','ğŸ˜š','ğŸ˜‹','ğŸ˜›','ğŸ˜','ğŸ˜œ','ğŸ¤ª','ğŸ¤¨','ğŸ§','ğŸ¤“','ğŸ˜','ğŸ¥¸','ğŸ¤©','ğŸ¥³'],
  'ğŸ‘':['ğŸ‘','ğŸ‘','ğŸ‘Œ','âœŒï¸','ğŸ¤','ğŸ¤Ÿ','ğŸ¤˜','ğŸ¤™','ğŸ‘ˆ','ğŸ‘‰','ğŸ‘†','ğŸ‘‡','â˜ï¸','ğŸ‘‹','ğŸ¤š','ğŸ–','âœ‹','ğŸ‘','ğŸ™Œ','ğŸ¤','ğŸ™','âœï¸','ğŸ’ª'],
  'â¤ï¸':['â¤ï¸','ğŸ§¡','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ–¤','ğŸ¤','ğŸ¤','ğŸ’”','â£ï¸','ğŸ’•','ğŸ’','ğŸ’“','ğŸ’—','ğŸ’–','ğŸ’˜','ğŸ’'],
  'ğŸ±':['ğŸ¶','ğŸ±','ğŸ­','ğŸ¹','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¨','ğŸ¯','ğŸ¦','ğŸ®','ğŸ·','ğŸ¸','ğŸµ','ğŸ”','ğŸ§','ğŸ¦','ğŸ¤','ğŸ¦†'],
  'ğŸ•':['ğŸ•','ğŸ”','ğŸŒ­','ğŸ¥ª','ğŸŒ®','ğŸŒ¯','ğŸœ','ğŸ','ğŸ£','ğŸ±','ğŸ¡','ğŸ§','ğŸ‚','ğŸ°','ğŸ®','â˜•','ğŸµ','ğŸ§ƒ'],
  'âš½':['âš½','ğŸ€','ğŸˆ','âš¾','ğŸ¾','ğŸ','ğŸ’','â›³','ğŸ®','ğŸ•¹ï¸','ğŸ²','ğŸ¯','ğŸ³'],
};
const EMOJI_CATS = Object.keys(EMOJI_DATA);
let activeCat = EMOJI_CATS[0];
let emojiOpen = false;

function buildEmojiPicker() {
  document.getElementById('emoji-cats').innerHTML = EMOJI_CATS.map(c =>
    `<button class="emoji-cat-btn${c===activeCat?' active':''}" onclick="showEmojiCat('${c}')">${c}</button>`).join('');
  showEmojiCat(activeCat, false);
}
function showEmojiCat(cat, updateCats=true) {
  activeCat = cat;
  if (updateCats) document.querySelectorAll('.emoji-cat-btn').forEach((b,i)=>b.classList.toggle('active',EMOJI_CATS[i]===cat));
  document.getElementById('emoji-grid').innerHTML = EMOJI_DATA[cat].map(e =>
    `<button class="emoji-btn-item" onclick="insertEmoji('${e}')">${e}</button>`).join('');
}
function toggleEmojiPicker() { emojiOpen=!emojiOpen; document.getElementById('emoji-picker').classList.toggle('open',emojiOpen); if(emojiOpen) buildEmojiPicker(); }
function insertEmoji(e) { const i=document.getElementById('msg-input');const p=i.selectionStart;i.value=i.value.slice(0,p)+e+i.value.slice(p);i.selectionStart=i.selectionEnd=p+e.length;i.focus();autoResize(i); }
document.addEventListener('click',e=>{ if(emojiOpen&&!e.target.closest('#emoji-picker')&&!e.target.closest('.emoji-btn')){emojiOpen=false;document.getElementById('emoji-picker').classList.remove('open');} });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SETTINGS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveSettings() { localStorage.setItem('nexus_settings',JSON.stringify(settings)); }
function applySettings() {
  document.body.classList.toggle('theme-light',settings.theme==='light');
  document.getElementById('theme-dark').classList.toggle('active',settings.theme==='dark');
  document.getElementById('theme-light').classList.toggle('active',settings.theme==='light');
  document.documentElement.style.setProperty('--font-size',settings.fontSize+'px');
  document.getElementById('font-slider').value=settings.fontSize;
  document.getElementById('font-size-label').textContent=settings.fontSize+'px';
  document.getElementById('toggle-sound').classList.toggle('on',settings.sound);
  document.getElementById('toggle-notif').classList.toggle('on',settings.notif);
  document.getElementById('toggle-mention-only').classList.toggle('on',settings.mentionOnly);
  document.getElementById('send-key-select').value=settings.sendKey;
}
function setTheme(t){settings.theme=t;saveSettings();applySettings();}
function setFontSize(v){settings.fontSize=parseInt(v);saveSettings();applySettings();}
function toggleSetting(k){settings[k]=!settings[k];saveSettings();applySettings();}
function setSendKey(v){settings.sendKey=v;saveSettings();}
function requestNotifPermission(){if(!('Notification'in window))return;Notification.requestPermission().then(p=>{settings.notif=p==='granted';saveSettings();applySettings();});}
const AVATAR_STYLES = [
  { key: 'bottts',      label: 'ğŸ¤– ãƒœãƒƒãƒˆ' },
  { key: 'avataaars',   label: 'ğŸ‘¤ äººç‰©' },
  { key: 'pixel-art',   label: 'ğŸ® ãƒ”ã‚¯ã‚»ãƒ«' },
  { key: 'fun-emoji',   label: 'ğŸ˜€ çµµæ–‡å­—' },
  { key: 'thumbs',      label: 'ğŸ‘ ã‚µãƒ ã‚º' },
  { key: 'shapes',      label: 'ğŸ”· ã‚·ã‚§ã‚¤ãƒ—' },
];

let pendingAvatar = null; // ä¿å­˜å‰ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨

function openSettings() {
  document.getElementById('settings-username').textContent = currentUser?.username || 'â€”';
  document.getElementById('settings-role').textContent = currentUser?.role || 'member';
  // ã‚¢ãƒã‚¿ãƒ¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆæœŸåŒ–
  pendingAvatar = currentUser?.avatar;
  document.getElementById('settings-avatar-preview').src = pendingAvatar || '';
  // ã‚¹ã‚¿ã‚¤ãƒ«ãƒœã‚¿ãƒ³ç”Ÿæˆ
  const container = document.getElementById('avatar-style-btns');
  container.innerHTML = AVATAR_STYLES.map(s =>
    `<button onclick="previewAvatarStyle('${s.key}')" style="padding:4px 10px;border:1px solid var(--border);border-radius:20px;background:var(--bg-mid);color:var(--text-2);font-size:12px;cursor:pointer" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='var(--bg-mid)'">${s.label}</button>`
  ).join('');
  document.getElementById('avatar-save-msg').style.display = 'none';
  openModal('settings-modal');
}

function previewAvatarStyle(style) {
  const url = `https://api.dicebear.com/7.x/${style}/svg?seed=${encodeURIComponent(currentUser?.username || 'user')}`;
  pendingAvatar = url;
  document.getElementById('settings-avatar-preview').src = url;
}

async function handleAvatarFileSelect(files) {
  if (!files || !files.length) return;
  const file = files[0];
  if (!file.type.startsWith('image/')) { alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  const form = new FormData();
  form.append('file', file);
  try {
    const res = await fetch(`${API}/api/upload`, { method: 'POST', headers: { Authorization: `Bearer ${token}` }, body: form });
    if (!res.ok) throw new Error('upload failed');
    const data = await res.json();
    pendingAvatar = data.url.startsWith('http') ? data.url : `${API}${data.url}`;
    document.getElementById('settings-avatar-preview').src = pendingAvatar;
  } catch(e) {
    alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

async function saveAvatar() {
  if (!pendingAvatar || pendingAvatar === currentUser?.avatar) return;
  try {
    const res = await fetch(`${API}/api/profile/avatar`, {
      method: 'PUT',
      headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ avatar: pendingAvatar }),
    });
    if (!res.ok) throw new Error('failed');
    currentUser.avatar = pendingAvatar;
    document.getElementById('user-avatar-img').src = pendingAvatar;
    document.getElementById('avatar-save-msg').style.display = '';
    setTimeout(() => document.getElementById('avatar-save-msg').style.display = 'none', 2000);
  } catch(e) {
    alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

function openDeleteAccount() {
  document.getElementById('delete-account-pw').value = '';
  document.getElementById('delete-account-err').style.display = 'none';
  openModal('delete-account-modal');
}

async function confirmDeleteAccount() {
  const pw = document.getElementById('delete-account-pw').value;
  if (!pw) { showDeleteAccountErr('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  try {
    const res = await fetch(`${API}/api/account`, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pw }),
    });
    const data = await res.json();
    if (!res.ok) { showDeleteAccountErr(data.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
    alert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
    localStorage.removeItem('token');
    localStorage.removeItem('nexus_dmRooms');
    if (socket) socket.disconnect();
    location.reload();
  } catch(e) {
    showDeleteAccountErr('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
  }
}

function showDeleteAccountErr(msg) {
  const el = document.getElementById('delete-account-err');
  el.textContent = msg;
  el.style.display = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
function closeModalOutside(e,id){if(e.target===document.getElementById(id))closeModal(id);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SEARCH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let searchOpen=false;
function toggleSearch(){
  searchOpen=!searchOpen;
  document.getElementById('search-bar').classList.toggle('open',searchOpen);
  document.getElementById('search-btn').classList.toggle('active',searchOpen);
  if(searchOpen) document.getElementById('search-input').focus();
  else { document.getElementById('search-input').value=''; document.getElementById('search-results').classList.remove('open'); }
}
function debounceSearch(q) {
  clearTimeout(searchTimer);
  if (!q||q.length<2) { document.getElementById('search-results').classList.remove('open'); return; }
  searchTimer = setTimeout(()=>doSearch(q), 400);
}
async function doSearch(q) {
  const scope = document.getElementById('search-scope').value;
  const channel = scope==='current' ? currentChannel : '';
  const url = `${API}/api/search?q=${encodeURIComponent(q)}${channel?'&channel='+channel:''}`;
  const res = await fetch(url,{headers:{Authorization:`Bearer ${token}`}});
  const results = await res.json();
  const el = document.getElementById('search-results');
  if (!results.length) { el.innerHTML='<div style="color:var(--text-3);padding:8px;font-size:13px">çµæœãªã—</div>'; el.classList.add('open'); return; }
  el.innerHTML = results.map(m=>`
    <div class="search-result-item" onclick="jumpToMessage('${m.channelId}','${m.id}')">
      <div class="search-result-author">${escHtml(m.author)} <span class="search-result-meta">#${escHtml(m.channelId)}</span></div>
      <div class="search-result-content">${escHtml(m.content||'')}</div>
      <div class="search-result-meta">${new Date(m.timestamp).toLocaleString('ja-JP')}</div>
    </div>`).join('');
  el.classList.add('open');
}
async function jumpToMessage(channelId, msgId) {
  document.getElementById('search-results').classList.remove('open');
  if (channelId !== currentChannel) await joinChannel(channelId);
  setTimeout(()=>{
    const el = document.querySelector(`[data-id="${msgId}"]`);
    if (el) { el.scrollIntoView({behavior:'smooth',block:'center'}); el.style.background='rgba(88,101,242,0.15)'; setTimeout(()=>el.style.background='',1500); }
  },300);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NOTIFICATIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function playNotifSound(){if(!settings.sound)return;try{const ctx=new(window.AudioContext||window.webkitAudioContext)();const o=ctx.createOscillator();const g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.frequency.setValueAtTime(880,ctx.currentTime);o.frequency.exponentialRampToValueAtTime(440,ctx.currentTime+0.1);g.gain.setValueAtTime(0.3,ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.3);o.start(ctx.currentTime);o.stop(ctx.currentTime+0.3);}catch{}}
function showBrowserNotif(title,body){if(!settings.notif||Notification.permission!=='granted')return;if(document.hasFocus())return;new Notification(title,{body,icon:'/favicon.ico'});}
function showToastNotif(author,content,channelId,onClick){
  const el=document.createElement('div');el.className='toast-notif';
  el.innerHTML=`<div class="toast-notif-icon">ğŸ’¬</div><div class="toast-notif-body"><div class="toast-notif-title">${escHtml(author)} <span style="color:var(--text-3);font-size:11px">${channelId?'#'+escHtml(channelId):'DM'}</span></div><div class="toast-notif-text">${escHtml((content||'').substring(0,60))}${(content||'').length>60?'â€¦':''}</div></div>`;
  if(onClick) el.onclick=onClick;
  document.body.appendChild(el);setTimeout(()=>el.remove(),4000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AUTH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab){document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',(i===0)===(tab==='login')));document.getElementById('login-form').style.display=tab==='login'?'':'none';document.getElementById('register-form').style.display=tab==='register'?'':'none';hideError();}
function showError(msg){const e=document.getElementById('auth-error');e.textContent=msg;e.classList.add('show');}
function hideError(){document.getElementById('auth-error').classList.remove('show');}
async function login(){const username=document.getElementById('login-username').value.trim();const password=document.getElementById('login-password').value;if(!username||!password)return showError('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');try{const res=await fetch(`${API}/api/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password})});const data=await res.json();if(!res.ok)return showError(data.error||'ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—');onLogin(data);}catch{showError('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“');}}
async function register(){const username=document.getElementById('reg-username').value.trim();const password=document.getElementById('reg-password').value;if(!username||!password)return showError('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');if(password.length<6)return showError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Š');try{const res=await fetch(`${API}/api/register`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password})});const data=await res.json();if(!res.ok)return showError(data.error||'ç™»éŒ²å¤±æ•—');onLogin(data);}catch{showError('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“');}}
function onLogin({token:t,user}){token=t;currentUser=user;localStorage.setItem('token',t);document.getElementById('auth-screen').style.display='none';document.getElementById('app').classList.add('visible');applySettings();initApp();}
function openLogoutConfirm() { closeModal('settings-modal'); openModal('logout-confirm-modal'); }
function logout(){localStorage.removeItem('token');localStorage.removeItem('nexus_dmRooms');if(socket)socket.disconnect();location.reload();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• APP INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initApp() {
  document.getElementById('user-display-name').textContent = currentUser.username;
  document.getElementById('user-avatar-img').src = currentUser.avatar;
  document.getElementById('user-role-tag').textContent = currentUser.role;
  if (currentUser.role === 'admin') document.getElementById('admin-btn').style.display = '';
  document.getElementById('settings-username').textContent = currentUser.username;
  document.getElementById('settings-role').textContent = currentUser.role;

  const res = await fetch(`${API}/api/channels`,{headers:{Authorization:`Bearer ${token}`}});
  const channels = await res.json();
  renderChannelList(channels.filter(c=>c.type==='text'));

  // å…¨ãƒ¡ãƒ³ãƒãƒ¼å–å¾—ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³è¡¨ç¤ºç”¨ï¼‰
  fetch(`${API}/api/members`,{headers:{Authorization:`Bearer ${token}`}})
    .then(r=>r.json()).then(members=>{ window._allMembers=members; renderMembers(onlineUsersList); }).catch(()=>{});

  // æ°¸ç¶šåŒ–ã•ã‚ŒãŸDMãƒªã‚¹ãƒˆã‚’å¾©å…ƒ
  renderDmList();

  socket = io({auth:{token}});

  // æ¥ç¶šãƒ»å†æ¥ç¶šã©ã¡ã‚‰ã§ã‚‚ join_channel ã‚’é€ã‚‹ï¼ˆsocket.io v4 ã§ã¯ connect ãŒæ¯å›ç™ºç«ï¼‰
  socket.on('connect', () => {
    if (!socket._hasInitialized) {
      // åˆå›æ¥ç¶š: ç”»é¢ã‚’æç”»ã—ã¦ãƒãƒ£ãƒ³ãƒãƒ«ã«å‚åŠ 
      socket._hasInitialized = true;
      joinChannel(currentChannel);
    } else {
      // å†æ¥ç¶š: ç”»é¢ã¯è§¦ã‚‰ãšã€ã‚µãƒ¼ãƒãƒ¼ãƒ«ãƒ¼ãƒ ã¸ã®å†ç™»éŒ²ã ã‘è¡Œã†
      if (currentChannelType === 'text' && currentChannel) {
        socket.emit('join_channel', currentChannel);
      }
    }
  });

  socket.on('message', (msg)=>{
    // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã‚‚å®Œå…¨ç„¡è¦–
    if (msg.type === 'system') return;

    // â”€â”€ ã“ã®ãƒãƒ£ãƒ³ãƒãƒ«ãŒfetchãƒ­ãƒ¼ãƒ‰ä¸­ãªã‚‰ãƒãƒƒãƒ•ã‚¡ã«ç©ã‚€ã ã‘ï¼ˆæç”»ã—ãªã„ï¼‰â”€â”€
    // æç”»ã¯joinChannelå®Œäº†å¾Œã«ä¸€æ‹¬ã§è¡Œã†ãŸã‚ã€ã“ã“ã§æç”»ã™ã‚‹ã¨äºŒé‡ã«ãªã‚‹
    if (channelLoading[msg.channelId]) {
      if (!pendingSocketMsgs[msg.channelId]) pendingSocketMsgs[msg.channelId] = [];
      if (!pendingSocketMsgs[msg.channelId].find(m => m.id === msg.id)) {
        pendingSocketMsgs[msg.channelId].push(msg);
      }
      return;
    }

    // ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒãƒ£ãƒ³ãƒãƒ«ã¸ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    if(!allMessages[msg.channelId]) allMessages[msg.channelId]=[];
    if (!allMessages[msg.channelId].find(m => m.id === msg.id)) {
      allMessages[msg.channelId].push(msg);
    }
    if(msg.channelId===currentChannel && currentChannelType==='text'){renderMessageToDom(msg);scrollToBottom();}
    else if(msg.type!=='system'){unreadCounts[msg.channelId]=(unreadCounts[msg.channelId]||0)+1;updateUnreadBadge(msg.channelId);}
    const isMention=msg.content&&currentUser&&msg.content.includes('@'+currentUser.username);
    if(msg.type==='text'&&msg.author!==currentUser?.username){
      if(!settings.mentionOnly||isMention) playNotifSound();
      if(isMention){showBrowserNotif(`${msg.author} ãŒã‚ãªãŸã‚’ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³`,msg.content);if(msg.channelId!==currentChannel)showToastNotif(msg.author,msg.content,msg.channelId);}
      else if(!settings.mentionOnly&&msg.channelId!==currentChannel)showToastNotif(msg.author,msg.content,msg.channelId,()=>joinChannel(msg.channelId));
    }
  });

  // ç·¨é›†ãƒ»å‰Šé™¤
  socket.on('message_edited',({msgId,channelId,content,editedAt})=>{
    const msg=allMessages[channelId]?.find(m=>m.id===msgId);
    if(msg){msg.content=content;msg.edited=true;msg.editedAt=editedAt;}
    const el=document.querySelector(`[data-id="${msgId}"]`);
    if(el){const c=el.querySelector('.msg-content');if(c){c.innerHTML=mentionify(linkify(markdownify(escHtml(content))));const h=el.querySelector('.msg-header');let edEl=h?.querySelector('.msg-edited');if(!edEl&&h){edEl=document.createElement('span');edEl.className='msg-edited';h.appendChild(edEl);}if(edEl)edEl.textContent='(ç·¨é›†æ¸ˆã¿)';}}
  });
  socket.on('message_deleted',({msgId,channelId})=>{
    allMessages[channelId]=allMessages[channelId]?.filter(m=>m.id!==msgId)||[];
    document.querySelector(`[data-id="${msgId}"]`)?.remove();
  });

  // ãƒ”ãƒ³
  socket.on('pin_update',({channelId,pins})=>{ allMessages[`pins:${channelId}`]=pins; });

  // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  socket.on('reaction_update',({msgId,reactions})=>updateReactions(msgId,reactions));

  // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼
  socket.on('online_users',(users)=>{ onlineUsersList=users; renderMembers(users); });

  // ãƒœã‚¤ã‚¹çŠ¶æ…‹

  // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°
  socket.on('typing',({username,isTyping})=>{if(isTyping)typingUsers[username]=true;else delete typingUsers[username];renderTyping();});

  // DM
  socket.on('dm_message',(msg)=>{
    const roomId=msg.channelId;
    if(!allMessages[roomId])allMessages[roomId]=[];
    allMessages[roomId].push(msg);
    if(currentDmRoom===roomId&&currentChannelType==='dm'){renderMessageToDom(msg);scrollToBottom();}
    else{const otherUser=roomId.split('__').find(u=>u!==currentUser.username);showToastNotif(msg.author,msg.content,null,()=>openDm(otherUser));if(!openDmRooms.find(r=>r.roomId===roomId)){openDmRooms.push({roomId,otherUser});localStorage.setItem('nexus_dmRooms', JSON.stringify(openDmRooms));renderDmList();}}
    playNotifSound();
  });


  // ãƒ­ãƒ¼ãƒ«å¤‰æ›´
  socket.on('role_changed',({role})=>{currentUser.role=role;document.getElementById('user-role-tag').textContent=role;if(role==='admin')document.getElementById('admin-btn').style.display='';});
  socket.on('user_role_updated',()=>{renderMembers(onlineUsersList);});
  socket.on('user_avatar_updated',({username, avatar})=>{
    // è‡ªåˆ†ã®ã‚¢ãƒã‚¿ãƒ¼ãŒä»–ã®ã‚¿ãƒ–ç­‰ã‹ã‚‰æ›´æ–°ã•ã‚ŒãŸå ´åˆ
    if (username === currentUser?.username) { currentUser.avatar = avatar; document.getElementById('user-avatar-img').src = avatar; }
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§ã®ã‚¢ãƒã‚¿ãƒ¼ã‚‚æ›´æ–°
    document.querySelectorAll(`.msg`).forEach(el => {
      const author = el.querySelector('.msg-author')?.textContent;
      if (author === username) { const img = el.querySelector('.msg-avatar img'); if (img) img.src = avatar; }
    });
    renderMembers(onlineUsersList);
  });

  // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—
  document.addEventListener('dragover',e=>{e.preventDefault();document.getElementById('drop-overlay').classList.add('active');});
  document.addEventListener('dragleave',e=>{if(!e.relatedTarget)document.getElementById('drop-overlay').classList.remove('active');});
  document.addEventListener('drop',e=>{e.preventDefault();document.getElementById('drop-overlay').classList.remove('active');handleFileSelect(e.dataTransfer.files);});

  // â”€â”€ ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– â”€â”€
  initMobile();
}

function initMobile() {
  const isMobile = window.matchMedia('(max-width:640px)').matches;
  if (!isMobile) return;

  // iOS: ä»®æƒ³ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãŒå‡ºãŸã‚ã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ãŒãšã‚Œã‚‹ã®ã‚’ä¿®æ­£
  const input = document.getElementById('msg-input');
  input.addEventListener('focus', () => {
    setTimeout(scrollToBottom, 350); // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾…ã¡
  });

  // iOS Safari: ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ ã‚’é˜²ãï¼ˆCSS touch-action ã§å¯¾å¿œï¼‰
  // â€» touchend ã§ preventDefault() ã™ã‚‹ã¨ click ãŒç™ºç«ã—ãªããªã‚‹ãŸã‚ CSS ã§ä»£æ›¿

  // ã‚¹ãƒ¯ã‚¤ãƒ—ã§ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‹ãï¼ˆå·¦ç«¯ã‹ã‚‰å³ã‚¹ãƒ¯ã‚¤ãƒ—ï¼‰
  let touchStartX = 0, touchStartY = 0;
  document.addEventListener('touchstart', e => {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
  }, {passive:true});
  document.addEventListener('touchend', e => {
    const dx = e.changedTouches[0].clientX - touchStartX;
    const dy = Math.abs(e.changedTouches[0].clientY - touchStartY);
    if (dx > 60 && dy < 60 && touchStartX < 30) {
      // å·¦ç«¯ã‹ã‚‰å³ã‚¹ãƒ¯ã‚¤ãƒ— â†’ ã‚µã‚¤ãƒ‰ãƒãƒ¼é–‹ã
      document.querySelector('.sidebar').classList.add('open');
      document.getElementById('drawer-overlay').classList.add('open');
    } else if (dx < -60 && dy < 60) {
      // å³ã‚¹ãƒ¯ã‚¤ãƒ— â†’ é–‹ã„ã¦ã„ã‚‹ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
      closeDrawers();
    }
  }, {passive:true});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CHANNELS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderChannelList(channels) {
  const list = document.getElementById('channel-list');
  list.innerHTML = channels.map(ch=>`
    <div class="ch-item${ch.id===currentChannel?' active':''}" id="ch-${ch.id}" onclick="joinChannel('${ch.id}')">
      <span class="ch-icon">#</span>${escHtml(ch.name)}
      <span class="unread-badge" id="badge-${ch.id}"></span>
    </div>`).join('');
}


function updateUnreadBadge(channelId) {
  const badge=document.getElementById(`badge-${channelId}`);
  const el=document.getElementById(`ch-${channelId}`);
  const count=unreadCounts[channelId]||0;
  if(badge)badge.textContent=count>99?'99+':count;
  if(el)el.classList.toggle('unread',count>0);
}

// joinChannel ãŒå‘¼ã°ã‚Œã‚‹ãŸã³ã«ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã—ã€è‡ªåˆ†ãŒã€Œæœ€æ–°ã®å‘¼ã³å‡ºã—ã€ã‹åˆ¤å®šã™ã‚‹
const joinGeneration = {};
// fetchä¸­ã«socketã§å±Šã„ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸€æ™‚ãƒãƒƒãƒ•ã‚¡ï¼ˆãƒãƒ£ãƒ³ãƒãƒ«ã”ã¨ï¼‰
const pendingSocketMsgs = {};
// ç¾åœ¨fetchãƒ­ãƒ¼ãƒ‰ä¸­ã‹ã©ã†ã‹ï¼ˆãƒãƒ£ãƒ³ãƒãƒ«ã”ã¨ï¼‰
const channelLoading = {};

async function joinChannel(channelId, silent = false) {
  closeDrawers();
  currentChannelType = 'text';
  currentDmRoom = null;
  document.querySelectorAll('.ch-item').forEach(el=>el.classList.remove('active'));
  document.getElementById(`ch-${channelId}`)?.classList.add('active');
  currentChannel = channelId;
  unreadCounts[channelId] = 0;
  updateUnreadBadge(channelId);

  // silent=true ã®ã¨ãã¯ãƒ«ãƒ¼ãƒ å‚åŠ ã ã‘ï¼ˆå†æ¥ç¶šå¾Œã®å†ç™»éŒ²ç”¨ï¼‰
  if (silent) { socket.emit('join_channel', channelId); return; }

  // â”€â”€ ä¸–ä»£ç•ªå·ï¼šåŒãƒãƒ£ãƒ³ãƒãƒ«ã¸ã®äºŒé‡å‘¼ã³å‡ºã—ã§å¤ã„fetchã®æç”»ã‚’ãƒ–ãƒ­ãƒƒã‚¯ â”€â”€
  const myGen = (joinGeneration[channelId] = (joinGeneration[channelId] || 0) + 1);

  // â”€â”€ fetchãƒ­ãƒ¼ãƒ‰é–‹å§‹ï¼šã“ã®ãƒãƒ£ãƒ³ãƒãƒ«ã®socketãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒãƒƒãƒ•ã‚¡ã«å›ã™ â”€â”€
  channelLoading[channelId] = true;
  pendingSocketMsgs[channelId] = [];

  document.getElementById('chat-header-icon').textContent = '#';
  document.getElementById('chat-header-name').textContent = channelId;
  document.getElementById('msg-input').placeholder = `#${channelId} ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡`;
  document.getElementById('messages').style.display = '';
  document.getElementById('input-bar').style.display = '';
  document.getElementById('pins-btn').style.display = '';
  document.getElementById('messages').innerHTML = `
    <div class="welcome-msg">
      <div class="welcome-icon">#</div>
      <div class="welcome-title">#${channelId} ã¸ã‚ˆã†ã“ãï¼</div>
      <div class="welcome-sub">å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>`;

  socket.emit('join_channel', channelId);

  let messages = [];
  try {
    const res = await fetch(`${API}/api/channels/${channelId}/messages`,{headers:{Authorization:`Bearer ${token}`}});
    messages = await res.json();
  } catch(e) {
    console.error('[joinChannel] fetchå¤±æ•—:', e);
  }

  // â”€â”€ åˆ¥ãƒãƒ£ãƒ³ãƒãƒ«ã¸åˆ‡ã‚Šæ›¿ã‚ã£ãŸã€ã¾ãŸã¯æ–°ã—ã„å‘¼ã³å‡ºã—ãŒæ¥ã¦ã„ãŸã‚‰ã‚¹ã‚­ãƒƒãƒ— â”€â”€
  if (channelId !== currentChannel || myGen !== joinGeneration[channelId]) {
    channelLoading[channelId] = false;
    return;
  }

  // â”€â”€ ãƒãƒƒãƒ•ã‚¡ã«æºœã¾ã£ãŸsocketãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚µãƒ¼ãƒãƒ¼å±¥æ­´ã¨IDã§ãƒãƒ¼ã‚¸ â”€â”€
  const serverIds = new Set(messages.map(m => m.id));
  const buffered = (pendingSocketMsgs[channelId] || []).filter(m => !serverIds.has(m.id));
  const allMsgs = [...messages, ...buffered].sort((a,b) => new Date(a.timestamp)-new Date(b.timestamp));

  // allMessages ã‚’ç¢ºå®šç‰ˆã§ä¸Šæ›¸ã
  allMessages[channelId] = allMsgs;

  const savedTs = lastSeenTs[channelId];
  let unreadInserted = false;

  // â”€â”€ DOM ã‚’ç¢ºå®šç‰ˆã§ä¸€åº¦ã ã‘æç”» â”€â”€
  document.getElementById('messages').innerHTML = `
    <div class="welcome-msg">
      <div class="welcome-icon">#</div>
      <div class="welcome-title">#${channelId} ã¸ã‚ˆã†ã“ãï¼</div>
      <div class="welcome-sub">ã“ã‚Œã¯ãƒãƒ£ãƒ³ãƒãƒ«ã®å§‹ã¾ã‚Šã§ã™ã€‚</div>
    </div>`;

  for (const msg of allMsgs) {
    if (!unreadInserted && savedTs && msg.timestamp > savedTs && msg.author !== currentUser?.username && msg.type !== 'system') {
      insertUnreadDivider();
      unreadInserted = true;
    }
    renderMessageToDom(msg);
  }

  lastSeenTs[channelId] = new Date().toISOString();
  localStorage.setItem('lastSeenTs', JSON.stringify(lastSeenTs));
  scrollToBottom();

  // â”€â”€ ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼šä»¥é™ã®socketãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯é€šå¸¸é€šã‚Šappend â”€â”€
  channelLoading[channelId] = false;
  pendingSocketMsgs[channelId] = [];
}

function insertUnreadDivider() {
  const container = document.getElementById('messages');
  const divider = document.createElement('div');
  divider.className = 'unread-divider';
  divider.innerHTML = '<span class="unread-divider-label">ã“ã“ã‹ã‚‰æœªèª­</span>';
  container.appendChild(divider);
}



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MESSAGES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const QUICK_REACTIONS = ['ğŸ‘','â¤ï¸','ğŸ˜‚','ğŸ˜®','ğŸ˜¢','ğŸ‰'];

// â”€â”€ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’DOMã«è¿½åŠ ï¼ˆé‡è¤‡ãªã—ä¿è¨¼ã¯joinChannelå´ã§è¡Œã†ï¼‰ â”€â”€
function renderMessageToDom(msg) {
  const container = document.getElementById('messages');
  if (msg.type === 'system') return; // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è¡¨ç¤ºã—ãªã„
  // æœ€çµ‚å®‰å…¨ç¶²: åŒã˜IDãŒæ—¢ã«DOMã«ã‚ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—
  if (msg.id && document.querySelector(`[data-id="${msg.id}"]`)) return;

  // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒã‚¿ãƒ¼ãŒã‚ã‚Œã°ãã¡ã‚‰ã‚’å„ªå…ˆ
  const memberData = (window._allMembers || []).find(m => m.username === msg.author);
  const avatar = memberData?.avatar || `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(msg.author)}`;
  const time   = new Date(msg.timestamp).toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'});
  const isMention = msg.content && currentUser && msg.content.includes('@'+currentUser.username);
  const isOwn = msg.author === currentUser?.username;
  const canEdit = isOwn;
  const canDelete = isOwn || ['admin','moderator'].includes(currentUser?.role);
  const canPin = ['admin','moderator'].includes(currentUser?.role);

  const el = document.createElement('div');
  el.className = 'msg'+(isMention?' mention-highlight':'');
  el.dataset.id = msg.id;

  let contentHtml = '';
  if (msg.type==='file'&&msg.fileInfo) {
    const {filename,url,mimetype,size}=msg.fileInfo;
    // ãƒ­ãƒ¼ã‚«ãƒ«URLã¯API baseã‚’ä»˜ã‘ã‚‹ã€å¤–éƒ¨URLï¼ˆDiscord CDNç­‰ï¼‰ã¯ãã®ã¾ã¾
    const fullUrl = url.startsWith('http') ? url : `${API}${url}`;
    if (mimetype?.startsWith('image/'))
      contentHtml=`<div class="msg-content" style="color:var(--text-3);font-size:13px;margin-bottom:4px">${escHtml(filename)} <a href="${fullUrl}" download="${escHtml(filename)}" target="_blank" style="color:var(--accent);font-size:12px;text-decoration:none">â¬‡ DL</a></div><img class="img-preview" src="${fullUrl}" alt="${escHtml(filename)}" onclick="openLightbox('${fullUrl}')" loading="lazy" />`;
    else
      contentHtml=`<a class="file-attachment" href="${fullUrl}" target="_blank" download="${escHtml(filename)}"><div class="file-icon">${fileIcon(mimetype)}</div><div class="file-info"><div class="file-name">${escHtml(filename)}</div><div class="file-size">${formatBytes(size)}</div></div><span style="color:var(--text-3)">â¬‡</span></a>`;
  } else {
    contentHtml=`<div class="msg-content">${mentionify(linkify(markdownify(escHtml(msg.content||''))))}</div>`;
  }

  const editedHtml = msg.edited ? '<span class="msg-edited">(ç·¨é›†æ¸ˆã¿)</span>' : '';

  el.innerHTML=`
    <div class="msg-avatar"><img src="${avatar}" alt="${escHtml(msg.author)}" /></div>
    <div class="msg-body">
      <div class="msg-header">
        <span class="msg-author" onclick="insertMention('${escHtml(msg.author)}')">${escHtml(msg.author)}</span>
        <span class="msg-time">${time}</span>${editedHtml}
      </div>
      ${contentHtml}
      <div class="msg-edit-area" id="edit-${msg.id}">
        <textarea class="msg-edit-input" id="edit-input-${msg.id}" rows="2">${escHtml(msg.content||'')}</textarea>

```
    <div class="msg-edit-btns">
      <button class="edit-save-btn" onclick="saveEdit('${msg.id}')">ä¿å­˜</button>
      <button class="edit-cancel-btn" onclick="cancelEdit('${msg.id}')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  <div class="reactions" id="reactions-${msg.id}"></div>
</div>
<div class="msg-actions">
  <button class="msg-action-btn" title="ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³" onclick="showReactionPicker('${msg.id}',this)">ğŸ˜Š</button>
  <button class="msg-action-btn" title="è¿”ä¿¡" onclick="replyTo('${escHtml(msg.author)}')">â†©</button>
  ${canPin?`<button class="msg-action-btn" title="ãƒ”ãƒ³ç•™ã‚" onclick="pinMessage('${msg.id}')">ğŸ“Œ</button>`:''}
  ${canEdit?`<button class="msg-action-btn" title="ç·¨é›†" onclick="startEdit('${msg.id}')">âœï¸</button>`:''}
  ${canDelete?`<button class="msg-action-btn danger" title="å‰Šé™¤" onclick="deleteMessage('${msg.id}')">ğŸ—‘</button>`:''}
</div>`;
```

container.appendChild(el);
if (msg.reactions) renderReactions(msg.id,msg.reactions);
}

// ç·¨é›†
function startEdit(msgId) {
const area = document.getElementById(`edit-${msgId}`);
area?.classList.add(â€˜activeâ€™);
document.getElementById(`edit-input-${msgId}`)?.focus();
}
function cancelEdit(msgId) { document.getElementById(`edit-${msgId}`)?.classList.remove(â€˜activeâ€™); }
function saveEdit(msgId) {
const content = document.getElementById(`edit-input-${msgId}`)?.value?.trim();
if (!content) return;
socket.emit(â€˜edit_messageâ€™,{msgId,channelId:currentChannelType===â€˜dmâ€™?currentDmRoom:currentChannel,content});
cancelEdit(msgId);
}

// å‰Šé™¤
function deleteMessage(msgId) {
if (!confirm(â€˜ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿâ€™)) return;
socket.emit(â€˜delete_messageâ€™,{msgId,channelId:currentChannelType===â€˜dmâ€™?currentDmRoom:currentChannel});
}

// ãƒ”ãƒ³
function pinMessage(msgId) { socket.emit(â€˜pin_messageâ€™,{msgId,channelId:currentChannel}); }

async function openPins() {
const res = await fetch(`${API}/api/channels/${currentChannel}/pins`,{headers:{Authorization:`Bearer ${token}`}});
const pins = await res.json();
const list = document.getElementById(â€˜pins-listâ€™);
if (!pins.length) { list.innerHTML=â€™<div style="color:var(--text-3);text-align:center">ãƒ”ãƒ³ç•™ã‚ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>â€™; }
else {
list.innerHTML = pins.map(p=>` <div class="pin-item"> <img src="https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(p.author)}" style="width:32px;height:32px;border-radius:50%;flex-shrink:0" /> <div class="pin-item-body"> <div class="pin-item-author">${escHtml(p.author)}</div> <div class="pin-item-content">${escHtml(p.content||'')}</div> <div class="pin-item-meta">ğŸ“Œ ${escHtml(p.pinnedBy)} ãŒ ${new Date(p.pinnedAt).toLocaleString('ja-JP')}</div> </div> ${['admin','moderator'].includes(currentUser?.role)?`<button class="pin-unpin-btn" onclick="unpinMessage('${p.id}')">å¤–ã™</button>`:''} </div>`).join(â€™â€™);
}
openModal(â€˜pins-modalâ€™);
}

function unpinMessage(msgId) { socket.emit(â€˜unpin_messageâ€™,{msgId,channelId:currentChannel}); closeModal(â€˜pins-modalâ€™); }

// ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
function showReactionPicker(msgId, btn) {
document.querySelectorAll(â€™.quick-reaction-pickerâ€™).forEach(e=>e.remove());
const picker=document.createElement(â€˜divâ€™);
picker.className=â€˜quick-reaction-pickerâ€™;
picker.style.cssText=â€˜position:absolute;right:0;bottom:100%;background:var(â€“bg-panel);border:1px solid var(â€“border);border-radius:12px;padding:6px;display:flex;gap:4px;box-shadow:0 8px 24px rgba(0,0,0,0.4);z-index:100;â€™;
picker.innerHTML=QUICK_REACTIONS.map(e=>`<button onclick="addReaction('${msgId}','${e}')" style="width:32px;height:32px;border:none;background:transparent;border-radius:6px;cursor:pointer;font-size:18px;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">${e}</button>`).join(â€™â€™);
btn.closest(â€™.msg-actionsâ€™).appendChild(picker);
setTimeout(()=>document.addEventListener(â€˜clickâ€™,()=>picker.remove(),{once:true}),100);
}
function addReaction(msgId,emoji){socket.emit(â€˜add_reactionâ€™,{msgId,emoji,channelId:currentChannelType===â€˜dmâ€™?currentDmRoom:currentChannel});document.querySelectorAll(â€™.quick-reaction-pickerâ€™).forEach(e=>e.remove());}
function updateReactions(msgId,reactions){const el=document.getElementById(`reactions-${msgId}`);if(el)renderReactions(msgId,reactions,el);}
function renderReactions(msgId,reactions,el=null){if(!el)el=document.getElementById(`reactions-${msgId}`);if(!el)return;if(!reactions||!Object.keys(reactions).length){el.innerHTML=â€™â€™;return;}el.innerHTML=Object.entries(reactions).map(([emoji,users])=>{const reacted=users.includes(currentUser?.username);return`<span class="reaction-pill${reacted?' reacted':''}" onclick="addReaction('${msgId}','${emoji}')">${emoji}<span class="reaction-count">${users.length}</span></span>`;}).join(â€™â€™);}

function scrollToBottom(){
const m=document.getElementById(â€˜messagesâ€™);
// requestAnimationFrame ã§iOSã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å±•é–‹å¾Œã®å†æç”»ã‚’å¾…ã¤
requestAnimationFrame(()=>{ m.scrollTop=m.scrollHeight; });
}
function insertMention(u){const i=document.getElementById(â€˜msg-inputâ€™);i.value+=`@${u} `;i.focus();autoResize(i);}
function replyTo(u){const i=document.getElementById(â€˜msg-inputâ€™);i.value=`@${u} `+i.value;i.focus();autoResize(i);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SEND â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sendMessage() {
const input=document.getElementById(â€˜msg-inputâ€™);
const content=input.value.trim();
if (!content) return;
if (currentChannelType === â€˜dmâ€™) {
const otherUser = currentDmRoom?.split(â€™__â€™).find(u=>u!==currentUser.username);
if (otherUser) socket.emit(â€˜send_dmâ€™,{toUsername:otherUser,content});
} else {
socket.emit(â€˜send_messageâ€™,{channelId:currentChannel,content});
}
input.value=â€™â€™;autoResize(input);stopTyping();
}
function handleKey(e){if(settings.sendKey===â€˜enterâ€™){if(e.key===â€˜Enterâ€™&&!e.shiftKey){e.preventDefault();sendMessage();}}else{if(e.key===â€˜Enterâ€™&&(e.ctrlKey||e.metaKey)){e.preventDefault();sendMessage();}}}
function autoResize(el){el.style.height=â€˜24pxâ€™;el.style.height=Math.min(el.scrollHeight,200)+â€˜pxâ€™;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TYPING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function emitTyping(){if(!socket||currentChannelType!==â€˜textâ€™)return;socket.emit(â€˜typingâ€™,{channelId:currentChannel,isTyping:true});clearTimeout(typingTimer);typingTimer=setTimeout(stopTyping,2000);}
function stopTyping(){if(!socket)return;socket.emit(â€˜typingâ€™,{channelId:currentChannel,isTyping:false});clearTimeout(typingTimer);}
function renderTyping(){const bar=document.getElementById(â€˜typing-barâ€™);const users=Object.keys(typingUsers).filter(u=>u!==currentUser?.username);if(!users.length){bar.innerHTML=â€™â€™;return;}bar.innerHTML=`<div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div><span>${escHtml(users.join(', '))} ãŒå…¥åŠ›ä¸­â€¦</span>`;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MEMBERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMembers(onlineUsers) {
document.getElementById(â€˜online-countâ€™).textContent = onlineUsers.length;
const onlineUsernames = new Set(onlineUsers.map(u=>u.username));
const offlineUsers = (window._allMembers||[]).filter(u=>!onlineUsernames.has(u.username));

let html = â€˜â€™;
if (onlineUsers.length > 0) {
html += `<div style="padding:8px 16px 4px;font-size:11px;font-weight:700;color:var(--text-3);text-transform:uppercase;letter-spacing:0.8px">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ â€” ${onlineUsers.length}</div>`;
html += onlineUsers.map(u=>` <div class="member-item" onclick="openDm('${escHtml(u.username)}')"> <div class="member-avatar"> <img src="https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(u.username)}" alt="${escHtml(u.username)}" /> <div class="member-status" style="background:var(--green)"></div> </div> <div class="member-name">${escHtml(u.username)}</div> </div>`).join(â€™â€™);
}
if (offlineUsers.length > 0) {
html += `<div style="padding:12px 16px 4px;font-size:11px;font-weight:700;color:var(--text-3);text-transform:uppercase;letter-spacing:0.8px">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ â€” ${offlineUsers.length}</div>`;
html += offlineUsers.map(u=>` <div class="member-item" style="opacity:0.5" onclick="openDm('${escHtml(u.username)}')"> <div class="member-avatar"> <img src="https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(u.username)}" alt="${escHtml(u.username)}" /> <div class="member-status" style="background:var(--text-muted)"></div> </div> <div class="member-name">${escHtml(u.username)}</div> </div>`).join(â€™â€™);
}
document.getElementById(â€˜members-listâ€™).innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDmList() {
document.getElementById(â€˜dm-listâ€™).innerHTML = openDmRooms.map(({roomId,otherUser})=>` <div class="ch-item${currentDmRoom===roomId?' active':''}" id="ch-dm-${escHtml(roomId)}" onclick="openDm('${escHtml(otherUser)}')"> <span class="ch-icon">ğŸ’¬</span>${escHtml(otherUser)} </div>`).join(â€™â€™);
}

async function openDm(otherUser) {
if (otherUser === currentUser.username) return;
closeModal(â€˜dm-search-modalâ€™);
closeDrawers();
const roomId = [currentUser.username, otherUser].sort().join(â€™__â€™);
if (!openDmRooms.find(r=>r.roomId===roomId)) { openDmRooms.push({roomId,otherUser}); localStorage.setItem(â€˜nexus_dmRoomsâ€™, JSON.stringify(openDmRooms)); renderDmList(); }
currentChannelType = â€˜dmâ€™;
currentDmRoom = roomId;
currentChannel = roomId;
document.querySelectorAll(â€™.ch-itemâ€™).forEach(el=>el.classList.remove(â€˜activeâ€™));
document.getElementById(`ch-dm-${roomId}`)?.classList.add(â€˜activeâ€™);
document.getElementById(â€˜chat-header-iconâ€™).textContent = â€˜ğŸ’¬â€™;
document.getElementById(â€˜chat-header-nameâ€™).textContent = otherUser;
document.getElementById(â€˜msg-inputâ€™).placeholder = `${otherUser} ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡`;
document.getElementById(â€˜messagesâ€™).style.display = â€˜â€™;
document.getElementById(â€˜input-barâ€™).style.display = â€˜â€™;
document.getElementById(â€˜pins-btnâ€™).style.display = â€˜noneâ€™;
document.getElementById(â€˜messagesâ€™).innerHTML = ` <div class="welcome-msg"> <div class="welcome-icon">ğŸ’¬</div> <div class="welcome-title">${escHtml(otherUser)} ã¨ã®DM</div> <div class="welcome-sub">ã“ã“ã‹ã‚‰ä¼šè©±ãŒå§‹ã¾ã‚Šã¾ã™ã€‚</div> </div>`;
const res = await fetch(`${API}/api/dm/${roomId}`,{headers:{Authorization:`Bearer ${token}`}});
const messages = await res.json();
allMessages[roomId] = messages;
messages.forEach(renderMessageToDom);
scrollToBottom();
}

function openDmSearch() {
document.getElementById(â€˜dm-search-inputâ€™).value=â€™â€™;
document.getElementById(â€˜dm-search-resultsâ€™).innerHTML=â€™â€™;
filterDmSearch(â€™â€™);
openModal(â€˜dm-search-modalâ€™);
setTimeout(()=>document.getElementById(â€˜dm-search-inputâ€™).focus(),100);
}

function filterDmSearch(q) {
const users = onlineUsersList.filter(u=>u.username!==currentUser.username&&(!q||u.username.toLowerCase().includes(q.toLowerCase())));
document.getElementById(â€˜dm-search-resultsâ€™).innerHTML = users.map(u=>` <div class="member-item" onclick="openDm('${escHtml(u.username)}')"> <div class="member-avatar"><img src="https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(u.username)}" /></div> <div class="member-name">${escHtml(u.username)}</div> </div>`).join(â€™â€™) || â€˜<div style="color:var(--text-3);font-size:13px">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã—</div>â€™;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ADMIN PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function openAdminPanel() {
openModal(â€˜admin-modalâ€™);
const res = await fetch(`${API}/api/users`,{headers:{Authorization:`Bearer ${token}`}});
if (!res.ok) { document.getElementById(â€˜admin-user-listâ€™).innerHTML=â€™<div style="color:var(--red)">æ¨©é™ã‚¨ãƒ©ãƒ¼</div>â€™; return; }
const users = await res.json();
document.getElementById(â€˜admin-user-listâ€™).innerHTML = users.map(u=>` <div class="admin-user-row"> <img class="admin-user-avatar" src="${u.avatar}" alt="${escHtml(u.username)}" /> <div class="admin-user-name">${escHtml(u.username)}</div> <select class="role-select" onchange="setUserRole('${escHtml(u.username)}',this.value)"> <option value="member"${u.role==='member'?' selected':''}>member</option> <option value="moderator"${u.role==='moderator'?' selected':''}>moderator</option> <option value="admin"${u.role==='admin'?' selected':''}>admin</option> </select> </div>`).join(â€™â€™);
}

async function setUserRole(username, role) {
await fetch(`${API}/api/users/${username}/role`,{method:â€˜PUTâ€™,headers:{Authorization:`Bearer ${token}`,â€˜Content-Typeâ€™:â€˜application/jsonâ€™},body:JSON.stringify({role})});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FILE UPLOAD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openFilePicker(){document.getElementById(â€˜file-inputâ€™).click();}
async function handleFileSelect(files){if(!files||!files.length)return;for(const f of files)await uploadFile(f);}
async function uploadFile(file){
document.getElementById(â€˜upload-labelâ€™).textContent=`${file.name} ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...`;
document.getElementById(â€˜upload-toastâ€™).classList.add(â€˜showâ€™);
const form=new FormData();form.append(â€˜fileâ€™,file);
try{const res=await fetch(`${API}/api/upload`,{method:â€˜POSTâ€™,headers:{Authorization:`Bearer ${token}`},body:form});if(!res.ok){const e=await res.json();throw new Error(e.error||â€˜Upload failedâ€™);}const fileInfo=await res.json();socket.emit(â€˜send_fileâ€™,{channelId:currentChannel,fileInfo});}
catch(err){alert(â€˜ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: â€˜+err.message);}
setTimeout(()=>document.getElementById(â€˜upload-toastâ€™).classList.remove(â€˜showâ€™),600);
document.getElementById(â€˜file-inputâ€™).value=â€™â€™;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MISC â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openLightbox(src){document.getElementById(â€˜lightbox-imgâ€™).src=src;document.getElementById(â€˜lightboxâ€™).classList.add(â€˜openâ€™);}
function closeLightbox(){document.getElementById(â€˜lightboxâ€™).classList.remove(â€˜openâ€™);}
function toggleSidebar(){const s=document.querySelector(â€™.sidebarâ€™),o=document.getElementById(â€˜drawer-overlayâ€™);const open=s.classList.toggle(â€˜openâ€™);o.classList.toggle(â€˜openâ€™,open);}
function toggleMembers(){const p=document.querySelector(â€™.members-panelâ€™),o=document.getElementById(â€˜drawer-overlayâ€™);const open=p.classList.toggle(â€˜openâ€™);o.classList.toggle(â€˜openâ€™,open);}
function closeDrawers(){document.querySelector(â€™.sidebarâ€™)?.classList.remove(â€˜openâ€™);document.querySelector(â€™.members-panelâ€™)?.classList.remove(â€˜openâ€™);document.getElementById(â€˜drawer-overlayâ€™)?.classList.remove(â€˜openâ€™);}
function escHtml(str){return String(str||â€™â€™).replace(/&/g,â€™&â€™).replace(/</g,â€™<â€™).replace(/>/g,â€™>â€™).replace(/â€/g,â€™"â€™);}
function markdownify(text) {
// ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ (è¤‡æ•°è¡Œ)
text = text.replace(/`([\s\S]*?)`/g, (_, code) =>
`<pre style="background:var(--bg-dark);border:1px solid var(--border);border-radius:6px;padding:10px 14px;overflow-x:auto;margin:6px 0;font-family:var(--font-mono);font-size:13px;line-height:1.5;color:var(--text-1);user-select:text">${code.replace(/^\n/,'')}</pre>`);
// ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰
text = text.replace(/`([^`]+)`/g, â€˜<code style="background:var(--bg-dark);border:1px solid var(--border);border-radius:4px;padding:1px 5px;font-family:var(--font-mono);font-size:13px">$1</code>â€™);
// å¤ªå­—
text = text.replace(/**(.+?)**/g, â€˜<strong style="color:var(--text-1)">$1</strong>â€™);
// æ–œä½“
text = text.replace(/(?<!*)*(?!*)(.+?)(?<!*)*(?!*)/g, â€˜<em>$1</em>â€™);
// å–ã‚Šæ¶ˆã—ç·š
text = text.replace(/~(.+?)~/g, â€˜<del>$1</del>â€™);
// æ”¹è¡Œ â†’ <br>
text = text.replace(/\n/g, â€˜<br>â€™);
return text;
}
function linkify(text){return text.replace(/(https?://[^\s<â€]+)/g,â€™<a href="$1" target="_blank" rel="noopener" style="color:var(--accent)">$1</a>â€™);}
function mentionify(text){return text.replace(/@(\w+)/g,â€™<span class="mention">@$1</span>â€™);}
function formatBytes(b){if(b<1024)return b+â€™ Bâ€™;if(b<1048576)return(b/1024).toFixed(1)+â€™ KBâ€™;return(b/1048576).toFixed(1)+â€™ MBâ€™;}
function fileIcon(m=â€™â€™){if(m.startsWith(â€˜image/â€™))returnâ€™ğŸ–¼ï¸â€™;if(m.startsWith(â€˜video/â€™))returnâ€™ğŸ¬â€™;if(m.startsWith(â€˜audio/â€™))returnâ€™ğŸµâ€™;if(m.includes(â€˜pdfâ€™))returnâ€™ğŸ“„â€™;if(m.match(/zip|rar|7z/))returnâ€™ğŸ“¦â€™;returnâ€™ğŸ“â€™;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AUTO LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
applySettings();
(async()=>{
if (!token) return;
try{const res=await fetch(`${API}/api/me`,{headers:{Authorization:`Bearer ${token}`}});if(!res.ok){localStorage.removeItem(â€˜tokenâ€™);return;}currentUser=await res.json();document.getElementById(â€˜auth-screenâ€™).style.display=â€˜noneâ€™;document.getElementById(â€˜appâ€™).classList.add(â€˜visibleâ€™);applySettings();initApp();}
catch{localStorage.removeItem(â€˜tokenâ€™);}
})();
</script>

</body>
</html>
